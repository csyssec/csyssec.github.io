<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Index of Computer System and Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="computer system, computer security" />
  
  
  
  
  <meta name="description" content="FROM 0 TO 1">
<meta property="og:type" content="website">
<meta property="og:title" content="Index of Computer System and Security">
<meta property="og:url" content="http://yoursite.com/page/4/index.html">
<meta property="og:site_name" content="Index of Computer System and Security">
<meta property="og:description" content="FROM 0 TO 1">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Index of Computer System and Security">
<meta name="twitter:description" content="FROM 0 TO 1">
  
    <link rel="alternate" href="/atom.xml" title="Index of Computer System and Security" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<body>
  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            <a href="/" title="Index of Computer System and Security" rel="home">
              Index of Computer System and Security</a>
          </h1>
          <div class="site-description">FROM 0 TO 1</div>

            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/syssec">系统安全</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/architecture">系统结构</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/virtualization">虚拟化</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/malware">恶意代码</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/conferences">主流会议</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/courses">名人课堂</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/academy">学术专家</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/contribution">本站达人</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>




  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-xencolor"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170504/xencolor/">Xen模式-你的XEN是什么颜色？</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170504/xencolor/" class="article-date">
	  <time datetime="2017-05-04T10:23:26.000Z" itemprop="datePublished">五月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Author:<a href="http://www.brendangregg.com/index.html" target="_blank" rel="external">Brendan D. Gregg</a><br>Source:<a href="http://www.brendangregg.com/blog/2014-05-07/what-color-is-your-xen.html" target="_blank" rel="external">http://www.brendangregg.com/blog/2014-05-07/what-color-is-your-xen.html</a><br>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<p>What’s faster: <strong>PV</strong>, <strong>HVM</strong>, <strong>HVM with PV drivers</strong>, <strong>PVHVM</strong>, or <strong>PVH</strong>? Cloud computing providers using <a href="http://www.xenproject.org/" target="_blank" rel="external">Xen</a> can offer different virtualization “modes”, based on paravirtualization (PV), hardware virtual machine (HVM), or a hybrid of them. As a customer, you may be required to choose one of these. So, which one?</p>
<p>Rackspace offers <a href="http://www.rackspace.com/knowledge_center/article/choosing-a-virtualization-mode-pv-versus-pvhvm" target="_blank" rel="external">PV or PVHVM</a>, and Amazon EC2 offers <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html" target="_blank" rel="external">PV or HVM</a>. I’d summarize the choice today as:</p>
<pre><code>The best performance is the latest PV/HVM hybrid mode that Xen supports.
</code></pre><p>For most places right now, PVHVM should deliver the best performance. On AWS EC2, if you create a “HVM” instance, and Linux supports it, you get PVHVM. In the future (Xen 4.4+) the fastest mode will be <a href="http://blog.xen.org/index.php/2014/01/31/linux-3-14-and-pvh/" target="_blank" rel="external">PVH</a>.</p>
<p>Not picking the latest hybrid mode should only make sense for some corner cases. You can test this yourself, as your mileage and requirements may vary.</p>
<p>Now, if you search for <a href="http://lmgtfy.com/?q=PV+vs+HVM" target="_blank" rel="external">PV vs HVM</a>, the more you read the more confused you may become. My first hit was a post from 2012 discussing EC2 choices, concluding with:</p>
<pre><code>&quot;If you want a good performance for Linux/Unix then use PV&quot;
</code></pre><p>You might still be thinking the same, and a while ago this was right, before many changes in the world of Xen (before PV drivers on HVM, PVHVM, and PVH). At least the post from 2012 has a date on it (like this one).</p>
<p>What makes this even more confusing is that never versions of the hybrid model have been named as separate “modes”. In this post, I’ll summarize the current virtualization spectrum model, and suggest a slightly different explanation: instead of focusing on the choice of modes, I’ll show them as an evolution of versions.</p>
<p>Note that I’m not a Xen developer, so I’m not an official source of Truth for this: I’m a performance architect for a large EC2 user, and I’m hoping to contribute to our collective understanding of Xen choices.<br><br></p>
<h3 id="The-Virtualization-Spectrum"><a href="#The-Virtualization-Spectrum" class="headerlink" title="The Virtualization Spectrum"></a><strong>The Virtualization Spectrum</strong></h3><p>In the articles <a href="http://blog.xen.org/index.php/2012/10/23/the-paravirtualization-spectrum-part-1-the-ends-of-the-spectrum/" target="_blank" rel="external">The Ends of the Spectrum</a> and <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/" target="_blank" rel="external">From Poles to a Spectrum</a>, George Dunlap introduced the idea that there are no longer two modes of Xen virtualization – PV or HVM – but, rather, a spectrum of modes, where PV and HVM are the poles.</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/xen-virt-spectrum-crop-800.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/xen-virt-spectrum-crop-800.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>This is pictured in the right diagram <a href="http://www.slideshare.net/xen_com_mgr/linuxcon-eu-virtualization-in-the-cloud-featuring-xen-and-xcp/16" target="_blank" rel="external">from Lars Kurth</a>, which lists different Xen virtualization modes as rows, and features as columns. Full HVM mode is the top row, full PV mode is the bottom, and hybrid modes are in-between. (This shows PVH as a Xen 4.3 feature; it’s now Xen 4.4.)</p>
<p>The HVM and PV technologies provide their own performance benefits:</p>
<ul>
<li><strong>HVM</strong>: A processor technology for accelerating CPU virtualization (privileged instructions, syscalls) and the MMU (page tables). This is supported by Intel (VT-x) and AMD (AMD-V).</li>
<li><strong>PV</strong>: A software technology where the guest kernel can use an accelerated interface for virtualized components, including disks and network interfaces, rather than emulating hardware.<br>Xen has been developing additional hybrid modes for the best of both words, where a HVM guest can use faster PV kernel parts, or vice versa. At first, PV disk and network drivers on HVM were possible. Then, interrupts and timers. Each of these moves reduced the need for slower emulation, such as via QEMU, improving performance. This is all summarized pretty well by the spectrum diagram.</li>
</ul>
<p>You can find more detailed explanations of the modes in those <a href="http://blog.xen.org/index.php/2012/10/23/the-paravirtualization-spectrum-part-1-the-ends-of-the-spectrum/" target="_blank" rel="external">two</a> <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/" target="_blank" rel="external">articles</a>. As George suggested, PVH is expected to be the best hybrid mode, and that other modes could eventually be dropped from the Linux kernel, simplifying it. And, if HVM existed (the Intel VT-x or AMD-V processor features) when Xen was written, PVH would probably have been the chosen mode.<br><br></p>
<h3 id="The-Colors-of-Xen"><a href="#The-Colors-of-Xen" class="headerlink" title="The Colors of Xen"></a><strong>The Colors of Xen</strong></h3><p>So Xen today is something of a mess – the result of evolving software and hardware features, aiming to provide the best performance possible. And, as George noted in his first article, the terminology has been a little unclear, and has evolved over time.</p>
<p>The spectrum of modes is great way to make sense of this, but there are some loose ends. One is that a spectrum of modes can imply a choice when doesn’t need to be one: if my instance supports PVHVM, should I study its pros and cons versus PV drivers over HVM? No, PVHVM is just the latest version of the same thing. So, instead of a spectrum of modes, is it more a spectrum of versions?</p>
<p>There are other sources of confusion: George’s <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/" target="_blank" rel="external">article</a> describes “PVHVM mode” and “PVH mode”, then depicts them inside “HVM mode” and “PV mode” groups, which are labeled as “mode/domain” in the above figure. So “PVHVM mode” is a mode, but “PV mode” is a domain or group of modes?</p>
<p>His article also warns about PVHVM mode confusion:</p>
<blockquote>
<p>(“PVHVM” mode should not be confused with “PV-on-HVM” mode, which is a term sometimes used in the past for “fully virtualized with PV drivers”.)<br>I understand this statement, however, many sources seem to still misuse the terms: the Xen wiki page on PV on HVM describes this as “also called PVHVM or <a href="http://wiki.xen.org/wiki/PV_on_HVM" target="_blank" rel="external">PV-on-HVM</a> drivers”, which seems to contradict the warning. Also, what I think are the developer’s slides on PVHVM are actually titled “<a href="http://www.slideshare.net/xen_com_mgr/6-stefano-spvhvm" target="_blank" rel="external">Linux PV on HVM</a>. Maybe I’m wrong and these are consistent, but I struggle to see how.<br><br></p>
</blockquote>
<h3 id="Back-to-Poles"><a href="#Back-to-Poles" class="headerlink" title="Back to Poles"></a><strong>Back to Poles</strong></h3><p>Here’s a different way to think about the modes, if it helps. Lets go back to the poles model (PV and HVM), before the spectrum, and explain the current state of Xen in that context.</p>
<p>In this model, there are only two modes to worry about, PV and HVM, and each mode may support additional features to improve performance:</p>
<ul>
<li><strong>PV</strong>: Use this if the PVH feature is supported, which boots the best type of hybrid. You may also need to choose this if the processor doesn’t do HVM: eg, following the EC2 <em><a href="http://aws.amazon.com/amazon-linux-ami/instance-type-matrix/" target="_blank" rel="external">instance type matrix</a></em> , where you will end up with a fully PV mode instance.</li>
<li><strong>HVM</strong>: Until PVH, choose this. Xen, and the guest kernel, are likely to support a number of enhancements which use PV code paths, so the booted instance will be a hybrid. The number of enhancements depends on the Xen and guest kernel versions: newer for more.</li>
</ul>
<p>This selection of instances is pictured in the flowchart on the right. It shows what can be selected to achieve the highest performance, in general. You may have a corner case that differs, due to different requirements.</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/xen-mode-flow.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/xen-mode-flow.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>PVHVM and PVH can be thought of as features and not modes. The choices are PV or HVM, which describes how the instance boots, and your choice may be influenced by the features available. Currently, on EC2, PVH is not available, but PVHVM is: so the best choice for Linux (in general) would be booting a “HVM” instance with PVHVM enabled (eg, setting CONFIG_XEN_PVHVM).</p>
<p>I’ve redrawn the spectrum picture on the right to emphasize the two modes, and to group all mixed types as “Hybrid”, showing that they are a progression of Xen versions, rather than a group of modes to choose from. Is this helpful?</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/xen-colors.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/xen-colors.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>If you don’t find this an improvement, I’ll try a different way to clarify what your Xen guest is doing in my next post, where I’ll cover tools for feature detection.<br><br></p>
<h3 id="Enhanced-Networking"><a href="#Enhanced-Networking" class="headerlink" title="Enhanced Networking"></a><strong>Enhanced Networking</strong></h3><p>While my spectrum diagram may be an improvement, I’ve left a loose end untied: <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking.html" target="_blank" rel="external">SR-IOV for enhanced networking</a>. If the instance type supports it, this uses hardware virtualization enhancements to improve performance and provide an interface better suited for virtualization. In some ways, this is an evolution of I/O controllers that is similar to what processors have done, with their own virtualization extensions.</p>
<p>SR-IOV, if you can enable it, should provide the best I/O performance. So perhaps the first feature column in the spectrum diagram should really show two options: P (paravirt) as yellow, and VH (SR-IOV) as green. Here’s how it <a href="http://www.brendangregg.com/blog/images/2014/xen-colors-sriov.png" target="_blank" rel="external">looks</a> (although I’m not sure all the hybrid types support SR-IOV).<br><br></p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a><strong>Conclusion</strong></h3><p>Nowadays, there are various hybrid Xen modes (or versions), which obsolete older advice that “PV is fastest”. On AWS EC2 today, “HVM” mode (which supports PVHVM) should be fastest. In the future, it will be PVH. If you can, you can also enable SR-IOV to improve I/O performance further.</p>
<p>In this post I summarized the spectrum model of the modes, and described them a little differently in terms of the earlier PV or HVM model. The number of Xen modes is a little confusing, and is a result of an evolution of software and hardware, and Xen development work to deliver the fastest guests they can.</p>
<p>A while ago I wrote a post on <a href="http://dtrace.org/blogs/brendan/2013/01/11/virtualization-performance-zones-kvm-xen/" target="_blank" rel="external">the performance of Zones vs KVM vs Xen</a>, and for Xen I pictured a fully HVM instance with the QEMU I/O proxy, mentioning that paravirtualization drivers could improve I/O performance. That how I’d draw the digram today: as I/O should be using the faster PV drivers, even for <a href="http://docs.aws.amazon.com/AWSEC2/latest/WindowsGuide/Upgrading_PV_drivers.html" target="_blank" rel="external">Windows</a>.</p>
<p>Despite the Xen improvements, Solaris Zones, or Linux containers, should still be the fastest possible virtualization option, allowing guests to run bare-metal everything. But there is still a road ahead for their widespread adoption: a topic for another post.</p>
<p>In my <a href="http://www.brendangregg.com/blog/2014-05-09/xen-feature-detection.html" target="_blank" rel="external">next post</a>, I show various tools you can use from your Linux Xen guest to detect which HVM and PV features are enabled.<br><br></p>
<h3 id="References-and-Resources"><a href="#References-and-Resources" class="headerlink" title="References and Resources"></a><strong>References and Resources</strong></h3><ul>
<li>George Dunlap’s <a href="http://blog.xen.org/index.php/2012/10/23/the-paravirtualization-spectrum-part-1-the-ends-of-the-spectrum/" target="_blank" rel="external">The Ends of the Spectrum</a> and <a href="http://blog.xen.org/index.php/2012/10/31/the-paravirtualization-spectrum-part-2-from-poles-to-a-spectrum/" target="_blank" rel="external">From Poles to a Spectrum</a> are the best summary of all the modes, and how these have been developed (evolved) little by little.</li>
<li>Lars Kurth’s talk <a href="http://www.slideshare.net/xen_com_mgr/linuxcon-eu-virtualization-in-the-cloud-featuring-xen-and-xcp/16" target="_blank" rel="external">Virtualization in the Cloud Featuring Xen</a>.</li>
<li>Stefano Stabellini’s <a href="http://www.slideshare.net/xen_com_mgr/6-stefano-spvhvm" target="_blank" rel="external">Linux PV on HVM</a>, and especially the <a href="http://vimeo.com/33056481" target="_blank" rel="external">video</a>, give the best insight into why the PVHVM features were developed, and the value they bring.</li>
<li>The Xen <a href="http://wiki.xen.org/wiki/Xen_Linux_PV_on_HVM_drivers" target="_blank" rel="external">Linux PV on HVM drivers</a>shows more commands for studying Xen configuration.</li>
<li>Also see the Xen wiki <a href="http://wiki.xen.org/wiki/PV_on_HVM" target="_blank" rel="external">PV on HVM</a> page.</li>
<li><a href="http://blog.xen.org/index.php/2014/01/31/linux-3-14-and-pvh/" target="_blank" rel="external">Linux 3.14 and PVH</a>, describing how to get the development version working.</li>
<li>See the <a href="http://www.slideshare.net/xen_com_mgr/xen-project-4-4-features-and-futures" target="_blank" rel="external">Xen Project 4.4</a> slides by Russell Pavlicek, Mar 27, 2014, for a recent summary.</li>
<li>The AWS <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/instance-types.html" target="_blank" rel="external">EC2 instance types</a> does explain that “HVM” isn’t fully “HVM”.</li>
<li>The AWS <a href="http://docs.aws.amazon.com/general/latest/gr/glos-chap.html#H" target="_blank" rel="external">glossary</a> also defines “HVM”.</li>
<li>Rackspace <a href="http://www.rackspace.com/knowledge_center/article/choosing-a-virtualization-mode-pv-versus-pvhvm" target="_blank" rel="external">choosing PV vs PVHVM</a>.</li>
<li>EC2 <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/enhanced-networking.html" target="_blank" rel="external">enhanced nerworking (SR-IOV)</a>.</li>
<li>The first hit from google for <a href="http://palakonda.org/2012/10/30/aws-virtualization-hvm-vs-paravirtualization/" target="_blank" rel="external">PV vs HVM</a> (out of date).</li>
<li>Moolah ecommerce <a href="http://moolah-ecommerce.com/blog/36-2014/219-amazon-vs-rackspace-performance" target="_blank" rel="external">benchmarked</a> the difference between PV and PVHVM, using <a href="http://www.brendangregg.com/blog/2014-05-02/compilers-love-messing-with-benchmarks.html" target="_blank" rel="external">UnixBench</a>?</li>
<li>Xen Orchestra has also benchmarked <a href="https://xen-orchestra.com/debian-pvhvm-vs-pv/" target="_blank" rel="external">Debian PVHVM vs PV</a> using … UnixBench? again?? (flips desk.)</li>
</ul>
<p>Thanks to the AWS performance engineers for helping me understand this better.</p>
<hr>
<p>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/虚拟化原理/">虚拟化原理<span class="article-category-count">7</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Virtualization/">Virtualization</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/XEN/">XEN</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-cloud-osv"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170504/cloud-osv/">Unikernels为云设计的库操作系统(OSv)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170504/cloud-osv/" class="article-date">
	  <time datetime="2017-05-04T10:21:55.000Z" itemprop="datePublished">五月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Author：<a href="https://github.com/bzhu5" target="_blank" rel="external">Bing Zhu</a><br>Source：<a href="http://hypervsir.blogspot.com/2014/11/unikernels-library-operating-systems.html" target="_blank" rel="external">http://hypervsir.blogspot.com/2014/11/unikernels-library-operating-systems.html</a><br>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<p>Unlike a general-purpose, commercial operating system (like Windows, Ubuntu), OSv (<a href="http://osv.io/" target="_blank" rel="external">http://osv.io/</a> from cloudius-systems) is a single-purpose operating system. It is also kind of library operating system <strong><em>designed for the cloud</em></strong>  that running on top of different hypervisors, e.g. XEN, KVM, VMware. So what does OSv like look? </p>
<p>By quickly taking a look at this slide (<a href="http://www.slideshare.net/dmarti1111/o-sv-usenix-atc-2014" target="_blank" rel="external">http://www.slideshare.net/dmarti1111/o-sv-usenix-atc-2014</a>), we can get to know these two features below. </p>
<ul>
<li>General-purpose OS has kernel mode (ring 0) and user mode (ring 3), but <strong>OSv only has code running in Ring 0 mode, it doesn’t have code running in user (ring 3) mode</strong>. This is one of most significant differences.</li>
<li>The other main difference is that the <strong>OSv only has one single address space</strong> (multiple threads allowed, though) running on a hypervisor as being a single virtual appliance, which serves a single-purpose cloud service. </li>
</ul>
<p>So, each OSv holds one specific application (with multiple threads) on top of it, and the OSv itself runs as a guest OS on top of hypervisor. Application and resource isolation is guaranteed by the hypervisor.</p>
<p>Since an OSv has a single address space, it needs only one CR3 value. Process and address space switch (scheduler) is not required any more, and hence no TLB flush overhead introduced. This also can reduce “kernel” component memory footprint, and let application own more memory space.</p>
<p>Regarding address translation overheads, e.g. GVA-&gt;GPA-&gt;HPA, by using the larger table (2MB, or even 1GB) for both guest virtual memory page tables and EPT tables, such a translation overhead could be further reduced a lot. </p>
<p>Note that, as the slides pointed out, <strong>syscalls (user/kernel switch) are no longer required</strong>. Any traditional syscalls now are converted to just function calls in kernel mode only. Although this can significantly reduce performance cost, it also causes a new issue: application ABI compatibility issue. This means that in order to deploy this application on top of OSv, the source code must have to be modified and recompiled. </p>
<p>There are many challenges, you can check <a href="http://osv.io/" target="_blank" rel="external">http://osv.io/</a> for greater details. But anyway, if OSv is a correct direction for cloud OS (and with a success on having rich application supported) in future, it will definitely have a direct competition with some other solutions like <a href="https://www.docker.com/" target="_blank" rel="external">Docker</a>. </p>
<p>I like this product in person, the much simpler it is, the more I love it :-).</p>
<p>Also, see this slide (OSb: <a href="http://www.slideshare.net/yushiomote/osb-osv-on-bitvisor" target="_blank" rel="external">OSv on BitVisor</a>), someone is working on enabling OSv on top of <strong><a href="http://hypervsir.blogspot.com/2014/11/paper-read-bitvisor-thin-hypervisor-for.html" target="_blank" rel="external">BitVisor</a></strong>,  cool ! </p>
<hr>
<p><strong><em>Some other references about Library OS:</em></strong></p>
<p>Unikernels: Rise of the Virtual Library Operating System<br><a href="http://queue.acm.org/detail.cfm?id=2566628" target="_blank" rel="external">http://queue.acm.org/detail.cfm?id=2566628</a></p>
<p>XPDS14: OSv - A Modern Semi-POSIX LibraryOS - Glauber Costa<br><a href="http://www.xenproject.org/help/presentations-and-videos/video/xpds14v-osv.html" target="_blank" rel="external">http://www.xenproject.org/help/presentations-and-videos/video/xpds14v-osv.html</a></p>
<p>Rethinking the Library OS from the Top Down:<br><a href="http://research.microsoft.com/pubs/141071/asplos2011-drawbridge.pdf" target="_blank" rel="external">http://research.microsoft.com/pubs/141071/asplos2011-drawbridge.pdf</a></p>
<p>OSv on bhyve:<br><a href="http://bhyvecon.org/osv_on_bhyve.pdf" target="_blank" rel="external">http://bhyvecon.org/osv_on_bhyve.pdf</a></p>
<hr>
<p>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/系统内核/">系统内核<span class="article-category-count">11</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Cloud/">Cloud</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/">Kernel</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-securekernel-design"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170504/securekernel-design/">这是Linux内核中一种好的安全设计吗- thread_info和内核栈的联系</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170504/securekernel-design/" class="article-date">
	  <time datetime="2017-05-04T10:19:40.000Z" itemprop="datePublished">五月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Author：<a href="https://github.com/bzhu5" target="_blank" rel="external">Bing Zhu</a><br>Source：<a href="http://hypervsir.blogspot.com/2014/10/in-linux-kernel-threadinfo-is-small-cpu.html" target="_blank" rel="external">http://hypervsir.blogspot.com/2014/10/in-linux-kernel-threadinfo-is-small-cpu.html</a><br>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<p>In Linux kernel, <strong><em>thread_info</em></strong> is a small CPU-specific data structure that stores some low-level task data for corresponding process, it also has a pointer to <strong><em>task_struct</em></strong>, which is a processor-independent process control block data structure, e.g. scheduling, virtual memory structures.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* x86 * 64 */</span></div><div class="line"><span class="keyword">struct</span> thread_info &#123;</div><div class="line"><span class="keyword">struct</span> task_struct   *task;        <span class="comment">/* main task structure */</span></div><div class="line"><span class="keyword">struct</span> exec_domain  *exec_domain; <span class="comment">/* execution domain */</span></div><div class="line">__u32               flags;        <span class="comment">/* low level flags */</span></div><div class="line">__u32               status;       <span class="comment">/* thread synchronous flags*/</span></div><div class="line">__u32                cpu;          <span class="comment">/* current CPU */</span></div><div class="line"><span class="keyword">int</span>                  saved_preempt_count;</div><div class="line"><span class="keyword">mm_segment_t</span>         addr_limit;</div><div class="line"><span class="keyword">struct</span> restart_block restart_block;</div><div class="line"><span class="keyword">void</span> __user          *sysenter_return;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>         sig_on_uaccess_error:<span class="number">1</span>;</div><div class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span>         uaccess_err:<span class="number">1</span>; <span class="comment">/* uaccess failed */</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>Every user process has its unique two stacks, one is for code running in user mode, and the other is <strong><em>kernel stack</em></strong> for code execution running in kernel mode. </p>
<p>The current design is like below picture, the kernel stack space of process and its thread_info structure are located together (at two ends because stack grows down). This is because it offers a key benefit in terms of efficiency: the kernel can easily obtain the address of the <em>*</em>thread_info structure of the process currently running on a CPU from the value of its kernel ESP register. </p>
<p>For example as below, %eax eventually holds the pointer to <strong><em>thread_info</em></strong> structure.<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">movl $<span class="number">0xFFFFE000</span>, %eax</div><div class="line">andl %esp,        %eax (mask out last <span class="number">13</span> bits)</div></pre></td></tr></table></figure></p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/thread_info_stack%281%29.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/thread_info_stack%281%29.png" width="450"></a><br>    <figcaption></figcaption><br></figure>


<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/thread_info_stack%282%29.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/thread_info_stack%282%29.png" width="450"></a><br>    <figcaption></figcaption><br></figure>


<ul>
<li>Note that these pictures above are from Junfeng’s operating system course slides.<br><a href="http://www.cs.columbia.edu/~junfeng/10sp-w4118/syllabus.html" target="_blank" rel="external">http://www.cs.columbia.edu/~junfeng/10sp-w4118/syllabus.html</a> (or <a href="http://www.cs.columbia.edu/~junfeng/" target="_blank" rel="external">link</a>).</li>
</ul>
<p>From security’s point of view, this means that whenever the address of kernel stack is leaked for some reasons (e.g. a bug, vulnerability), the address of corresponding <strong><em>thread_info</em></strong> structure will also be leaked. And as you can see that we can also get the address of <strong><em>task_struct</em></strong> as long as the address of thread_info is gotten. </p>
<p>The <strong><em>task_struct</em></strong> is a one of very critical kernel data structures in Linux system, for example, it contains the credentials (uid, gid, suid, sgid…). Provided that there is a kernel vulnerability that can cause arbitrary kernel memory overwrite, then those credential fields could be clear by an exploit to get root privilege even without executing any code in kernel mode. </p>
<p>So, the question: is this a bad security design? Could we do something to improve it? </p>
<p>See my <a href="http://hypervsir.blogspot.com/2014/09/windows-os-thread-scheduling-monitoring.html" target="_blank" rel="external">previous post</a> for monitoring Windows thread scheduling, it seems that Windows operating system uses FS (or GS) to retrieve thread-related structure for current running thread. However, as far as I know, in Linux system, fs/gs are used for LTS (Local Thread Storage) purpose. </p>
<hr>
<p><strong>UPDATE:</strong></p>
<ol>
<li><strong>Fortunately I got an idea (not too bad idea:-) to mitigate this issue, I will talk about it later in a new post.</strong></li>
<li>Add references for “stack overflow” attack against this bad design.</li>
</ol>
<p><br><br>Exploiting Stack Overflows in the Linux Kernel<br><a href="https://jon.oberheide.org/blog/2010/11/29/exploiting-stack-overflows-in-the-linux-kernel/" target="_blank" rel="external">https://jon.oberheide.org/blog/2010/11/29/exploiting-stack-overflows-in-the-linux-kernel/</a></p>
<p>Exploiting stack overflows<br><a href="https://jon.oberheide.org/files/infiltrate12-thestackisback.pdf" target="_blank" rel="external">https://jon.oberheide.org/files/infiltrate12-thestackisback.pdf</a></p>
<p>Exploiting the Futex Bug and uncovering Towelroot<br><a href="http://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/" target="_blank" rel="external">http://tinyhack.com/2014/07/07/exploiting-the-futex-bug-and-uncovering-towelroot/</a></p>
<p>SMEP: What is It, and How to Beat It on Linux<br><a href="http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux/" target="_blank" rel="external">http://vulnfactory.org/blog/2011/06/05/smep-what-is-it-and-how-to-beat-it-on-linux/</a></p>
<hr>
<p>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/系统内核/">系统内核<span class="article-category-count">11</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/">Kernel</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-secureos2"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170504/secureos2/">安全操作系统设计-Linux内核关键数据结构写保护</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170504/secureos2/" class="article-date">
	  <time datetime="2017-05-04T10:18:05.000Z" itemprop="datePublished">五月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Author：<a href="https://github.com/bzhu5" target="_blank" rel="external">Bing Zhu</a><br>Source：<a href="http://hypervsir.blogspot.com/2014/11/security-os-design-cont-write.html" target="_blank" rel="external">http://hypervsir.blogspot.com/2014/11/security-os-design-cont-write.html</a><br>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<p>To be continued for <a href="http://hypervsir.blogspot.com/2014/10/security-os-design-idea-to-prevent.html" target="_blank" rel="external">previous post</a>, let me review what must be changed in Linux kernel in order to prevent buffer overrun/overflow attacks from modifying the critical kernel data structures, like GDT, IDT, task_struct, mm_struct, etc.</p>
<p>There are some kernel data structures that are never changed at runtime as long as the operating system completes their initialization. For example, the GDT and IDT table, the system call table, or SSDT (pointed by nt!KeServiceDescriptorTable, see this <a href="http://resources.infosecinstitute.com/hooking-system-service-dispatch-table-ssdt/" target="_blank" rel="external">link</a> for SSDT hooking in Windows OS). Note that in Linux system, some of GDT table entries will also be updated by kernel. </p>
<p>For those data structures, we can directly configure them with Read-Only memory permission in page table entries. </p>
<p>However, there are many kernel data structures like task_struct, mm_struct, GDT, which must have to be configured with Read-Write attribute because they are changed very frequently during OS runtime. </p>
<p>But the good thing is that those data are only changed by kernel itself. Basically, the system drivers or other LKMs must not change them, and we can even think that any changes to them by those LKMs are illegitimate, and not desired behaviors. </p>
<p>So, with this assumption we can now take a look at what we should have to do on existing Linux kernel system or a new operating system started from scratch.</p>
<h3 id="Kernel-virtual-memory-management-subsystem"><a href="#Kernel-virtual-memory-management-subsystem" class="headerlink" title="Kernel virtual memory management subsystem:"></a><strong>Kernel virtual memory management subsystem:</strong></h3><p>First of all, add a new type of memory allocation to support Read-Only memory allocation (with kmalloc() or even vmalloc() ), for example, adding a new parameter GFP_ROMEM. </p>
<p>This means that the kernel internal memory management subsystem (e.g. Linux slab allocator) must be extended to group RO memory chunks together in a single or multiple RO pages (4KB or 2MB in size), and traditional RW memory chunks into other multiple RW pages in 4KB or 2MB size. This might greatly increase the complicity of memory management system design. </p>
<h3 id="Memory-allocation-for-kernel-itself-and-drivers-or-any-LKMs"><a href="#Memory-allocation-for-kernel-itself-and-drivers-or-any-LKMs" class="headerlink" title="Memory allocation for kernel itself and drivers (or any LKMs)"></a><strong>Memory allocation for kernel itself and drivers (or any LKMs)</strong></h3><p>Once we add a new type GFP_ROMEM, we must define the rules to use it. </p>
<p>The first rule #1 is … for the data structures that will only be modified by kernel module itself, we must use this new type for memory allocation in kernel (e.g. scheduler). All the drivers (or other LKMs) are disallowed to use this new type, we can use code static analysis tool to enforce this usage. </p>
<p>The second rule #2 is … since the data structure are now RO attribute, and by default CR0.WP bit is set, so kernel module must have to disable CR0.WP before writing access to those data structures. So the code logic is as below:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">disable_wp();                              // clear CR0.WP bit.</div><div class="line">write access to RO data fields.</div><div class="line">enable_wp();                             // set CR0.WP bit again.</div></pre></td></tr></table></figure>
<p> At the same time, any legitimate drivers (LKMs) are not allowed to change CR0.WP bit (code scanning to enforce this).</p>
<p>With solution, we can prevent many buffer overflow attacks like, some driver bug that causes arbitrary kernel memory overwriting. However, ROP (JOP) attacks might bypass this solution, but this security design is not intended to address such a specific attack like ROP. </p>
<p>Problems: </p>
<ol>
<li>This will increase tremendous changes to existing Linux kernel system. But it would be good if we plan to write our own operating system starting from scratch. </li>
<li>Performance impact. Too many extra cycles for disabling/enabling CR0.WP bit. But we can optimize it, the real impact might not so big.</li>
<li>Need to consider the interrupts or NMIs between disable_wp() and enable_wp() functions. This is just an implementation consideration. It can be solved very easily. </li>
</ol>
<p>Any other big issues? </p>
<hr>
<h3 id="Update"><a href="#Update" class="headerlink" title="[Update]:"></a><strong>[Update]:</strong></h3><p>The memory <strong><em>Protection Keys</em></strong> feature can do kind of similar protection for key data structures. With this feature enabled, each process also has a protection key value associated with it. On a memory access the hardware checks that the current process’s protection key matches the value associated with the memory block being accessed; if not, an exception occurs. </p>
<p>See the wikipedia page for details: <a href="http://en.wikipedia.org/wiki/Memory_protection#Protection_keys" target="_blank" rel="external">http://en.wikipedia.org/wiki/Memory_protection#Protection_keys</a></p>
<hr>
<p>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/系统内核/">系统内核<span class="article-category-count">11</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/">Kernel</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-secureos"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170504/secureos/">安全操作系统内核设计-一种阻止恶意软件覆盖关键系统内核数据结构的思想</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170504/secureos/" class="article-date">
	  <time datetime="2017-05-04T10:16:12.000Z" itemprop="datePublished">五月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>Author：<a href="https://github.com/bzhu5" target="_blank" rel="external">Bing Zhu</a><br>Source：<a href="http://hypervsir.blogspot.com/2014/10/security-os-design-idea-to-prevent.html" target="_blank" rel="external">http://hypervsir.blogspot.com/2014/10/security-os-design-idea-to-prevent.html</a><br>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<p>Recently, when reading this paper “<strong><a href="http://www.csc.ncsu.edu/faculty/jiang/pubs/OAKLAND10.pdf" target="_blank" rel="external">HyperSafe - A Lightweight Approach to Provide Lifetime Hypervisor Control-Flow Integrity</a></strong>“, an idea just comes out from my mind: using write protection (CR0.WP) and read-only (RO) page attribute to prevent the critical kernel data structures being overwritten by malicious software through buffer (stack, heap) overflow in an exploitable kernel module.</p>
<p>In a virtual memory management system, OS kernel can configure a Read-Only (RO) virtual page by clearing R/W bit in corresponding page table entry (PTE) so that a virtual page cannot be modified by OS kernel and/or application.</p>
<p>Write Protection (CR0.WP) allows virtual pages to be protected from supervisor-mode writes. If CR0.WP = 0, supervisor-mode write accesses are allowed to linear addresses with read-only access rights; if CR0.WP = 1, such write accesses are not allowed. However, note that user-mode write accesses are never allowed to virtual addresses with Read-Only access rights, regardless of the value of CR0.WP.</p>
<p>In a modern operating system design, Write Protection bit by default is always set by kernel, which means that even the kernel code cannot directly modify the Read-Only pages. And basically the Read-Only access permission are used in these two ways below:</p>
<ol>
<li><p>COW (Copy-On-Write). WP and RO facilitates implementation of the copy-on-write method of creating a new process (fork()). &gt;<br>When a new child process is created, the OS kernel doesn’t create a whole bunch of things at one time, instead, the child process shares most of pages with its parent process, and OS kernel only clears corresponding PTE.R/W bit for those shared pages. Whenever a process (parent or child) modifies a shared page, a write access violation (#PF) occurs, then a separate copy of that particular page alone will be made by the #PF handler for that process (parent or child).</p>
</li>
<li><p>Write protection for kernel code and static data. Obviously, at OS runtime, those pages (except Self-Modified Code) should never be changed by any legitimate software. So generally speaking OS kernel must configure them with Read-Only access right.</p>
</li>
</ol>
<p>However, this post presents a 3rd usage in OS kernel design: <strong><em>Setting Read-Only  access permission even for the critical system kernel data structures that previously are configured with write access permission</em></strong>. Here are the reasons.</p>
<p>Like <a href="http://hypervsir.blogspot.com/2014/10/in-linux-kernel-threadinfo-is-small-cpu.html" target="_blank" rel="external">my last post</a> explained, thread_info structure is just one of critical data structures. Its field addr_limit can be overwritten by exploiting stack overflows existing in any kernel module/driver. This is because the thread_info structure is a writable page (the corresponding PTE.R/W bit = 1). </p>
<p>So the question is - what if we configure that page (e.g. thread_info page) with Read-Only permission? </p>
<p>In this way, we can prevent such those stack overflow attacks, because whenever a kernel module has an exploitable bug that attempts to overwrite this read-only structure, a write access violation (#PF, page fault) will be triggered.</p>
<p>But this will cause a problem, when a kernel legitimately writes/modifies that read-only structure, an access violation will happen too. To solve this problem, the legitimate kernel code must turn off write protection (clearing CR0.WP bit) before writing that read-only structure, and turn it on back after write access. </p>
<p>In a summary, the OS kernel designer can arrange the critical data structures together as possible as we can, and set those pages with read-only access permission. Whenever the OS kernel attempts to modify them, it turns off WP, and after modification turns it on again. And as a security design rule, the kernel module (e.g. *.ko) should not directly modify any kernel critical data structures, only kernel itself can modify the those write-protected kernel data structures (actually, this is the case in any modern operating system design).</p>
<p>However, this introduces performance issue (but not too bad), for example, on each legitimate write access, extra CPU cycles will be consumed by writing CR0.WP bit. However, we can reduce this by grouping those legitimate access code to decrease the times of writing CR0.WP bit. Another problem might be interrupts. During the window of disabling CR0.WP and enabling it, an interrupt might happen. We can solve this by disabling interrupt (or preemption) or saving/restoring CR0.WP bit in the interrupt handler (ISR).  </p>
<hr>
<p><strong><em>UPDATE:</em></strong><br>thread_info is not a good example, because it shares the same space with kernel stack which must have to be configured as Read-Write attribute. </p>
<p>Some other kernel structures, like task_struct, mm_struct might be good examples for this design. </p>
<hr>
<p>转载请注明：原作者信息以及<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/系统内核/">系统内核<span class="article-category-count">11</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/">Kernel</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/3/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/5/">下一页</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div class="widget-wrap" style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 75%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 42px;" placeholder=" 搜索…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="搜索">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">集思广益</h3>
      <p>我们推崇的是黑客与分享精神，如果您觉得本站对您有帮助，不妨自己也参与进来共同建设，期待您能推荐好文章或投稿至本站，
让更多人受益。本站热烈欢迎志愿者参与本站的共同维护和建设，您可通过微博[@Diting0x](http://weibo.com/diting0x)，或者邮件csyssec@hotmail.com联系我们</p>
       <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="null" title="Words"><i class="fa fa-words" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a> </li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>


        	</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>最新推荐</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170505/cfi-mathias/">控制流完整性-Mathias Payer</a></h6>
          <!--  <span>五月 5, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170505/vmi-xenproject/">虚拟机自省技术-一个有新商业应用的安全性创造</a></h6>
          <!--  <span>五月 5, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/cf-exception/">控制流分支指令上的控制流处理器异常(单步执行)</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/cfi-development/">控制流完整性的发展历程</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/cfi-ccs05/">控制流完整性-CCS05年论文</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/rop-intel/">因特尔发布新的技术规范去防御 ROP 攻击</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/ropjop-research/">ROP/JOP攻击与防御最新研究进展</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/nmi-virtual/">虚拟化技术的NMI窗口退出</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/lbr-ret2dir/">利用LBR特性检测ret2dir攻击</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/virtual-ret2dir/">利用虚拟化技术防御ret2dir攻击</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/smep-nx/">利用NX位实现基于软件的SMEP</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/smep-virtual/">如何利用虚拟化技术实现基于软件的SMEP(监督模式执行)</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/tsx-exploit/">TSX处理器技术对漏洞利用意味着什么？</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/lbr-idthooking/">使用LRB(最近分支记录)特性检测IDT Hooking</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/bitvisor/">BitVisor- 一种实施I/O设备安全的轻量级Hypervisor</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/xencolor/">Xen模式-你的XEN是什么颜色？</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类导航</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hypervisor安全/">Hypervisor安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/主流会议/">主流会议</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制分析/">二进制分析</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内存安全/">内存安全</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内核安全/">内核安全</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内核完整性/">内核完整性</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/博士之路/">博士之路</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/名人课堂/">名人课堂</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学术专家/">学术专家</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全圈子/">安全圈子</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/恶意代码/">恶意代码</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞利用/">漏洞利用</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件特性/">硬件特性</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件虚拟化/">硬件虚拟化</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统内核/">系统内核</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化原理/">虚拟化原理</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化基础/">虚拟化基础</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化综合/">虚拟化综合</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机快照/">虚拟机快照</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机监控/">虚拟机监控</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机记录与重放/">虚拟机记录与重放</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机迁移/">虚拟机迁移</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签导航</h3>
    <div class="widget tagcloud">
      <a href="/tags/ASLR/" style="font-size: 11.54px;">ASLR</a> <a href="/tags/ASPLOS/" style="font-size: 10px;">ASPLOS</a> <a href="/tags/Attack/" style="font-size: 12.31px;">Attack</a> <a href="/tags/Binary/" style="font-size: 10.77px;">Binary</a> <a href="/tags/CFI/" style="font-size: 12.31px;">CFI</a> <a href="/tags/Cloud/" style="font-size: 10px;">Cloud</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/Conference/" style="font-size: 12.31px;">Conference</a> <a href="/tags/Conferences/" style="font-size: 10px;">Conferences</a> <a href="/tags/Course/" style="font-size: 13.08px;">Course</a> <a href="/tags/Exception/" style="font-size: 10px;">Exception</a> <a href="/tags/Exploit/" style="font-size: 16.92px;">Exploit</a> <a href="/tags/Forensics/" style="font-size: 10px;">Forensics</a> <a href="/tags/HAV/" style="font-size: 12.31px;">HAV</a> <a href="/tags/Hardware/" style="font-size: 13.85px;">Hardware</a> <a href="/tags/Heap/" style="font-size: 10.77px;">Heap</a> <a href="/tags/Hooking/" style="font-size: 10px;">Hooking</a> <a href="/tags/Instrumentation/" style="font-size: 10.77px;">Instrumentation</a> <a href="/tags/Introspection/" style="font-size: 13.85px;">Introspection</a> <a href="/tags/JOP/" style="font-size: 10px;">JOP</a> <a href="/tags/KVM/" style="font-size: 16.15px;">KVM</a> <a href="/tags/Kernel/" style="font-size: 17.69px;">Kernel</a> <a href="/tags/Libvmi/" style="font-size: 13.08px;">Libvmi</a> <a href="/tags/Linux/" style="font-size: 13.08px;">Linux</a> <a href="/tags/Malware/" style="font-size: 15.38px;">Malware</a> <a href="/tags/Memory/" style="font-size: 13.08px;">Memory</a> <a href="/tags/Migration/" style="font-size: 11.54px;">Migration</a> <a href="/tags/Monitoring/" style="font-size: 13.08px;">Monitoring</a> <a href="/tags/NX/" style="font-size: 10px;">NX</a> <a href="/tags/Overflow/" style="font-size: 10.77px;">Overflow</a> <a href="/tags/PIN/" style="font-size: 10px;">PIN</a> <a href="/tags/Paper/" style="font-size: 11.54px;">Paper</a> <a href="/tags/Ph-D/" style="font-size: 10.77px;">Ph.D</a> <a href="/tags/Ppaerwriting/" style="font-size: 10px;">Ppaerwriting</a> <a href="/tags/Professor/" style="font-size: 12.31px;">Professor</a> <a href="/tags/QEMU/" style="font-size: 14.62px;">QEMU</a> <a href="/tags/RE/" style="font-size: 10px;">RE</a> <a href="/tags/ROP/" style="font-size: 10.77px;">ROP</a> <a href="/tags/Rootkit/" style="font-size: 11.54px;">Rootkit</a> <a href="/tags/SYSCALL/" style="font-size: 10px;">SYSCALL</a> <a href="/tags/Sandbox/" style="font-size: 10.77px;">Sandbox</a> <a href="/tags/Security/" style="font-size: 20px;">Security</a> <a href="/tags/Shellcode/" style="font-size: 10px;">Shellcode</a> <a href="/tags/Snapshot/" style="font-size: 10px;">Snapshot</a> <a href="/tags/Stack/" style="font-size: 10.77px;">Stack</a> <a href="/tags/Syscall/" style="font-size: 10px;">Syscall</a> <a href="/tags/System/" style="font-size: 18.46px;">System</a> <a href="/tags/Systemcall/" style="font-size: 11.54px;">Systemcall</a> <a href="/tags/TSX/" style="font-size: 10px;">TSX</a> <a href="/tags/TrustZone/" style="font-size: 10px;">TrustZone</a> <a href="/tags/VT-x/" style="font-size: 10px;">VT-x</a> <a href="/tags/Valgrind/" style="font-size: 10px;">Valgrind</a> <a href="/tags/Virtualization/" style="font-size: 19.23px;">Virtualization</a> <a href="/tags/Virtulization/" style="font-size: 12.31px;">Virtulization</a> <a href="/tags/Volatility/" style="font-size: 10px;">Volatility</a> <a href="/tags/XEN/" style="font-size: 13.08px;">XEN</a>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      版权所有&copy; 2017 Index of Computer System and Security 保留所有权利.
      </div>
      <div class="site-credit">
       <!--  自豪地使用 <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a> --> 
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/syssec" class="mobile-nav-link">Syssec</a>
  
    <a href="/architecture" class="mobile-nav-link">Architecture</a>
  
    <a href="/virtualization" class="mobile-nav-link">Virtualization</a>
  
    <a href="/malware" class="mobile-nav-link">Malware</a>
  
    <a href="/conferences" class="mobile-nav-link">Conferences</a>
  
    <a href="/courses" class="mobile-nav-link">Courses</a>
  
    <a href="/academy" class="mobile-nav-link">Academy</a>
  
    <a href="/contribution" class="mobile-nav-link">Contribution</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>





  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261078922&web_id=1261078922" language="JavaScript"></script>
  </div>


</body>
</html>
