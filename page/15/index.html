<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Index of Computer System and Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="computer system, computer security" />
  
  
  
  
  <meta name="description" content="Diting0x@">
<meta property="og:type" content="website">
<meta property="og:title" content="Index of Computer System and Security">
<meta property="og:url" content="http://yoursite.com/page/15/index.html">
<meta property="og:site_name" content="Index of Computer System and Security">
<meta property="og:description" content="Diting0x@">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Index of Computer System and Security">
<meta name="twitter:description" content="Diting0x@">
  
    <link rel="alternate" href="/atom.xml" title="Index of Computer System and Security" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<body>
  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            <a href="/" title="Index of Computer System and Security" rel="home">
              Index of Computer System and Security</a>
          </h1>
          <div class="site-description">Diting0x@</div>

            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/syssec">系统安全</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/architecture">系统结构</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/virtualization">虚拟化</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/malware">恶意代码</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/conferences">主流会议</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/courses">名人课堂</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/academy">学术专家</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/news">安全事件</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/knowledge">小科普</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/share">技术分享</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/contribution">本站达人</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>




  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-byoungyounglee"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170224/byoungyounglee/">Purdue大学助理教授Byoungyoung Lee</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170224/byoungyounglee/" class="article-date">
	  <time datetime="2017-02-24T06:21:39.000Z" itemprop="datePublished">二月 24, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <hr>
<p><strong>CSysSec注</strong>： 本系列文章旨在介绍计算机系统与安全领域著名教授与学者</p>
<p><strong>转载请注明</strong>： 文章出处：《<a href="http://www.csyssec.org/20170224/byoungyounglee/" target="_blank" rel="external">Purdue大学助理教授Byoungyoung Lee</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<h3 id="个人简介"><a href="#个人简介" class="headerlink" title="个人简介"></a>个人简介</h3><p>Byoungyoung Lee，11-16年在佐治亚理工大学获得博士学位，师从<a href="">Prof. Wenke Lee</a>和<a href="">Prof. Taesoo Kim</a>. 16年以助理教授身份加入Purdue大学计算机系.</p>
<h3 id="研究兴趣"><a href="#研究兴趣" class="headerlink" title="研究兴趣"></a>研究兴趣</h3><p>集中关注系统安全：在操作系统、编译器以及应用程序中设计与实现安全的系统。在NDSS,Security,CCS,ATC发表多篇论文，曾获CSAW, DEFCON, Facebook, Usenix等多项大奖</p>
<h3 id="论文标签"><a href="#论文标签" class="headerlink" title="论文标签"></a>论文标签</h3><p>[ASLR],[SGX],[Code reuse attack], [Use-after-free],[Data Flow Integrity]</p>
<h3 id="个人主页"><a href="#个人主页" class="headerlink" title="个人主页"></a>个人主页</h3><p><a href="https://lifeasageek.github.io/" target="_blank" rel="external">Byoungyoung Lee</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/学术专家/">学术专家<span class="article-category-count">1</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Professor/">Professor</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-migration"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170224/migration/">云平台高可用之虚拟机迁移</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170224/migration/" class="article-date">
	  <time datetime="2017-02-24T06:04:17.000Z" itemprop="datePublished">二月 24, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<hr>
<p><strong>CSysSec注</strong>： 本文来自<a href="http://www.chongh.wiki/about/" target="_blank" rel="external">Diting0x</a>的<a href="http://www.chongh.wiki/blog/2016/01/03/highavailability-migration/" target="_blank" rel="external">个人博客</a>，主要介绍虚拟机迁移技术，包括虚拟机迁移主要算法以及在KVM/QEMU平台上的迁移细节。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170224/migration/" target="_blank" rel="external">云平台高可用之虚拟机迁移</a>》与作者信息：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<hr>
<blockquote>
<ul>
<li>什么是云平台高可用</li>
<li>虚拟机迁移主要算法</li>
<li>实现 Pre-copy</li>
<li>思考</li>
</ul>
</blockquote>
<h2 id="什么是云平台高可用"><a href="#什么是云平台高可用" class="headerlink" title="什么是云平台高可用"></a>什么是云平台高可用</h2><p>云，一个再熟悉不过的词了。大家都看到了云计算的商业价值，于是乎各大IT公司都纷纷提出自己的云计算服务，有Amozon的EC2，微软的Azure,谷歌的Google AppEngine,腾讯云，百度云，阿里云等。说到Google AppEngine，相信许多用goagent翻墙党都用过这个东西，但估计大家都只忙着使用goagent，却忽略了AppEngine其中提供的云服务。如今，云无处不在，从当今主流产品看，云平台需要满足以下几个需求：</p>
<ul>
<li>第一，满足多用户的大规模并发访问，想想2015年的双十一，官方数据表明Taobao每秒钟要处理14万订单交易，平均每天也有七八千万访客（具体数据待我问阿里朋友）</li>
<li>第二，处理海量数据，14年，google平均每天要处理57.4亿次查询，处理的数据高达100PB；阿里云的大数据产品ODPS在6个小时内就能处理100PB的数据</li>
<li>第三，提供可持续的服务，如今云平台的用户如此之大，分秒级的停机时间将影响数百万用户，导致数十万美元损失，不管从用户角度还是公司本身角度来看，停机时间过长都是不可容忍的</li>
</ul>
<p>针对需求一和需求二，当前云平台的解决方案大多是通过分布式协议及系统来组织管理大量的廉价设备，以提供良好的可扩展性，从而满足大量用户的高并发访问需求以及对海量数据的处理能力，这不在本文考虑范围之内，不多叙说。本文只针对第三个需求，提供可持续的服务，也就是云计算平台中常说的高可用性（high availability)。可用性的准确定义是，在需要的外部资源得到保证的前提下，系统在规定的条件和时间内处于可执行功能状态的能力，高可用则定义为用来保障系统可用性达到某一预定水平的系统设计和技术手段。目前，许多云服务提供商都声称自己的云平台能保证较高的可用性，但实际上，近年来云平台的失效事件频繁发生。具体事件，可搜索了解一下。</p>
<p>虚拟化技术是云计算平台的核心支撑技术，虚拟机的强隔离性有效解决了资源的共享使用问题，大大支撑了云计算平台的资源聚合、负载均衡、节能、可扩展等特性。为保证云平台的高可用性，基于虚拟机备份思想的技术应运而生，也是当前云平台为保证高可用性的最主要途径。虚拟机备份思想，主要包括三个方面：</p>
<ul>
<li>第一，快照回滚（snapshot&amp;rollback)，将虚拟机备份状态保存在持久化存储系统中, 在虚拟机因上层软件或底层硬件故障失效后,可以加载备份状态并恢复到之前的运行 状态继续运行</li>
<li>第二，热备技术（hot-standby)，将虚拟机执行状态实时传输到目的端计算节点,在检测到源计算节点失效后,目的端的虚拟机状态可立刻恢复并持续提供任务</li>
<li>第三，虚拟机迁移（migration)，将虚拟机运行时状态从一台计算节点传输到另一台计算节点,保证虚拟机在源计算节点因失效或维护而停机时可以在目的端继续执行</li>
</ul>
<p>本文旨在讲解虚拟机迁移技术</p>
<h2 id="虚拟机迁移主要算法"><a href="#虚拟机迁移主要算法" class="headerlink" title="虚拟机迁移主要算法"></a>虚拟机迁移主要算法</h2><p>目前运用最广泛最原始的算法是预拷贝（pre-copy)算法和后拷贝（post-copy)算法，Pre-copy算法也被集成在主流虚拟机平台中如Xen,KVM,VMWare的官方源码中, Post-copy虽还没被各主流虚拟机平台集成，但个人实现起来也不是什么难事。 下面主要介绍这两种算法：</p>
<p>Pre-copy, 先引用顶会 <a href="https://www.usenix.org/legacy/event/nsdi05/tech/full_papers/clark/clark.pdf" target="_blank" rel="external">NSDI’05 Live Migration of Virtual Machines</a> 论文中的一张图，描述了pre-copy算法的时间线</p>
<p><img src="http://7xppf1.com1.z0.glb.clouddn.com/precopy-step.png" alt="pre-copy steps"><br>简而言之，大致思想就是先迭代的迁移整个内存的所有页面，迭代过程中，如果页面有更新，则再迁移更新过的页面，直到满足一个条件让迭代过程收敛（这个条件可以自己根据不同情况合理设置），最后再迁移剩余的页面、cpu、寄存器等状态以及外部设备。<br>贴一个基于Qemu/kvm 1.1.2的pre-copy算法主要代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">ram_save_live</span><span class="params">(QEMUFile *f, <span class="keyword">int</span> stage, <span class="keyword">void</span> *opaque)</span></span></div><div class="line">&#123;</div><div class="line">    <span class="keyword">ram_addr_t</span> addr;</div><div class="line">    <span class="keyword">uint64_t</span> bytes_transferred_last;</div><div class="line">    <span class="keyword">double</span> bwidth = <span class="number">0</span>;</div><div class="line">    <span class="keyword">uint64_t</span> expected_time = <span class="number">0</span>;</div><div class="line">    <span class="keyword">int</span> ret;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (stage &lt; <span class="number">0</span>) &#123;</div><div class="line">        memory_global_dirty_log_stop();</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    memory_global_sync_dirty_bitmap(get_system_memory());</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (stage == <span class="number">1</span>) &#123;</div><div class="line">        RAMBlock *block;</div><div class="line">        bytes_transferred = <span class="number">0</span>;</div><div class="line">        last_block = <span class="literal">NULL</span>;</div><div class="line">        last_offset = <span class="number">0</span>;</div><div class="line">        sort_ram_list();</div><div class="line"></div><div class="line">        <span class="comment">/* Make sure all dirty bits are set */</span></div><div class="line">        QLIST_FOREACH(block, &amp;ram_list.blocks, next) &#123;</div><div class="line">            <span class="keyword">for</span> (addr = <span class="number">0</span>; addr &lt; block-&gt;length; addr += TARGET_PAGE_SIZE) &#123;</div><div class="line">                <span class="keyword">if</span> (!memory_region_get_dirty(block-&gt;mr, addr, TARGET_PAGE_SIZE,</div><div class="line">                                             DIRTY_MEMORY_MIGRATION)) &#123;</div><div class="line">                    memory_region_set_dirty(block-&gt;mr, addr, TARGET_PAGE_SIZE);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        memory_global_dirty_log_start();</div><div class="line"></div><div class="line">        qemu_put_be64(f, ram_bytes_total() | RAM_SAVE_FLAG_MEM_SIZE);</div><div class="line"></div><div class="line">        QLIST_FOREACH(block, &amp;ram_list.blocks, next) &#123;</div><div class="line">            qemu_put_byte(f, <span class="built_in">strlen</span>(block-&gt;idstr));</div><div class="line">            qemu_put_buffer(f, (<span class="keyword">uint8_t</span> *)block-&gt;idstr, <span class="built_in">strlen</span>(block-&gt;idstr));</div><div class="line">            qemu_put_be64(f, block-&gt;length);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    bytes_transferred_last = bytes_transferred;</div><div class="line">    bwidth = qemu_get_clock_ns(rt_clock);</div><div class="line"></div><div class="line">    <span class="keyword">while</span> ((ret = qemu_file_rate_limit(f)) == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">int</span> bytes_sent;</div><div class="line"></div><div class="line">        bytes_sent = ram_save_block(f);</div><div class="line">        bytes_transferred += bytes_sent;</div><div class="line">        <span class="keyword">if</span> (bytes_sent == <span class="number">0</span>) &#123; <span class="comment">/* no more blocks */</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (ret &lt; <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    bwidth = qemu_get_clock_ns(rt_clock) - bwidth;</div><div class="line">    bwidth = (bytes_transferred - bytes_transferred_last) / bwidth;</div><div class="line"></div><div class="line">    <span class="comment">/* if we haven't transferred anything this round, force expected_time to a</span></div><div class="line">     * a very high value, but without crashing */</div><div class="line">    <span class="keyword">if</span> (bwidth == <span class="number">0</span>) &#123;</div><div class="line">        bwidth = <span class="number">0.000001</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/* try transferring iterative blocks of memory */</span></div><div class="line">    <span class="keyword">if</span> (stage == <span class="number">3</span>) &#123;</div><div class="line">        <span class="keyword">int</span> bytes_sent;</div><div class="line"></div><div class="line">        <span class="comment">/* flush all remaining blocks regardless of rate limiting */</span></div><div class="line">        <span class="keyword">while</span> ((bytes_sent = ram_save_block(f)) != <span class="number">0</span>) &#123;</div><div class="line">            bytes_transferred += bytes_sent;</div><div class="line">        &#125;</div><div class="line">        memory_global_dirty_log_stop();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    qemu_put_be64(f, RAM_SAVE_FLAG_EOS);</div><div class="line"></div><div class="line">    expected_time = ram_save_remaining() * TARGET_PAGE_SIZE / bwidth;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> (stage == <span class="number">2</span>) &amp;&amp; (expected_time &lt;= migrate_max_downtime());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>第一阶段，（14-42），代码所有的内存被标记为脏页并初始化页面更新追踪机制</li>
<li>第二阶段，（47-55），如果页面被标记为脏页，则传输这些页面，页面脏位被重置，如果有程序修改页面，页面的脏位又可设置。一般来说，第二阶段是迭代过程最长的</li>
<li>第三阶段，（71-79），那些修改过的却还没有来得及被传输到目的端的页面可以用来计算停机时间，设置一个目标停机时间，当达到这个值的时候，停止第二阶段的迭代过程，进入第三阶段，这时源虚拟机被暂停，将剩余的页面、CPU等状态一同传输到目的端，目的端再重新恢复虚拟机。</li>
</ul>
<p>pre-copy总体来说能带来很小的停机时间，但不太适合写密集型的负载，写密集型负载会大量更新页面，使得迭代过程结束后的剩余页面增多，延长停机时间。</p>
<p>下面再来看看post-copy算法</p>
<p>Post-copy算法的思想是先暂停源虚拟机，把能保证一次正常运行的最小运行集（所有的CPU状态）传输到目的端，目的端恢复虚拟机的执行，若需要内存页，则产生页错误，主动从源虚拟机中获取。Post-copy能保证尽可能的做到个内存也最多只传输一次，避免pre-copy算法迭代过程中的重复传输；由于不断地从源端获取丢失页，不可避免地带来性能损失。<a href="http://www.cs.binghamton.edu/~mhines/papers/vee2009.pdf" target="_blank" rel="external">VEE’09 Post-Copy Based Live Virtual Machine Migration Using Adaptive Pre-Paging and Dynamic Self-Ballooning</a> 利用了一种称之为<code>adaptive pre-paging</code>的方法来减少页错误，<code>adaptive pre-paging</code>能尽可能的预测出目的端下一个需要的页面，从而减少页面传输的次数。</p>
<h2 id="实现-Pre-copy"><a href="#实现-Pre-copy" class="headerlink" title="实现 Pre-copy"></a>实现 Pre-copy</h2><p>这一章节主要讲述KVM/Qemu关于Pre-copy迁移算法的实现，基于qemu-kvm-1.1.2版本。首先看一下源码中的hmp-commands.hx文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">    &#123;</div><div class="line">        .name       = &quot;migrate&quot;,</div><div class="line">        .args_type  = &quot;detach:-d,blk:-b,inc:-i,uri:s&quot;,</div><div class="line">        .params     = &quot;[-d] [-b] [-i] uri&quot;,</div><div class="line">        .help       = &quot;migrate to URI (using -d to not wait for completion)&quot;</div><div class="line">		      &quot;\n\t\t\t -b for migration without shared storage with&quot;</div><div class="line">		      &quot; full copy of disk\n\t\t\t -i for migration without &quot;</div><div class="line">		      &quot;shared storage with incremental copy of disk &quot;</div><div class="line">		      &quot;(base image shared between src and destination)&quot;,</div><div class="line">        .mhandler.cmd = hmp_migrate,</div><div class="line">    &#125;,</div><div class="line"></div><div class="line"></div><div class="line">STEXI</div><div class="line">@item migrate [-d] [-b] [-i] @var&#123;uri&#125;</div><div class="line">@findex migrate</div><div class="line">Migrate to @var&#123;uri&#125; (using -d to not wait for completion).</div><div class="line">	-b for migration with full copy of disk</div><div class="line">	-i for migration with incremental copy of disk (base image is shared)</div><div class="line">ETEXI</div></pre></td></tr></table></figure>
<p>每一个Qemu相关命令都需要在此文件中注册，如savevm,snapshot,migrate等，如果想自定义命令，亦是如此，关于如何修改KVM/Qemu源码，可以结合我的 <a href="http://www.chongh.wiki/blog/2016/01/01/kvm-qemu-bytalk/" target="_blank" rel="external">上一篇</a> 文章.</p>
<p>Qemu-kvm利用<code>hmp-commands.hx</code>这个文件保存相应的命令行参数以及常量，然后使用<code>hxtool</code>工具产生对应的头文件<code>hmp-commands.h</code>到<code>./x86_64-softmmu</code>文件夹中，这个过程自动进行。注，STEXI与ETEXI之间的内容属于注释内容。从代码中可看到，与迁移命令migrate相对应的处理函数是<code>hmp_migrate</code>,从<code>hmp_migrate</code>函数开始，会依次调用<code>qmp_migrate</code>,<code>tcp_start_outgoing_migration</code>,<code>migrate_fd_connect</code>, <code>migrate_fd_put_ready</code>,具体可看源码，不一一详细介绍。</p>
<p>重点说一下<code>migrate_fd_connect</code>函数与<code>migrate_fd_put_ready</code>函数，<br><code>migrate_fd_connect</code>函数主要调用了<code>qemu_savevm_state_begin</code>函数进行迁移工作的初始化工作（对应于前文说的迁移过程的第一阶段），而<code>migrate_fd_connect</code>函数主要调用了<code>qemu_savevm_state_iterate</code>函数（对应第二阶段）与<code>qemu_savevm_state_complete</code>函数（对应第三阶段），这里注意，此三个函数（<code>qemu_savevm_state_beging</code>,<code>qemu_savevm_state_iterate</code>,<code>qemu_savevm_state_complete</code>)里面代码结构非同类似，必有蹊跷，这里贴出其中的<code>qemu_savevm_state_iterate</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">qemu_savevm_state_iterate</span><span class="params">(QEMUFile *f)</span></span></div><div class="line">&#123;</div><div class="line">    SaveStateEntry *se;</div><div class="line">    <span class="keyword">int</span> ret = <span class="number">1</span>;</div><div class="line"></div><div class="line">    QTAILQ_FOREACH(se, &amp;savevm_handlers, entry) &#123;</div><div class="line">        <span class="keyword">if</span> (se-&gt;save_live_state == <span class="literal">NULL</span>)</div><div class="line">            <span class="keyword">continue</span>;</div><div class="line"></div><div class="line">        <span class="comment">/* Section type */</span></div><div class="line">        qemu_put_byte(f, QEMU_VM_SECTION_PART);</div><div class="line">        qemu_put_be32(f, se-&gt;section_id);</div><div class="line"></div><div class="line">        ret = se-&gt;save_live_state(f, QEMU_VM_SECTION_PART, se-&gt;opaque);</div><div class="line">        <span class="keyword">if</span> (ret &lt;= <span class="number">0</span>) &#123;</div><div class="line">            <span class="comment">/* Do not proceed to the next vmstate before this one reported</span></div><div class="line">               completion of the current stage. This serializes the migration</div><div class="line">               and reduces the probability that a faster changing state is</div><div class="line">               synchronized over and over again. */</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">return</span> ret;</div><div class="line">    &#125;</div><div class="line">    ret = qemu_file_get_error(f);</div><div class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</div><div class="line">        qemu_savevm_state_cancel(f);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>三个函数都会有一句代码</p>
<pre><code>ret = se-&gt;save_live_state(f, QEMU_VM_SECTION_PART, se-&gt;opaque); 
</code></pre><p>只是其中参数不同。</p>
<p>这个save_live_state是什么？</p>
<p>注意，非常重要，存在于虚拟机迁移的核心结构体SaveStateEntry中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> SaveStateEntry &#123;</div><div class="line">    QTAILQ_ENTRY(SaveStateEntry) entry;</div><div class="line">    <span class="keyword">char</span> idstr[<span class="number">256</span>];</div><div class="line">    <span class="keyword">int</span> instance_id;</div><div class="line">    <span class="keyword">int</span> alias_id;</div><div class="line">    <span class="keyword">int</span> version_id;</div><div class="line">    <span class="keyword">int</span> section_id;</div><div class="line">    SaveSetParamsHandler *set_params;</div><div class="line">    SaveLiveStateHandler *save_live_state;</div><div class="line">    SaveStateHandler *save_state;</div><div class="line">    LoadStateHandler *load_state;</div><div class="line">    <span class="keyword">const</span> VMStateDescription *vmsd;</div><div class="line">    <span class="keyword">void</span> *opaque;</div><div class="line">    CompatEntry *compat;</div><div class="line">    <span class="keyword">int</span> no_migrate;</div><div class="line">    <span class="keyword">int</span> is_ram;</div><div class="line">&#125; SaveStateEntry;</div></pre></td></tr></table></figure>
<p>此结构体存储了虚拟机迁移的用到的所有数据结构，主要包括被传输设备的存储格式以及被调用的具体设备的迁移功能函数. 那指针 <code>*save_live_state</code> 到底做了什么，一一追踪可发现，在<code>vl.c</code>文件中的main函数中（整个qemu程序的开始),针对ram设备，可发现如下一段代码：</p>
<pre><code>register_savevm_live(NULL, &quot;ram&quot;, 0, 4, NULL, ram_save_live, NULL, ram_load, NULL);
</code></pre><p>正是<code>register_savem_live</code>函数将<code>ram_save_live</code>指针传递给了<code>save_live_state</code>，前文说了，<code>ram_save_live</code>便是真正执行迁移工作的函数，这里如果需要自定义迁移工作，修改<code>ram_save_live</code>注册到<code>register_savevm_live</code>函数中就行了。了解清楚这一连串的函数调用关系，便能彻底明白迁移的每一步工作。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>本文重点介绍了pre-copy迁移算法的详细过程，并简单介绍了post-copy算法，两个算法各有优缺点，也都各有改进之处。虚拟机迁移的初衷是保证云平台的高可用性，高可用性要尽量减少提供服务的云主机的宕机时间即停机时间，在此同时，也应尽量减少迁移过程中带来的性能开销，就像post-copy若不断的缺页，虽保证了极短的宕机时间，但如果性能损失太大也是无法接受的。目前多数优化迁移算法的工作主要是采取减少传输的内存数据量来实现，而为了减少内存数据量，又有：</p>
<ul>
<li>压缩内存</li>
<li>基于hash指纹找出相同或类似页面去重</li>
<li>尽可能传输不必要的页面如free页面等</li>
</ul>
<p>除此之外，也有工作不传输整个内存页面，而是传输内存页面到外部设备的映射关系，目的端则靠此映射关系从外设获取数据。这里不一一列出相关论文，若有兴趣深入者，可自行查阅。笔者也有一部分工作提出了相应的思路与实现，之后会有专门文章作详细介绍。</p>
<p>如果你对迁移算法的优化有什么看法或什么建议，可留言，也可直接与我邮件联系。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>崔磊先生的博士论文</p>
<p><a href="https://www.usenix.org/legacy/event/nsdi05/tech/full_papers/clark/clark.pdf" target="_blank" rel="external">NSDI’05 Live Migration of Virtual Machines</a></p>
<p><a href="http://www.cs.binghamton.edu/~mhines/papers/vee2009.pdf" target="_blank" rel="external">VEE’09 Post-Copy Based Live Virtual Machine Migration Using Adaptive Pre-Paging and Dynamic Self-Ballooning</a> </p>
<hr>
<p><strong>CSysSec注</strong>： 本文来自<a href="http://www.chongh.wiki/about/" target="_blank" rel="external">Diting0x</a>的<a href="http://www.chongh.wiki/blog/2016/01/03/highavailability-migration/" target="_blank" rel="external">个人博客</a>，主要介绍虚拟机迁移技术，包括虚拟机迁移主要算法以及在KVM/QEMU平台上的迁移细节。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170224/migration/" target="_blank" rel="external">云平台高可用之虚拟机迁移</a>》与作者信息：<a href="http://weibo.com/diting0x" target="_blank" rel="external">Diting0x</a></p>
<hr>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/虚拟机迁移/">虚拟机迁移<span class="article-category-count">3</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KVM/">KVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Migration/">Migration</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QEMU/">QEMU</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Virtualization/">Virtualization</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-course-byoungyounglee1"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170223/course-byoungyounglee1/">名人课堂-安全与可信系统</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170223/course-byoungyounglee1/" class="article-date">
	  <time datetime="2017-02-23T09:13:05.000Z" itemprop="datePublished">二月 23, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>CSysSec注</strong>： 本系列文章在于收集知名海外教授在计算机系统与安全领域的授课信息，会包含课程详细信息以及slides。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/course-byoungyounglee1/" target="_blank" rel="external">安全与可信系统</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<p>来源：<a href="https://lifeasageek.github.io/class/cs590-sts/" target="_blank" rel="external">https://lifeasageek.github.io/class/cs590-sts/</a></p>
<h3 id="教授"><a href="#教授" class="headerlink" title="教授"></a>教授</h3><p><a href="http://www.csyssec.org/20170224/byoungyounglee/" target="_blank" rel="external">Byongyong Lee</a> </p>
<h3 id="课程简介"><a href="#课程简介" class="headerlink" title="课程简介"></a>课程简介</h3><p>This course focuses on studying security techniques for trusted computing systems. The course starts with discussing software/system security fundamentals and principals for designing and building trusted computing systems. Then we study comprehensive security oriented hardenning techniques for trusted computing platforms as well as promising new services and applications. Lastly we will cover possible attacks and defenses against trusted computing systems.</p>
<p>The course will be mostly based on research papers. Each lecture will cover one research paper, and each student is expected to present a few research papers (one or two) throughout the semester. In order to facilitate discussion, all students are strongly encouraged to read the paper before the class and actively participate the in-class discussion. Students are also required to pick the research topic related to the class, and perform their own research project.</p>
<pre><code>Instructor : Byoungyoung Lee 
Lecture: 4:30 pm - 5:45 pm (Tue &amp; Thr) at Lawson B134
Office hour: 3:30 pm - 4:30 pm (Tue &amp; Thr) at LWSN 1187
</code></pre><h3 id="课程安排"><a href="#课程安排" class="headerlink" title="课程安排"></a>课程安排</h3><table>
<thead>
<tr>
<th style="text-align:left">Date</th>
<th style="text-align:left">Topic</th>
<th style="text-align:left">Paper</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">01/10</td>
<td style="text-align:left">Introduction online meetup</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">01/12</td>
<td style="text-align:left">No class travel</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">01/17</td>
<td style="text-align:left">Introduction</td>
<td style="text-align:left">Intro. on trusted computing (1)    </td>
</tr>
<tr>
<td style="text-align:left">01/19</td>
<td style="text-align:left">Introduction</td>
<td style="text-align:left">Intro. on trusted computing (2) </td>
</tr>
<tr>
<td style="text-align:left">01/24</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">AEGIS [ICS 03]</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">01/26</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">SecVisor [SOSP 07]    </td>
</tr>
<tr>
<td style="text-align:left">01/31</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">OverShadow [ASPLOS 08]</td>
</tr>
<tr>
<td style="text-align:left">02/02</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">Flicker [EuroSys 08]</td>
</tr>
<tr>
<td style="text-align:left">02/07</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">TrustVisor [SP 10]    </td>
</tr>
<tr>
<td style="text-align:left">02/09</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">TrustZone-TLR [ASPLOS 14]    </td>
</tr>
<tr>
<td style="text-align:left">02/14</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Haven [OSDI 14]</td>
</tr>
<tr>
<td style="text-align:left">02/16</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">No class    </td>
</tr>
<tr>
<td style="text-align:left">02/21</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">A2C [NDSS 17] (practice talk)    </td>
</tr>
<tr>
<td style="text-align:left">02/21</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Graphene [EuroSys 14] (makeup)</td>
</tr>
<tr>
<td style="text-align:left">02/23</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">VC3 [SP 15]    </td>
</tr>
<tr>
<td style="text-align:left">02/23</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Ryoan [OSDI 16] (makeup)</td>
</tr>
<tr>
<td style="text-align:left">02/28</td>
<td style="text-align:left">-    No class (NDSS travel)    </td>
</tr>
<tr>
<td style="text-align:left">03/02</td>
<td style="text-align:left">-    No class (NDSS travel)    </td>
</tr>
<tr>
<td style="text-align:left">03/07</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">MiniBox [ATC 14]</td>
</tr>
<tr>
<td style="text-align:left">03/07</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">CyprtDB [SOSP 11] (makeup)    </td>
</tr>
<tr>
<td style="text-align:left">03/09</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Scone [OSDI 16]    </td>
</tr>
<tr>
<td style="text-align:left">03/14</td>
<td style="text-align:left">-    No class (Spring break)    </td>
</tr>
<tr>
<td style="text-align:left">03/16</td>
<td style="text-align:left">-    No class (Spring break)    </td>
</tr>
<tr>
<td style="text-align:left">03/21</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">BlindBox [SIGCOMM 15]</td>
</tr>
<tr>
<td style="text-align:left">03/23</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">Embark [NSDI 16]    </td>
</tr>
<tr>
<td style="text-align:left">03/28</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">Secure Mylar [NSDI 14]</td>
</tr>
<tr>
<td style="text-align:left">03/30</td>
<td style="text-align:left">Securing access patterns</td>
<td style="text-align:left">Path ORAM [CCS 13]    </td>
</tr>
<tr>
<td style="text-align:left">04/04</td>
<td style="text-align:left">Securing access patterns</td>
<td style="text-align:left">Raccoon [SEC 15]    </td>
</tr>
<tr>
<td style="text-align:left">04/06</td>
<td style="text-align:left">Securing access patterns</td>
<td style="text-align:left">Oblivious multi-party ML [SEC 16]    </td>
</tr>
<tr>
<td style="text-align:left">04/11</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">Iago Attacks [ASPLOS 13]    </td>
</tr>
<tr>
<td style="text-align:left">04/13</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">Controlled-channel attacks [SP 15]    </td>
</tr>
<tr>
<td style="text-align:left">04/18</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">Memoir [SP 11]    </td>
</tr>
<tr>
<td style="text-align:left">04/20</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">StealthMem [SEC 12]</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">04/25</td>
<td style="text-align:left">-    Final presentation    </td>
</tr>
<tr>
<td style="text-align:left">04/27</td>
<td style="text-align:left">-    Final presentation</td>
</tr>
</tbody>
</table>
<h3 id="完整论文阅读列表"><a href="#完整论文阅读列表" class="headerlink" title="完整论文阅读列表"></a>完整论文阅读列表</h3><ul>
<li>Toward trusted computing<ul>
<li>(XOM) Architectural Support for Copy and Tamper Resistant Software [ASPLOS 00] </li>
<li>AEGIS: architecture for tamper-evident and tamper-resistant processing [ICS 03] </li>
<li>SecVisor: a tiny hypervisor to provide lifetime kernel code integrity for commodity OSes [SOSP 07] </li>
<li>Overshadow: a virtualization-based approach to retrofitting protection in commodity operating systems [ASPLOS 08] </li>
<li>InkTag: secure applications on an untrusted operating system [ASPLOS 13] </li>
<li>Flicker: An execution infrastructure for TCB minimization [EuroSys 08]</li>
<li>TrustVisor: Efficient TCB reduction and attestation [SP 10] </li>
<li>(TrustZone-TLR) Using ARM TrustZone to Build a Trusted Language Runtime for Mobile Applications [ASPLOS 14] </li>
</ul>
</li>
<li>SandBox/Containers for trusted computing<ul>
<li>MiniBox: A two-way sandbox for x86 native code [ATC 14] </li>
<li>VC3: trustworthy data analytics in the cloud using SGX [SP 15] </li>
<li>Ryoan: A Distributed Sandbox for Untrusted Computation on Secret Data [OSDI 16] </li>
<li>(Graphene) Cooperation and Security Isolation of Library OSes for Multi-Process Applications [EuroSys 14] </li>
<li>SCONE: Secure Linux Containers with Intel SGX [OSDI 16] </li>
<li>Shielding Applications from an Untrusted Cloud with Haven [OSDI 14] </li>
</ul>
</li>
<li>Trusted Services<ul>
<li>Secure Untrusted Data Repository (SUNDR) [OSDI 04] </li>
<li>CryptDB: protecting confidentiality with encrypted query processing [SOSP 11] </li>
<li>BlindBox: Deep packet inspection over encrypted traffic [SIGCOMM 15] </li>
<li>Embark: Securely Outsourcing Middleboxes to the Cloud [NSDI 16] </li>
<li>Building web applications on top of encrypted data using Mylar [NSDI 14] </li>
</ul>
</li>
<li>Securing access patterns<ul>
<li>Path ORAM: An Extremely Simple Oblivious RAM Protocol [CCS 13] </li>
<li>Raccoon: Closing Digital Side-Channels through Obfuscated Execution [SEC 15] </li>
<li>Oblivious multi-party machine learning on trusted processors [SEC 16] </li>
</ul>
</li>
<li>Attacks and defenses<ul>
<li>Iago attacks: why the system call API is a bad untrusted RPC interface [ASPLOS 13] </li>
<li>Controlled-channel attacks: Deterministic side channels for untrusted operating systems [SP 15] </li>
<li>Memoir: Practical state continuity for protected modules [SP 11] </li>
<li>STEALTHMEM: System-Level Protection Against Cache-Based Side Channel Attacks in the Cloud [SEC 12] </li>
<li>Drammer: Deterministic Rowhammer Attacks on Mobile Platforms [CCS 16] </li>
</ul>
</li>
<li>Papers to appear<ul>
<li>Enhancing Security and Privacy of Tor’s Ecosystem by using Trusted Execution Environments [NSDI 17]</li>
<li>SGX-Shield: Enabling Address Space Layout Randomization for SGX Programs [NDSS 17]</li>
<li>T-SGX: Eradicating Controlled-Channel Attacks Against Enclave Programs [NDSS 17]</li>
<li>Panoply: Low-TCB Linux Applications With SGX Enclaves [NDSS 17]</li>
<li>BOOMERANG: Exploiting the Semantic Gap in Trusted Execution Environments [NDSS 17]</li>
<li>ObliviSync: Practical Oblivious File Backup and Synchronization [NDSS 17]</li>
</ul>
</li>
</ul>
<hr>
<p><strong>CSysSec注</strong>： 本系列文章在于收集知名海外教授在计算机系统与安全领域的授课信息，会包含课程详细信息以及slides。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/course-byoungyounglee1/" target="_blank" rel="external">安全与可信的系统</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/名人课堂/">名人课堂<span class="article-category-count">5</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Course/">Course</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Professor/">Professor</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-obfuscation1"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170223/obfuscation1/">X86 Shellcode代码混淆(一)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170223/obfuscation1/" class="article-date">
	  <time datetime="2017-02-23T08:03:26.000Z" itemprop="datePublished">二月 23, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>来源： <a href="https://breakdev.org/" target="_blank" rel="external">https://breakdev.org/</a><br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/obfuscation1/" target="_blank" rel="external">X86 shellcode代码混淆</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<p>为了了解开发一个可以接受所有二进制x86 shellcode的工具并且由此形成独一无二的版本，我决定在shellcode混淆问题上做些研究。</p>
<p>值得一提的是这种工具尤其当填充数据代码需要储存在磁盘中时在脚本中最为实用（比如嵌入在可执行文件中）。易混淆的填充数据会扩大是我们不太愿意看到的结果，尤其当这类工具被嵌入到利用有效载荷时首选的是小型shellcode。</p>
<p>存在shellcode混淆的主要原因是由IDS或AV产品执行的静态或运行时间签名探测。以[Metasploit][<a href="https://www.metasploit.com/]为例，它的利用有效载荷已经公开很多年，至今为止最主流IDS/AV解决方案能够通过搜索它们关于恶意软件签名的庞大数据库来检测它们。" target="_blank" rel="external">https://www.metasploit.com/]为例，它的利用有效载荷已经公开很多年，至今为止最主流IDS/AV解决方案能够通过搜索它们关于恶意软件签名的庞大数据库来检测它们。</a></p>
<p>为了避免被检测出而手动修改或从头开始编写新的shellcodes是一个无限的工作，而且长远来讲很浪费时间。我所关注的将是编写一个可以接受所有二进制形式的shellcode的工具，它可以修改指令同时保留其功能，但代码会变得特殊而更难分析。</p>
<p>我需要在这里说明，这篇文章不会包含通过行为分析或应用于不同安全产品的代码仿真的内容。</p>
<p>有些人会说有一种方式可以让shellcode绕过签名检测方法——使用[Shikata Ga Nai][<a href="https://www.exploit-db.com/docs/18532.pdf]编码器。shellcode密码本身在运行时间利用亦或，这意味着shellcode所在的存储区应是**可写的**，但常常并不是这样。这种方法在安全软件的代码仿真中也不能幸免于运行签名。" target="_blank" rel="external">https://www.exploit-db.com/docs/18532.pdf]编码器。shellcode密码本身在运行时间利用亦或，这意味着shellcode所在的存储区应是**可写的**，但常常并不是这样。这种方法在安全软件的代码仿真中也不能幸免于运行签名。</a></p>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>每个shellcode为能在所有存储单元运行来编写的。这意味着所有转移或储存参量都与它的当前位置有关，并没有固定的存储位置。</p>
<p>当然也有以下例外，直接来自Metasploit的有效载荷之一：</p>
<pre><code>66 0000008d:5d               POP EBP
67 0000008e:6a01             PUSH 0x1
68 00000090:8d85b2000000     LEA EAX,[EBP+0xb2];&lt;--fixed offset that willbreak things when we insert code after this line!
69 00000096:50               PUSH EAX
70 00000097:68318b6f87       PUSH DWORD 0x876f8b31
71 0000009c:ffd5             CALL EBP
</code></pre><p>为了产生混淆代码，这个工具需要以下条件：</p>
<ul>
<li>能够在现有指令的前、后或其间插入新的指令</li>
<li>能够在添加或删去指令时修订相对跳转偏移</li>
<li>能够用可替换指令替代已存在的指令以确定没有静态数据被落下，这些数据会协助检测签名的创写</li>
<li>能够嵌入可以改变执行流并随机把shellcode分配到不同码块的跳转指令</li>
</ul>
<p>第一条并不是那么难达到，不过也有陷阱，所有调用/跳转指令指向相对内存位置，这就像“<em>从这个指令向前或向后跳转X字节</em>”。这就是说，如果我们在跳转指令和它的目标之间插入任何字节，相对跳转偏移会被我们插入的字节数修正掉。</p>
<p>第二条包括：在shellcode中跟踪记录所有相对跳转，还有每当我们在跳转偏移的开始和目标之间增加或删减代码数据时调整跳转偏移。</p>
<p>第三条需要适当反编译指令的正确指纹并在保留原有功能的前提下把他们重创为不同的指令。</p>
<p>第四条要求会允许改变shellcode的执行流，把它分配到不同的码块，完全改变顺序，指令按初始放置。</p>
<h3 id="修正跳转"><a href="#修正跳转" class="headerlink" title="修正跳转"></a>修正跳转</h3><hr>
<p>你可能会觉得在这时修正跳转指令不应该那么难了，我们只需要调整相对存储偏移就好。问题是，跳转可能<code>近</code><br>可能<code>远</code>，短跳转存储偏移有<code>1字节</code>那么大而远的就有<code>4字节</code>。我们来看一个例子，存储在<code>401000</code>储存位置的<code>jnz 401020</code>指令：</p>
<p>近跳转：<code>00401000: 75 1E</code><br><code>75</code>- <strong>JNZ</strong> 操作码<br><code>1E</code>-向前跳转<strong>OX1E</strong>字节（<code>0x401020 - 0x401000 - instruction length [2 bytes])</code>）</p>
<p>远跳转：<code>00401000: 0F 85 1A 00 00 00</code><br><code>0F 85</code>- <strong>JNZ</strong> 操作码<br><code>1A 00 00 00</code>-向前跳转<strong>OX1A</strong>字节（<code>0x401020 - 0x401000 - instruction length [4 bytes])</code>）</p>
<p>正如你所看到的，这两种指令都执行相同的操作，却在编写上有所不同。并且与指令并用的相对存储偏移也受指令长度本身的影响。这一点需要牢记于心。</p>
<p>现在让我们来看看以下的代码：</p>
<pre><code>00401000: 75 7E : jnz 00401080  
...
00401080: 90 : nop
</code></pre><p><strong>JNZ</strong>指令是<code>75 7E</code>,但如果我们把4字节插入到<code>00401000</code>与<code>00401080</code>地址之间呢？合理的做法是增加4个相对存储偏移，变成<code>75 82</code>. 来看一下修正后的指令：</p>
<pre><code>00401000: 75 82 : jnz 00400F84  
...
-- added 4 bytes --
...
00401084: nop  
</code></pre><p>现在指令向后跳转吗？是的。短跳转的相对存储偏移是值在<strong>-128</strong>到<strong>127</strong>之间的<code>1符号字节</code>。<code>0x82</code>在这个例子中实际上被当作<strong>-126</strong>.</p>
<p>当插入字节时我们需要非常小心。这个工具同样需要检测指令是否需要从<code>短</code>转成<code>长</code>。从先前例子中进行正确的跳转修订如下：</p>
<pre><code>00401000: 0F 85 7E 00 00 00 : jnz 00401084  
...
-- added 4 bytes --
...
00401084: nop  
</code></pre><p>每次插入字节时，这个工具需要找到受影响的跳转指令并检测修订相对地址是否也包括替代有着更长替代的受影响的跳转指令。</p>
<p>遗憾的是还有另一个并发症需要处理。</p>
<h2 id="问题跳转"><a href="#问题跳转" class="headerlink" title="问题跳转"></a>问题跳转</h2><p>一些操作短记忆偏移指令没有它们的长替代，意思就是在这种情况下不容易用另一个替代一个指令。相反，为了正确地处理这些指令，我们需要用多个其他指令替代这一个同时保留原有指令的功能。</p>
<p>问题指令包括：<code>LOOP</code>，<code>JECXZ</code>,<code>LOOPNZ</code>,<code>LOOPZ</code></p>
<p>好在我从Randall Hyde的《[汇编语言程序设计的艺术][<a href="https://courses.engr.illinois.edu/ece390/books/artofasm/CH06/CH06-5.html]》找到了一个非常有用的章节，这本书涵盖了上述指令的替代：" target="_blank" rel="external">https://courses.engr.illinois.edu/ece390/books/artofasm/CH06/CH06-5.html]》找到了一个非常有用的章节，这本书涵盖了上述指令的替代：</a></p>
<p><strong>JECXZ</strong></p>
<pre><code>jecxz Target 
</code></pre><p>   变成：</p>
<pre><code>test ecx, ecx        ;Sets the zero flag if ecx=0  
jz Target  
</code></pre><p><strong>LOOP</strong></p>
<pre><code>loop Target  
</code></pre><p>   变成：</p>
<pre><code>dec ecx  
jnz Target 
</code></pre><p><strong>LOOPNZ/LOOPZ</strong></p>
<pre><code>loopnz/loopz Target  
</code></pre><p>   变成：</p>
<pre><code>  jnz/jz quit
  dec ecx
  jz quit2
  jmp Target
quit:  
  dec ecx
quit2:  
</code></pre><p>在混淆工具中，为了避免后续问题，我决定用在开头的长替代代替问题指令。</p>
<h2 id="数据分组"><a href="#数据分组" class="headerlink" title="数据分组"></a>数据分组</h2><p>大多shellcodes嵌入一些不是代码的二进制数据形式。着可能是一个用于执行的命令，用于IP地址连接到反向壳或者是其他任何不应该被看作代码的东西。让反汇编程序分辨代码和数据是不可能的。</p>
<p>在我们让工具执行任何代码混淆之前，我们需要有让用户列举真正代码指令所在的能力并让工具把其他看作可以在混淆过程中被跳过的数据。</p>
<h2 id="混淆"><a href="#混淆" class="headerlink" title="混淆"></a>混淆</h2><p>现在，有趣的部分开始了。</p>
<p>这个工具可以正确解析反汇编代码。它可以插入并删除指令在这同时修改可能在该过程中被影响相对跳转。现在逝世后让这个工具做真正的工作并用随机而独特的等效物。</p>
<p>我们越支持不同指令，输出的shellcode就会更加独特。</p>
<p>我会从单个指令开始，在之后的部分慢慢加入更多指令。</p>
<p><strong>MOV REG， IMM</strong><br>（将直接静态值移动到寄存器）</p>
<p>例如：</p>
<pre><code>B8 EF BE AD DE   : MOV EAX, 0xDEADBEEF  
66 BA FE CA      : MOV DX, 0xCAFE  
B1 77            : MOV CL, 0x77  
</code></pre><p>这是最简单的指令之一，但是如果我们不替代这些，它会成为写出检测shellcode有效签名的信息来源。</p>
<p>在这里我不会十分详细地深入讲述x86指令是如何编码的。如果你想要（也应该）更深入的学习，你可以在以下的链接中找到有用的信息。<br>[x86 Instruction Encoding Revealed: Bit Twiddling for Fun and Profit][<a href="https://www.codeproject.com/articles/662301/x-instruction-encoding-revealed-bit-twiddling-fo" target="_blank" rel="external">https://www.codeproject.com/articles/662301/x-instruction-encoding-revealed-bit-twiddling-fo</a>]<br>[Encoding Real x86 Instructions][<a href="http://www.c-jump.com/CIS77/CPU/x86/lecture.html" target="_blank" rel="external">http://www.c-jump.com/CIS77/CPU/x86/lecture.html</a>]<br>[X86 Opcode and Instruction Reference][<a href="http://ref.x86asm.net/coder32.html" target="_blank" rel="external">http://ref.x86asm.net/coder32.html</a>]<br><strong>MOV R16/32, IMM16/32</strong>指令由<code>0xB8</code>操作码开始。伴随指令使用的寄存器值保存在操作码的<strong>最低 3 bits</strong>.</p>
<p>寄存器值如下：</p>
<pre><code>EAX/AX/AL : 000b / 00h  
ECX/CX/CL : 001b / 01h  
EDX/DX/DL : 010b / 02h  
EBX/BX/BL : 011b / 03h  
ESP/SP/AH : 100b / 04h  
EBP/BP/CH : 101b / 05h  
ESI/SI/DH : 110b / 06h  
EDI/DI/BH : 111b / 07h  
</code></pre><p>为了用我们想要的寄存器形成操作码值，我们需要在操作码初始值中加入寄存器值（<code>OxB8</code>）.</p>
<pre><code>B8 44 33 22 11 : MOV EAX, 11223344h  
BA 44 33 22 11 : MOV EDX, 11223344h  
</code></pre><p>如果我们想使用16-bit而不是32-bit的寄存器和值，技巧是在操作码之前加入<code>0x66</code>字节的前缀。</p>
<pre><code>66 B8 22 11 : MOV AX, 1122h  
66 BA 22 11 : MOV DX, 1122h  
</code></pre><p><strong>MOV R8, IMM8</strong>与前面的类似。唯一的不同是这个操作码的初始值是<code>0xB0</code>.</p>
<pre><code>B0 11 : MOV AL, 11h  
B2 11 : MOV DL, 11h  
</code></pre><p>总的来讲，为了正确的检测<strong>MOV REG, IMM</strong>指令，我们需要寻找由<code>0xB0</code>到<code>0xBF</code>字节范围的操作码并且也要记住第一个字节可能由<code>0x66</code>做前缀，指令在16-bit模式下。</p>
<p>我们将会把每个指令转化成几个能够执行原始立即值运算的几个<strong>ADD,SUB</strong>or<strong>XOR</strong>指令。</p>
<p>以下是这个混淆的具体例子：</p>
<p>前：</p>
<pre><code>B8 44 33 22 11 : MOV EAX, 0x11223344 
</code></pre><p>后：</p>
<pre><code>BA 38 2C 30 A2    : MOV EDX, 0xA2302C38  
81 C2 BD 85 4F D8 : ADD EDX, 0xD84F85BD  
81 EA E0 5C 59 BF : SUB EDX, 0xBF595CE0  
81 F2 1C 9A 82 23 : XOR EDX, 0x23829A1C  
81 F2 4D FC 86 89 : XOR EDX, 0x8986FC4D  
</code></pre><p>得到：</p>
<pre><code>EDX = 0xA2302C38 + 0xD84F85BD - 0xBF595CE0 ^ 0x23829A1C ^ 0x8986FC4D = 0x11223344
</code></pre><p>你可以看到这个指令现在已经完全不同了，但是仍然在前一指令执行后，<strong>EDX</strong>会以<code>0x11223344</code>为初始值。我们可以产生很多想要的运算指令。</p>
<h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><p>考虑到为让便于更多读者尝试，我决定在Python中写这个工具。尽管我自己进行了一点简单的拆装来对几个指令类型采指纹，我需要一个可以对每个拆卸了的指令长度的全面反汇编程序字典。</p>
<p>为此，我用吉尔·达巴赫(Gil Dabah)所写的[diStorm3][<a href="https://breakdev.org/x86-shellcode-obfuscation-part-1/]反汇编程序字典，它快而好用。我认为用[Capstone][http://www.capstone-engine.org/]有点大材小用。" target="_blank" rel="external">https://breakdev.org/x86-shellcode-obfuscation-part-1/]反汇编程序字典，它快而好用。我认为用[Capstone][http://www.capstone-engine.org/]有点大材小用。</a></p>
<p>现在这个工具的版本只在<strong>MOV REG,IMM</strong>指令产生混淆，但即将支持更多的指令。</p>
<p>以下是无用shellcode的例子，为方便检测，我准备展示一下它的混淆：</p>
<p>输入：</p>
<pre><code>0    00000000: fc                               CLD  
1    00000001: b105                             MOV CL, 0x5  
2    00000003: 80fc02                           CMP AH, 0x2  
3    00000006: 7504                             JNZ 0xc  
4    00000008: 66b88888                         MOV AX, 0x8888  
5    0000000c: ba44332211                       MOV EDX, 0x11223344  
6    00000011: e2f9                             LOOP 0xc 
</code></pre><p>输出：</p>
<pre><code>0    00000000: fc                               CLD  
1    00000001: b1a2                             MOV CL, 0xa2  
2    00000003: 82c1c4                           ADD CL, 0xc4  
3    00000006: 82e961                           SUB CL, 0x61  
4    00000009: 80fc02                           CMP AH, 0x2  
5    0000000c: 7518                             JNZ 0x26  
6    0000000e: 66b80596                         MOV AX, 0x9605  
7    00000012: 6681c0ce9a                       ADD AX, 0x9ace  
8    00000017: 6681c0a039                       ADD AX, 0x39a0  
9    0000001c: 6681f04371                       XOR AX, 0x7143  
10   00000021: 6681c0886d                       ADD AX, 0x6d88  
11   00000026: ba44351577                       MOV EDX, 0x77153544  
12   0000002b: 81f2fbd13236                     XOR EDX, 0x3632d1fb  
13   00000031: 81f299f2d3ed                     XOR EDX, 0xedd3f299  
14   00000037: 81c22c9ffb09                     ADD EDX, 0x9fb9f2c  
15   0000003d: 81eae2468266                     SUB EDX, 0x668246e2  
16   00000043: 81f2345d4f41                     XOR EDX, 0x414f5d34  
17   00000049: 49                               DEC ECX  
18   0000004a: 75da                             JNZ 0x26
</code></pre><p>源代码在[GitHub][<a href="https://github.com/kgretzky/python-x86-obfuscator]上都可以找到。" target="_blank" rel="external">https://github.com/kgretzky/python-x86-obfuscator]上都可以找到。</a><br><strong>下载DOWNLODAD</strong><br>[Source code][<a href="https://github.com/kgretzky/python-x86-obfuscator" target="_blank" rel="external">https://github.com/kgretzky/python-x86-obfuscator</a>]</p>
<p><strong>未完待续…</strong><br>这个博客系列的第一部分就结束了。接下来的部分会涵盖其他指令的混淆问题。</p>
<p>敬请期待！</p>
<p>你可以在[Twitter][<a href="https://twitter.com/mrgretzky]和[Google+][https://plus.google.com/u/0/101650735283323618463/]上关注我。" target="_blank" rel="external">https://twitter.com/mrgretzky]和[Google+][https://plus.google.com/u/0/101650735283323618463/]上关注我。</a></p>
<p>如果你有什么问题或建议，期待你在评论区评论。</p>
<p><strong>第二部分</strong>已发布！</p>
<p>[X86 Shellcode 混淆 - 第二部分][<a href="http://www.csyssec.org/20170223/obfuscation1/" target="_blank" rel="external">http://www.csyssec.org/20170223/obfuscation1/</a>]</p>
<p><strong>完</strong></p>
<hr>
<p>来源： <a href="https://breakdev.org/" target="_blank" rel="external">https://breakdev.org/</a><br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/obfuscation1/" target="_blank" rel="external">X86 shellcode代码混淆</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/漏洞利用/">漏洞利用<span class="article-category-count">14</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shellcode/">Shellcode</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-mallocsystemcall"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170105/mallocsystemcall/">Malloc使用的系统调用</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170105/mallocsystemcall/" class="article-date">
	  <time datetime="2017-01-05T03:07:05.000Z" itemprop="datePublished">一月 5, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>译者：资深工程师@Barret</p>
<hr>
<p><strong>CSysSec注</strong>： 本系列文章译自安全自由工作者<a href="https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/" target="_blank" rel="external">Sploitfun</a>的漏洞利用系列博客，从经典栈缓冲区漏洞利用堆漏洞利用，循序渐进，是初学者不可多得的好材料，本系列所有文章涉及的源码可以在<a href="https://github.com/sploitfun/lsploits" target="_blank" rel="external">这里</a>找到。CSysSec计划在原基础上不断添加相关漏洞利用技术以及相应的Mitigation方法，欢迎推荐或自荐文章。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170105/mallocsystemcall" target="_blank" rel="external">Linux(X86)漏洞利用系列-Malloc使用的系统调用</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 brk</li>
<li>0X02 mmap</li>
</ul>
</blockquote>
<p>学到这里，你应该已经知道malloc是使用系统调用从操作系统获取内存，正如下图所示，malloc是使用<a href="http://man7.org/linux/man-pages/man2/sbrk.2.html" target="_blank" rel="external">brk</a>或者<a href="http://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="external">mmap</a>系统调用来获得内存分配的。</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/mallocsystemcall1.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/mallocsystemcall1.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<h3 id="0X01-brk"><a href="#0X01-brk" class="headerlink" title="0X01 brk"></a>0X01 brk</h3><p><a href="http://lxr.free-electrons.com/source/mm/mmap.c?v=3.8#L252" target="_blank" rel="external">brk</a>通过增加程序中断位置(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L365" target="_blank" rel="external">brk</a>)从内核中获取内存（初始化非0）。一开始堆段的起始(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L365" target="_blank" rel="external">start_brk</a>)和结束(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L365" target="_blank" rel="external">brk</a>)都指向同一位置。</p>
<blockquote>
<ul>
<li>当<a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" target="_blank" rel="external">ASLR</a>关闭时，start_brk和brk将指向数据段(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L364" target="_blank" rel="external">end_data</a>)的末尾</li>
<li>当ASLR打开时，start_brk和brk指向的位置即为数据段(end_data)的末尾地址加上随机brk偏移地址所指向的位置</li>
</ul>
</blockquote>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/mallocsystemcall2.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/mallocsystemcall2.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>由上图可知，start_brk即为堆段的初始位置，brk（程序中断）即为堆段的末尾位置<br><em><u>Example:</u></em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/* sbrk and brk example */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">void</span> *curr_brk, *tmp_brk = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Welcome to sbrk example:%d\n"</span>, getpid());</div><div class="line"></div><div class="line">        <span class="comment">/* sbrk(0) gives current program break location */</span></div><div class="line">        tmp_brk = curr_brk = sbrk(<span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Program Break Location1:%p\n"</span>, curr_brk);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        <span class="comment">/* brk(addr) increments/decrements program break location */</span></div><div class="line">        brk(curr_brk+<span class="number">4096</span>);</div><div class="line"></div><div class="line">        curr_brk = sbrk(<span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Program break Location2:%p\n"</span>, curr_brk);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        brk(tmp_brk);</div><div class="line"></div><div class="line">        curr_brk = sbrk(<span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Program Break Location3:%p\n"</span>, curr_brk);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em><u>输出分析:</u></em><br>在增加程序中断之前：在下面的输出中我们可以看到这没有堆段，因此</p>
<blockquote>
<ul>
<li>start_brk=brk=end_data=0x804b000</li>
</ul>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ ./sbrk </div><div class="line">Welcome to sbrk example:<span class="number">6141</span></div><div class="line">Program Break Location1:<span class="number">0x804b000</span></div><div class="line">...</div><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ cat /proc/<span class="number">6141</span>/maps</div><div class="line">...</div><div class="line"><span class="number">0804</span>a000<span class="number">-0804</span>b000 rw-p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539624</span>     /home/sploitfun/ptmalloc.ppt/syscalls/sbrk</div><div class="line">b7e21000-b7e22000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </div><div class="line">...</div><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$</div></pre></td></tr></table></figure>
<p><em>增加了程序中断位置之后：</em>在下面的输出中我们可以看到这有堆段了，因此：</p>
<blockquote>
<ul>
<li>start_brk=end_data=0x804b000</li>
<li>brk=0x804c000</li>
</ul>
</blockquote>
<p>在这<br>0804b000-0804c000是这个堆段的虚拟地址范围<br>rw-p是权限（读，写，不可执行，私有）<br>00000000代表文件偏移量——由于它不是从其它文件映射而来，所以就为0<br>00:00是主要/次要设备编号——由于它不是从其它文件映射而来，所以这里为0<br>0代表Inode编号——由于它不是从其它文件映射而来，所以这里为0<br>[heap]堆段</p>
<h3 id="0X02-mmap"><a href="#0X02-mmap" class="headerlink" title="0X02 mmap"></a>0X02 mmap</h3><p> malloc使用<a href="http://lxr.free-electrons.com/source/mm/mmap.c?v=3.8#L1285" target="_blank" rel="external">mmap</a>创建私有匿名映射段。私有匿名映射的主要目的是分配新的内存（零填充），并且这个新的内存将被调用进程独占使用。<br><em><u>Example:</u></em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> <span class="comment">/* Private anonymous mapping example using mmap syscall */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="title">errExit</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></div><div class="line">&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%s failed. Exiting the process\n"</span>, msg);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">-1</span>;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Welcome to private anonymous mapping example::PID:%d\n"</span>, getpid());</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Before mmap\n"</span>);</div><div class="line">        getchar();</div><div class="line">        <span class="keyword">char</span>* addr = <span class="literal">NULL</span>;</div><div class="line">        addr = mmap(<span class="literal">NULL</span>, (<span class="keyword">size_t</span>)<span class="number">132</span>*<span class="number">1024</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (addr == MAP_FAILED)</div><div class="line">                errExit(<span class="string">"mmap"</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"After mmap\n"</span>);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        <span class="comment">/* Unmap mapped region. */</span></div><div class="line">        ret = munmap(addr, (<span class="keyword">size_t</span>)<span class="number">132</span>*<span class="number">1024</span>);</div><div class="line">        <span class="keyword">if</span>(ret == <span class="number">-1</span>)</div><div class="line">                errExit(<span class="string">"munmap"</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"After munmap\n"</span>);</div><div class="line">        getchar();</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em><u>输出分析：</u></em><br><em><u>mmap之前：</u></em>在下面的输出中，我们只能看到属于共享库libc.so和ld-linux.so的内存映射段</p>
<pre><code>sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ cat /proc/6067/maps
08048000-08049000 r-xp 00000000 08:01 539691     /home/sploitfun/ptmalloc.ppt/syscalls/mmap
08049000-0804a000 r--p 00000000 08:01 539691     /home/sploitfun/ptmalloc.ppt/syscalls/mmap
0804a000-0804b000 rw-p 00001000 08:01 539691     /home/sploitfun/ptmalloc.ppt/syscalls/mmap
b7e21000-b7e22000 rw-p 00000000 00:00 0 
...
sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$
</code></pre><p><em><u>mmap之后：</u></em>在下面的输出中，我们可以观察到我们的内存映射段（b7e00000 - b7e21000，大小为132KB）与已有的内存映射段（b7e21000 - b7e22000）结合了</p>
<p>在这里<br>b7e00000-b7e22000是这个堆段的虚拟地址范围<br>rw-p代表权限（读，写，不可执行，私有）<br>00000000代表文件偏移量——由于它不是从其它文件映射而来，所以就为0<br>00:00是主要/次要设备编号——由于它不是从其它文件映射而来，所以这里为0<br>0代表Inode编号——由于它不是从其它文件映射而来，所以这里为0</p>
<p><em><u>munmap之后：</u></em>在下面的输出中，我们可以看到我们的内存映射段是未映射的，即它的相应的内存被释放到操作系统。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ cat /proc/<span class="number">6067</span>/maps</div><div class="line"><span class="number">08048000</span><span class="number">-08049000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539691</span>     /home/sploitfun/ptmalloc.ppt/syscalls/mmap</div><div class="line"><span class="number">08049000</span><span class="number">-0804</span>a000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539691</span>     /home/sploitfun/ptmalloc.ppt/syscalls/mmap</div><div class="line"><span class="number">0804</span>a000<span class="number">-0804</span>b000 rw-p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539691</span>     /home/sploitfun/ptmalloc.ppt/syscalls/mmap</div><div class="line">b7e21000-b7e22000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </div><div class="line">...</div><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$</div></pre></td></tr></table></figure>
<p><em><u>注意：</u></em>在我们的示例程序执行过程中ASLR是被关闭的。</p>
<p><em><u>参考文献：</u></em><br>1.<a href="http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/" target="_blank" rel="external">Anatomy of program in memory</a></p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170105/mallocsystemcall" target="_blank" rel="external">Linux(X86)漏洞利用系列-Malloc使用的系统调用</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/系统内核/">系统内核<span class="article-category-count">11</span></a>


      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exploit/">Exploit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/">Kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Memory/">Memory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/14/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="extend next" rel="next" href="/page/16/">下一页</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div class="widget-wrap" style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 75%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 42px;" placeholder=" 搜索…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="搜索">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">集思广益</h3>
      <p>我们推崇的是黑客与分享精神，如果您觉得本站对您有帮助，不妨自己也参与进来共同建设，期待您能推荐好文章或投稿至本站，
让更多人受益。本站热烈欢迎志同道合者与志愿者参与本站的共同维护和建设，您可通过微博[@Diting0x](http://weibo.com/diting0x)联系我</p>
       <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="null" title="Words"><i class="fa fa-words" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a> </li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>


        	</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>最新推荐</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170808/googleprojectzero/">谷歌Project Zero：通过“Row hammer”漏洞获取系统权限</a></h6>
          <!--  <span>八月 8, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170807/bypassaslr-analysis/">ASLR保护机制被突破的攻击技术分析</a></h6>
          <!--  <span>八月 7, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170605/memorysafety-defense/">内存持久战之防御措施</a></h6>
          <!--  <span>六月 5, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170531/ravel/">会找漏洞的时光机-Pinpointing Vulnerabilities</a></h6>
          <!--  <span>五月 31, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170513/memorysafety-attack/">内存支持战之攻击模型</a></h6>
          <!--  <span>五月 13, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170513/memorysafety/">内存持久战之内存安全性</a></h6>
          <!--  <span>五月 13, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170508/intro-aslr/">系统安全浅薄知识系列(一)-ASLR</a></h6>
          <!--  <span>五月 8, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170505/cfi-mathias/">控制流完整性-Mathias Payer</a></h6>
          <!--  <span>五月 5, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170505/vmi-xenproject/">虚拟机自省技术-一个有新商业应用的安全性创造</a></h6>
          <!--  <span>五月 5, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/cf-exception/">控制流分支指令上的控制流处理器异常(单步执行)</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/cfi-development/">控制流完整性的发展历程</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/cfi-ccs05/">控制流完整性-CCS05年论文</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/rop-intel/">因特尔发布新的技术规范去防御 ROP 攻击</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/ropjop-research/">ROP/JOP攻击与防御最新研究进展</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/nmi-virtual/">虚拟化技术的NMI窗口退出</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170504/lbr-ret2dir/">利用LBR特性检测ret2dir攻击</a></h6>
          <!--  <span>五月 4, 2017</span> -->
            </div>

          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类导航</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Hypervisor安全/">Hypervisor安全</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/主流会议/">主流会议</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制分析/">二进制分析</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内存安全/">内存安全</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内核安全/">内核安全</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/内核完整性/">内核完整性</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/博士之路/">博士之路</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/名人课堂/">名人课堂</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/学术专家/">学术专家</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全圈子/">安全圈子</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/恶意代码/">恶意代码</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞利用/">漏洞利用</a><span class="category-list-count">14</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件特性/">硬件特性</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/硬件虚拟化/">硬件虚拟化</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统内核/">系统内核</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统安全/">系统安全</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统安全科普/">系统安全科普</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化原理/">虚拟化原理</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化基础/">虚拟化基础</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化综合/">虚拟化综合</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机快照/">虚拟机快照</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机监控/">虚拟机监控</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机记录与重放/">虚拟机记录与重放</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机迁移/">虚拟机迁移</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签导航</h3>
    <div class="widget tagcloud">
      <a href="/tags/ASLR/" style="font-size: 12.31px;">ASLR</a> <a href="/tags/ASPLOS/" style="font-size: 10px;">ASPLOS</a> <a href="/tags/Attack/" style="font-size: 12.31px;">Attack</a> <a href="/tags/Binary/" style="font-size: 10.77px;">Binary</a> <a href="/tags/CFI/" style="font-size: 12.31px;">CFI</a> <a href="/tags/Cloud/" style="font-size: 10px;">Cloud</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/Conference/" style="font-size: 12.31px;">Conference</a> <a href="/tags/Conferences/" style="font-size: 10px;">Conferences</a> <a href="/tags/Course/" style="font-size: 13.08px;">Course</a> <a href="/tags/Exception/" style="font-size: 10px;">Exception</a> <a href="/tags/Exploit/" style="font-size: 16.92px;">Exploit</a> <a href="/tags/Forensics/" style="font-size: 10px;">Forensics</a> <a href="/tags/HAV/" style="font-size: 12.31px;">HAV</a> <a href="/tags/Hardware/" style="font-size: 13.85px;">Hardware</a> <a href="/tags/Heap/" style="font-size: 10.77px;">Heap</a> <a href="/tags/Hooking/" style="font-size: 10px;">Hooking</a> <a href="/tags/Instrumentation/" style="font-size: 10.77px;">Instrumentation</a> <a href="/tags/Introspection/" style="font-size: 13.85px;">Introspection</a> <a href="/tags/JOP/" style="font-size: 10px;">JOP</a> <a href="/tags/KVM/" style="font-size: 16.15px;">KVM</a> <a href="/tags/Kernel/" style="font-size: 17.69px;">Kernel</a> <a href="/tags/Libvmi/" style="font-size: 13.08px;">Libvmi</a> <a href="/tags/Linux/" style="font-size: 13.08px;">Linux</a> <a href="/tags/Malware/" style="font-size: 15.38px;">Malware</a> <a href="/tags/Memory/" style="font-size: 13.08px;">Memory</a> <a href="/tags/Migration/" style="font-size: 11.54px;">Migration</a> <a href="/tags/Monitoring/" style="font-size: 13.08px;">Monitoring</a> <a href="/tags/NX/" style="font-size: 10px;">NX</a> <a href="/tags/Overflow/" style="font-size: 10.77px;">Overflow</a> <a href="/tags/PIN/" style="font-size: 10px;">PIN</a> <a href="/tags/Paper/" style="font-size: 11.54px;">Paper</a> <a href="/tags/Ph-D/" style="font-size: 10.77px;">Ph.D</a> <a href="/tags/Ppaerwriting/" style="font-size: 10px;">Ppaerwriting</a> <a href="/tags/Professor/" style="font-size: 12.31px;">Professor</a> <a href="/tags/QEMU/" style="font-size: 14.62px;">QEMU</a> <a href="/tags/RE/" style="font-size: 10px;">RE</a> <a href="/tags/ROP/" style="font-size: 10.77px;">ROP</a> <a href="/tags/Rootkit/" style="font-size: 11.54px;">Rootkit</a> <a href="/tags/Rowhammer/" style="font-size: 10px;">Rowhammer</a> <a href="/tags/SYSCALL/" style="font-size: 10px;">SYSCALL</a> <a href="/tags/Sandbox/" style="font-size: 10.77px;">Sandbox</a> <a href="/tags/Security/" style="font-size: 20px;">Security</a> <a href="/tags/Shellcode/" style="font-size: 10px;">Shellcode</a> <a href="/tags/Snapshot/" style="font-size: 10px;">Snapshot</a> <a href="/tags/Stack/" style="font-size: 10.77px;">Stack</a> <a href="/tags/Syscall/" style="font-size: 10px;">Syscall</a> <a href="/tags/System/" style="font-size: 18.46px;">System</a> <a href="/tags/Systemcall/" style="font-size: 11.54px;">Systemcall</a> <a href="/tags/TSX/" style="font-size: 10px;">TSX</a> <a href="/tags/TrustZone/" style="font-size: 10px;">TrustZone</a> <a href="/tags/VT-x/" style="font-size: 10px;">VT-x</a> <a href="/tags/Valgrind/" style="font-size: 10px;">Valgrind</a> <a href="/tags/Virtualization/" style="font-size: 19.23px;">Virtualization</a> <a href="/tags/Volatility/" style="font-size: 10px;">Volatility</a> <a href="/tags/XEN/" style="font-size: 13.08px;">XEN</a>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      版权所有&copy; 2017 Index of Computer System and Security 保留所有权利.
      </div>
      <div class="site-credit">
       <!--  自豪地使用 <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a> --> 
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
    <a href="/syssec" class="mobile-nav-link">Syssec</a>
  
    <a href="/architecture" class="mobile-nav-link">Architecture</a>
  
    <a href="/virtualization" class="mobile-nav-link">Virtualization</a>
  
    <a href="/malware" class="mobile-nav-link">Malware</a>
  
    <a href="/conferences" class="mobile-nav-link">Conferences</a>
  
    <a href="/courses" class="mobile-nav-link">Courses</a>
  
    <a href="/academy" class="mobile-nav-link">Academy</a>
  
    <a href="/news" class="mobile-nav-link">News</a>
  
    <a href="/knowledge" class="mobile-nav-link">Knowledge</a>
  
    <a href="/share" class="mobile-nav-link">Share</a>
  
    <a href="/contribution" class="mobile-nav-link">Contribution</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>





  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261078922&web_id=1261078922" language="JavaScript"></script>
  </div>


</body>
</html>
