<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>kvm源码分析之cpu虚拟化 | Index of Computer System and Security</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
    <meta name="keywords" content="computer system, computer security" />
  
  
  
  
  <meta name="description" content="作者：Oen Han

CSysSec注： 本KVM源码分析系列文章来自系Intel中国Linux内核与虚拟化开发工程师Oen Han的博客,Oen Han 在虚拟化领域有丰富的开发经验，其写的KVM源码分析系列是本人目前见过最好最详细的，值得推荐。转载本文请务必注明，文章出处：《KVM源码分析之CPU虚拟化》及原作者信息:Oen Han



0X01 VT-x 技术
0X02 VMCS寄存器">
<meta property="og:type" content="article">
<meta property="og:title" content="KVM源码分析之CPU虚拟化">
<meta property="og:url" content="http://yoursite.com/20170104/kvmsource-cpu/index.html">
<meta property="og:site_name" content="Index of Computer System and Security">
<meta property="og:description" content="作者：Oen Han

CSysSec注： 本KVM源码分析系列文章来自系Intel中国Linux内核与虚拟化开发工程师Oen Han的博客,Oen Han 在虚拟化领域有丰富的开发经验，其写的KVM源码分析系列是本人目前见过最好最详细的，值得推荐。转载本文请务必注明，文章出处：《KVM源码分析之CPU虚拟化》及原作者信息:Oen Han



0X01 VT-x 技术
0X02 VMCS寄存器">
<meta property="og:image" content="http://oij0laovn.bkt.clouddn.com/kvmsource301.jpg">
<meta property="og:updated_time" content="2017-01-04T11:52:44.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="KVM源码分析之CPU虚拟化">
<meta name="twitter:description" content="作者：Oen Han

CSysSec注： 本KVM源码分析系列文章来自系Intel中国Linux内核与虚拟化开发工程师Oen Han的博客,Oen Han 在虚拟化领域有丰富的开发经验，其写的KVM源码分析系列是本人目前见过最好最详细的，值得推荐。转载本文请务必注明，文章出处：《KVM源码分析之CPU虚拟化》及原作者信息:Oen Han



0X01 VT-x 技术
0X02 VMCS寄存器">
<meta name="twitter:image" content="http://oij0laovn.bkt.clouddn.com/kvmsource301.jpg">
  
    <link rel="alternate" href="/atom.xml" title="Index of Computer System and Security" type="application/atom+xml">
  
  <link rel="icon" href="/css/images/favicon.ico">
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link href="https://fonts.googleapis.com/css?family=Open+Sans|Montserrat:700" rel="stylesheet" type="text/css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,300,300italic,400italic" rel="stylesheet" type="text/css">
  <link href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
  <style type="text/css">
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/9749f0/00000000000000000001008f/27/l?subset_id=2&fvd=n5) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/90cf9f/000000000000000000010091/27/l?subset_id=2&fvd=n7) format("woff2");font-weight:500;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/8a5494/000000000000000000013365/27/l?subset_id=2&fvd=n4) format("woff2");font-weight:lighter;font-style:normal;}
    @font-face{font-family:futura-pt;src:url(https://use.typekit.net/af/d337d8/000000000000000000010095/27/l?subset_id=2&fvd=i4) format("woff2");font-weight:400;font-style:italic;}</style>
    
  <link rel="stylesheet" id="athemes-headings-fonts-css" href="//fonts.googleapis.com/css?family=Yanone+Kaffeesatz%3A200%2C300%2C400%2C700&amp;ver=4.6.1" type="text/css" media="all">
  <link rel="stylesheet" href="/css/style.css">

  <script src="/js/jquery-3.1.1.min.js"></script>

  <!-- Bootstrap core CSS -->
  <link rel="stylesheet" href="/css/bootstrap.css" >
  <link rel="stylesheet" href="/css/hiero.css" >
  <link rel="stylesheet" href="/css/glyphs.css" >

</head>

<body>
  <header id="allheader" class="site-header" role="banner">
  <div class="clearfix container">
      <div class="site-branding">

          <h1 class="site-title">
            <a href="/" title="Index of Computer System and Security" rel="home">
              Index of Computer System and Security</a>
          </h1>
          <div class="site-description">FROM 0 TO 1</div>

            
          <nav id="main-navigation" class="main-navigation" role="navigation">
            <a class="nav-open">Menu</a>
            <a class="nav-close">Close</a>
            <div class="clearfix sf-menu">

              <ul id="main-nav" class="nmenu sf-js-enabled">
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/">首页</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/syssec">系统安全</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/architecture">系统结构</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/virtualization">虚拟化</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/malware">恶意代码</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/conferences">主流会议</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/courses">名人课堂</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/academy">学术专家</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/contribution">本站达人</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/donation">打赏支持</a> </li>
                    
                      <li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-1663"> <a class="" href="/about">关于</a> </li>
                    
              </ul>
            </div>
          </nav>


      </div>
  </div>
</header>


  <div style="background:#fff;width: 100%;">

      <div style="max-height:600px; overflow: hidden;">
        <img width="100%" alt="Hike News" src="/css/images/pose.jpg">
      </div>

  </div>



  <div id="container">
    <div id="wrap">
            
      <div id="content" class="outer">
        
          <section id="main" style="float:none;"><article id="post-kvmsource-cpu" style="width: 66%; float:left;" class="article article-type-post" itemscope itemprop="blogPost" >
  <div id="articleInner" class="clearfix post-1016 post type-post status-publish format-standard has-post-thumbnail hentry category-template-2 category-uncategorized tag-codex tag-edge-case tag-featured-image tag-image tag-template">
    
    
      <header class="article-header">
        
  
    <h1 class="thumb" class="article-title" itemprop="name">
      KVM源码分析之CPU虚拟化
    </h1>
  

      </header>
    
    <div class="article-meta">
      
	Posted on <a href="/20170104/kvmsource-cpu/" class="article-date">
	  <time datetime="2017-01-04T05:49:37.000Z" itemprop="datePublished">一月 4, 2017</time>
	</a>

    </div>
    <div class="article-entry" itemprop="articleBody">
      
        <p>作者：<a href="http://www.oenhan.com/about" target="_blank" rel="external">Oen Han</a></p>
<hr>
<p><strong>CSysSec注</strong>： 本KVM源码分析系列文章来自系Intel中国Linux内核与虚拟化开发工程师Oen Han的<a href="http://www.oenhan.com/kvm-src-3-cpu" target="_blank" rel="external">博客</a>,Oen Han 在虚拟化领域有丰富的开发经验，其写的KVM源码分析系列是本人目前见过最好最详细的，值得推荐。<br><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170104/kvmsource-cpu/" target="_blank" rel="external">KVM源码分析之CPU虚拟化</a>》及原作者信息:<a href="http://www.oenhan.com/about" target="_blank" rel="external">Oen Han</a></p>
<hr>
<blockquote>
<ul>
<li>0X01 VT-x 技术</li>
<li>0X02 VMCS寄存器</li>
<li>0X03 VM-Entry/VM-Exit</li>
<li>0X04 KVM_CREATE_VM</li>
<li>0X05 KVM_CREATE_VCPU</li>
<li>0X06 KVM_RUN</li>
</ul>
</blockquote>
<p>在<a href="http://www.csyssec.org/20170104/kvmsource-create/" target="_blank" rel="external">虚拟机的创建与运行</a>章节里面笼统的介绍了KVM在qemu中的创建和运行，基本的qemu代码流程已经梳理清楚，后续主要写一些硬件虚拟化的原理和代码流程，主要写原理和qemu控制KVM运行的的ioctl接口，后续对内核代码的梳理也从这些接口下手。</p>
<p>QEMU：git://git.qemu.org/qemu.git v2.4.0</p>
<p>KVM：<a href="https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git" target="_blank" rel="external">https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux-stable.git</a> v4.2</p>
<h3 id="0X01-VT-x-技术"><a href="#0X01-VT-x-技术" class="headerlink" title="0X01 VT-x 技术"></a>0X01 VT-x 技术</h3><p>Intel处理器支持的虚拟化技术即是VT-x，之所以CPU支持硬件虚拟化是因为软件虚拟化的效率太低。</p>
<p>处理器虚拟化的本质是分时共享，主要体现在状态恢复和资源隔离，实际上每个VM对于VMM看就是一个task么，之前Intel处理器在虚拟化上没有提供默认的硬件支持，传统 x86 处理器有4个特权级，Linux使用了0,3级别，0即内核，3即用户态，（更多参考CPU的运行环、特权级与保护）而在虚拟化架构上，虚拟机监控器的运行级别需要内核态特权级，而CPU特权级被传统OS占用，所以Intel设计了VT-x，提出了VMX模式，即VMX root operation 和 VMX non-root operation，虚拟机监控器运行在VMX root operation，虚拟机运行在VMX non-root operation。每个模式下都有相对应的0~3特权级。</p>
<p>为什么引入这两种特殊模式，在传统x86的系统中，CPU有不同的特权级，是为了划分不同的权限指令，某些指令只能由系统软件操作，称为特权指令，这些指令只能在最高特权级上才能正确执行，反之则会触发异常，处理器会陷入到最高特权级，由系统软件处理。还有一种需要操作特权资源（如访问中断寄存器）的指令，称为敏感指令。OS运行在特权级上，屏蔽掉用户态直接执行的特权指令，达到控制所有的硬件资源目的；而在虚拟化环境中，VMM控制所有所有硬件资源，VM中的OS只能占用一部分资源，OS执行的很多特权指令是不能真正对硬件生效的，所以原特权级下有了root模式，OS指令不需要修改就可以正常执行在特权级上，但这个特权级的所有敏感指令都会传递到root模式处理，这样达到了VMM的目的。</p>
<p>在KVM源代码分析1:基本工作原理章节中也说了kvm分3个模式，对应到VT-x 中即是客户模式对应vmx非root模式，内核模式对应VMX root模式下的0特权级，用户模式对应vmx root模式下的3特权级。</p>
<figure><br>    <a href="http://oij0laovn.bkt.clouddn.com/kvmsource301.jpg" target="_blank" rel="external"><img src="http://oij0laovn.bkt.clouddn.com/kvmsource301.jpg" width="450"></a><br>    <figcaption></figcaption><br></figure>


<p>在非根模式下敏感指令引发的陷入称为VM-Exit，VM-Exit发生后，CPU从非根模式切换到根模式；对应的，VM-Entry则是从根模式到非根模式，通常意味着调用VM进入运行态。VMLAUCH/VMRESUME命令则是用来发起VM-Entry。</p>
<h3 id="0X02-VMCS寄存器"><a href="#0X02-VMCS寄存器" class="headerlink" title="0X02 VMCS寄存器"></a>0X02 VMCS寄存器</h3><p>VMCS保存虚拟机的相关CPU状态，每个VCPU都有一个VMCS（内存的），每个物理CPU都有VMCS对应的寄存器（物理的），当CPU发生VM-Entry时，CPU则从VCPU指定的内存中读取VMCS加载到物理CPU上执行，当发生VM-Exit时，CPU则将当前的CPU状态保存到VCPU指定的内存中，即VMCS，以备下次VMRESUME。</p>
<p>VMLAUCH指VM的第一次VM-Entry，VMRESUME则是VMLAUCH之后后续的VM-Entry。VMCS下有一些控制域：</p>
<table>
<thead>
<tr>
<th style="text-align:left">Field</th>
<th style="text-align:left">Function</th>
<th style="text-align:left">Example</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">VM-execution controls</td>
<td style="text-align:left">Determines what operations cause VM exits</td>
<td style="text-align:left">CR0, CR3, CR4, Exceptions, IO Ports, Interrupts, Pin Events, etc</td>
</tr>
<tr>
<td style="text-align:left">Guest-state area</td>
<td style="text-align:left">Saved on VM exits，Reloaded on VM entry</td>
<td style="text-align:left">EIP, ESP, EFLAGS, IDTR, Segment Regs, Exit info, etc</td>
</tr>
<tr>
<td style="text-align:left"> Host-state area</td>
<td style="text-align:left">Loaded on VM exits</td>
<td style="text-align:left">CR3, EIP set to monitor entry point, EFLAGS hardcoded, etc</td>
</tr>
<tr>
<td style="text-align:left"> VM-exit controls</td>
<td style="text-align:left">Determines which state to save, load, how to transition</td>
<td style="text-align:left">Example: MSR save-load list</td>
</tr>
<tr>
<td style="text-align:left"> VM-entry controls</td>
<td style="text-align:left">Determines which state to load, how to transition</td>
<td style="text-align:left">Including injecting events (interrupts, exceptions) on entry</td>
</tr>
</tbody>
</table>
<p> 关于具体控制域的细节，还是翻Intel手册吧。</p>
<h3 id="0X03-VM-Entry-VM-Exit"><a href="#0X03-VM-Entry-VM-Exit" class="headerlink" title="0X03 VM-Entry/VM-Exit"></a>0X03 VM-Entry/VM-Exit</h3><p>VM-Entry是从根模式切换到非根模式，即VMM切换到guest上，这个状态由VMM发起，发起之前先保存VMM中的关键寄存器内容到VMCS中，然后进入到VM-Entry，VM-Entry附带参数主要有3个：1.guest是否处于64bit模式，2.MSR VM-Entry控制，3.注入事件。1应该只在VMLAUCH有意义，3更多是在VMRESUME，而VMM发起VM-Entry更多是因为3，2主要用来每次更新MSR。</p>
<p>VM-Exit是CPU从非根模式切换到根模式，从guest切换到VMM的操作，VM-Exit触发的原因就很多了，执行敏感指令，发生中断，模拟特权资源等。</p>
<p>运行在非根模式下的敏感指令一般分为3个方面：</p>
<ul>
<li><p>1.行为没有变化的，也就是说该指令能够正确执行。</p>
</li>
<li><p>2.行为有变化的，直接产生VM-Exit。</p>
</li>
<li><p>3.行为有变化的，但是是否产生VM-Exit受到VM-Execution控制域控制。</p>
</li>
</ul>
<p>主要说一下”受到VM-Execution控制域控制”的敏感指令，这个就是针对性的硬件优化了，一般是1.产生VM-Exit；2.不产生VM-Exit，同时调用优化函数完成功能。典型的有“RDTSC指令”。除了大部分是优化性能的，还有一小部分是直接VM-Exit执行指令结果是异常的，或者说在虚拟化场景下是不适用的，典型的就是TSC offset了。</p>
<p>VM-Exit发生时退出的相关信息，如退出原因、触发中断等，这些内容保存在VM-Exit信息域中。</p>
<h3 id="0X04-KVM-CREATE-VM"><a href="#0X04-KVM-CREATE-VM" class="headerlink" title="0X04 KVM_CREATE_VM"></a>0X04 KVM_CREATE_VM</h3><p>创建VM就写这里吧，kvm_dev_ioctl_create_vm函数是主干，在kvm_create_vm中，主要有两个函数，kvm_arch_init_vm和hardware_enable_all，需要注意，但是更先一步的是KVM结构体，下面的struct是精简后的版本。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> kvm &#123;</div><div class="line">	<span class="keyword">struct</span> mm_struct *mm; <span class="comment">/* userspace tied to this vm */</span></div><div class="line">	<span class="keyword">struct</span> kvm_memslots *memslots;  <span class="comment">/*qemu模拟的内存条模型*/</span></div><div class="line">	<span class="keyword">struct</span> kvm_vcpu *vcpus[KVM_MAX_VCPUS]; <span class="comment">/* 模拟的CPU */</span></div><div class="line">	<span class="keyword">atomic_t</span> online_vcpus;</div><div class="line">	<span class="keyword">int</span> last_boosted_vcpu;</div><div class="line">	<span class="keyword">struct</span> list_head vm_list;  <span class="comment">//HOST上VM管理链表，</span></div><div class="line">	<span class="keyword">struct</span> kvm_io_bus *buses[KVM_NR_BUSES];</div><div class="line">	<span class="keyword">struct</span> kvm_vm_stat stat;</div><div class="line">	<span class="keyword">struct</span> kvm_arch arch; <span class="comment">//这个是host的arch的一些参数</span></div><div class="line">	<span class="keyword">atomic_t</span> users_count;</div><div class="line"></div><div class="line">	<span class="keyword">long</span> tlbs_dirty;</div><div class="line">	<span class="keyword">struct</span> list_head devices;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>kvm_arch_init_vm基本没有特别动作，初始化了KVM-&gt;arch，以及更新了kvmclock函数，这个另外再说。<br>而hardware_enable_all，针对于每个CPU执行“on_each_cpu(hardware_enable_nolock, NULL, 1）”，在hardware_enable_nolock中先把cpus_hardware_enabled置位，进入到kvm_arch_hardware_enable中，有hardware_enable和TSC初始化规则，主要看hardware_enable，crash_enable_local_vmclear清理位图，判断MSR_IA32_FEATURE_CONTROL寄存器是否满足虚拟环境，不满足则将条件写入到寄存器内，CR4将X86_CR4_VMXE置位，另外还有kvm_cpu_vmxon打开VMX操作模式，外层包了vmm_exclusive的判断，它是kvm_intel.ko的外置参数，默认唯一，可以让用户强制不使用VMM硬件支持。</p>
<h3 id="0X05-KVM-CREATE-VCPU"><a href="#0X05-KVM-CREATE-VCPU" class="headerlink" title="0X05 KVM_CREATE_VCPU"></a>0X05 KVM_CREATE_VCPU</h3><p>kvm_vm_ioctl_create_vcpu主要有三部分，kvm_arch_vcpu_create，kvm_arch_vcpu_setup和kvm_arch_vcpu_postcreate，重点自然是kvm_arch_vcpu_create。老样子，在这之前先看一下VCPU的结构体。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> kvm_vcpu &#123;</div><div class="line">	<span class="keyword">struct</span> kvm *kvm;  <span class="comment">//归属的KVM</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_PREEMPT_NOTIFIERS</span></div><div class="line">	<span class="keyword">struct</span> preempt_notifier preempt_notifier;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">	<span class="keyword">int</span> cpu;</div><div class="line">	<span class="keyword">int</span> vcpu_id;</div><div class="line">	<span class="keyword">int</span> srcu_idx;</div><div class="line">	<span class="keyword">int</span> mode;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> requests;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> guest_debug;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> mutex mutex;</div><div class="line">	<span class="keyword">struct</span> kvm_run *run;  <span class="comment">//运行时的状态</span></div><div class="line"></div><div class="line">	<span class="keyword">int</span> fpu_active;</div><div class="line">	<span class="keyword">int</span> guest_fpu_loaded, guest_xcr0_loaded;</div><div class="line">	<span class="keyword">wait_queue_head_t</span> wq; <span class="comment">//队列</span></div><div class="line">	<span class="keyword">struct</span> pid *pid;</div><div class="line">	<span class="keyword">int</span> sigset_active;</div><div class="line">	<span class="keyword">sigset_t</span> sigset;</div><div class="line">	<span class="keyword">struct</span> kvm_vcpu_stat stat; <span class="comment">//一些数据</span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HAS_IOMEM</span></div><div class="line">	<span class="keyword">int</span> mmio_needed;</div><div class="line">	<span class="keyword">int</span> mmio_read_completed;</div><div class="line">	<span class="keyword">int</span> mmio_is_write;</div><div class="line">	<span class="keyword">int</span> mmio_cur_fragment;</div><div class="line">	<span class="keyword">int</span> mmio_nr_fragments;</div><div class="line">	<span class="keyword">struct</span> kvm_mmio_fragment mmio_fragments[KVM_MAX_MMIO_FRAGMENTS];</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KVM_ASYNC_PF</span></div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		u32 queued;</div><div class="line">		<span class="keyword">struct</span> list_head <span class="built_in">queue</span>;</div><div class="line">		<span class="keyword">struct</span> list_head done;</div><div class="line">		<span class="keyword">spinlock_t</span> lock;</div><div class="line">	&#125; async_pf;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line"></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_HAVE_KVM_CPU_RELAX_INTERCEPT</span></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Cpu relax intercept or pause loop exit optimization</div><div class="line">	 * in_spin_loop: set when a vcpu does a pause loop exit</div><div class="line">	 *  or cpu relax intercepted.</div><div class="line">	 * dy_eligible: indicates whether vcpu is eligible for directed yield.</div><div class="line">	 */</div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		<span class="keyword">bool</span> in_spin_loop;</div><div class="line">		<span class="keyword">bool</span> dy_eligible;</div><div class="line">	&#125; spin_loop;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">	<span class="keyword">bool</span> preempted;</div><div class="line">	<span class="keyword">struct</span> kvm_vcpu_arch arch;  <span class="comment">//当前VCPU虚拟的架构，默认介绍X86</span></div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>借着看kvm_arch_vcpu_create，它借助kvm_x86_ops-&gt;vcpu_create即vmx_create_vcpu完成任务，vmx是X86硬件虚拟化层，从代码看，qemu用户态是一层，kernel 中KVM通用代码是一层，类似kvm_x86_ops是一层，针对各个不同硬件架构，而vcpu_vmx则是具体架构的虚拟化方案一层。首先是kvm_vcpu_init初始化，主要是填充结构体，可以注意的是vcpu-&gt;run分派了一页内存，下面有kvm_arch_vcpu_init负责填充x86 CPU结构体，下面就是kvm_vcpu_arch：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">struct</span> kvm_vcpu_arch &#123;</div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * rip and regs accesses must go through</div><div class="line">	 * kvm_&#123;register,rip&#125;_&#123;read,write&#125; functions.</div><div class="line">	 */</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> regs[NR_VCPU_REGS];</div><div class="line">	u32 regs_avail;</div><div class="line">	u32 regs_dirty;</div><div class="line"><span class="comment">//类似这些寄存器就是就是用来缓存真正的CPU值的</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> cr0;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> cr0_guest_owned_bits;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> cr2;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> cr3;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> cr4;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> cr4_guest_owned_bits;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> cr8;</div><div class="line">	u32 hflags;</div><div class="line">	u64 efer;</div><div class="line">	u64 apic_base;</div><div class="line">	<span class="keyword">struct</span> kvm_lapic *apic;    <span class="comment">/* kernel irqchip context */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> apic_attention;</div><div class="line">	<span class="keyword">int32_t</span> apic_arb_prio;</div><div class="line">	<span class="keyword">int</span> mp_state;</div><div class="line">	u64 ia32_misc_enable_msr;</div><div class="line">	<span class="keyword">bool</span> tpr_access_reporting;</div><div class="line">	u64 ia32_xss;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Paging state of the vcpu</div><div class="line">	 *</div><div class="line">	 * If the vcpu runs in guest mode with two level paging this still saves</div><div class="line">	 * the paging mode of the l1 guest. This context is always used to</div><div class="line">	 * handle faults.</div><div class="line">	 */</div><div class="line">	<span class="keyword">struct</span> kvm_mmu mmu; <span class="comment">//内存管理，更多的是附带了直接操作函数</span></div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Paging state of an L2 guest (used for nested npt)</div><div class="line">	 *</div><div class="line">	 * This context will save all necessary information to walk page tables</div><div class="line">	 * of the an L2 guest. This context is only initialized for page table</div><div class="line">	 * walking and not for faulting since we never handle l2 page faults on</div><div class="line">	 * the host.</div><div class="line">	 */</div><div class="line">	<span class="keyword">struct</span> kvm_mmu nested_mmu;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Pointer to the mmu context currently used for</div><div class="line">	 * gva_to_gpa translations.</div><div class="line">	 */</div><div class="line">	<span class="keyword">struct</span> kvm_mmu *walk_mmu;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> kvm_mmu_memory_cache mmu_pte_list_desc_cache;</div><div class="line">	<span class="keyword">struct</span> kvm_mmu_memory_cache mmu_page_cache;</div><div class="line">	<span class="keyword">struct</span> kvm_mmu_memory_cache mmu_page_header_cache;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> fpu guest_fpu;</div><div class="line">	u64 xcr0;</div><div class="line">	u64 guest_supported_xcr0;</div><div class="line">	u32 guest_xstate_size;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> kvm_pio_request pio;</div><div class="line">	<span class="keyword">void</span> *pio_data;</div><div class="line"></div><div class="line">	u8 event_exit_inst_len;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> kvm_queued_exception &#123;</div><div class="line">		<span class="keyword">bool</span> pending;</div><div class="line">		<span class="keyword">bool</span> has_error_code;</div><div class="line">		<span class="keyword">bool</span> reinject;</div><div class="line">		u8 nr;</div><div class="line">		u32 error_code;</div><div class="line">	&#125; exception;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> kvm_queued_interrupt &#123;</div><div class="line">		<span class="keyword">bool</span> pending;</div><div class="line">		<span class="keyword">bool</span> soft;</div><div class="line">		u8 nr;</div><div class="line">	&#125; interrupt;</div><div class="line"></div><div class="line">	<span class="keyword">int</span> halt_request; <span class="comment">/* real mode on Intel only */</span></div><div class="line"></div><div class="line">	<span class="keyword">int</span> cpuid_nent;</div><div class="line">	<span class="keyword">struct</span> kvm_cpuid_entry2 cpuid_entries[KVM_MAX_CPUID_ENTRIES];</div><div class="line"></div><div class="line">	<span class="keyword">int</span> maxphyaddr;</div><div class="line"></div><div class="line">	<span class="comment">/* emulate context */</span></div><div class="line"><span class="comment">//下面是KVM的软件模拟模式，也就是没有vmx的情况，估计也没人用这一套</span></div><div class="line">	<span class="keyword">struct</span> x86_emulate_ctxt emulate_ctxt;</div><div class="line">	<span class="keyword">bool</span> emulate_regs_need_sync_to_vcpu;</div><div class="line">	<span class="keyword">bool</span> emulate_regs_need_sync_from_vcpu;</div><div class="line">	<span class="keyword">int</span> (*complete_userspace_io)(<span class="keyword">struct</span> kvm_vcpu *vcpu);</div><div class="line"></div><div class="line">	<span class="keyword">gpa_t</span> time;</div><div class="line">	<span class="keyword">struct</span> pvclock_vcpu_time_info hv_clock;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">int</span> hw_tsc_khz;</div><div class="line">	<span class="keyword">struct</span> gfn_to_hva_cache pv_time;</div><div class="line">	<span class="keyword">bool</span> pv_time_enabled;</div><div class="line">	<span class="comment">/* set guest stopped flag in pvclock flags field */</span></div><div class="line">	<span class="keyword">bool</span> pvclock_set_guest_stopped_request;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		u64 msr_val;</div><div class="line">		u64 last_steal;</div><div class="line">		u64 accum_steal;</div><div class="line">		<span class="keyword">struct</span> gfn_to_hva_cache stime;</div><div class="line">		<span class="keyword">struct</span> kvm_steal_time steal;</div><div class="line">	&#125; st;</div><div class="line"></div><div class="line">	u64 last_guest_tsc;</div><div class="line">	u64 last_host_tsc;</div><div class="line">	u64 tsc_offset_adjustment;</div><div class="line">	u64 this_tsc_nsec;</div><div class="line">	u64 this_tsc_write;</div><div class="line">	u64 this_tsc_generation;</div><div class="line">	<span class="keyword">bool</span> tsc_catchup;</div><div class="line">	<span class="keyword">bool</span> tsc_always_catchup;</div><div class="line">	s8 virtual_tsc_shift;</div><div class="line">	u32 virtual_tsc_mult;</div><div class="line">	u32 virtual_tsc_khz;</div><div class="line">	s64 ia32_tsc_adjust_msr;</div><div class="line"></div><div class="line">	<span class="keyword">atomic_t</span> nmi_queued;  <span class="comment">/* unprocessed asynchronous NMIs */</span></div><div class="line">	<span class="keyword">unsigned</span> nmi_pending; <span class="comment">/* NMI queued after currently running handler */</span></div><div class="line">	<span class="keyword">bool</span> nmi_injected;    <span class="comment">/* Trying to inject an NMI this entry */</span></div><div class="line"></div><div class="line">	<span class="keyword">struct</span> mtrr_state_type mtrr_state;</div><div class="line">	u64 pat;</div><div class="line"></div><div class="line">	<span class="keyword">unsigned</span> switch_db_regs;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> db[KVM_NR_DB_REGS];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> dr6;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> dr7;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> eff_db[KVM_NR_DB_REGS];</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> guest_debug_dr7;</div><div class="line"></div><div class="line">	u64 mcg_cap;</div><div class="line">	u64 mcg_status;</div><div class="line">	u64 mcg_ctl;</div><div class="line">	u64 *mce_banks;</div><div class="line"></div><div class="line">	<span class="comment">/* Cache MMIO info */</span></div><div class="line">	u64 mmio_gva;</div><div class="line">	<span class="keyword">unsigned</span> access;</div><div class="line">	<span class="keyword">gfn_t</span> mmio_gfn;</div><div class="line">	u64 mmio_gen;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> kvm_pmu pmu;</div><div class="line"></div><div class="line">	<span class="comment">/* used for guest single stepping over the given code position */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> singlestep_rip;</div><div class="line"></div><div class="line">	<span class="comment">/* fields used by HYPER-V emulation */</span></div><div class="line">	u64 hv_vapic;</div><div class="line"></div><div class="line">	<span class="keyword">cpumask_var_t</span> wbinvd_dirty_mask;</div><div class="line"></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> last_retry_eip;</div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> last_retry_addr;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		<span class="keyword">bool</span> halted;</div><div class="line">		<span class="keyword">gfn_t</span> gfns[roundup_pow_of_two(ASYNC_PF_PER_VCPU)];</div><div class="line">		<span class="keyword">struct</span> gfn_to_hva_cache data;</div><div class="line">		u64 msr_val;</div><div class="line">		u32 id;</div><div class="line">		<span class="keyword">bool</span> send_user_only;</div><div class="line">	&#125; apf;</div><div class="line"></div><div class="line">	<span class="comment">/* OSVW MSRs (AMD only) */</span></div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		u64 length;</div><div class="line">		u64 status;</div><div class="line">	&#125; osvw;</div><div class="line"></div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		u64 msr_val;</div><div class="line">		<span class="keyword">struct</span> gfn_to_hva_cache data;</div><div class="line">	&#125; pv_eoi;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Indicate whether the access faults on its page table in guest</div><div class="line">	 * which is set when fix page fault and used to detect unhandeable</div><div class="line">	 * instruction.</div><div class="line">	 */</div><div class="line">	<span class="keyword">bool</span> write_fault_to_shadow_pgtable;</div><div class="line"></div><div class="line">	<span class="comment">/* set at EPT violation at this point */</span></div><div class="line">	<span class="keyword">unsigned</span> <span class="keyword">long</span> exit_qualification;</div><div class="line"></div><div class="line">	<span class="comment">/* pv related host specific info */</span></div><div class="line">	<span class="keyword">struct</span> &#123;</div><div class="line">		<span class="keyword">bool</span> pv_unhalted;</div><div class="line">	&#125; pv;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>整个arch结构真是长，很适合凑篇幅，很多结构其他过程涉及到的再提吧，反正我也不知道。<br>kvm_arch_vcpu_init初始化了x86在虚拟化底层的实现函数，首先是pv和emulate_ctxt，这些不支持VMX下的模拟虚拟化，尤其是vcpu-&gt;arch.emulate_ctxt.ops = &amp;emulate_ops，emulate_ops初始化虚拟化模拟的对象函数。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">static</span> <span class="keyword">struct</span> x86_emulate_ops emulate_ops = &#123;</div><div class="line">	.read_std            = kvm_read_guest_virt_system,</div><div class="line">	.write_std           = kvm_write_guest_virt_system,</div><div class="line">	.fetch               = kvm_fetch_guest_virt,</div><div class="line">	.read_emulated       = emulator_read_emulated,</div><div class="line">	.write_emulated      = emulator_write_emulated,</div><div class="line">	.cmpxchg_emulated    = emulator_cmpxchg_emulated,</div><div class="line">	.invlpg              = emulator_invlpg,</div><div class="line">	.pio_in_emulated     = emulator_pio_in_emulated,</div><div class="line">	.pio_out_emulated    = emulator_pio_out_emulated,</div><div class="line">	.get_segment         = emulator_get_segment,</div><div class="line">	.set_segment         = emulator_set_segment,</div><div class="line">	.get_cached_segment_base = emulator_get_cached_segment_base,</div><div class="line">	.get_gdt             = emulator_get_gdt,</div><div class="line">	.get_idt	     = emulator_get_idt,</div><div class="line">	.set_gdt             = emulator_set_gdt,</div><div class="line">	.set_idt	     = emulator_set_idt,</div><div class="line">	.get_cr              = emulator_get_cr,</div><div class="line">	.set_cr              = emulator_set_cr,</div><div class="line">	.cpl                 = emulator_get_cpl,</div><div class="line">	.get_dr              = emulator_get_dr,</div><div class="line">	.set_dr              = emulator_set_dr,</div><div class="line">	.set_msr             = emulator_set_msr,</div><div class="line">	.get_msr             = emulator_get_msr,</div><div class="line">	.halt                = emulator_halt,</div><div class="line">	.wbinvd              = emulator_wbinvd,</div><div class="line">	.fix_hypercall       = emulator_fix_hypercall,</div><div class="line">	.get_fpu             = emulator_get_fpu,</div><div class="line">	.put_fpu             = emulator_put_fpu,</div><div class="line">	.intercept           = emulator_intercept,</div><div class="line">	.get_cpuid           = emulator_get_cpuid,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>x86_emulate_ops函数看看就好，实际上也很少有人放弃vmx直接软件模拟。后面又有mp_state，给pio_data分配了一个page，kvm_set_tsc_khz设置TSC，kvm_mmu_create则是初始化MMU的函数，里面的函数都是地址转换的重点，在内存虚拟化重点提到。kvm_create_lapic初始化lapic，初始化mce_banks结构，还有pv_time,xcr0,xstat,pmu等，类似x86硬件结构上需要存在的，OS底层需要看到的硬件名称都要有对应的软件结构。<br>回到vmx_create_vcpu，vmx的guest_msrs分配得到一个page，后面是vmcs的分配，vmx-&gt;loaded_vmcs-&gt;vmcs = alloc_vmcs()，alloc_vmcs为当前cpu执行alloc_vmcs_cpu，alloc_vmcs_cpu中alloc_pages_exact_node分配给vmcs，alloc_pages_exact_node调用__alloc_pages实现，原来以为vmcs占用了一个page，但此处从伙伴系统申请了2^vmcs_config.order页，此处vmcs_config在setup_vmcs_config中初始化，vmcs_conf-&gt;order = get_order(vmcs_config.size)，而vmcs_conf-&gt;size = vmx_msr_high &amp; 0x1fff，又rdmsr(MSR_IA32_VMX_BASIC, vmx_msr_low, vmx_msr_high)，此处size由于与0x1fff与运算，大小必然小于4k，order则为0，然来绕去还是一个page大小。这么做估计是为了兼容vmcs_config中的size计算。<br>下面根据vmm_exclusive进行kvm_cpu_vmxon，进入vmx模式，初始化loaded_vmcs，然后用kvm_cpu_vmxoff退出vmx模式。<br>vmx_vcpu_load加载VCPU的信息，切换到指定cpu，进入到vmx模式，将loaded_vmcs的vmcs和当前cpu的vmcs绑定到一起。vmx_vcpu_setup则是初始化vmcs内容，主要是赋值计算，下面的vmx_vcpu_put则是vmx_vcpu_load的反运算。下面还有一些apic，nested，pml就不说了。<br>vmx_create_vcpu结束就直接回到kvm_vm_ioctl_create_vcpu函数，下面是kvm_arch_vcpu_setup，整个就一条线到kvm_arch_vcpu_load函数，主要有kvm_x86_ops-&gt;vcpu_load(vcpu, cpu)和tsc处理，vcpu_load就是vmx_vcpu_load，刚说了，就是进入vcpu模式下准备工作。<br>kvm_arch_vcpu_setup后面是create_vcpu_fd为proc创建控制fd，让qemu使用。kvm_arch_vcpu_postcreate则是马后炮般，重新vcpu_load，写msr，tsc。<br>如此整个vcpu就创建完成了。</p>
<h3 id="0X06-KVM-RUN"><a href="#0X06-KVM-RUN" class="headerlink" title="0X06 KVM_RUN"></a>0X06 KVM_RUN</h3><p>KVM run涉及内容也不少，先写完内存虚拟化之后再开篇专门写RUN流程。</p>
<p>下一篇：</p>
<p><a href="http://www.csyssec.org/20170104/kvmsource-memory/" target="_blank" rel="external">KVM源代码分析之内存虚拟化</a></p>
<p>——完—–</p>
<p>——下面未编辑的留存———<br>给vmcs分配空间并初始化，在alloc_vmcs_cpu分配一个页大小内存，用来保存vm和vmm信息</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vmx-&amp;gt;vmcs = alloc_vmcs();</div><div class="line">    <span class="keyword">if</span> (!vmx-&amp;gt;vmcs)</div><div class="line">        <span class="keyword">goto</span> free_msrs;</div><div class="line"> </div><div class="line">    vmcs_init(vmx-&amp;gt;vmcs);</div></pre></td></tr></table></figure>
<p>执行vm entry的时候将vmm状态保存到vmcs的host area，并加载对应vm的vmcs guest area信息到CPU中，vm exit的时候则反之，vmcs具体结构分配由硬件实现，程序员只需要通过VMWRITE和VMREAD指令去访问。</p>
<p>vmx执行完后，回到kvm_vm_ioctl_create_vcpu函数。kvm_arch_vcpu_reset对vcpu的结构进行初始化，后面一些就是检查vcpu的合法性，最后和kvm串接到一起。</p>
<p>vcpu的创建到此结束，下面说一下vcpu的运行。</p>
<p>VCPU一旦创建成功，后续的控制基本上从kvm_vcpu_ioctl开始，控制开关有KVM_RUN，KVM_GET_REGS，KVM_SET_REGS，KVM_GET_SREGS，KVM_SET_SREGS，KVM_GET_MP_STATE，KVM_SET_MP_STATE，KVM_TRANSLATE，KVM_SET_GUEST_DEBUG，KVM_SET_SIGNAL_MASK等，如果不清楚具体开关作用，可以直接到qemu搜索对应开关代码，一目了然。</p>
<p>KVM_RUN的实现函数是kvm_arch_vcpu_ioctl_run，进行安全检查之后进入__vcpu_run中，在while循环里面调用vcpu_enter_guest进入guest模式，首先处理vcpu-&gt;requests，对应的request做处理，kvm_mmu_reload加载mmu，通过kvm_x86_ops-&gt;prepare_guest_switch(vcpu)准备陷入到guest，prepare_guest_switch实现是vmx_save_host_state，顾名思义，就是保存host的当前状态。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">kvm_x86_ops-&amp;gt;prepare_guest_switch(vcpu);</div><div class="line">	<span class="keyword">if</span> (vcpu-&amp;gt;fpu_active)</div><div class="line">		kvm_load_guest_fpu(vcpu);</div><div class="line">	kvm_load_guest_xcr0(vcpu);</div><div class="line"></div><div class="line">	vcpu-&amp;gt;mode = IN_GUEST_MODE;</div><div class="line"></div><div class="line">	<span class="comment">/* We should set -&amp;gt;mode before check -&amp;gt;requests,</span></div><div class="line">	 * see the comment in make_all_cpus_request.</div><div class="line">	 */</div><div class="line">	smp_mb();</div><div class="line"></div><div class="line">	local_irq_disable();</div><div class="line">    kvm_x86_ops-&amp;gt;prepare_guest_switch(vcpu);</div><div class="line">    <span class="keyword">if</span> (vcpu-&amp;gt;fpu_active)</div><div class="line">        kvm_load_guest_fpu(vcpu);</div><div class="line">    kvm_load_guest_xcr0(vcpu);</div><div class="line"> </div><div class="line">    vcpu-&amp;gt;mode = IN_GUEST_MODE;</div><div class="line"> </div><div class="line">    <span class="comment">/* We should set -&amp;gt;mode before check -&amp;gt;requests,</span></div><div class="line">     * see the comment in make_all_cpus_request.</div><div class="line">     */</div><div class="line">    smp_mb();</div><div class="line"> </div><div class="line">    local_irq_disable();</div></pre></td></tr></table></figure>
<p>然后加载guest的寄存器等信息，fpu，xcr0,将vcpu模式设置为guest状态，屏蔽中断响应，准备进入guest。但仍进行一次检查，vcpu-&gt;mode和vcpu-&gt;requests等，如果有问题，则恢复host状态。</p>
<p>kvm_guest_enter做了两件事：account_system_vtime计算虚拟机系统时间；rcu_virt_note_context_switch对rcu锁数据进行保护，完成上下文切换。</p>
<p>准备工作搞定，kvm_x86_ops-&gt;run(vcpu)，开始运行guest，由vmx_vcpu_run实现。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">if</span> (vmx-&amp;gt;emulation_required &amp;amp;&amp;amp; emulate_invalid_guest_state)</div><div class="line">	<span class="keyword">return</span>;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (test_bit(VCPU_REGS_RSP, (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;amp;vcpu-&amp;gt;arch.regs_dirty))</div><div class="line">	vmcs_writel(GUEST_RSP, vcpu-&amp;gt;arch.regs[VCPU_REGS_RSP]);</div><div class="line"><span class="keyword">if</span> (test_bit(VCPU_REGS_RIP, (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;amp;vcpu-&amp;gt;arch.regs_dirty))</div><div class="line">	vmcs_writel(GUEST_RIP, vcpu-&amp;gt;arch.regs[VCPU_REGS_RIP]);</div><div class="line">   <span class="keyword">if</span> (vmx-&amp;gt;emulation_required &amp;amp;&amp;amp; emulate_invalid_guest_state)</div><div class="line">       <span class="keyword">return</span>;</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (test_bit(VCPU_REGS_RSP, (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;amp;vcpu-&amp;gt;arch.regs_dirty))</div><div class="line">       vmcs_writel(GUEST_RSP, vcpu-&amp;gt;arch.regs[VCPU_REGS_RSP]);</div><div class="line">   <span class="keyword">if</span> (test_bit(VCPU_REGS_RIP, (<span class="keyword">unsigned</span> <span class="keyword">long</span> *)&amp;amp;vcpu-&amp;gt;arch.regs_dirty))</div><div class="line">       vmcs_writel(GUEST_RIP, vcpu-&amp;gt;arch.regs[VCPU_REGS_RIP]);</div></pre></td></tr></table></figure>
<p>判断模拟器，RSP，RIP寄存器值。</p>
<p>主要功能在这段内联汇编上</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">asm</span>(</div><div class="line">                <span class="comment">/* Store host registers */</span></div><div class="line">		&amp;quot;push %%&amp;quot;R&amp;quot;dx; push %%&amp;quot;R&amp;quot;bp;&amp;quot;</div><div class="line">		&amp;quot;push %%&amp;quot;R&amp;quot;cx nt&amp;quot; <span class="comment">/* placeholder for guest rcx */</span></div><div class="line">		&amp;quot;push %%&amp;quot;R&amp;quot;cx nt&amp;quot;</div><div class="line">                <span class="comment">//如果vcpu host rsp和环境不等，则将其拷贝到vpu上</span></div><div class="line">		&amp;quot;cmp %%&amp;quot;R&amp;quot;sp, %c[host_rsp](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;je <span class="number">1f</span> nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;sp, %c[host_rsp](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		__ex(ASM_VMX_VMWRITE_RSP_RDX) &amp;quot;nt&amp;quot;<span class="comment">//__kvm_handle_fault_on_reboot write host rsp</span></div><div class="line">		&amp;quot;<span class="number">1</span>: nt&amp;quot;</div><div class="line">		<span class="comment">/* Reload cr2 if changed */</span></div><div class="line">		&amp;quot;mov %c[cr2](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;ax nt&amp;quot;</div><div class="line">		&amp;quot;mov %%cr2, %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">                <span class="comment">//环境上cr2值和vpu上的值不同，则将vpu上值拷贝到环境上</span></div><div class="line">		&amp;quot;cmp %%&amp;quot;R&amp;quot;ax, %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">		&amp;quot;je <span class="number">2f</span> nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;ax, %%cr2 nt&amp;quot;</div><div class="line">		&amp;quot;<span class="number">2</span>: nt&amp;quot;</div><div class="line">		<span class="comment">/* Check if vmlaunch of vmresume is needed */</span></div><div class="line">		&amp;quot;cmpl $<span class="number">0</span>, %c[launched](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		<span class="comment">/* Load guest registers.  Don't clobber flags. */</span></div><div class="line">		&amp;quot;mov %c[rax](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;ax nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[rbx](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;bx nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[rdx](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[rsi](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;si nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[rdi](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;di nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[rbp](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;bp nt&amp;quot;</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">		&amp;quot;mov %c[r8](%<span class="number">0</span>),  %%r8  nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[r9](%<span class="number">0</span>),  %%r9  nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[r10](%<span class="number">0</span>), %%r10 nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[r11](%<span class="number">0</span>), %%r11 nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[r12](%<span class="number">0</span>), %%r12 nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[r13](%<span class="number">0</span>), %%r13 nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[r14](%<span class="number">0</span>), %%r14 nt&amp;quot;</div><div class="line">		&amp;quot;mov %c[r15](%<span class="number">0</span>), %%r15 nt&amp;quot;</div><div class="line">#endif</div><div class="line">		&amp;quot;mov %c[rcx](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;cx nt&amp;quot; <span class="comment">/* kills %0 (ecx) */</span></div><div class="line"></div><div class="line">		<span class="comment">/* Enter guest mode */</span></div><div class="line">                <span class="comment">//此处和cmpl $0, %c[launched](%0)是对应的，此处选择进入guest的两种模式</span></div><div class="line">                <span class="comment">//RESUME和LAUNCH，通过__ex  __kvm_handle_fault_on_reboot执行</span></div><div class="line">		&amp;quot;jne .Llaunched nt&amp;quot;</div><div class="line">		__ex(ASM_VMX_VMLAUNCH) &amp;quot;nt&amp;quot;</div><div class="line">		&amp;quot;jmp .Lkvm_vmx_return nt&amp;quot;</div><div class="line">		&amp;quot;.Llaunched: &amp;quot; __ex(ASM_VMX_VMRESUME) &amp;quot;nt&amp;quot;</div><div class="line">                 <span class="comment">//退出vmx，保存guest信息，加载host信息</span></div><div class="line">		&amp;quot;.Lkvm_vmx_return: &amp;quot;</div><div class="line">		<span class="comment">/* Save guest registers, load host registers, keep flags */</span></div><div class="line">		&amp;quot;mov %<span class="number">0</span>, %c[wordsize](%%&amp;quot;R&amp;quot;sp) nt&amp;quot;</div><div class="line">		&amp;quot;pop %<span class="number">0</span> nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;ax, %c[rax](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;bx, %c[rbx](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;pop&amp;quot;Q&amp;quot; %c[rcx](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;dx, %c[rdx](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;si, %c[rsi](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;di, %c[rdi](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;bp, %c[rbp](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">		&amp;quot;mov %%r8,  %c[r8](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%r9,  %c[r9](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%r10, %c[r10](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%r11, %c[r11](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%r12, %c[r12](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%r13, %c[r13](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%r14, %c[r14](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">		&amp;quot;mov %%r15, %c[r15](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">#endif</div><div class="line">		&amp;quot;mov %%cr2, %%&amp;quot;R&amp;quot;ax   nt&amp;quot;</div><div class="line">		&amp;quot;mov %%&amp;quot;R&amp;quot;ax, %c[cr2](%<span class="number">0</span>) nt&amp;quot;</div><div class="line"></div><div class="line">		&amp;quot;pop  %%&amp;quot;R&amp;quot;bp; pop  %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">		&amp;quot;setbe %c[fail](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">	      : : &amp;quot;c&amp;quot;(vmx), &amp;quot;d&amp;quot;((<span class="keyword">unsigned</span> <span class="keyword">long</span>)HOST_RSP),</div><div class="line"></div><div class="line"><span class="comment">//下面加了前面寄存器的指针值，对应具体结构的值</span></div><div class="line">		[launched]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, launched)),</div><div class="line">		[fail]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, fail)),</div><div class="line">		[host_rsp]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, host_rsp)),</div><div class="line">		[rax]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RAX])),</div><div class="line">		[rbx]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RBX])),</div><div class="line">		[rcx]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RCX])),</div><div class="line">		[rdx]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RDX])),</div><div class="line">		[rsi]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RSI])),</div><div class="line">		[rdi]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RDI])),</div><div class="line">		[rbp]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RBP])),</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">		[r8]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R8])),</div><div class="line">		[r9]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R9])),</div><div class="line">		[r10]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R10])),</div><div class="line">		[r11]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R11])),</div><div class="line">		[r12]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R12])),</div><div class="line">		[r13]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R13])),</div><div class="line">		[r14]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R14])),</div><div class="line">		[r15]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R15])),</div><div class="line">#endif</div><div class="line">		[cr2]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.cr2)),</div><div class="line">		[wordsize]&amp;quot;i&amp;quot;(<span class="keyword">sizeof</span>(ulong))</div><div class="line">	      : &amp;quot;cc&amp;quot;, &amp;quot;memory&amp;quot;</div><div class="line">		, R&amp;quot;ax&amp;quot;, R&amp;quot;bx&amp;quot;, R&amp;quot;di&amp;quot;, R&amp;quot;si&amp;quot;</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">		, &amp;quot;r8&amp;quot;, &amp;quot;r9&amp;quot;, &amp;quot;r10&amp;quot;, &amp;quot;r11&amp;quot;, &amp;quot;r12&amp;quot;, &amp;quot;r13&amp;quot;, &amp;quot;r14&amp;quot;, &amp;quot;r15&amp;quot;</div><div class="line">#endif</div><div class="line"></div><div class="line"><span class="keyword">asm</span>(</div><div class="line">                <span class="comment">/* Store host registers */</span></div><div class="line">        &amp;quot;push %%&amp;quot;R&amp;quot;dx; push %%&amp;quot;R&amp;quot;bp;&amp;quot;</div><div class="line">        &amp;quot;push %%&amp;quot;R&amp;quot;cx nt&amp;quot; <span class="comment">/* placeholder for guest rcx */</span></div><div class="line">        &amp;quot;push %%&amp;quot;R&amp;quot;cx nt&amp;quot;</div><div class="line">                <span class="comment">//如果vcpu host rsp和环境不等，则将其拷贝到vpu上</span></div><div class="line">        &amp;quot;cmp %%&amp;quot;R&amp;quot;sp, %c[host_rsp](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;je <span class="number">1f</span> nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;sp, %c[host_rsp](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        __ex(ASM_VMX_VMWRITE_RSP_RDX) &amp;quot;nt&amp;quot;<span class="comment">//__kvm_handle_fault_on_reboot write host rsp</span></div><div class="line">        &amp;quot;<span class="number">1</span>: nt&amp;quot;</div><div class="line">        <span class="comment">/* Reload cr2 if changed */</span></div><div class="line">        &amp;quot;mov %c[cr2](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;ax nt&amp;quot;</div><div class="line">        &amp;quot;mov %%cr2, %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">                <span class="comment">//环境上cr2值和vpu上的值不同，则将vpu上值拷贝到环境上</span></div><div class="line">        &amp;quot;cmp %%&amp;quot;R&amp;quot;ax, %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">        &amp;quot;je <span class="number">2f</span> nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;ax, %%cr2 nt&amp;quot;</div><div class="line">        &amp;quot;<span class="number">2</span>: nt&amp;quot;</div><div class="line">        <span class="comment">/* Check if vmlaunch of vmresume is needed */</span></div><div class="line">        &amp;quot;cmpl $<span class="number">0</span>, %c[launched](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        <span class="comment">/* Load guest registers.  Don't clobber flags. */</span></div><div class="line">        &amp;quot;mov %c[rax](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;ax nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[rbx](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;bx nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[rdx](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[rsi](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;si nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[rdi](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;di nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[rbp](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;bp nt&amp;quot;</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">        &amp;quot;mov %c[r8](%<span class="number">0</span>),  %%r8  nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[r9](%<span class="number">0</span>),  %%r9  nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[r10](%<span class="number">0</span>), %%r10 nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[r11](%<span class="number">0</span>), %%r11 nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[r12](%<span class="number">0</span>), %%r12 nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[r13](%<span class="number">0</span>), %%r13 nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[r14](%<span class="number">0</span>), %%r14 nt&amp;quot;</div><div class="line">        &amp;quot;mov %c[r15](%<span class="number">0</span>), %%r15 nt&amp;quot;</div><div class="line">#endif</div><div class="line">        &amp;quot;mov %c[rcx](%<span class="number">0</span>), %%&amp;quot;R&amp;quot;cx nt&amp;quot; <span class="comment">/* kills %0 (ecx) */</span></div><div class="line"> </div><div class="line">        <span class="comment">/* Enter guest mode */</span></div><div class="line">                <span class="comment">//此处和cmpl $0, %c[launched](%0)是对应的，此处选择进入guest的两种模式</span></div><div class="line">                <span class="comment">//RESUME和LAUNCH，通过__ex  __kvm_handle_fault_on_reboot执行</span></div><div class="line">        &amp;quot;jne .Llaunched nt&amp;quot;</div><div class="line">        __ex(ASM_VMX_VMLAUNCH) &amp;quot;nt&amp;quot;</div><div class="line">        &amp;quot;jmp .Lkvm_vmx_return nt&amp;quot;</div><div class="line">        &amp;quot;.Llaunched: &amp;quot; __ex(ASM_VMX_VMRESUME) &amp;quot;nt&amp;quot;</div><div class="line">                 <span class="comment">//退出vmx，保存guest信息，加载host信息</span></div><div class="line">        &amp;quot;.Lkvm_vmx_return: &amp;quot;</div><div class="line">        <span class="comment">/* Save guest registers, load host registers, keep flags */</span></div><div class="line">        &amp;quot;mov %<span class="number">0</span>, %c[wordsize](%%&amp;quot;R&amp;quot;sp) nt&amp;quot;</div><div class="line">        &amp;quot;pop %<span class="number">0</span> nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;ax, %c[rax](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;bx, %c[rbx](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;pop&amp;quot;Q&amp;quot; %c[rcx](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;dx, %c[rdx](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;si, %c[rsi](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;di, %c[rdi](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;bp, %c[rbp](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">        &amp;quot;mov %%r8,  %c[r8](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%r9,  %c[r9](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%r10, %c[r10](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%r11, %c[r11](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%r12, %c[r12](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%r13, %c[r13](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%r14, %c[r14](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">        &amp;quot;mov %%r15, %c[r15](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">#endif</div><div class="line">        &amp;quot;mov %%cr2, %%&amp;quot;R&amp;quot;ax   nt&amp;quot;</div><div class="line">        &amp;quot;mov %%&amp;quot;R&amp;quot;ax, %c[cr2](%<span class="number">0</span>) nt&amp;quot;</div><div class="line"> </div><div class="line">        &amp;quot;pop  %%&amp;quot;R&amp;quot;bp; pop  %%&amp;quot;R&amp;quot;dx nt&amp;quot;</div><div class="line">        &amp;quot;setbe %c[fail](%<span class="number">0</span>) nt&amp;quot;</div><div class="line">          : : &amp;quot;c&amp;quot;(vmx), &amp;quot;d&amp;quot;((<span class="keyword">unsigned</span> <span class="keyword">long</span>)HOST_RSP),</div><div class="line"> </div><div class="line"><span class="comment">//下面加了前面寄存器的指针值，对应具体结构的值</span></div><div class="line">        [launched]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, launched)),</div><div class="line">        [fail]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, fail)),</div><div class="line">        [host_rsp]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, host_rsp)),</div><div class="line">        [rax]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RAX])),</div><div class="line">        [rbx]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RBX])),</div><div class="line">        [rcx]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RCX])),</div><div class="line">        [rdx]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RDX])),</div><div class="line">        [rsi]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RSI])),</div><div class="line">        [rdi]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RDI])),</div><div class="line">        [rbp]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_RBP])),</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">        [r8]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R8])),</div><div class="line">        [r9]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R9])),</div><div class="line">        [r10]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R10])),</div><div class="line">        [r11]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R11])),</div><div class="line">        [r12]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R12])),</div><div class="line">        [r13]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R13])),</div><div class="line">        [r14]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R14])),</div><div class="line">        [r15]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.regs[VCPU_REGS_R15])),</div><div class="line">#endif</div><div class="line">        [cr2]&amp;quot;i&amp;quot;(offsetof(<span class="keyword">struct</span> vcpu_vmx, vcpu.arch.cr2)),</div><div class="line">        [wordsize]&amp;quot;i&amp;quot;(<span class="keyword">sizeof</span>(ulong))</div><div class="line">          : &amp;quot;cc&amp;quot;, &amp;quot;memory&amp;quot;</div><div class="line">        , R&amp;quot;ax&amp;quot;, R&amp;quot;bx&amp;quot;, R&amp;quot;di&amp;quot;, R&amp;quot;si&amp;quot;</div><div class="line">#ifdef CONFIG_X86_64</div><div class="line">        , &amp;quot;r8&amp;quot;, &amp;quot;r9&amp;quot;, &amp;quot;r10&amp;quot;, &amp;quot;r11&amp;quot;, &amp;quot;r12&amp;quot;, &amp;quot;r13&amp;quot;, &amp;quot;r14&amp;quot;, &amp;quot;r15&amp;quot;</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>以上代码相对容易理解的，根据注释大致清楚了具体作用。</p>
<p>然后就是恢复系统NMI等中断:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">vmx_complete_atomic_exit(vmx);</div><div class="line">vmx_recover_nmi_blocking(vmx);</div><div class="line">vmx_complete_interrupts(vmx);</div><div class="line">vmx_complete_atomic_exit(vmx);</div><div class="line">vmx_recover_nmi_blocking(vmx);</div><div class="line">vmx_complete_interrupts(vmx);</div></pre></td></tr></table></figure>
<p>回到vcpu_enter_guest，通过hw_breakpoint_restore恢复硬件断点。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">	<span class="keyword">if</span> (hw_breakpoint_active())</div><div class="line">		hw_breakpoint_restore();</div><div class="line"></div><div class="line">	kvm_get_msr(vcpu, MSR_IA32_TSC, &amp;amp;vcpu-&amp;gt;arch.last_guest_tsc);</div><div class="line"></div><div class="line"><span class="comment">//设置vcpu模式，恢复host相关内容</span></div><div class="line">	vcpu-&amp;gt;mode = OUTSIDE_GUEST_MODE;</div><div class="line">	smp_wmb();</div><div class="line">	local_irq_enable();</div><div class="line"></div><div class="line">	++vcpu-&amp;gt;stat.exits;</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * We must have an instruction between local_irq_enable() and</div><div class="line">	 * kvm_guest_exit(), so the timer interrupt isn't delayed by</div><div class="line">	 * the interrupt shadow.  The stat.exits increment will do nicely.</div><div class="line">	 * But we need to prevent reordering, hence this barrier():</div><div class="line">	 */</div><div class="line">	barrier();</div><div class="line"><span class="comment">//刷新系统时间</span></div><div class="line">	kvm_guest_exit();</div><div class="line"></div><div class="line">	preempt_enable();</div><div class="line"></div><div class="line">	vcpu-&amp;gt;srcu_idx = srcu_read_lock(&amp;amp;vcpu-&amp;gt;kvm-&amp;gt;srcu);</div><div class="line"></div><div class="line">	<span class="comment">/*</span></div><div class="line">	 * Profile KVM exit RIPs:</div><div class="line">	 */</div><div class="line">	<span class="keyword">if</span> (unlikely(prof_on == KVM_PROFILING)) &#123;</div><div class="line">		<span class="keyword">unsigned</span> <span class="keyword">long</span> rip = kvm_rip_read(vcpu);</div><div class="line">		profile_hit(KVM_PROFILING, (<span class="keyword">void</span> *)rip);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	kvm_lapic_sync_from_vapic(vcpu);</div><div class="line"><span class="comment">//处理vmx退出</span></div><div class="line">	r = kvm_x86_ops-&amp;gt;handle_exit(vcpu);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (hw_breakpoint_active())</div><div class="line">        hw_breakpoint_restore();</div><div class="line"> </div><div class="line">    kvm_get_msr(vcpu, MSR_IA32_TSC, &amp;amp;vcpu-&amp;gt;arch.last_guest_tsc);</div><div class="line"> </div><div class="line"><span class="comment">//设置vcpu模式，恢复host相关内容</span></div><div class="line">    vcpu-&amp;gt;mode = OUTSIDE_GUEST_MODE;</div><div class="line">    smp_wmb();</div><div class="line">    local_irq_enable();</div><div class="line"> </div><div class="line">    ++vcpu-&amp;gt;stat.exits;</div><div class="line"> </div><div class="line">    <span class="comment">/*</span></div><div class="line">     * We must have an instruction between local_irq_enable() and</div><div class="line">     * kvm_guest_exit(), so the timer interrupt isn't delayed by</div><div class="line">     * the interrupt shadow.  The stat.exits increment will do nicely.</div><div class="line">     * But we need to prevent reordering, hence this barrier():</div><div class="line">     */</div><div class="line">    barrier();</div><div class="line"><span class="comment">//刷新系统时间</span></div><div class="line">    kvm_guest_exit();</div><div class="line"> </div><div class="line">    preempt_enable();</div><div class="line"> </div><div class="line">    vcpu-&amp;gt;srcu_idx = srcu_read_lock(&amp;amp;vcpu-&amp;gt;kvm-&amp;gt;srcu);</div><div class="line"> </div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Profile KVM exit RIPs:</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (unlikely(prof_on == KVM_PROFILING)) &#123;</div><div class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> rip = kvm_rip_read(vcpu);</div><div class="line">        profile_hit(KVM_PROFILING, (<span class="keyword">void</span> *)rip);</div><div class="line">    &#125;</div><div class="line"> </div><div class="line">    kvm_lapic_sync_from_vapic(vcpu);</div><div class="line"><span class="comment">//处理vmx退出</span></div><div class="line">    r = kvm_x86_ops-&amp;gt;handle_exit(vcpu);</div><div class="line">handle_exit退出函数由vmx_handle_exit实现，主要设置vcpu-&gt;run-&gt;exit_reason，让外部感知退出原因，并对应处理。对于vpu而言，handle_exit只是意味着一个传统linux一个时间片的结束，后续的工作都是由handle完成的，handle_exit对应的函数集如下：</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*kvm_vmx_exit_handlers[])</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span> </span>= &#123;</div><div class="line">	[EXIT_REASON_EXCEPTION_NMI]           = handle_exception,</div><div class="line">	[EXIT_REASON_EXTERNAL_INTERRUPT]      = handle_external_interrupt,</div><div class="line">	[EXIT_REASON_TRIPLE_FAULT]            = handle_triple_fault,</div><div class="line">	[EXIT_REASON_NMI_WINDOW]	      = handle_nmi_window,</div><div class="line">	[EXIT_REASON_IO_INSTRUCTION]          = handle_io,</div><div class="line">	[EXIT_REASON_CR_ACCESS]               = handle_cr,</div><div class="line">	[EXIT_REASON_DR_ACCESS]               = handle_dr,</div><div class="line">	[EXIT_REASON_CPUID]                   = handle_cpuid,</div><div class="line">	[EXIT_REASON_MSR_READ]                = handle_rdmsr,</div><div class="line">	[EXIT_REASON_MSR_WRITE]               = handle_wrmsr,</div><div class="line">	[EXIT_REASON_PENDING_INTERRUPT]       = handle_interrupt_window,</div><div class="line">	[EXIT_REASON_HLT]                     = handle_halt,</div><div class="line">	[EXIT_REASON_INVD]		      = handle_invd,</div><div class="line">	[EXIT_REASON_INVLPG]		      = handle_invlpg,</div><div class="line">	[EXIT_REASON_VMCALL]                  = handle_vmcall,</div><div class="line">	[EXIT_REASON_VMCLEAR]	              = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMLAUNCH]                = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMPTRLD]                 = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMPTRST]                 = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMREAD]                  = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMRESUME]                = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMWRITE]                 = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMOFF]                   = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_VMON]                    = handle_vmx_insn,</div><div class="line">	[EXIT_REASON_TPR_BELOW_THRESHOLD]     = handle_tpr_below_threshold,</div><div class="line">	[EXIT_REASON_APIC_ACCESS]             = handle_apic_access,</div><div class="line">	[EXIT_REASON_WBINVD]                  = handle_wbinvd,</div><div class="line">	[EXIT_REASON_XSETBV]                  = handle_xsetbv,</div><div class="line">	[EXIT_REASON_TASK_SWITCH]             = handle_task_switch,</div><div class="line">	[EXIT_REASON_MCE_DURING_VMENTRY]      = handle_machine_check,</div><div class="line">	[EXIT_REASON_EPT_VIOLATION]	      = handle_ept_violation,</div><div class="line">	[EXIT_REASON_EPT_MISCONFIG]           = handle_ept_misconfig,</div><div class="line">	[EXIT_REASON_PAUSE_INSTRUCTION]       = handle_pause,</div><div class="line">	[EXIT_REASON_MWAIT_INSTRUCTION]	      = handle_invalid_op,</div><div class="line">	[EXIT_REASON_MONITOR_INSTRUCTION]     = handle_invalid_op,</div><div class="line">&#125;;</div><div class="line"><span class="function"><span class="keyword">static</span> <span class="title">int</span> <span class="params">(*kvm_vmx_exit_handlers[])</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu)</span> </span>= &#123;</div><div class="line">    [EXIT_REASON_EXCEPTION_NMI]           = handle_exception,</div><div class="line">    [EXIT_REASON_EXTERNAL_INTERRUPT]      = handle_external_interrupt,</div><div class="line">    [EXIT_REASON_TRIPLE_FAULT]            = handle_triple_fault,</div><div class="line">    [EXIT_REASON_NMI_WINDOW]          = handle_nmi_window,</div><div class="line">    [EXIT_REASON_IO_INSTRUCTION]          = handle_io,</div><div class="line">    [EXIT_REASON_CR_ACCESS]               = handle_cr,</div><div class="line">    [EXIT_REASON_DR_ACCESS]               = handle_dr,</div><div class="line">    [EXIT_REASON_CPUID]                   = handle_cpuid,</div><div class="line">    [EXIT_REASON_MSR_READ]                = handle_rdmsr,</div><div class="line">    [EXIT_REASON_MSR_WRITE]               = handle_wrmsr,</div><div class="line">    [EXIT_REASON_PENDING_INTERRUPT]       = handle_interrupt_window,</div><div class="line">    [EXIT_REASON_HLT]                     = handle_halt,</div><div class="line">    [EXIT_REASON_INVD]              = handle_invd,</div><div class="line">    [EXIT_REASON_INVLPG]              = handle_invlpg,</div><div class="line">    [EXIT_REASON_VMCALL]                  = handle_vmcall,</div><div class="line">    [EXIT_REASON_VMCLEAR]                  = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMLAUNCH]                = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMPTRLD]                 = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMPTRST]                 = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMREAD]                  = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMRESUME]                = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMWRITE]                 = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMOFF]                   = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_VMON]                    = handle_vmx_insn,</div><div class="line">    [EXIT_REASON_TPR_BELOW_THRESHOLD]     = handle_tpr_below_threshold,</div><div class="line">    [EXIT_REASON_APIC_ACCESS]             = handle_apic_access,</div><div class="line">    [EXIT_REASON_WBINVD]                  = handle_wbinvd,</div><div class="line">    [EXIT_REASON_XSETBV]                  = handle_xsetbv,</div><div class="line">    [EXIT_REASON_TASK_SWITCH]             = handle_task_switch,</div><div class="line">    [EXIT_REASON_MCE_DURING_VMENTRY]      = handle_machine_check,</div><div class="line">    [EXIT_REASON_EPT_VIOLATION]          = handle_ept_violation,</div><div class="line">    [EXIT_REASON_EPT_MISCONFIG]           = handle_ept_misconfig,</div><div class="line">    [EXIT_REASON_PAUSE_INSTRUCTION]       = handle_pause,</div><div class="line">    [EXIT_REASON_MWAIT_INSTRUCTION]          = handle_invalid_op,</div><div class="line">    [EXIT_REASON_MONITOR_INSTRUCTION]     = handle_invalid_op,</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>有handle_task_switch进行任务切换，handle_io处理qemu的外部模拟IO等，具体处理内容后面在写。</p>
<p>再次退回到__vcpu_run函数，在while (r &gt; 0)中，循环受vcpu_enter_guest返回值控制，只有运行异常的时候才退出循环，否则通过kvm_resched一直运行下去。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">if</span> (need_resched()) &#123;</div><div class="line">	srcu_read_unlock(&amp;amp;kvm-&amp;gt;srcu, vcpu-&amp;gt;srcu_idx);</div><div class="line">	kvm_resched(vcpu);</div><div class="line">	vcpu-&amp;gt;srcu_idx = srcu_read_lock(&amp;amp;kvm-&amp;gt;srcu);</div><div class="line">&#125;</div><div class="line">      <span class="keyword">if</span> (need_resched()) &#123;</div><div class="line">          srcu_read_unlock(&amp;amp;kvm-&amp;gt;srcu, vcpu-&amp;gt;srcu_idx);</div><div class="line">          kvm_resched(vcpu);</div><div class="line">          vcpu-&amp;gt;srcu_idx = srcu_read_lock(&amp;amp;kvm-&amp;gt;srcu);</div><div class="line">      &#125;</div></pre></td></tr></table></figure>
<p>再退就到了kvm_arch_vcpu_ioctl_run函数，此时kvm run的执行也结束。</p>
<p>KVM cpu虚拟化的理解基本如上，涉及到的具体细节有时间后开篇另说。</p>
<p>KVM源代码分析未完待续</p>
<p>—结束—</p>
<hr>
<p><strong>转载本文请务必注明</strong>，文章出处：《<a href="http://www.csyssec.org/20170104/kvmsource-cpu/" target="_blank" rel="external">KVM源码分析之CPU虚拟化</a>》及原作者信息:<a href="http://www.oenhan.com/about" target="_blank" rel="external">Oen Han</a></p>

      
    </div>
    <footer class="entry-meta entry-footer">
      
	<span class="ico-folder"></span>
    <a class="article-category-link" href="/categories/虚拟化原理/">虚拟化原理</a>

      
  <span class="ico-tags"></span>
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/KVM/">KVM</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/QEMU/">QEMU</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Virtualization/">Virtualization</a></li></ul>

      
        
	<div id="comment">
	
	<!-- 多说评论框 start -->
	 <div class="ds-thread" data-thread-key="/20170104/kvmsource-cpu/" data-title="KVM源码分析之CPU虚拟化" data-url="http://yoursite.com/20170104/kvmsource-cpu/"></div>
	<!-- 多说评论框 end -->
	<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"csyssec"};
	  (function() {
	    var ds = document.createElement('script');
	    ds.type = 'text/javascript';ds.async = true;
	    ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
	    ds.charset = 'UTF-8';
	    (document.getElementsByTagName('head')[0] 
	     || document.getElementsByTagName('body')[0]).appendChild(ds);
	  })();
	  </script>
	<!-- 多说公共JS代码 end -->
	
	</div>
	<link rel="stylesheet" href="/css/comment.css">


      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/20170104/kvmsource-memory/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">上一篇</strong>
      <div class="article-nav-title">
        
          KVM源码分析之内存虚拟化
        
      </div>
    </a>
  
  
    <a href="/20170104/kvmsource-create/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">下一篇</strong>
      <div class="article-nav-title">KVM源码分析之虚拟机的创建与运行</div>
    </a>
  
</nav>

  
</article>

<!-- Table of Contents -->

  <aside id="sidebar">
    <div id="toc" class="toc-article">
    <strong class="toc-title">文章目录</strong>
    
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0X01-VT-x-技术"><span class="toc-number">1.</span> <span class="toc-text">0X01 VT-x 技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X02-VMCS寄存器"><span class="toc-number">2.</span> <span class="toc-text">0X02 VMCS寄存器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X03-VM-Entry-VM-Exit"><span class="toc-number">3.</span> <span class="toc-text">0X03 VM-Entry/VM-Exit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X04-KVM-CREATE-VM"><span class="toc-number">4.</span> <span class="toc-text">0X04 KVM_CREATE_VM</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X05-KVM-CREATE-VCPU"><span class="toc-number">5.</span> <span class="toc-text">0X05 KVM_CREATE_VCPU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0X06-KVM-RUN"><span class="toc-number">6.</span> <span class="toc-text">0X06 KVM_RUN</span></a></li></ol>
    
    </div>
  </aside>
</section>
        
      </div>
      <footer id="footer" class="site-footer">
  

  <div class="clearfix container">
      <div class="site-info">
	      版权所有&copy; 2017 Index of Computer System and Security 保留所有权利.
      </div>
      <div class="site-credit">
       <!--  自豪地使用 <a href="https://github.com/iTimeTraveler/hexo-theme-hiero" target="_blank">hiero</a> --> 
      </div>
  </div>
</footer>


<!-- min height -->

<script>
    var wrapdiv = document.getElementById("wrap");
    var contentdiv = document.getElementById("content");

    wrapdiv.style.minHeight = document.body.offsetHeight + "px";
    contentdiv.style.minHeight = document.body.offsetHeight - document.getElementById("allheader").offsetHeight - document.getElementById("footer").offsetHeight + "px";
</script>

    </div>
    <!-- <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/syssec" class="mobile-nav-link">Syssec</a>
  
    <a href="/architecture" class="mobile-nav-link">Architecture</a>
  
    <a href="/virtualization" class="mobile-nav-link">Virtualization</a>
  
    <a href="/malware" class="mobile-nav-link">Malware</a>
  
    <a href="/conferences" class="mobile-nav-link">Conferences</a>
  
    <a href="/courses" class="mobile-nav-link">Courses</a>
  
    <a href="/academy" class="mobile-nav-link">Academy</a>
  
    <a href="/contribution" class="mobile-nav-link">Contribution</a>
  
    <a href="/donation" class="mobile-nav-link">Donation</a>
  
    <a href="/about" class="mobile-nav-link">About</a>
  
</nav> -->
    
<div style="display: none;">
  <script src="https://s11.cnzz.com/z_stat.php?id=1260716016&web_id=1260716016" language="JavaScript"></script>
</div>

<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$','$'], ["\\(","\\)"] ],
      processEscapes: true
    }
  });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>
<script src="/js/bootstrap.js"></script>
<script src="/js/main.js"></script>





  </div>

  <a id="rocket" href="#top" class=""></a>
  <script type="text/javascript" src="/js/totop.js" async=""></script>
  

  <div style="display: none;">
    <script src="https://s95.cnzz.com/z_stat.php?id=1261078922&web_id=1261078922" language="JavaScript"></script>
  </div>


</body>
</html>
